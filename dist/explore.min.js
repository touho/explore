!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t,e){void 0===t&&(t="???"),void 0===e&&(e=16);for(var n=t,r=e-1;r>=0;--r)n+=M[Math.random()*J|0];return n}function e(t){u(void 0===j[t.id],"Serializable id clash "+t.id),j[t.id]=t}function n(t){return j[t]||null}function r(t){if(!j[t])throw new Error("Serializable not found!");delete j[t]}function o(){return V}function i(t){t!==V&&(V=t)}function a(t,e){if(u(V,"Change without origin!"),e.id){var n={type:t,reference:e,id:e.id,external:F,origin:V};t===L.setPropertyValue?n.value=e._value:t===L.move?n.parent=e._parent:t===L.addSerializableToTree&&(n.parent=e._parent,delete n.id);var r=V;W.forEach(function(t){return t(n)}),V!==r&&(V=r)}}function s(t){if(i("external"),F)return t();F=!0,t(),F=!1}function p(t){u("function"==typeof t),W.push(t)}function l(t){if(t.packedChange)return t.packedChange;var e={};try{t.parent&&(t.parentId=t.parent.id),t.type===L.addSerializableToTree?t.reference?t.value=t.reference.toJSON():t.value||u(!1,"invalid change of type addSerializableToTree",t):t.value&&(t.value=t.reference.propertyType.type.toJSON(t.value)),Object.keys(k).forEach(function(n){if(t[n]){if("type"===n&&t[n]===L.setPropertyValue)return;e[k[n]]=t[n]}})}catch(t){console.log("PACK ERROR",t)}return e}function c(t){var e={packedChange:t};if(Object.keys(t).forEach(function(n){e[B[n]]=t[n]}),e.type||(e.type=L.setPropertyValue),e.type===L.addSerializableToTree)e.id=e.value.id;else{if(e.reference=n(e.id),!e.reference)return console.error("received a change with unknown id",e,"packed:",t),null;e.id=e.reference.id}return e.parentId&&(e.parent=n(e.parentId)),e}function h(t){var e;s(function(){if(console.log("execute change",t.type,t.id||t.value),t.type===L.setPropertyValue)t.reference.value=t.reference.propertyType.type.fromJSON(t.value);else if(t.type===L.addSerializableToTree)if(t.parent){var n=z.fromJSON(t.value);t.parent.addChild(n),"ent"===n.threeLetterType&&(n.localMaster=!1)}else{var r=z.fromJSON(t.value);"sce"===r.threeLetterType&&(e=r)}else t.type===L.deleteAllChildren?t.reference.deleteChildren():t.type===L.deleteSerializable?t.reference.delete():t.type===L.move&&t.reference.move(t.parent)}),e&&e.play()}function u(t,e){if(!t)throw console.log("Assert",e,(new Error).stack,"\norigin",o()),new Error(e)}function d(t,e,n){for(var r=[],o=arguments.length-3;o-- >0;)r[o]=arguments[o+3];n=n();var i=n.validators.default(),a="",s=[],p=null;return r.forEach(function(t,e){"string"==typeof t?a=t:t&&t.validate?i=t:t&&t.isFlag?s.push(t):t&&t.visibleIf?p=t:u(!1,"invalid parameter "+t+" idx "+e)}),new U(t,n,i,e,a,s,p)}function f(t,e){return void 0===e&&(e={}),e.isFlag=!0,e.type=t,e}function y(t){var e=t.name;void 0===e&&(e="");var n=t.validators;void 0===n&&(n={default:function(t){return t}});var r=t.toJSON;void 0===r&&(r=function(t){return t});var o=t.fromJSON;void 0===o&&(o=function(t){return t});var i=t.clone;void 0===i&&(i=function(t){return t}),u(e,"name missing from property type"),u("function"==typeof n.default,"default validator missing from property type: "+e),u("function"==typeof r,"invalid toJSON for property type: "+e),u("function"==typeof o,"invalid fromJSON for property type: "+e);var a={name:e,validators:n,toJSON:r,fromJSON:o,clone:i},s=function(){return a};return Object.keys(n).forEach(function(t){s[t]=m(t,n[t]),n[t]=s[t]}),s}function m(t,e){var n=function(){for(var n=arguments.length,r=Array(n);n--;)r[n]=arguments[n];var o=[].concat(r);return{validatorName:t,validatorParameters:o,validate:function(t){return e.apply(void 0,[t].concat(o))},parameters:o}};return n.validatorName=t,n.validate=e,n}function v(t){if(isNaN(t)||t===1/0||t===-(1/0))throw new Error("Invalid float: "+t)}function g(t,e){u(!t._p2World),t._p2World=new it.World({gravity:[0,9.81]}),t._p2World.sleepMode=it.World.BODY_SLEEPING}function _(t,e){t._p2World.step(1/60,e,10)}function T(t){t._p2World&&t._p2World.clear(),delete t._p2World,delete t._p2Materials}function C(t,e){t._p2World.addBody(e)}function S(t,e){t._p2World.removeBody(e)}function w(t,e){t._p2Materials||(t._p2Materials={});var n=t._p2Materials;e=Object.assign({},st,e);var r=[e.friction,e.restitution,e.stiffness,e.relaxation,e.frictionStiffness,e.frictionRelaxation,e.surfaceVelocity].join(";");if(n[r])return n[r];var o=new it.Material;o.options=e,n[r]=o;for(var i in n){var a=n[i],s=o.options,p=a.options,l=new it.ContactMaterial(o,a,{friction:Math.min(s.friction,p.friction),restitution:s.restitution*p.restitution,stiffness:Math.min(s.stiffness,p.stiffness),relaxation:(s.relaxation+p.relaxation)/2,frictionStiffness:Math.min(s.frictionStiffness,p.frictionStiffness),frictionRelaxation:(s.frictionRelaxation+p.frictionRelaxation)/2,surfaceVelocity:Math.max(s.surfaceVelocity,p.surfaceVelocity)});t._p2World.addContactMaterial(l)}return o}function I(t){return gt[t]||!1}function E(t){void 0===t&&(t=!0),wt=t}function N(){It=!0}function b(t){return"sce"===t.reference.getRoot().threeLetterType}function O(t){for(var e=window.location.search.substring(1),n=e.split("&"),r=0;r<n.length;r++){var o=n[r].split("=");if(decodeURIComponent(o[0])==t)return decodeURIComponent(o[1])}console.log("Query variable %s not found",t)}function P(){if(!window.io)return setTimeout(P,10);St=io();var t=[],e={};p(function(n){if("external"!==n.origin&&wt&&!b(n)){if(n.type===L.setPropertyValue){var r=e[n.id];r&&t.splice(t.indexOf(r),1),e[n.id]=n}t.push(n)}}),setInterval(function(){if(0!==t.length){var n=t.map(l);t.length=0,e={},console.log("sending",n),St.emit("c",n)}},100),St.on("c",function(t){console.log("RECEIVE,",wt),wt&&(console.log("received",t),t.forEach(function(t){t=c(t),t&&h(t)}))}),St.on("requestGameId",function(t){nt&&St.emit("gameId",nt.id)});var n=Date.now();St.on("refreshIfOlderThan",function(t){n<t&&location.reload()}),St.on("gameData",function(t){if(console.log("gameData",t),s(function(){z.fromJSON(t)}),localStorage.anotherGameId=t.id,history.replaceState({},null,"?gameId="+t.id),console.log("replaced with",""+location.origin+location.pathname+"?gameId="+t.id),It){var e=nt.getChildren("lvl")[0].createScene();e.play(),nt.listen("levelCompleted",function(){e.play()})}}),setTimeout(function(){var t=O("gameId")||localStorage.anotherGameId;console.log("requestGameData",t),St.emit("requestGameData",t)},100)}function x(){Et&&(Et.width=window.innerWidth,Et.height=window.innerHeight)}var A="undefined"!=typeof window,D="undefined"!=typeof module;if(A&&D)throw new Error("Can not be client and server at the same time.");var M="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",J=M.length,R=new Map,z=function n(r,o){if(void 0===r&&(r=!1),void 0===o&&(o=!1),u(this.threeLetterType,"Forgot to Serializable.registerSerializable your class?"),this._children=new Map,this._listeners=[],this._isInTree=this.isRoot,this._state|=n.STATE_CONSTRUCTOR,!o){if(r?(this._state|=n.STATE_PREDEFINEDID,this.id=r):this.id=t(this.threeLetterType),this.id.startsWith("?"))throw new Error("?");e(this)}};z.prototype.delete=function(){return this._parent?(this._parent.deleteChild(this),!1):(this.deleteChildren(),this._alive=!1,this._isInTree=!1,this._listeners.length=0,r(this.id),this._state|=z.STATE_DESTROY,!0)},z.prototype.deleteChildren=function(){this._children.size&&(this._children.forEach(function(t){t.forEach(function(t){t._parent=null,t.delete()})}),this._children.clear(),this._parent&&a(L.deleteAllChildren,this))},z.prototype.initWithChildren=function(t){return void 0===t&&(t=[]),u(!(this._state&z.STATE_INIT),"init already done"),this._state|=z.STATE_INIT,t.length>0&&this.addChildren(t),this},z.prototype.addChildren=function(t){for(var e=this,n=0;n<t.length;n++)e.addChild(t[n]);return this},z.prototype.addChild=function(t){return this._addChild(t),this._state|=z.STATE_ADDCHILD,this._isInTree&&a(L.addSerializableToTree,t),this},z.prototype._addChild=function(t){u(null===t._parent);var e=this._children.get(t.threeLetterType);return void 0===e&&(e=[],this._children.set(t.threeLetterType,e)),e.push(t),t._parent=this,t._state|=z.STATE_ADDPARENT,t.setInTreeStatus(this._isInTree),this},z.prototype.findChild=function(t,e){var n=this._children.get(t);return n?e?n.find(e)||null:n[0]:null},z.prototype.findParent=function(t,e){void 0===e&&(e=null);for(var n=this;n;){if(n.threeLetterType===t&&(!e||e(n)))return n;n=n._parent}return null},z.prototype.getRoot=function(){for(var t=this;t._parent;)t=t._parent;return t},z.prototype.deleteChild=function(t,e){return a(L.deleteSerializable,t),this._detachChild(t,e),t.delete(),this},z.prototype._detachChild=function(t,e){void 0===e&&(e=0);var n=this._children.get(t.threeLetterType);return u(n,"child not found"),n[e]!==t&&(e=n.indexOf(t)),u(e>=0,"child not found"),n.splice(e,1),0===n.length&&this._children.delete(t.threeLetterType),t._parent=null,t.setInTreeStatus(!1),this},z.prototype.forEachChild=function(t,e,n){function r(r){r.forEach(function(r){e(r),n&&r.forEachChild(t,e,!0)})}return void 0===t&&(t=null),void 0===n&&(n=!1),t?r(this._children.get(t)||[]):this._children.forEach(r),this},z.prototype.move=function(t){return t._addChild(this._detach()),a(L.move,this),this},z.prototype._detach=function(){return this._parent&&this._parent._detachChild(this),this},z.prototype.getParent=function(){return this._parent||null},z.prototype.getChildren=function(t){return this._children.get(t)||[]},z.prototype.toJSON=function(){var t=this,e={id:this.id};if(this._children.size>0){var n=[];Array.from(this._children.keys()).sort(function(t,e){return"prt"===t?-1:1}).forEach(function(e){return n.push(t._children.get(e))}),e.c=(r=[]).concat.apply(r,n).map(function(t){return t.toJSON()})}return e;var r},z.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},z.prototype.clone=function(){var t=new this.constructor,e=[];return this.forEachChild(null,function(t){e.push(t.clone())}),t.initWithChildren(e),this._state|=z.STATE_CLONE,t},z.prototype.listen=function(t,e){var n=this;return this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]),this._listeners[t].unshift(e),function(){var r=n._listeners[t].indexOf(e);n._listeners[t].splice(r,1)}},z.prototype.dispatch=function(t){for(var e=this,n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];if(this._listeners.hasOwnProperty(t))for(var o=this._listeners[t].length-1;o>=0;--o)try{e._listeners[t][o].apply(null,n)}catch(n){console.error("Event "+t+" listener crashed.",e._listeners[t][o],n)}},z.prototype.hasDescendant=function(t){var e=this;if(!t)return!1;for(var n=t._parent;n;){if(n===e)return!0;n=n._parent}return!1},z.prototype.setInTreeStatus=function(t){this._isInTree!==t&&(this._isInTree=t,this._children.forEach(function(e){e.forEach(function(e){return e.setInTreeStatus(t)})}))},z.fromJSON=function t(e){u("string"==typeof e.id&&e.id.length>5,"Invalid id.");var t=R.get(e.id.substring(0,3));u(t);var n;try{n=t(e)}catch(t){if(A){if(window.force,!window.force)throw new Error}else console.log("Error fromJSON",t);return null}var r=e.c?e.c.map(function(t){return z.fromJSON(t)}).filter(Boolean):[];return n._state&z.STATE_INIT?n.addChildren(r):n.initWithChildren(r),n._state|=z.STATE_FROMJSON,n},z.registerSerializable=function(t,e,n){void 0===n&&(n=null),t.prototype.threeLetterType=e,u("string"==typeof e&&3===e.length),n||(n=function(e){return new t(e.id)}),R.set(e,n)},z.prototype._parent=null,z.prototype._alive=!0,z.prototype._state=0,z.STATE_CONSTRUCTOR=1,z.STATE_INIT=2,z.STATE_ADDCHILD=4,z.STATE_ADDPARENT=8,z.STATE_CLONE=16,z.STATE_DESTROY=32,z.STATE_FROMJSON=64,z.STATE_PREDEFINEDID=128,z.prototype.isRoot=!1,Object.defineProperty(z.prototype,"debug",{get:function(){var t=this,e=this.threeLetterType;this._children.forEach(function(n,r){e+="|",e+="prp"===r?t.getChildren("prp").map(function(t){return t.name+"="+t._value}).join(", "):r+"("+n.length+")"}),e+="|state: ";var n=[],r=function(e,r){t._state&e&&n.push(r)};return r(z.STATE_CONSTRUCTOR,"constructor"),r(z.STATE_INIT,"init"),r(z.STATE_ADDCHILD,"add child"),r(z.STATE_ADDPARENT,"add parent"),r(z.STATE_CLONE,"clone"),r(z.STATE_DESTROY,"destroy"),r(z.STATE_FROMJSON,"from json"),r(z.STATE_PREDEFINEDID,"predefined id"),e+=n.join(", ")}}),Object.defineProperty(z.prototype,"debugChildren",{get:function(){function t(t){return new function(){}}var e=[];this._children.forEach(function(t,n){e=e.concat(t)});var n=[];return e.forEach(function(e){var r=t(e.threeLetterType);r.debug=e.debug,r.ref=e;var o=e.debugChildArray;o&&o.length>0&&(r.children=o),n.push(r)}),n}});var j={},L={addSerializableToTree:"a",setPropertyValue:"s",deleteSerializable:"d",move:"m",deleteAllChildren:"c"},k={id:"i",type:"t",value:"v",parentId:"p"},B={};Object.keys(k).forEach(function(t){B[k[t]]=t});var V,F=!1,W=[],q=function(t){function e(e){var n=e.value,r=e.predefinedId,o=e.name,i=e.propertyType,a=e.skipSerializableRegistering;void 0===a&&(a=!1),u(o,"Property without a name can not exist"),t.call(this,r,a),this._initialValue=n,i?this.setPropertyType(i):(this.name=o,this._initialValueIsJSON=!0)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPropertyType=function(t){this.propertyType=t;try{void 0!==this._initialValue?this.value=this._initialValueIsJSON?t.type.fromJSON(this._initialValue):this._initialValue:this.value=t.initialValue}catch(e){console.log("Invalid value",e,t,this),this.value=t.initialValue}this.name=t.name},e.prototype.clone=function(t){return void 0===t&&(t=!1),new e({value:this.propertyType.type.clone(this.value),name:this.name,propertyType:this.propertyType,skipSerializableRegistering:t})},e.prototype.toJSON=function(){return Object.assign(t.prototype.toJSON.call(this),{v:this.type.toJSON(this.value),n:this.propertyType.name})},e}(z);q.prototype.propertyType=null,Object.defineProperty(q.prototype,"type",{get:function(){return this.propertyType.type}}),Object.defineProperty(q.prototype,"value",{set:function(t){this._value=this.propertyType.validator.validate(t),this.dispatch("change",this._value),this._isInTree&&a(L.setPropertyValue,this)},get:function(){return this._value}}),z.registerSerializable(q,"prp",function(t){return new q({value:t.v,predefinedId:t.id,name:t.n})}),Object.defineProperty(q.prototype,"debug",{get:function(){return"prp "+this.name+"="+this.value}});var U=function(t,e,n,r,o,i,a){var s=this;void 0===i&&(i=[]),u("string"==typeof t),u(t[0]>="a"&&t[0]<="z","Name of a property must start with lower case letter."),u(e&&"string"==typeof e.name),u(n&&"function"==typeof n.validate),this.name=t,this.type=e,this.validator=n,this.initialValue=r,this.description=o,this.visibleIf=a,this.flags={},i.forEach(function(t){return s.flags[t.type]=t})};U.prototype.getFlag=function(t){return this.flags[t.type]},U.prototype.createProperty=function(t){void 0===t&&(t={});var e=t.value,n=t.predefinedId,r=t.skipSerializableRegistering;return void 0===r&&(r=!1),new q({propertyType:this,value:e,predefinedId:n,name:this.name,skipSerializableRegistering:r})};var H=d;H.visibleIf=function(t,e){return u("string"==typeof t&&t.length),u(void 0!==e),{visibleIf:!0,propertyName:t,value:e}},d.flagDegreesInEditor=f("degreesInEditor");var G=function(t,e){this.x=t||0,this.y=e||0};G.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},G.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},G.prototype.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},G.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this},G.prototype.divide=function(t){return this.x/=t.x,this.y/=t.y,this},G.prototype.divideScalar=function(t){return this.x/=t,this.y/=t,this},G.prototype.dot=function(t){return this.x*t.x+this.y*t.y},G.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},G.prototype.lengthSq=function(){return this.x*this.x+this.y*this.y},G.prototype.setLength=function(t){var e=this.length();return 0===e?(this.x=t,this.y=0):this.multiplyScalar(t/e),this},G.prototype.getProjectionOn=function(t){var e=t.length();return 0===e?this.clone():t.clone().multiplyScalar(this.dot(t)/(e*e))},G.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},G.prototype.distanceSq=function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n},G.prototype.normalize=function(){return this.setLength(1)},G.prototype.horizontalAngle=function(){return Math.atan2(this.y,this.x)},G.prototype.verticalAngle=function(){return Math.atan2(this.x,this.y)},G.prototype.rotate=function(t){var e=this.x*Math.cos(t)-this.y*Math.sin(t);return this.y=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=e,this},G.prototype.rotateTo=function(t){return this.rotate(t-this.verticalAngle())},G.prototype.isEqualTo=function(t){return this.x===t.x&&this.y===t.y},G.prototype.isZero=function(){return!this.x&&!this.y},G.prototype.clone=function(){return new G(this.x,this.y)},G.prototype.set=function(t){return this.x=t.x,this.y=t.y,this},G.prototype.toString=function(){return"["+this.x+", "+this.y+"]"},G.prototype.toArray=function(){return[this.x,this.y]},G.fromObject=function(t){return new G(t.x,t.y)},G.fromArray=function(t){return new G(t[0],t[1])};var Y=Math.pow(10,4);H.float=y({name:"float",validators:{default:function(t){return t=parseFloat(t),v(t),t},range:function(t,e,n){return t=parseFloat(t),v(t),Math.min(n,Math.max(e,t))},modulo:function(t,e,n){t=parseFloat(t),v(t);var r=n-e;return t<e?t+=(((e-t)/r|0)+1)*r:t>n-1e-7&&(t-=(((t-n)/r|0)+1)*r),t}},toJSON:function(t){return Math.round(t*Y)/Y},fromJSON:function(t){return t}}),H.int=y({name:"int",validators:{default:function(t){return t=parseInt(t),v(t),t},range:function(t,e,n){return t=parseInt(t),v(t),Math.min(n,Math.max(e,t))}},toJSON:function(t){return t},fromJSON:function(t){return t}}),H.vector=y({name:"vector",validators:{default:function(t){if(!(t instanceof G))throw new Error;return t=t.clone(),t.x=parseFloat(t.x),t.y=parseFloat(t.y),v(t.x),v(t.y),t}},toJSON:function(t){return{x:Math.round(t.x*Y)/Y,y:Math.round(t.y*Y)/Y}},fromJSON:function(t){return G.fromObject(t)},clone:function(t){return t.clone()}}),H.string=y({name:"string",validators:{default:function(t){return t?String(t):""}},toJSON:function(t){return t},fromJSON:function(t){return t}}),H.bool=y({name:"bool",validators:{default:function(t){if("boolean"!=typeof t)throw new Error;return t}},toJSON:function(t){return t?1:0},fromJSON:function(t){return!!t}}),H.enum=y({name:"enum",validators:{default:function(){u(!1,"also specify enum values with Prop.enum.values('value1', 'value2', ...)")},values:function t(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];if(!Array.isArray(t))throw new Error;if("string"!=typeof e)throw new Error("val should be string");if(t.indexOf(e)<0)throw new Error("value "+e+" not in enum: ["+t+"]");return e}},toJSON:function(t){return t},fromJSON:function(t){return t}});var Z=function(t){function e(e){void 0===e&&(e=!1),u(Array.isArray(this.constructor._propertyTypes),"call PropertyOwner.defineProperties after class definition"),t.call(this,e),this._properties={}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.initWithPropertyValues=function(t){var e=this;void 0===t&&(t={});var n=[];return Object.keys(t).forEach(function(r){var o=e.constructor._propertyTypesByName[r];u(o,"Invalid property "+r),n.push(o.createProperty({value:t[r]}))}),this.initWithChildren(n),this},e.prototype.initWithChildren=function(e){var n=this;void 0===e&&(e=[]),u(!(this._state&t.STATE_INIT),"init already done"),this._state|=t.STATE_INIT;var r=[],o=[];e.forEach(function(t){"prp"===t.threeLetterType?r.push(t):o.push(t)}),t.prototype.addChildren.call(this,o);var i=0;r.filter(function(t){return!t.propertyType}).forEach(function(t){if(!n.constructor._propertyTypesByName[t.name])return console.log("Property of that name not defined",n.id,t.name,n),i++,void(t.isInvalid=!0);t.setPropertyType(n.constructor._propertyTypesByName[t.name])}),i&&(r=r.filter(function(t){return!t.isInvalid}));var a={};r.forEach(function(t){return a[t.name]=t}),this.constructor._propertyTypes.forEach(function(t){a[t.name]||r.push(t.createProperty())}),t.prototype.addChildren.call(this,r)},e.prototype.addChild=function(e){if(u(this._state&t.STATE_INIT,this.constructor.componentName||this.constructor+" requires that initWithChildren will be called before addChild"),t.prototype.addChild.call(this,e),"prp"===e.threeLetterType){if(!e.propertyType){if(!this.constructor._propertyTypesByName[e.name])return void console.log("Property of that name not defined",this.id,e,this);e.setPropertyType(this.constructor._propertyTypesByName[e.name])}u(void 0===this._properties[e.propertyType.name],"Property already added"),this._properties[e.propertyType.name]=e}},e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(this._properties={},!0)},e.prototype.deleteChild=function(e,n){u("prp"!==e.threeLetterType,"Can not delete just one Property child."),t.prototype.deleteChild.call(this,e,n)},e}(z);Z.defineProperties=function(t,e){t._propertyTypes=e,t._propertyTypesByName={},e.forEach(function(e){u(void 0===t.prototype[e.name],"Property name "+e.name+" clashes"),t._propertyTypesByName[e.name]=e,Object.defineProperty(t.prototype,e.name,{get:function(){return this._properties[e.name].value},set:function(t){this._properties[e.name].value=t}})})};var K="entity is already dead",Q=function(t){function e(e){void 0===e&&(e=!1),t.call(this,e),this.components=new Map,this.sleeping=!1,this.prototype=null,this.localMaster=!0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getComponent=function(t){u(this._alive,K);var e=this.components.get(t);return void 0!==e?e[0]:null},e.prototype.getComponents=function(t){return u(this._alive,K),this.components.get(t)||[]},e.prototype.getListOfAllComponents=function(){var t=[];return this.components.forEach(function(e,n){t.push.apply(t,e)}),t},e.prototype.clone=function(){var t=new e;t.prototype=this.prototype.clone(),t.sleeping=this.sleeping;var n=[];return this.components.forEach(function(t,e){n.push.apply(n,t.map(function(t){return t.clone()}))}),t.addComponents(n),t},e.prototype.addComponents=function(t){var n=this;u(this._alive,K),u(Array.isArray(t),"Parameter is not an array.");for(var r=0;r<t.length;r++){(n.components.get(t[r]._name)||n.components.set(t[r]._name,[]).get(t[r]._name)).push(t[r]),t[r].entity=n,t[r]._parent=n}return this.sleeping||e.initComponents(t),this},e.initComponents=function(t){for(var e=0;e<t.length;e++)t[e]._preInit();for(var n=0;n<t.length;n++)t[n]._init()},e.makeComponentsSleep=function(t){for(var e=0;e<t.length;e++)t[e]._sleep()},e.deleteComponents=function(t){for(var e=0;e<t.length;e++)t[e].delete()},e.prototype.sleep=function(){return u(this._alive,K),!this.sleeping&&(this.components.forEach(function(t,n){return e.makeComponentsSleep(t)}),this.sleeping=!0,!0)},e.prototype.wakeUp=function(){return u(this._alive,K),!!this.sleeping&&(this.components.forEach(function(t,n){return e.initComponents(t)}),this.sleeping=!1,!0)},e.prototype.delete=function(){return u(this._alive,K),this.sleep(),!!t.prototype.delete.call(this)&&(this.components.forEach(function(t,n){return e.deleteComponents(t)}),this.components.clear(),!0)},e.prototype.deleteComponent=function(t){var e=this.getComponents(t.constructor.componentName),n=e.indexOf(t);return u(n>=0),this.sleeping||t._sleep(),t.delete(),e.splice(n,1),this},e.prototype.setInTreeStatus=function(t){this._isInTree!==t&&(this._isInTree=t,this.components.forEach(function(e,n){e.forEach(function(e){return e.setInTreeStatus(t)})}))},e.prototype.toJSON=function(){u(this._alive,K);var e=[];return this.components.forEach(function(t){t.forEach(function(t){e.push(t.toJSON())})}),Object.assign(t.prototype.toJSON.call(this),{comp:e,proto:this.prototype.id})},e}(z);Object.defineProperty(Q.prototype,"position",{get:function(){return this.getComponent("Transform").position},set:function(t){this.getComponent("Transform").position=t}}),z.registerSerializable(Q,"ent",function(t){console.log("creating entity from json",t);var e=new Q(t.id);return e.prototype=getSerializable(t.proto),console.log("created entity from json",e),t.comp&&e.addComponents(t.comp.map(z.fromJSON)),e});var X=function(e){function n(n,r,o){void 0===r&&(r=!1),void 0===o&&(o=!1),this.name=n,this.componentClass=ht.get(this.name),u(this.componentClass,"Component class not defined: "+n),e.call(this,r),this.componentClass.allowMultiple||(o="_"+n),this.componentId=o||t("cid",10)}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.addChild=function(t){if("prp"===t.threeLetterType&&!t.propertyType){if(!this.componentClass._propertyTypesByName[t.name])return void(A?console.log("Property of that name not defined",this.id,t,this):console.log("Property of that name not defined",this.id,this.name,t.name));t.setPropertyType(this.componentClass._propertyTypesByName[t.name])}return e.prototype.addChild.call(this,t),this},n.prototype.clone=function(t){var r=!(!t||!t.cloneComponentId)&&this.componentId,o=new n(this.name,!1,r),i=[];return this.forEachChild(null,function(t){i.push(t.clone())}),o.initWithChildren(i),this._state|=e.STATE_CLONE,o},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{cid:this.componentId,n:this.name})},n.prototype.getInheritedProperties=function(t){void 0===t&&(t=0);var e={},n=this.getParentComponentData();return n&&n.getInheritedProperties(t+1).forEach(function(t){return e[t.name]=t}),this.getChildren("prp").forEach(function(n){e[n.name]=0===t?n:n.clone(!0)}),0===t?this.componentClass._propertyTypes.map(function(t){return e[t.name]||t.createProperty({skipSerializableRegistering:!0})}):Object.keys(e).map(function(t){return e[t]})},n.prototype.getParentComponentData=function(){var t=this;if(!this._parent)return null;for(var e=this._parent.getParentPrototype();e;){var n=e.findChild("cda",function(e){return e.componentId===t.componentId});if(n)return n;e=e.getParentPrototype()}return null},n.prototype.getPropertyOrCreate=function(t){var e=this.findChild("prp",function(e){return e.name===t});return e||(e=this.componentClass._propertyTypesByName[t].createProperty(),this.addChild(e)),e},n.prototype.getProperty=function(t){return this.findChild("prp",function(e){return e.name===t})},n.prototype.setValue=function(t,e){return this.getPropertyOrCreate(t).value=e,this},n.prototype.getValue=function(t){var e=this.getProperty(t);if(e)return e.value;var n=this.getParentComponentData();return n?n.getValue(t):this.componentClass._propertyTypesByName[t].initialValue},n.prototype.createComponent=function(){var t=this.getInheritedProperties(),e={};t.forEach(function(t){e[t.name]=t.value});var n=ut.create(this.name,e);return n._componentId=this.componentId,n},n}(z);z.registerSerializable(X,"cda",function(t){return new X(t.n,t.id,t.cid)});var $=[d("name","No name",d.string)],tt=function(t){function e(){t.apply(this,arguments),this.previouslyCreatedEntity=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.addChild=function(e){"cda"!==e.threeLetterType||e.componentClass.allowMultiple||u(null===this.findChild("cda",function(t){return t.componentId===e.componentId}),"Can't have multiple "+e.name+" components. See Component.allowMultiple"),t.prototype.addChild.call(this,e)},e.prototype.getParentPrototype=function(){return this._parent&&"prt"===this._parent.threeLetterType?this._parent:null},e.prototype.getInheritedComponentDatas=function(t){function e(r,o){void 0===o&&(o=0);var i,a=r.getParentPrototype();return i=a?e(a,o+1):{},r.getChildren("cda").forEach(function(e){t&&!t(e)||(i[e.componentId]||(i[e.componentId]={ownComponentData:null,componentClass:e.componentClass,componentId:e.componentId,propertyHash:{},threeLetterType:"icd",generatedForPrototype:n}),0===o&&(i[e.componentId].ownComponentData=e),e.getChildren("prp").forEach(function(t){i[e.componentId].propertyHash[t.name]=0===o?t:t.clone(!0)}))}),i}void 0===t&&(t=null);var n=this,r=e(this),o=Object.keys(r).map(function(t){return r[t]});return o.forEach(function(t){t.properties=t.componentClass._propertyTypes.map(function(e){return t.propertyHash[e.name]?t.propertyHash[e.name]:e.createProperty({skipSerializableRegistering:!0})}),delete t.propertyHash}),o.forEach(function(t){t.componentId}),o.sort(function(t,e){return t.componentClass.componentName.localeCompare(e.componentClass.componentName)})},e.prototype.createAndAddPropertyForComponentData=function(t,e,n){var r=t.componentClass._propertyTypesByName[e];u(r,"Invalid propertyName",e,t);var o=this.findChild("cda",function(e){return e.componentId===t.componentId}),i=!1;o||(console.log("no component data. create one",this,t),o=new X(t.componentClass.componentName,!1,t.componentId),i=!0);var a=o.findChild("prp",function(t){return t.name===e});return a?(a.value=n,a):(a=r.createProperty({value:n}),o.addChild(a),i&&this.addChild(o),a)},e.prototype.findComponentDataByComponentId=function(t,e){void 0===e&&(e=!1);var n=this.findChild("cda",function(e){return e.componentId===t});if(n)return n;if(e){var r=this.getParentPrototype();if(r)return r.findComponentDataByComponentId(t,e)}return null},e.prototype.getOwnComponentDataOrInherit=function(t){var e=this.findComponentDataByComponentId(t,!1);if(!e){var n=this.findComponentDataByComponentId(t,!0);if(!n)return null;e=new X(n.name,!1,t),this.addChild(e)}return e},e.prototype.findOwnProperty=function(t,e){var n=this.findComponentDataByComponentId(t);return n?n.getProperty(e):null},e.prototype.createEntity=function(){var t=new Q,e=this.getInheritedComponentDatas(),n=e.map(ut.createWithInheritedComponentData);return t.addComponents(n),t.prototype=this,this.previouslyCreatedEntity=t,t},e.prototype.getValue=function(t,e){var n=this.findComponentDataByComponentId(t,!0);return n?n.getValue(e):void 0},e.prototype.countEntityPrototypes=function(t){var e=this;if(void 0===t&&(t=!1),"prt"!==this.threeLetterType)return 0;for(var n=0,r=nt.getChildren("lvl"),o=r.length-1;o>=0;o--)for(var i=r[o].getChildren("epr"),a=i.length-1;a>=0;a--)i[a].prototype===e&&n++;return t&&this.forEachChild("prt",function(t){return n+=t.countEntityPrototypes(!0)}),n},e.prototype.delete=function(){var e=this;return this._game=this._game||this.getRoot(),!!t.prototype.delete.call(this)&&("prt"===this.threeLetterType&&this._game.forEachChild("lvl",function(t){for(var n=t.getChildren("epr"),r=n.length-1;r>=0;r--)n[r].prototype===e&&t.deleteChild(n[r],r)}),this.previouslyCreatedEntity=null,!0)},e}(Z);Z.defineProperties(tt,$),tt.create=function(t){return(new tt).initWithPropertyValues({name:t})},z.registerSerializable(tt,"prt");var et=[d("name","No name",d.string)],nt=null,rt="undefined"!=typeof window,ot=function(t){function e(e){if(rt){if(nt)try{nt.delete()}catch(t){console.warn("Deleting old game failed",t)}nt=this}e?console.log("game import"):console.log("game created"),t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.initWithChildren=function(){t.prototype.initWithChildren.apply(this,arguments),a(L.addSerializableToTree,this)},e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(nt===this&&(nt=null),console.log("game.delete"),!0)},e}(Z);Z.defineProperties(ot,et),ot.prototype.isRoot=!0,z.registerSerializable(ot,"gam");var it;it=A?window.p2:require("../src/external/p2");var at=it,st={friction:.3,restitution:0,stiffness:1e6,relaxation:4,frictionStiffness:1e6,frictionRelaxation:4,surfaceVelocity:0},pt=null,lt={enableSleeping:!0},ct=function(t){function e(e){if(void 0===e&&(e=!1),A){if(pt)try{pt.delete()}catch(t){console.warn("Deleting old scene failed",t)}pt=this,this.canvas=document.querySelector("canvas.anotherCanvas"),this.context=this.canvas.getContext("2d")}this.level=null,this.components=new Map,this.animationFrameId=null,this.playing=!1,
this.time=0,t.call(this,e),a(L.addSerializableToTree,this),e?console.log("scene import"):console.log("scene created"),g(this,lt),this.draw()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.win=function(){var t=this;setTimeout(function(){i(t),t.reset(),nt.dispatch("levelCompleted")})},e.prototype.animFrame=function(t){if(this.animationFrameId=null,this._alive&&this.playing){var e=performance.now(),n=.001*e,r=n-this._prevUpdate;r>.05&&(r=.05),this._prevUpdate=n,this.time+=r,i(this),this.dispatch("onUpdate",r,this.time),_(this,r,e),this.draw(),this.requestAnimFrame()}},e.prototype.requestAnimFrame=function(){var t=this;this.animationFrameId=window.requestAnimationFrame(function(){return t.animFrame()})},e.prototype.draw=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.dispatch("onDraw",this.context)},e.prototype.isInInitialState=function(){return!this.playing&&0===this.time},e.prototype.reset=function(){this.resetting=!0,this.pause(),this.deleteChildren(),T(this),g(this,lt),this.level&&this.level.createScene(this),this.time=0,this.draw(),delete this.resetting},e.prototype.pause=function(){this.playing&&(this.playing=!1,this.animationFrameId&&window.cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)},e.prototype.play=function(){this.playing||(this._prevUpdate=.001*performance.now(),this.playing=!0,this.requestAnimFrame(),0===this.time&&this.dispatch("onStart"))},e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(T(this),pt===this&&(pt=null),console.log("scene.delete"),!0)},e.prototype.addComponent=function(t){var e=this.components.get(t.constructor.componentName);e||(e=new Set,this.components.set(t.constructor.componentName,e)),e.add(t)},e.prototype.removeComponent=function(t){var e=this.components.get(t.constructor.componentName);u(e),u(e.delete(t))},e.prototype.getComponents=function(t){return this.components.get(t)||new Set},e}(z);ct.prototype.isRoot=!0,z.registerSerializable(ct,"sce");var ht=new Map,ut=function(t){function e(e){void 0===e&&(e=!1),t.call(this,e),this._componentId=null,this.scene=pt,this.game=nt,this._listenRemoveFunctions=[],this.entity=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){return this._parent=null,this.entity=null,t.prototype.delete.call(this),!0},e.prototype._preInit=function(){var t=this;this.constructor.requirements.forEach(function(e){t[e]=t.entity.getComponent(e),u(t[e],t.constructor.componentName+" requires component "+e+" but it is not found")}),this.forEachChild("com",function(t){return t._preInit()}),["onUpdate","onDraw","onDrawHelper","onStart"].forEach(function(e){"function"==typeof t[e]&&t._listenRemoveFunctions.push(t.scene.listen(e,function(){for(var n=[],r=arguments.length;r--;)n[r]=arguments[r];return(o=t)[e].apply(o,n);var o}))}),"Transform"!==this.constructor.componentName&&this.scene.addComponent(this);try{"function"==typeof this.preInit&&this.preInit()}catch(t){console.error(this.entity,this.constructor.componentName,"preInit",t)}},e.prototype._init=function(){this.forEachChild("com",function(t){return t._init()});try{"function"==typeof this.init&&this.init()}catch(t){console.error(this.entity,this.constructor.componentName,"init",t)}},e.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(t){console.error(this.entity,this.constructor.componentName,"sleep",t)}"Transform"!==this.constructor.componentName&&this.scene.removeComponent(this),this.forEachChild("com",function(t){return t._sleep()}),this._listenRemoveFunctions.forEach(function(t){return t()}),this._listenRemoveFunctions.length=0},e.prototype.listenProperty=function(t,e,n){this._listenRemoveFunctions.push(t._properties[e].listen("change",n))},e.prototype.createComponentData=function(){var t=this,e=this.constructor.componentName,n=this.constructor._propertyTypes,r=new X(e),o=[];return n.forEach(function(e){o.push(e.createProperty({value:t[e.name]}))}),r.initWithChildren(o),r},e.prototype.toJSON=function(){return Object.assign(t.prototype.toJSON.call(this),{n:this.constructor.componentName,cid:this._componentId})},e}(Z);ut.create=function(t,e){void 0===e&&(e={});var n=ht.get(t);u(n);var r=new n;return r.initWithPropertyValues(e),r},ut.createWithInheritedComponentData=function(t){var e=new t.componentClass;e._componentId=t.componentId;var n=t.properties.map(function(t){return t.clone()});return e.initWithChildren(n),e},ut.reservedPropertyNames=new Set(["id","constructor","delete","children","entity","env","init","preInit","sleep","toJSON","fromJSON"]),ut.reservedPrototypeMembers=new Set(["id","children","entity","env","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentData","toJSON","fromJSON"]),ut.register=function(t){var e=t.name;void 0===e&&(e="");var n=t.description;void 0===n&&(n="");var r=t.category;void 0===r&&(r="Other");var o=t.icon;void 0===o&&(o="fa-puzzle-piece");var i=t.color;void 0===i&&(i="");var a=t.properties;void 0===a&&(a=[]);var s=t.requirements;void 0===s&&(s=["Transform"]);var p=t.children;void 0===p&&(p=[]);var l=t.parentClass;void 0===l&&(l=ut);var c=t.prototype;void 0===c&&(c={});var h=t.allowMultiple;void 0===h&&(h=!0);var d=t.requiesInitWhenEntityIsEdited;void 0===d&&(d=!1),u(e,"Component must have a name."),u(e[0]>="A"&&e[0]<="Z","Component name must start with capital letter."),u(!ht.has(e),"Duplicate component class "+e),Object.keys(c).forEach(function(t){ut.reservedPrototypeMembers.has(t)&&u(!1,"Component prototype can not have a reserved member: "+t)});var f=c.constructor,y=c.delete;delete c.constructor,delete c.delete;var m=function(t){function e(){t.apply(this,arguments),f&&f()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(y&&y(),!0)},e}(l);a.forEach(function(t){u(!ut.reservedPropertyNames.has(t.name),"Can not have property called "+t.name)}),Z.defineProperties(m,a),m.componentName=e,m.category=r,s.indexOf("Transform")<0&&s.push("Transform"),m.requirements=s,m.children=p,m.description=n,m.allowMultiple=h,m.icon=o;var v=e.split("").reduce(function(t,e){return t+e.charCodeAt(0)},0);return m.color=i||"hsla("+v%360+", 40%, 60%, 1)",c._name=e,Object.assign(m.prototype,c),ht.set(m.componentName,m),m},z.registerSerializable(ut,"com",function(t){var e=new(ht.get(t.n))(t.id);return e._componentId=t.cid||null,e});var dt=function(t){function e(e){void 0===e&&(e=!1),t.apply(this,arguments),this.prototype=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getTransform=function(){return this.findChild("cda",function(t){return"Transform"===t.name})},e.prototype.getParentPrototype=function(){return this.prototype},e.prototype.clone=function(){var t=this,n=new e;n.prototype=this.prototype;var r=n.id,o=[];return this.forEachChild(null,function(e){if("prp"===e.threeLetterType&&"name"===e.name){var n=new q({value:e.propertyType.type.clone(e.value),name:e.name,propertyType:t.propertyType,predefinedId:r+"_n"});o.push(n)}else if("cda"===e.threeLetterType&&"Transform"===e.name){var i=new X("Transform",r+"_t"),a=i.componentClass._propertyTypesByName.position.createProperty({value:e.findChild("prp",function(t){return"position"===t.name}).value,predefinedId:r+"_p"});i.addChild(a);var s=i.componentClass._propertyTypesByName.scale.createProperty({value:e.findChild("prp",function(t){return"scale"===t.name}).value,predefinedId:r+"_s"});i.addChild(s);var p=i.componentClass._propertyTypesByName.angle.createProperty({value:e.findChild("prp",function(t){return"angle"===t.name}).value,predefinedId:r+"_r"});i.addChild(p),o.push(i)}else"cda"===e.threeLetterType?o.push(e.clone({cloneComponentId:!0})):o.push(e.clone())}),n.initWithChildren(o),this._state|=z.STATE_CLONE,n},e.prototype.toJSON=function(){var t=this,e=this.getTransform(),n={id:this.id,p:this.prototype.id},r=[];this._children.forEach(function(t){r.push(t)});var o=(p=[]).concat.apply(p,r).filter(function(n){return n!==e&&n!==t._properties.name});o.length>0&&(n.c=o.map(function(t){return t.toJSON()}));var i=this.prototype,a=d.float().toJSON,s=function(t){"name"===t.name?i&&t.value===i.name||(n.n=t.value):"position"===t.name?(n.x=a(t.value.x),n.y=a(t.value.y)):"scale"===t.name?t.value.isEqualTo(new G(1,1))||(n.w=a(t.value.x),n.h=a(t.value.y)):"angle"===t.name&&0!==t.value&&(n.a=a(t.value))};return s(this._properties.name),e.getChildren("prp").forEach(s),n;var p},e.prototype.spawnEntityToScene=function(t){if(pt){t&&(this.getTransform().getPropertyOrCreate("position").value=t);var e=this.createEntity();pt.addChild(e)}},e}(tt);Object.defineProperty(dt.prototype,"position",{get:function(){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value},set:function(t){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value=t}}),dt.createFromPrototype=function(t,e){void 0===e&&(e=[]);var n=new dt;n.prototype=t;var r=n.id;u(!e.find(function(t){return"Transform"===t.name}),"Prototype (prt) can not have a Transform component");var o=new X("Transform",r+"_t");e.push(o);var i=o.componentClass._propertyTypesByName.position.createProperty({value:new G(0,0),predefinedId:r+"_p"});o.addChild(i);var a=o.componentClass._propertyTypesByName.scale.createProperty({value:new G(1,1),predefinedId:r+"_s"});o.addChild(a);var s=o.componentClass._propertyTypesByName.angle.createProperty({value:0,predefinedId:r+"_r"});o.addChild(s);var p=dt._propertyTypesByName.name.createProperty({value:t.name,predefinedId:r+"_n"});return n.initWithChildren([p].concat(e)),n},z.registerSerializable(dt,"epr",function(t){var e=new dt(t.id);e.prototype=n(t.p),u(e.prototype,"Prototype "+t.p+" not found");var r=t.id+"_n",o=t.id+"_t",i=t.id+"_p",a=t.id+"_s",s=t.id+"_r",p=tt._propertyTypesByName.name.createProperty({value:void 0===t.n?e.prototype.name:t.n,predefinedId:r}),l=new X("Transform",o),c=ht.get("Transform"),h=c._propertyTypesByName.position.createProperty({value:new G(t.x,t.y),predefinedId:i});l.addChild(h);var d=c._propertyTypesByName.scale.createProperty({value:new G(void 0===t.w?1:t.w,void 0===t.h?1:t.h),predefinedId:a});l.addChild(d);var f=c._propertyTypesByName.angle.createProperty({value:t.a||0,predefinedId:s});return l.addChild(f),e.initWithChildren([p,l]),e});var ft=[d("name","No name",d.string)],yt=function(t){function e(e){t.apply(this,arguments),e?console.log("level import"):console.log("level created")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.createScene=function(t){void 0===t&&(t=!1),t||new ct;var e=this.getChildren("epr").map(function(t){return t.createEntity()});return pt.addChildren(e),pt.level=this,pt},e}(Z);Z.defineProperties(yt,ft),z.registerSerializable(yt,"lvl"),ut.register({name:"Transform",category:"Core",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[d("position",new G(0,0),d.vector),d("scale",new G(1,1),d.vector),d("angle",0,d.float,d.float.modulo(0,2*Math.PI),d.flagDegreesInEditor)]}),ut.register({name:"TransformVariance",category:"Core",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[d("positionVariance",new G(0,0),d.vector),d("scaleVariance",new G(0,0),d.vector),d("angleVariance",0,d.float,d.float.range(0,Math.PI),d.flagDegreesInEditor)],prototype:{onStart:function(){this.positionVariance.isZero()||(this.Transform.position=this.Transform.position.add(this.positionVariance.clone().multiplyScalar(-1+2*Math.random()))),this.scaleVariance.isZero()||(this.Transform.scale=this.Transform.scale.add(this.scaleVariance.clone().multiplyScalar(-1+2*Math.random()))),this.angleVariance&&(this.Transform.angle+=this.angleVariance*(-1+2*Math.random()))}}});var mt=0;ut.register({name:"Test",category:"Core",properties:[d("name","Oh right",d.string),d("enum","yksi",d.enum,d.enum.values("yksi","kaksi","kolme","neljä")),d("topBarHelper",new G(0,1),d.vector),d("test"+ ++mt,mt,d.int),d("test"+ ++mt,!1,d.bool),d("test"+ ++mt,!0,d.bool)]});var vt={left:37,right:39,up:38,down:40,ctrl:17,appleLeft:91,appleRight:93,alt:18,shift:16,space:32,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,0:48,1:49,9:57,backspace:8,enter:13,esc:27},gt={},_t=[],Tt=[];"undefined"!=typeof window&&(window.onkeydown=function(t){var e=t.which||t.keyCode;"input"==document.activeElement.nodeName.toLowerCase()&&e!==vt.esc||(gt[e]=!0,_t.forEach(function(t){return t(e)}))},window.onkeyup=function(t){var e=t.which||t.keyCode;gt[e]=!1,Tt.forEach(function(t){return t(e)})}),ut.register({name:"Mover",properties:[d("change",new G(10,10),d.vector),d("userControlled",!1,d.bool),d("speed",1,d.float),d("rotationSpeed",0,d.float,"Degrees per second",d.flagDegreesInEditor)],prototype:{onUpdate:function(t,e){if(this.userControlled){if(!this.entity.localMaster)return;var n=0,r=0;I(vt.left)&&(n-=1),I(vt.right)&&(n+=1),I(vt.up)&&(r-=1),I(vt.down)&&(r+=1),n&&(this.Transform.position.x+=n*this.speed*t),r&&(this.Transform.position.y+=r*this.speed*t),(n||r)&&(this.Transform.position=this.Transform.position),n&&this.rotationSpeed&&(this.Transform.angle+=t*n*this.rotationSpeed)}else{var o=new G(t,0).rotate(e*this.speed).multiply(this.change);this.Transform.position.set(this.Transform.position).add(o),this.rotationSpeed&&(this.Transform.angle+=t*this.rotationSpeed)}}}}),ut.register({name:"Rect",icon:"fa-stop",allowMultiple:!0,properties:[d("size",new G(10,10),d.vector),d("style","red",d.string),d("randomStyle",!1,d.bool)],prototype:{init:function(){this.randomStyle&&(this.style="hsl("+(360*Math.random()|0)+", 100%, 40%)")},onDraw:function(t){var e=this.Transform.position.x-this.size.x/2*this.Transform.scale.x,n=this.Transform.position.y-this.size.y/2*this.Transform.scale.y,r=this.size.x*this.Transform.scale.x,o=this.size.y*this.Transform.scale.y;t.save(),t.fillStyle=this.style,t.translate(e+r/2,n+o/2),t.rotate(this.Transform.angle),t.fillRect(-r/2,-o/2,r,o),t.restore()}}}),ut.register({name:"Spawner",properties:[d("typeName","",d.string)],prototype:{onStart:function(){this.spawn()},onDrawHelper:function(t){this.Transform.position.x,this.Transform.scale.x,this.Transform.position.y,this.Transform.scale.y,this.Transform.scale.x,this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px FontAwesome",t.textAlign="center",t.fillText("",this.Transform.position.x+2,this.Transform.position.y),t.strokeText("",this.Transform.position.x+2,this.Transform.position.y),t.restore()},spawn:function(){var t=this,e=this.game.findChild("prt",function(e){return e.name===t.typeName});e&&dt.createFromPrototype(e).spawnEntityToScene(this.Transform.position)}}}),ut.register({name:"Trigger",allowMultiple:!0,properties:[d("trigger","playerComesNear",d.enum,d.enum.values("playerComesNear")),d("radius",40,d.float,d.float.range(0,1e3),d.visibleIf("trigger","playerComesNear")),d("action","win",d.enum,d.enum.values("win"))],prototype:{onDrawHelper:function(t){this.Transform.position.x,this.Transform.scale.x,this.Transform.position.y,this.Transform.scale.y,this.Transform.scale.x,this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px FontAwesome",t.textAlign="center",t.fillText("",this.Transform.position.x,this.Transform.position.y+15),t.strokeText("",this.Transform.position.x,this.Transform.position.y+15),t.restore()},preInit:function(){this.storeProp="__Trigger_"+this._componentId},onUpdate:function(){var t=this;if("playerComesNear"===this.trigger){var e=this.scene.getComponents("Mover"),n=[];e.forEach(function(t){return n.push(t.entity)});for(var r=this.radius*this.radius,o=this.Transform.position,i=0;i<n.length;++i)if(n[i].position.distanceSq(o)<r){if(!n[i][t.storeProp]&&t.launchTrigger(n[i])===!1)break;n[i][t.storeProp]=!0}else n[i][t.storeProp]=!1}},launchTrigger:function(t){return"win"===this.action&&(this.scene.win(),!1)}}});var Ct={dynamic:at.Body.DYNAMIC,kinematic:at.Body.KINEMATIC,static:at.Body.STATIC};ut.register({name:"Physics",icon:"fa-stop",allowMultiple:!1,properties:[d("type","dynamic",d.enum,d.enum.values("dynamic","static")),d("density",1,d.float,d.float.range(0,100),d.visibleIf("type","dynamic")),d("startStill",!1,d.bool,d.visibleIf("type","dynamic")),d("drag",.1,d.float,d.float.range(0,1),d.visibleIf("type","dynamic")),d("rotationalDrag",.1,d.float,d.float.range(0,1),d.visibleIf("type","dynamic")),d("bounciness",0,d.float,d.float.range(0,1)),d("friction",.1,d.float,d.float.range(0,1))],requirements:["Rect"],requiesInitWhenEntityIsEdited:!0,prototype:{init:function(){var t=this,e=function(e){return function(n){!t.updatingOthers&&t.body&&(e(n),"dynamic"===t.type&&t.body.wakeUp())}};this.listenProperty(this.Transform,"position",e(function(e){return t.body.position=e.toArray().map(function(t){return.02*t})})),this.listenProperty(this.Transform,"angle",e(function(e){return t.body.angle=e})),this.listenProperty(this,"density",e(function(e){t.body.setDensity(e)})),this.listenProperty(this,"friction",e(function(e){return t.updateMaterial()})),this.listenProperty(this,"drag",e(function(e){return t.body.damping=e})),this.listenProperty(this,"type",e(function(e){t.body.type=e[t.type],t.entity.sleep(),t.entity.wakeUp()})),this.listenProperty(this,"bounciness",e(function(e){return t.updateMaterial()})),this._isInTree&&this.createBody()},createBody:function(){this.body=new at.Body({type:Ct[this.type],position:[.02*this.Transform.position.x,.02*this.Transform.position.y],angle:this.Transform.angle,velocity:[0,0],angularVelocity:0,sleepTimeLimit:.5,sleepSpeedLimit:.3,damping:this.drag,angularDamping:this.rotationalDrag}),this.body.entity=this.entity;var t=new at.Box({width:.02*this.Rect.size.x,height:.02*this.Rect.size.y});this.body.addShape(t),this.updateMaterial(),"dynamic"===this.type&&this.body.setDensity(this.density),C(this.scene,this.body)},updateMaterial:function(){var t=w(this.scene,{friction:this.friction,restitution:this.bounciness});this.body.shapes.forEach(function(e){return e.material=t})},onStart:function(){this.startStill&&"dynamic"===this.type&&this.body.sleep()},setInTreeStatus:function(t){for(var e=arguments.length,n=Array(e);e--;)n[e]=arguments[e];return t&&this.createBody(),(r=ut.prototype.setInTreeStatus).call.apply(r,[this].concat(n));var r},onUpdate:function(){this.body&&this.body.sleepState!==at.Body.SLEEPING&&(this.updatingOthers=!0,this.Transform.position=G.fromArray(this.body.position).divideScalar(.02),this.Transform.angle=this.body.angle,this.updatingOthers=!1)},sleep:function(){this.body&&(S(this.scene,this.body),this.body=null)}}});var St,wt=!1,It=!1;A&&P(),N(),E(!0);var Et;window.addEventListener("load",function(){Et=document.querySelector("canvas.anotherCanvas"),x()}),window.addEventListener("resize",x)});
//# sourceMappingURL=explore.min.js.map
