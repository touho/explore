!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t,e){void 0===t&&(t="???"),void 0===e&&(e=16);for(var n=t,o=e-1;o>=0;--o)n+=lt[Math.random()*ct|0];return n}function e(t){d(void 0===dt[t.id],"Serializable id clash "+t.id),dt[t.id]=t}function n(t){return dt[t]||null}function o(t){if(!dt[t])throw new Error("Serializable not found!");delete dt[t]}function r(){vt=null}function i(){return vt}function a(t){t!==vt&&(vt=t,setTimeout(r))}function s(t,e){if(d(vt,"Change without origin!"),e.id){var n={type:t,reference:e,id:e.id,external:gt,origin:vt};t===ft.setPropertyValue?n.value=e._value:t===ft.move?n.parent=e._parent:t===ft.addSerializableToTree&&(n.parent=e._parent,delete n.id);var o=vt;_t.forEach(function(t){return t(n)}),vt!==o&&(vt=o)}}function p(t){if(a("external"),gt)return t();gt=!0,t(),gt=!1}function l(t){d("function"==typeof t),_t.push(t)}function c(t){if(t.packedChange)return t.packedChange;var e={};try{t.parent&&(t.parentId=t.parent.id),t.type===ft.addSerializableToTree?t.reference?t.value=t.reference.toJSON():t.value||d(!1,"invalid change of type addSerializableToTree",t):t.value&&(t.value=t.reference.propertyType.type.toJSON(t.value)),Object.keys(yt).forEach(function(n){if(t[n]){if("type"===n&&t[n]===ft.setPropertyValue)return;e[yt[n]]=t[n]}})}catch(t){console.log("PACK ERROR",t)}return e}function u(t){var e={packedChange:t};if(Object.keys(t).forEach(function(n){e[mt[n]]=t[n]}),e.type||(e.type=ft.setPropertyValue),e.type===ft.addSerializableToTree)e.id=e.value.id;else{if(e.reference=n(e.id),!e.reference)return console.error("received a change with unknown id",e,"packed:",t),null;e.id=e.reference.id}return e.parentId&&(e.parent=n(e.parentId)),e}function h(t){var e;p(function(){if(console.log("execute change",t.type,t.id||t.value),t.type===ft.setPropertyValue)t.reference.value=t.reference.propertyType.type.fromJSON(t.value);else if(t.type===ft.addSerializableToTree)if(t.parent){var n=ht.fromJSON(t.value);t.parent.addChild(n),"ent"===n.threeLetterType&&(n.localMaster=!1)}else{var o=ht.fromJSON(t.value);"sce"===o.threeLetterType&&(e=o)}else t.type===ft.deleteAllChildren?t.reference.deleteChildren():t.type===ft.deleteSerializable?t.reference.delete():t.type===ft.move&&t.reference.move(t.parent)}),e&&e.play()}function d(t,e){if(!t)throw console.log("Assert",e,(new Error).stack,"\norigin",i()),new Error(e)}function f(t,e,n){for(var o=[],r=arguments.length-3;r-- >0;)o[r]=arguments[r+3];n=n();var i=n.validators.default(),a="",s=[],p=null;return o.forEach(function(t,e){"string"==typeof t?a=t:t&&t.validate?i=t:t&&t.isFlag?s.push(t):t&&t.visibleIf?p=t:d(!1,"invalid parameter "+t+" idx "+e)}),new Tt(t,n,i,e,a,s,p)}function y(t,e){return void 0===e&&(e={}),e.isFlag=!0,e.type=t,e}function m(t){var e=t.name;void 0===e&&(e="");var n=t.validators;void 0===n&&(n={default:function(t){return t}});var o=t.toJSON;void 0===o&&(o=function(t){return t});var r=t.fromJSON;void 0===r&&(r=function(t){return t});var i=t.clone;void 0===i&&(i=function(t){return t}),d(e,"name missing from property type"),d("function"==typeof n.default,"default validator missing from property type: "+e),d("function"==typeof o,"invalid toJSON for property type: "+e),d("function"==typeof r,"invalid fromJSON for property type: "+e);var a={name:e,validators:n,toJSON:o,fromJSON:r,clone:i},s=function(){return a};return Object.keys(n).forEach(function(t){s[t]=v(t,n[t]),n[t]=s[t]}),s}function v(t,e){var n=function(){for(var n=arguments.length,o=Array(n);n--;)o[n]=arguments[n];var r=[].concat(o);return{validatorName:t,validatorParameters:r,validate:function(t){return e.apply(void 0,[t].concat(r))},parameters:r}};return n.validatorName=t,n.validate=e,n}function g(t){if(isNaN(t)||t===1/0||t===-(1/0))throw new Error("Invalid float: "+t)}function _(t){return Ut[t]||!1}function C(t){return Ht.push(t),function(){return Ht.splice(Ht.indexOf(t),1)}}function T(t,e){t.addEventListener("mousemove",function(n){for(var o=n.pageX,r=n.pageY,i=t;null!=i;)o-=i.offsetLeft,r-=i.offsetTop,i=i.offsetParent;t._mx=o,t._my=r,e(new bt(o,r))})}function w(t,e){t.addEventListener("mousedown",function(n){"number"==typeof t._mx?e(new bt(t._mx,t._my)):e()})}function b(t,e){t.addEventListener("mouseup",function(n){"number"==typeof t._mx?e(new bt(t._mx,t._my)):e()})}function E(t){void 0===t&&(t=!0),Kt=t}function S(t){return"sce"===t.reference.getRoot().threeLetterType}function I(t){for(var e=window.location.search.substring(1),n=e.split("&"),o=0;o<n.length;o++){var r=n[o].split("=");if(decodeURIComponent(r[0])==t)return decodeURIComponent(r[1])}console.log("Query variable %s not found",t)}function P(){if(!window.io)return setTimeout(P,10);Gt=io();var t=[],e={};l(function(n){if("external"!==n.origin&&Kt&&!S(n)){if(n.type===ft.setPropertyValue){var o=e[n.id];o&&t.splice(t.indexOf(o),1),e[n.id]=n}t.push(n)}}),setInterval(function(){if(0!==t.length){var n=t.map(c);t.length=0,e={},console.log("sending",n),Gt.emit("c",n)}},100),Gt.on("c",function(t){console.log("RECEIVE,",Kt),Kt&&(console.log("received",t),t.forEach(function(t){t=u(t),t&&h(t)}))}),Gt.on("requestGameId",function(t){Lt&&Gt.emit("gameId",Lt.id)});var n=Date.now();Gt.on("refreshIfOlderThan",function(t){n<t&&location.reload()}),Gt.on("gameData",function(t){console.log("gameData",t),p(function(){ht.fromJSON(t)}),localStorage.anotherGameId=t.id,history.replaceState({},null,"?gameId="+t.id),console.log("replaced with",""+location.origin+location.pathname+"?gameId="+t.id)}),setTimeout(function(){var t=I("gameId")||localStorage.anotherGameId;console.log("requestGameData",t),Gt.emit("requestGameData",t)},100)}function x(t,e,n){var o=t===window?t:t.el||t,r="Debug info "+(new Error).stack;o.dispatchEvent(new CustomEvent(e,{detail:{data:n,debug:r},bubbles:!0}))}function O(t,e,n){(t===window?t:t.el||t).addEventListener(e,function(t){t instanceof CustomEvent?n(t.detail.data,t.detail.debug):n(t)})}function N(t,e,n){var o=t.el||t,r=e.el||e;return re(r)&&(r=r.el),e===r&&r.__redom_view&&(e=r.__redom_view),e!==r&&(r.__redom_view=e),e.isMounted?e.remount&&e.remount():e.mount&&e.mount(),n?o.insertBefore(r,n.el||n):o.appendChild(r),e.isMounted?e.remounted&&e.remounted():(e.isMounted=!0,e.mounted&&e.mounted()),e}function k(t,e){var n=t.el||t,o=e.el||e;return e===o&&o.__redom_view&&(e=o.__redom_view),e.unmount&&e.unmount(),n.removeChild(o),e.isMounted=!1,e.unmounted&&e.unmounted(),e}function L(t,e,n){var o=t.el||t;if(arguments.length>2)o.style[e]=n;else if(te(e))o.setAttribute("style",e);else for(var r in e)L(o,r,e[r])}function D(t,e,n){var o=t.el||t,r=o instanceof window.SVGElement;if(arguments.length>2)"style"===e?L(o,n):r&&ne(n)?o[e]=n:!r&&(e in o||ne(n))?o[e]=n:o.setAttribute(e,n);else for(var i in e)D(o,i,e[i])}function A(t,e){for(var n=0;n<e.length;n++){var o=e[n];o&&("function"==typeof o?o(t):te(o)||ee(o)?t.appendChild(Xt(o)):oe(o)||oe(o.el)||re(o.el)?N(t,o):o.length?A(t,o):"object"==typeof o&&D(t,o))}}function M(t,e){for(var n,o,r,i=0,a=0,s=0;s<=t.length;s++){var p=t.charCodeAt(s);if(p===ae||p===se||!p){if(0===i)n=0===s?"div":p?t.substring(a,s):t;else{var l=t.substring(a,s);1===i?o=l:r?r+=" "+l:r=l}a=s+1,i=p===ae?1:2}}var c=e?ie.createElementNS(e,n):ie.createElement(n);return o&&(c.id=o),r&&(e?c.setAttribute("class",r):c.className=r),c}function j(t){for(var e=arguments,n=[],o=arguments.length-1;o-- >0;)n[o]=e[o+1];var r;if(te(t))r=le(t).cloneNode(!1);else{if(!oe(t))throw new Error("At least one argument required");r=t.cloneNode(!1)}return A(r,n),r}function B(t,e){if(void 0===e.length)return B(t,[e]);for(var n=t.el||t,o=n.firstChild,r=0;r<e.length;r++){var i=e[r];if(i){var a=i.el||i;re(a)&&(a=a.el),a!==o?N(t,i,o):o=o.nextSibling}}for(;o;){var s=o.nextSibling;k(t,o),o=s}}function z(t,e,n,o){return new R(t,e,n,o)}function R(t,e,n,o){this.__redom_list=!0,this.View=e,this.key=n,this.initData=o,this.views=[],this.el=V(t),n&&(this.lookup={})}function V(t){return te(t)?j(t):oe(t.el)?t.el:t}function J(){return We.selectedLevel&&Mt&&Mt.isInInitialState()}function F(t,e,n,o){var r=t.getComponents(e).filter(function(t){return t._componentId===n})[0];r&&(r._properties[o.name].value=o.value)}function W(t,e){function n(t){t.getChildren("prt").forEach(function(t){"function"==typeof e?e(t)&&(r.add(t),n(t)):(r.add(t),n(t))})}if(void 0===e&&(e=null),"epr"===t.threeLetterType){var o=t.previouslyCreatedEntity;return o&&o._alive?[o]:[]}var r=new Set;r.add(t),n(t);var i=Mt.level.getChildren("epr").filter(function(t){return r.has(t.prototype)&&(!e||e(t))}).map(function(t){return t.previouslyCreatedEntity}).filter(function(t){return t&&t._alive});return console.log("returning",i),i}function q(t){if(Mt&&Mt.level&&J()&&"editorSelection"!==t.type){var e=t.reference;d(e._isInTree);var n=e&&e.threeLetterType||null;if("gam"===t.reference.getRoot().threeLetterType)if(t.type===ft.addSerializableToTree){if("epr"===n){var o=e;o.findParent("lvl")===We.selectedLevel&&Mt.addChild(o.createEntity())}else if("cda"===n){var r,i=e.getParent();r="prt"===i.threeLetterType?W(i):[i.previouslyCreatedEntity].filter(function(t){return t&&t._alive}),r.forEach(function(t){var n=t.getComponents(e.name).find(function(t){return t._componentId===e.componentId});console.log("delete old component",n+""),n&&t.deleteComponent(n);var o=t.prototype,r=o.findComponentDataByComponentId(e.componentId,!0);if(console.log("new componentData",r+""),r){var i=r.createComponent();console.log("add new component",i+""),t.addComponents([i])}})}else if("prp"===n){var a=e,s=a.findParent("cda"),p=s.getParent(),l=W(p);l.forEach(function(t){var e=t.prototype,n=e.getValue(s.componentId,a.name);t.getComponents(s.name).find(function(t){return t._componentId===s.componentId})._properties[a.name].value=n})}}else if(t.type===ft.setPropertyValue){var c=e,u=c.findParent("cda");if(!u)return;var h=u.getParent();if("epr"===h.threeLetterType)h.previouslyCreatedEntity&&F(h.previouslyCreatedEntity,u.name,u.componentId,c);else{var f=W(h,function(t){return null===t.findOwnProperty(u.componentId,c.name)});f.forEach(function(t){F(t,u.name,u.componentId,c)})}}else if(t.type===ft.deleteAllChildren){if("cda"===n){var y=e,m=y.getParent(),v=W(m);v.forEach(function(t){var e=t.prototype,n=t.getComponents(y.name).find(function(t){return t._componentId===y.componentId});t.deleteComponent(n);var o=e.getInheritedComponentDatas(),r=o.find(function(t){return t.componentId===y.componentId});if(r){var i=Component.createWithInheritedComponentData(r);t.addComponents([i])}})}}else if(t.type===ft.deleteSerializable){if("epr"===n){var g=e;g.previouslyCreatedEntity&&g.previouslyCreatedEntity.delete()}else if("prp"===n){var _=e,C=_.findParent("cda"),T=C.getParent(),w=W(T);w.forEach(function(t){var e,n=t.prototype,o=n.findComponentDataByComponentId(C.componentId,!0),r=o.componentClass,i=o.getProperty(_.name);i===_?(o=o.getParentComponentData(),e=o?o.getValue(_.name):r._propertyTypesByName[_.name].initialValue):e=i.value;var a=t.getComponents(C.name).find(function(t){return t._componentId===C.componentId});a&&(a._properties[_.name].value=e)})}else if("cda"===n){var b=e,E=b.getParent(),S=W(E);console.log("pissaa",b,E,S),S.forEach(function(t){var e=t.prototype,n=t.getComponents(b.name).find(function(t){return t._componentId===b.componentId});t.deleteComponent(n);var o=e.getInheritedComponentDatas(function(t){return t!==b}),r=o.find(function(t){return t.componentId===b.componentId});if(r){var i=Component.createWithInheritedComponentData(r);t.addComponents([i])}})}}else t.type,ft.move}}function U(t){if(Mt)if(J()){var e=t.map(function(t){var e=t.prototype.clone();return e.position=t.position,e});We.selectedLevel.addChildren(e),Mt.addChildren(e.map(function(t){return t.createEntity()}))}else Mt.addChildren(t.map(function(t){return t.clone()}))}function H(t){var e=null,n=1/0,o=t.x-10,r=t.x+10,i=t.y-10,a=t.y+10;return Mt.getChildren("ent").filter(function(s){var p=s.position;if(p.x<o)return!1;if(p.x>r)return!1;if(p.y<i)return!1;if(p.y>a)return!1;var l=t.distanceSq(p);l<n&&(n=l,e=s)}),e}function G(t,e){var n=Math.min(t.x,e.x),o=Math.max(t.x,e.x),r=Math.min(t.y,e.y),i=Math.max(t.y,e.y);return Mt.getChildren("ent").filter(function(t){var e=t.position;return!(e.x<n)&&(!(e.x>o)&&(!(e.y<r)&&!(e.y>i)))})}function K(t){J()&&t.forEach(function(t){t.prototype.position=t.position})}function Y(t,e){0!==t.length&&t.forEach(function(t){var n=t.getComponent("Transform");n.position=n.position.add(e)})}function Q(t,e){0!==t.length&&t.forEach(function(t){t.position=e})}function X(t){J()&&t.forEach(function(t){return t.prototype.delete()}),t.forEach(function(t){return t.delete()})}function Z(t,e){if(t&&"ent"===t.threeLetterType&&e&&e.type===ft.setPropertyValue){if(J()){var n=t.prototype;console.log("before",n);var o=e.reference,r=o.getParent(),i=r._componentId,a=e.reference.name,s=n.getOwnComponentDataOrInherit(i);console.log("componentData",s);var p=s.getPropertyOrCreate(a);console.log("entityPrototypeProperty",p),p.value=o.value,console.log("after",n)}t.dispatch("changedInEditor",e)}}function tt(t){if(t){var e=t.position;Mt.context.strokeStyle="#53f8ff",Mt.context.lineWidth=1,Mt.context.beginPath(),Mt.context.arc(e.x,e.y,10,0,2*Math.PI,!1),Mt.context.stroke()}}function et(t,e,n){if(void 0===n&&(n=[]),t&&e){Mt.context.strokeStyle="#53f8ff",Mt.context.lineWidth=.2;n.forEach(function(t){var e=t.position;Mt.context.beginPath(),Mt.context.arc(e.x,e.y,10,0,2*Math.PI,!1),Mt.context.stroke()}),Mt.context.fillStyle="rgba(255, 255, 0, 0.2)",Mt.context.lineWidth=1,Mt.context.strokeStyle="yellow",Mt.context.fillRect(t.x,t.y,e.x-t.x,e.y-t.y),Mt.context.strokeRect(t.x,t.y,e.x-t.x,e.y-t.y)}}function nt(t){if(Array.isArray(t)&&0!==t.length){Mt.context.strokeStyle="#53f8ff",Mt.context.lineWidth=1.7,t.forEach(function(t){var e=t.position;Mt.context.beginPath(),Mt.context.arc(e.x,e.y,10,0,2*Math.PI,!1),Mt.context.stroke()})}}function ot(t){Mt.context.fillStyle="white";var e=3,n=e/2;t.forEach(function(t){var o=t.position;Mt.context.fillRect(o.x-n,o.y-n,e,e)}),Mt.context.fillStyle="black",e=2,n=e/2,t.forEach(function(t){var o=t.position;Mt.context.fillRect(o.x-n,o.y-n,e,e)})}function rt(t){return $.contains(document.documentElement,t)}function it(t){for(var e=t.length-1;e>=0;--e)t[e]._alive===!1&&t.splice(e,1)}function at(){if(!Ue)try{Ue=JSON.parse(localStorage.anotherOptions)}catch(t){Ue={}}}function st(t,e){at(),Ue[t]=e;try{localStorage.anotherOptions=JSON.stringify(Ue)}catch(t){}}function pt(t){return at(),Ue[t]}var lt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",ct=lt.length,ut=new Map,ht=function n(o,r){if(void 0===o&&(o=!1),void 0===r&&(r=!1),d(this.threeLetterType,"Forgot to Serializable.registerSerializable your class?"),this._children=new Map,this._listeners=[],this._isInTree=this.isRoot,this._state|=n.STATE_CONSTRUCTOR,!r){if(o?(this._state|=n.STATE_PREDEFINEDID,this.id=o):this.id=t(this.threeLetterType),this.id.startsWith("?"))throw new Error("?");e(this)}};ht.prototype.delete=function(){return this._parent?(this._parent.deleteChild(this),!1):(this.deleteChildren(),this._alive=!1,this._isInTree=!1,this._listeners.length=0,o(this.id),this._state|=ht.STATE_DESTROY,!0)},ht.prototype.deleteChildren=function(){this._children.size&&(this._children.forEach(function(t){t.forEach(function(t){t._parent=null,t.delete()})}),this._children.clear(),this._parent&&s(ft.deleteAllChildren,this))},ht.prototype.initWithChildren=function(t){return void 0===t&&(t=[]),d(!(this._state&ht.STATE_INIT),"init already done"),this._state|=ht.STATE_INIT,t.length>0&&this.addChildren(t),this},ht.prototype.addChildren=function(t){for(var e=this,n=0;n<t.length;n++)e.addChild(t[n]);return this},ht.prototype.addChild=function(t){return this._addChild(t),this._state|=ht.STATE_ADDCHILD,this._isInTree&&s(ft.addSerializableToTree,t),this},ht.prototype._addChild=function(t){d(null===t._parent);var e=this._children.get(t.threeLetterType);return void 0===e&&(e=[],this._children.set(t.threeLetterType,e)),e.push(t),t._parent=this,t._state|=ht.STATE_ADDPARENT,t.setInTreeStatus(this._isInTree),this},ht.prototype.findChild=function(t,e){var n=this._children.get(t);return n?e?n.find(e)||null:n[0]:null},ht.prototype.findParent=function(t,e){void 0===e&&(e=null);for(var n=this;n;){if(n.threeLetterType===t&&(!e||e(n)))return n;n=n._parent}return null},ht.prototype.getRoot=function(){for(var t=this;t._parent;)t=t._parent;return t},ht.prototype.deleteChild=function(t,e){return s(ft.deleteSerializable,t),this._detachChild(t,e),t.delete(),this},ht.prototype._detachChild=function(t,e){void 0===e&&(e=0);var n=this._children.get(t.threeLetterType);return d(n,"child not found"),n[e]!==t&&(e=n.indexOf(t)),d(e>=0,"child not found"),n.splice(e,1),0===n.length&&this._children.delete(t.threeLetterType),t._parent=null,t.setInTreeStatus(!1),this},ht.prototype.forEachChild=function(t,e,n){function o(o){o.forEach(function(o){e(o),n&&o.forEachChild(t,e,!0)})}return void 0===t&&(t=null),void 0===n&&(n=!1),t?o(this._children.get(t)||[]):this._children.forEach(o),this},ht.prototype.move=function(t){return t._addChild(this._detach()),s(ft.move,this),this},ht.prototype._detach=function(){return this._parent&&this._parent._detachChild(this),this},ht.prototype.getParent=function(){return this._parent||null},ht.prototype.getChildren=function(t){return this._children.get(t)||[]},ht.prototype.toJSON=function(){var t=this,e={id:this.id};if(this._children.size>0){var n=[];Array.from(this._children.keys()).sort(function(t,e){return"prt"===t?-1:1}).forEach(function(e){return n.push(t._children.get(e))}),e.c=(o=[]).concat.apply(o,n).map(function(t){return t.toJSON()})}return e;var o},ht.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},ht.prototype.clone=function(){var t=new this.constructor,e=[];return this.forEachChild(null,function(t){e.push(t.clone())}),t.initWithChildren(e),this._state|=ht.STATE_CLONE,t},ht.prototype.listen=function(t,e){var n=this;return this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]),this._listeners[t].unshift(e),function(){var o=n._listeners[t].indexOf(e);n._listeners[t].splice(o,1)}},ht.prototype.dispatch=function(t){for(var e=this,n=[],o=arguments.length-1;o-- >0;)n[o]=arguments[o+1];if(this._listeners.hasOwnProperty(t))for(var r=this._listeners[t].length-1;r>=0;--r)try{e._listeners[t][r].apply(null,n)}catch(n){console.error("Event "+t+" listener crashed.",e._listeners[t][r],n)}},ht.prototype.hasDescendant=function(t){var e=this;if(!t)return!1;for(var n=t._parent;n;){if(n===e)return!0;n=n._parent}return!1},ht.prototype.setInTreeStatus=function(t){this._isInTree!==t&&(this._isInTree=t,this._children.forEach(function(e){e.forEach(function(e){return e.setInTreeStatus(t)})}))},ht.fromJSON=function t(e){d("string"==typeof e.id&&e.id.length>5,"Invalid id.");var t=ut.get(e.id.substring(0,3));d(t);var n;try{n=t(e)}catch(t){if(window.force,!window.force)throw new Error;return null}var o=e.c?e.c.map(function(t){return ht.fromJSON(t)}).filter(Boolean):[];return n._state&ht.STATE_INIT?n.addChildren(o):n.initWithChildren(o),n._state|=ht.STATE_FROMJSON,n},ht.registerSerializable=function(t,e,n){void 0===n&&(n=null),t.prototype.threeLetterType=e,d("string"==typeof e&&3===e.length),n||(n=function(e){return new t(e.id)}),ut.set(e,n)},ht.prototype._parent=null,ht.prototype._alive=!0,ht.prototype._state=0,ht.STATE_CONSTRUCTOR=1,ht.STATE_INIT=2,ht.STATE_ADDCHILD=4,ht.STATE_ADDPARENT=8,ht.STATE_CLONE=16,ht.STATE_DESTROY=32,ht.STATE_FROMJSON=64,ht.STATE_PREDEFINEDID=128,ht.prototype.isRoot=!1,Object.defineProperty(ht.prototype,"debug",{get:function(){var t=this,e=this.threeLetterType;this._children.forEach(function(n,o){e+="|",e+="prp"===o?t.getChildren("prp").map(function(t){return t.name+"="+t._value}).join(", "):o+"("+n.length+")"}),e+="|state: ";var n=[],o=function(e,o){t._state&e&&n.push(o)};return o(ht.STATE_CONSTRUCTOR,"constructor"),o(ht.STATE_INIT,"init"),o(ht.STATE_ADDCHILD,"add child"),o(ht.STATE_ADDPARENT,"add parent"),o(ht.STATE_CLONE,"clone"),o(ht.STATE_DESTROY,"destroy"),o(ht.STATE_FROMJSON,"from json"),o(ht.STATE_PREDEFINEDID,"predefined id"),e+=n.join(", ")}}),Object.defineProperty(ht.prototype,"debugChildren",{get:function(){function t(t){return new function(){}}var e=[];this._children.forEach(function(t,n){e=e.concat(t)});var n=[];return e.forEach(function(e){var o=t(e.threeLetterType);o.debug=e.debug,o.ref=e;var r=e.debugChildArray;r&&r.length>0&&(o.children=r),n.push(o)}),n}});var dt={},ft={addSerializableToTree:"a",setPropertyValue:"s",deleteSerializable:"d",move:"m",deleteAllChildren:"c"},yt={id:"i",type:"t",value:"v",parentId:"p"},mt={};Object.keys(yt).forEach(function(t){mt[yt[t]]=t});var vt,gt=!1,_t=[],Ct=function(t){function e(e){var n=e.value,o=e.predefinedId,r=e.name,i=e.propertyType,a=e.skipSerializableRegistering;void 0===a&&(a=!1),d(r,"Property without a name can not exist"),t.call(this,o,a),this._initialValue=n,i?this.setPropertyType(i):(this.name=r,this._initialValueIsJSON=!0)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPropertyType=function(t){this.propertyType=t;try{void 0!==this._initialValue?this.value=this._initialValueIsJSON?t.type.fromJSON(this._initialValue):this._initialValue:this.value=t.initialValue}catch(e){console.log("Invalid value",e,t,this),this.value=t.initialValue}this.name=t.name},e.prototype.clone=function(t){return void 0===t&&(t=!1),new e({value:this.propertyType.type.clone(this.value),name:this.name,propertyType:this.propertyType,skipSerializableRegistering:t})},e.prototype.toJSON=function(){return Object.assign(t.prototype.toJSON.call(this),{v:this.type.toJSON(this.value),n:this.propertyType.name})},e}(ht);Ct.prototype.propertyType=null,Object.defineProperty(Ct.prototype,"type",{get:function(){return this.propertyType.type}}),Object.defineProperty(Ct.prototype,"value",{set:function(t){this._value=this.propertyType.validator.validate(t),this.dispatch("change",this._value),this._isInTree&&s(ft.setPropertyValue,this)},get:function(){return this._value}}),ht.registerSerializable(Ct,"prp",function(t){return new Ct({value:t.v,predefinedId:t.id,name:t.n})}),Object.defineProperty(Ct.prototype,"debug",{get:function(){return"prp "+this.name+"="+this.value}});var Tt=function(t,e,n,o,r,i,a){var s=this;void 0===i&&(i=[]),d("string"==typeof t),d(t[0]>="a"&&t[0]<="z","Name of a property must start with lower case letter."),d(e&&"string"==typeof e.name),d(n&&"function"==typeof n.validate),this.name=t,this.type=e,this.validator=n,this.initialValue=o,this.description=r,this.visibleIf=a,this.flags={},i.forEach(function(t){return s.flags[t.type]=t})};Tt.prototype.getFlag=function(t){return this.flags[t.type]},Tt.prototype.createProperty=function(t){void 0===t&&(t={});var e=t.value,n=t.predefinedId,o=t.skipSerializableRegistering;return void 0===o&&(o=!1),new Ct({propertyType:this,value:e,predefinedId:n,name:this.name,skipSerializableRegistering:o})};var wt=f;wt.visibleIf=function(t,e){return d("string"==typeof t&&t.length),d(void 0!==e),{visibleIf:!0,propertyName:t,value:e}},f.flagDegreesInEditor=y("degreesInEditor");var bt=function(t,e){this.x=t||0,this.y=e||0};bt.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},bt.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},bt.prototype.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},bt.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this},bt.prototype.divide=function(t){return this.x/=t.x,this.y/=t.y,this},bt.prototype.divideScalar=function(t){return this.x/=t,this.y/=t,this},bt.prototype.dot=function(t){return this.x*t.x+this.y*t.y},bt.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},bt.prototype.lengthSq=function(){return this.x*this.x+this.y*this.y},bt.prototype.setLength=function(t){var e=this.length();return 0===e?(this.x=t,this.y=0):this.multiplyScalar(t/e),this},bt.prototype.getProjectionOn=function(t){var e=t.length();return 0===e?this.clone():t.clone().multiplyScalar(this.dot(t)/(e*e))},bt.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},bt.prototype.distanceSq=function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n},bt.prototype.normalize=function(){return this.setLength(1)},bt.prototype.horizontalAngle=function(){return Math.atan2(this.y,this.x)},bt.prototype.verticalAngle=function(){return Math.atan2(this.x,this.y)},bt.prototype.rotate=function(t){var e=this.x*Math.cos(t)-this.y*Math.sin(t);return this.y=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=e,this},bt.prototype.rotateTo=function(t){return this.rotate(t-this.verticalAngle())},bt.prototype.isEqualTo=function(t){return this.x===t.x&&this.y===t.y},bt.prototype.clone=function(){return new bt(this.x,this.y)},bt.prototype.set=function(t){return this.x=t.x,this.y=t.y,this},bt.prototype.toString=function(){return"["+this.x+", "+this.y+"]"},bt.fromObject=function(t){return new bt(t.x,t.y)};var Et=Math.pow(10,4);wt.float=m({name:"float",validators:{default:function(t){return t=parseFloat(t),g(t),t},range:function(t,e,n){return t=parseFloat(t),g(t),Math.min(n,Math.max(e,t))},modulo:function(t,e,n){t=parseFloat(t),g(t);var o=n-e;return t<e?t+=(((e-t)/o|0)+1)*o:t>n-1e-7&&(t-=(((t-n)/o|0)+1)*o),t}},toJSON:function(t){return Math.round(t*Et)/Et},fromJSON:function(t){return t}}),wt.int=m({name:"int",validators:{default:function(t){return t=parseInt(t),g(t),t},range:function(t,e,n){return t=parseInt(t),g(t),Math.min(n,Math.max(e,t))}},toJSON:function(t){return t},fromJSON:function(t){return t}}),wt.vector=m({name:"vector",validators:{default:function(t){if(!(t instanceof bt))throw new Error;return t=t.clone(),t.x=parseFloat(t.x),t.y=parseFloat(t.y),g(t.x),g(t.y),t}},toJSON:function(t){return{x:Math.round(t.x*Et)/Et,y:Math.round(t.y*Et)/Et}},fromJSON:function(t){return bt.fromObject(t)},clone:function(t){return t.clone()}}),wt.string=m({name:"string",validators:{default:function(t){return t?String(t):""}},toJSON:function(t){return t},fromJSON:function(t){return t}}),wt.bool=m({name:"bool",validators:{default:function(t){if("boolean"!=typeof t)throw new Error;return t}},toJSON:function(t){return t?1:0},fromJSON:function(t){return!!t}}),wt.enum=m({name:"enum",validators:{default:function(){d(!1,"also specify enum values with Prop.enum.values('value1', 'value2', ...)")},values:function t(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];if(!Array.isArray(t))throw new Error;if("string"!=typeof e)throw new Error("val should be string");if(t.indexOf(e)<0)throw new Error("value "+e+" not in enum: ["+t+"]");return e}},toJSON:function(t){return t},fromJSON:function(t){return t}});var St=function(t){function e(e){void 0===e&&(e=!1),d(Array.isArray(this.constructor._propertyTypes),"call PropertyOwner.defineProperties after class definition"),t.call(this,e),this._properties={}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.initWithPropertyValues=function(t){var e=this;void 0===t&&(t={});var n=[];return Object.keys(t).forEach(function(o){var r=e.constructor._propertyTypesByName[o];d(r,"Invalid property "+o),n.push(r.createProperty({value:t[o]}))}),this.initWithChildren(n),this},e.prototype.initWithChildren=function(e){var n=this;void 0===e&&(e=[]),d(!(this._state&t.STATE_INIT),"init already done"),this._state|=t.STATE_INIT;var o=[],r=[];e.forEach(function(t){"prp"===t.threeLetterType?o.push(t):r.push(t)}),t.prototype.addChildren.call(this,r);var i=0;o.filter(function(t){return!t.propertyType}).forEach(function(t){if(!n.constructor._propertyTypesByName[t.name])return console.log("Property of that name not defined",n.id,t.name,n),i++,void(t.isInvalid=!0);t.setPropertyType(n.constructor._propertyTypesByName[t.name])}),i&&(o=o.filter(function(t){return!t.isInvalid}));var a={};o.forEach(function(t){return a[t.name]=t}),this.constructor._propertyTypes.forEach(function(t){a[t.name]||o.push(t.createProperty())}),t.prototype.addChildren.call(this,o)},e.prototype.addChild=function(e){if(d(this._state&t.STATE_INIT,this.constructor.componentName||this.constructor+" requires that initWithChildren will be called before addChild"),t.prototype.addChild.call(this,e),"prp"===e.threeLetterType){if(!e.propertyType){if(!this.constructor._propertyTypesByName[e.name])return void console.log("Property of that name not defined",this.id,e,this);e.setPropertyType(this.constructor._propertyTypesByName[e.name])}d(void 0===this._properties[e.propertyType.name],"Property already added"),this._properties[e.propertyType.name]=e}},e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(this._properties={},!0)},e.prototype.deleteChild=function(e,n){d("prp"!==e.threeLetterType,"Can not delete just one Property child."),t.prototype.deleteChild.call(this,e,n)},e}(ht);St.defineProperties=function(t,e){t._propertyTypes=e,t._propertyTypesByName={},e.forEach(function(e){d(void 0===t.prototype[e.name],"Property name "+e.name+" clashes"),t._propertyTypesByName[e.name]=e,Object.defineProperty(t.prototype,e.name,{get:function(){return this._properties[e.name].value},set:function(t){this._properties[e.name].value=t}})})};var It="entity is already dead",Pt=function(t){function e(e){void 0===e&&(e=!1),t.call(this,e),this.components=new Map,this.sleeping=!1,this.prototype=null,this.localMaster=!0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getComponent=function(t){d(this._alive,It);var e=this.components.get(t);return void 0!==e?e[0]:null},e.prototype.getComponents=function(t){return d(this._alive,It),this.components.get(t)||[]},e.prototype.getListOfAllComponents=function(){var t=[];return this.components.forEach(function(e,n){t.push.apply(t,e)}),t},e.prototype.clone=function(){var t=new e;t.prototype=this.prototype,t.sleeping=this.sleeping;var n=[];return this.components.forEach(function(t,e){n.push.apply(n,t.map(function(t){return t.clone()}))}),t.addComponents(n),t},e.prototype.addComponents=function(t){var n=this;d(this._alive,It),d(Array.isArray(t),"Parameter is not an array.");for(var o=0;o<t.length;o++){(n.components.get(t[o]._name)||n.components.set(t[o]._name,[]).get(t[o]._name)).push(t[o]),t[o].entity=n,t[o]._parent=n}return this.sleeping||e.initComponents(t),this},e.initComponents=function(t){for(var e=0;e<t.length;e++)t[e]._preInit();for(var n=0;n<t.length;n++)t[n]._init()},e.makeComponentsSleep=function(t){for(var e=0;e<t.length;e++)t[e]._sleep()},e.deleteComponents=function(t){for(var e=0;e<t.length;e++)t[e].delete()},e.prototype.sleep=function(){return d(this._alive,It),!this.sleeping&&(this.components.forEach(function(t,n){return e.makeComponentsSleep(t)}),this.sleeping=!0,!0)},e.prototype.wakeUp=function(){return d(this._alive,It),!!this.sleeping&&(this.components.forEach(function(t,n){return e.initComponents(t)}),this.sleeping=!1,!0)},e.prototype.delete=function(){return d(this._alive,It),this.sleep(),!!t.prototype.delete.call(this)&&(this.components.forEach(function(t,n){return e.deleteComponents(t)}),this.components.clear(),!0)},e.prototype.deleteComponent=function(t){var e=this.getComponents(t.constructor.componentName),n=e.indexOf(t);return d(n>=0),this.sleeping||t._sleep(),t.delete(),e.splice(n,1),this},e.prototype.setInTreeStatus=function(t){this._isInTree!==t&&(this._isInTree=t,this.components.forEach(function(e,n){e.forEach(function(e){return e.setInTreeStatus(t)})}))},e.prototype.toJSON=function(){d(this._alive,It);var e=[];return this.components.forEach(function(t){t.forEach(function(t){e.push(t.toJSON())})}),Object.assign(t.prototype.toJSON.call(this),{comp:e,proto:this.prototype.id})},e}(ht);Object.defineProperty(Pt.prototype,"position",{get:function(){return this.getComponent("Transform").position},set:function(t){this.getComponent("Transform").position=t}}),ht.registerSerializable(Pt,"ent",function(t){console.log("creating entity from json",t)
;var e=new Pt(t.id);return e.prototype=getSerializable(t.proto),console.log("created entity from json",e),t.comp&&e.addComponents(t.comp.map(ht.fromJSON)),e});var xt=function(e){function n(n,o,r){void 0===o&&(o=!1),void 0===r&&(r=!1),this.name=n,this.componentClass=zt.get(this.name),d(this.componentClass,"Component class not defined: "+n),e.call(this,o),this.componentClass.allowMultiple||(r="_"+n),this.componentId=r||t("cid",10)}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.addChild=function(t){if("prp"===t.threeLetterType&&!t.propertyType){if(!this.componentClass._propertyTypesByName[t.name])return void console.log("Property of that name not defined",this.id,t,this);t.setPropertyType(this.componentClass._propertyTypesByName[t.name])}return e.prototype.addChild.call(this,t),this},n.prototype.clone=function(){var t=new n(this.name),o=[];return this.forEachChild(null,function(t){o.push(t.clone())}),t.initWithChildren(o),this._state|=e.STATE_CLONE,t},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{cid:this.componentId,n:this.name})},n.prototype.getInheritedProperties=function(t){void 0===t&&(t=0);var e={},n=this.getParentComponentData();return n&&n.getInheritedProperties(t+1).forEach(function(t){return e[t.name]=t}),this.getChildren("prp").forEach(function(n){e[n.name]=0===t?n:n.clone(!0)}),0===t?this.componentClass._propertyTypes.map(function(t){return e[t.name]||t.createProperty({skipSerializableRegistering:!0})}):Object.keys(e).map(function(t){return e[t]})},n.prototype.getParentComponentData=function(){var t=this;if(!this._parent)return null;for(var e=this._parent.getParentPrototype();e;){var n=e.findChild("cda",function(e){return e.componentId===t.componentId});if(n)return n;e=e.getParentPrototype()}return null},n.prototype.getPropertyOrCreate=function(t){var e=this.findChild("prp",function(e){return e.name===t});return e||(e=this.componentClass._propertyTypesByName[t].createProperty(),this.addChild(e)),e},n.prototype.getProperty=function(t){return this.findChild("prp",function(e){return e.name===t})},n.prototype.setValue=function(t,e){return this.getPropertyOrCreate(t).value=e,this},n.prototype.getValue=function(t){var e=this.getProperty(t);if(e)return e.value;var n=this.getParentComponentData();return n?n.getValue(t):this.componentClass._propertyTypesByName[t].initialValue},n.prototype.createComponent=function(){var t=this.getInheritedProperties(),e={};t.forEach(function(t){e[t.name]=t.value});var n=Rt.create(this.name,e);return n._componentId=this.componentId,n},n}(ht);ht.registerSerializable(xt,"cda",function(t){return new xt(t.n,t.id,t.cid)});var Ot=[f("name","No name",f.string)],Nt=function(t){function e(){t.apply(this,arguments),this.previouslyCreatedEntity=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.addChild=function(e){"cda"!==e.threeLetterType||e.componentClass.allowMultiple||d(null===this.findChild("cda",function(t){return t.componentId===e.componentId}),"Can't have multiple "+e.name+" components. See Component.allowMultiple"),t.prototype.addChild.call(this,e)},e.prototype.getParentPrototype=function(){return this._parent&&"prt"===this._parent.threeLetterType?this._parent:null},e.prototype.getInheritedComponentDatas=function(t){function e(o,r){void 0===r&&(r=0);var i,a=o.getParentPrototype();return i=a?e(a,r+1):{},o.getChildren("cda").forEach(function(e){t&&!t(e)||(i[e.componentId]||(i[e.componentId]={ownComponentData:null,componentClass:e.componentClass,componentId:e.componentId,propertyHash:{},threeLetterType:"icd",generatedForPrototype:n}),0===r&&(i[e.componentId].ownComponentData=e),e.getChildren("prp").forEach(function(t){i[e.componentId].propertyHash[t.name]=0===r?t:t.clone(!0)}))}),i}void 0===t&&(t=null);var n=this,o=e(this),r=Object.keys(o).map(function(t){return o[t]});return r.forEach(function(t){t.properties=t.componentClass._propertyTypes.map(function(e){return t.propertyHash[e.name]?t.propertyHash[e.name]:e.createProperty({skipSerializableRegistering:!0})}),delete t.propertyHash}),r.forEach(function(t){t.componentId}),r.sort(function(t,e){return t.componentClass.componentName.localeCompare(e.componentClass.componentName)})},e.prototype.createAndAddPropertyForComponentData=function(t,e,n){var o=t.componentClass._propertyTypesByName[e];d(o,"Invalid propertyName",e,t);var r=this.findChild("cda",function(e){return e.componentId===t.componentId}),i=!1;r||(console.log("no component data. create one",this,t),r=new xt(t.componentClass.componentName,!1,t.componentId),i=!0);var a=r.findChild("prp",function(t){return t.name===e});return a?(a.value=n,a):(a=o.createProperty({value:n}),r.addChild(a),i&&this.addChild(r),a)},e.prototype.findComponentDataByComponentId=function(t,e){void 0===e&&(e=!1);var n=this.findChild("cda",function(e){return e.componentId===t});if(n)return n;if(e){var o=this.getParentPrototype();if(o)return o.findComponentDataByComponentId(t,e)}return null},e.prototype.getOwnComponentDataOrInherit=function(t){var e=this.findComponentDataByComponentId(t,!1);if(!e){var n=this.findComponentDataByComponentId(t,!0);if(!n)return null;e=new xt(n.name,!1,t),this.addChild(e)}return e},e.prototype.findOwnProperty=function(t,e){var n=this.findComponentDataByComponentId(t);return n?n.getProperty(e):null},e.prototype.createEntity=function(){var t=new Pt,e=this.getInheritedComponentDatas(),n=e.map(Component.createWithInheritedComponentData);return t.addComponents(n),t.prototype=this,this.previouslyCreatedEntity=t,t},e.prototype.getValue=function(t,e){var n=this.findComponentDataByComponentId(t,!0);return n?n.getValue(e):void 0},e.prototype.countEntityPrototypes=function(t){var e=this;if(void 0===t&&(t=!1),"prt"!==this.threeLetterType)return 0;for(var n=0,o=Lt.getChildren("lvl"),r=o.length-1;r>=0;r--)for(var i=o[r].getChildren("epr"),a=i.length-1;a>=0;a--)i[a].prototype===e&&n++;return t&&this.forEachChild("prt",function(t){return n+=t.countEntityPrototypes(!0)}),n},e.prototype.delete=function(){var e=this;return this._game=this._game||this.getRoot(),!!t.prototype.delete.call(this)&&("prt"===this.threeLetterType&&this._game.forEachChild("lvl",function(t){for(var n=t.getChildren("epr"),o=n.length-1;o>=0;o--)n[o].prototype===e&&t.deleteChild(n[o],o)}),this.previouslyCreatedEntity=null,!0)},e}(St);St.defineProperties(Nt,Ot),Nt.create=function(t){return(new Nt).initWithPropertyValues({name:t})},ht.registerSerializable(Nt,"prt");var kt=[f("name","No name",f.string)],Lt=null,Dt="undefined"!=typeof window,At=function(t){function e(e){if(Dt){if(Lt)try{Lt.delete()}catch(t){console.warn("Deleting old game failed",t)}Lt=this}e?console.log("game import"):console.log("game created"),t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.initWithChildren=function(){t.prototype.initWithChildren.apply(this,arguments),s(ft.addSerializableToTree,this)},e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(Lt===this&&(Lt=null),console.log("game.delete"),!0)},e}(St);St.defineProperties(At,kt),At.prototype.isRoot=!0,ht.registerSerializable(At,"gam");var Mt=null,jt="undefined"!=typeof window,Bt=function(t){function e(e){if(void 0===e&&(e=!1),jt){if(Mt)try{Mt.delete()}catch(t){console.warn("Deleting old scene failed",t)}Mt=this,this.canvas=document.querySelector("canvas.anotherCanvas"),this.context=this.canvas.getContext("2d")}this.level=null,this.components=new Map,this.animationFrameId=null,this.playing=!1,this.time=0,t.call(this,e),s(ft.addSerializableToTree,this),e?console.log("scene import"):console.log("scene created"),this.draw()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.win=function(){var t=this;setTimeout(function(){a(t),t.reset(),Lt.dispatch("levelCompleted")})},e.prototype.animFrame=function(t){if(this.animationFrameId=null,this._alive&&this.playing){var e=.001*performance.now(),n=e-this._prevUpdate;n>.1&&(n=.1),this._prevUpdate=e,this.time+=n,a(this),this.dispatch("onUpdate",n,this.time),this.draw(),this.requestAnimFrame()}},e.prototype.requestAnimFrame=function(){var t=this;this.animationFrameId=window.requestAnimationFrame(function(){return t.animFrame()})},e.prototype.draw=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.dispatch("onDraw",this.context)},e.prototype.isInInitialState=function(){return!this.playing&&0===this.time},e.prototype.reset=function(){this.pause(),this.deleteChildren(),this.level&&this.level.createScene(this),this.time=0,this.draw()},e.prototype.pause=function(){this.playing&&(this.playing=!1,this.animationFrameId&&window.cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)},e.prototype.play=function(){this.playing||(this._prevUpdate=.001*performance.now(),this.playing=!0,this.requestAnimFrame(),0===this.time&&this.dispatch("onStart"))},e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(Mt===this&&(Mt=null),console.log("scene.delete"),!0)},e.prototype.addComponent=function(t){var e=this.components.get(t.constructor.componentName);e||(e=new Set,this.components.set(t.constructor.componentName,e)),e.add(t)},e.prototype.removeComponent=function(t){var e=this.components.get(t.constructor.componentName);d(e),d(e.delete(t))},e.prototype.getComponents=function(t){return this.components.get(t)||new Set},e}(ht);Bt.prototype.isRoot=!0,ht.registerSerializable(Bt,"sce");var zt=new Map,Rt=function(t){function e(e){void 0===e&&(e=!1),t.call(this,e),this._componentId=null,this.scene=Mt,this.game=Lt,this._listenRemoveFunctions=[],this.entity=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){return this._parent=null,this.entity=null,t.prototype.delete.call(this),!0},e.prototype._preInit=function(){var t=this;this.constructor.requirements.forEach(function(e){t[e]=t.entity.getComponent(e),d(t[e],t.constructor.componentName+" requires component "+e+" but it is not found")}),this.forEachChild("com",function(t){return t._preInit()}),["onUpdate","onDraw","onDrawHelper","onStart"].forEach(function(e){"function"==typeof t[e]&&t._listenRemoveFunctions.push(t.scene.listen(e,function(){for(var n=[],o=arguments.length;o--;)n[o]=arguments[o];return(r=t)[e].apply(r,n);var r}))}),"Transform"!==this.constructor.componentName&&this.scene.addComponent(this);try{"function"==typeof this.preInit&&this.preInit()}catch(t){console.error(this.entity,this.constructor.componentName,"preInit",t)}},e.prototype._init=function(){this.forEachChild("com",function(t){return t._init()});try{"function"==typeof this.init&&this.init()}catch(t){console.error(this.entity,this.constructor.componentName,"init",t)}},e.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(t){console.error(this.entity,this.constructor.componentName,"sleep",t)}"Transform"!==this.constructor.componentName&&this.scene.removeComponent(this),this.forEachChild("com",function(t){return t._sleep()}),this._listenRemoveFunctions.forEach(function(t){return t()}),this._listenRemoveFunctions.length=0},e.prototype.createComponentData=function(){var t=this,e=this.constructor.componentName,n=this.constructor._propertyTypes,o=new xt(e),r=[];return n.forEach(function(e){r.push(e.createProperty({value:t[e.name]}))}),o.initWithChildren(r),o},e.prototype.toJSON=function(){return Object.assign(t.prototype.toJSON.call(this),{n:this.constructor.componentName,cid:this._componentId})},e}(St);Rt.create=function(t,e){void 0===e&&(e={});var n=zt.get(t);d(n);var o=new n;return o.initWithPropertyValues(e),o},Rt.createWithInheritedComponentData=function(t){var e=new t.componentClass;e._componentId=t.componentId;var n=t.properties.map(function(t){return t.clone()});return e.initWithChildren(n),e},Rt.reservedPropertyNames=new Set(["id","constructor","delete","children","entity","env","init","preInit","sleep","toJSON","fromJSON"]),Rt.reservedPrototypeMembers=new Set(["id","children","entity","env","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentData","toJSON","fromJSON"]),Rt.register=function(t){var e=t.name;void 0===e&&(e="");var n=t.description;void 0===n&&(n="");var o=t.category;void 0===o&&(o="Other");var r=t.icon;void 0===r&&(r="fa-puzzle-piece");var i=t.color;void 0===i&&(i="");var a=t.properties;void 0===a&&(a=[]);var s=t.requirements;void 0===s&&(s=["Transform"]);var p=t.children;void 0===p&&(p=[]);var l=t.parentClass;void 0===l&&(l=Rt);var c=t.prototype;void 0===c&&(c={});var u=t.allowMultiple;void 0===u&&(u=!0),d(e,"Component must have a name."),d(e[0]>="A"&&e[0]<="Z","Component name must start with capital letter."),d(!zt.has(e),"Duplicate component class "+e),Object.keys(c).forEach(function(t){Rt.reservedPrototypeMembers.has(t)&&d(!1,"Component prototype can not have a reserved member: "+t)});var h=c.constructor,f=c.delete;delete c.constructor,delete c.delete;var y=function(t){function e(){t.apply(this,arguments),h&&h()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(f&&f(),!0)},e}(l);a.forEach(function(t){d(!Rt.reservedPropertyNames.has(t.name),"Can not have property called "+t.name)}),St.defineProperties(y,a),y.componentName=e,y.category=o,s.indexOf("Transform")<0&&s.push("Transform"),y.requirements=s,y.children=p,y.description=n,y.allowMultiple=u,y.icon=r;var m=e.split("").reduce(function(t,e){return t+e.charCodeAt(0)},0);return y.color=i||"hsla("+m%360+", 40%, 60%, 1)",c._name=e,Object.assign(y.prototype,c),zt.set(y.componentName,y),y},ht.registerSerializable(Rt,"com",function(t){var e=new(zt.get(t.n))(t.id);return e._componentId=t.cid||null,e});var Vt=function(t){function e(e){void 0===e&&(e=!1),t.apply(this,arguments),this.prototype=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getTransform=function(){return this.findChild("cda",function(t){return"Transform"===t.name})},e.prototype.getParentPrototype=function(){return this.prototype},e.prototype.clone=function(){var t=this,n=new e;n.prototype=this.prototype;var o=n.id,r=[];return this.forEachChild(null,function(e){if("prp"===e.threeLetterType&&"name"===e.name){var n=new Ct({value:e.propertyType.type.clone(e.value),name:e.name,propertyType:t.propertyType,predefinedId:o+"_n"});r.push(n)}else if("cda"===e.threeLetterType&&"Transform"===e.name){var i=new xt("Transform",o+"_t"),a=i.componentClass._propertyTypesByName.position.createProperty({value:e.findChild("prp",function(t){return"position"===t.name}).value,predefinedId:o+"_p"});i.addChild(a);var s=i.componentClass._propertyTypesByName.scale.createProperty({value:e.findChild("prp",function(t){return"scale"===t.name}).value,predefinedId:o+"_s"});i.addChild(s);var p=i.componentClass._propertyTypesByName.rotation.createProperty({value:e.findChild("prp",function(t){return"rotation"===t.name}).value,predefinedId:o+"_r"});i.addChild(p),r.push(i)}else r.push(e.clone())}),n.initWithChildren(r),this._state|=ht.STATE_CLONE,n},e.prototype.toJSON=function(){var t=this,e=this.getTransform(),n={id:this.id,p:this.prototype.id},o=[];this._children.forEach(function(t){o.push(t)});var r=(p=[]).concat.apply(p,o).filter(function(n){return n!==e&&n!==t._properties.name});r.length>0&&(n.c=r.map(function(t){return t.toJSON()}));var i=this.prototype,a=f.float().toJSON,s=function(t){"name"===t.name?i&&t.value===i.name||(n.n=t.value):"position"===t.name?(n.x=a(t.value.x),n.y=a(t.value.y)):"scale"===t.name?t.value.isEqualTo(new bt(1,1))||(n.w=a(t.value.x),n.h=a(t.value.y)):"rotation"===t.name&&0!==t.value&&(n.a=a(t.value))};return s(this._properties.name),e.getChildren("prp").forEach(s),n;var p},e.prototype.spawnEntityToScene=function(t){if(Mt){t&&(this.getTransform().getPropertyOrCreate("position").value=t);var e=this.createEntity();Mt.addChild(e)}},e}(Nt);Object.defineProperty(Vt.prototype,"position",{get:function(){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value},set:function(t){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value=t}}),Vt.createFromPrototype=function(t,e){void 0===e&&(e=[]);var n=new Vt;n.prototype=t;var o=n.id;d(!e.find(function(t){return"Transform"===t.name}),"Prototype (prt) can not have a Transform component");var r=new xt("Transform",o+"_t");e.push(r);var i=r.componentClass._propertyTypesByName.position.createProperty({value:new bt(0,0),predefinedId:o+"_p"});r.addChild(i);var a=r.componentClass._propertyTypesByName.scale.createProperty({value:new bt(1,1),predefinedId:o+"_s"});r.addChild(a);var s=r.componentClass._propertyTypesByName.rotation.createProperty({value:0,predefinedId:o+"_r"});r.addChild(s);var p=Vt._propertyTypesByName.name.createProperty({value:t.name,predefinedId:o+"_n"});return n.initWithChildren([p].concat(e)),n},ht.registerSerializable(Vt,"epr",function(t){var e=new Vt(t.id);e.prototype=n(t.p),d(e.prototype,"Prototype "+t.p+" not found");var o=t.id+"_n",r=t.id+"_t",i=t.id+"_p",a=t.id+"_s",s=t.id+"_r",p=Nt._propertyTypesByName.name.createProperty({value:void 0===t.n?e.prototype.name:t.n,predefinedId:o}),l=new xt("Transform",r),c=zt.get("Transform"),u=c._propertyTypesByName.position.createProperty({value:new bt(t.x,t.y),predefinedId:i});l.addChild(u);var h=c._propertyTypesByName.scale.createProperty({value:new bt(void 0===t.w?1:t.w,void 0===t.h?1:t.h),predefinedId:a});l.addChild(h);var f=c._propertyTypesByName.rotation.createProperty({value:t.a||0,predefinedId:s});return l.addChild(f),e.initWithChildren([p,l]),e});var Jt=[f("name","No name",f.string)],Ft=function(t){function e(e){t.apply(this,arguments),e?console.log("level import"):console.log("level created")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.createScene=function(t){void 0===t&&(t=!1),t||new Bt;var e=this.getChildren("epr").map(function(t){return t.createEntity()});return Mt.addChildren(e),Mt.level=this,Mt},e}(St);St.defineProperties(Ft,Jt),ht.registerSerializable(Ft,"lvl"),Rt.register({name:"Transform",category:"Core",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[f("position",new bt(0,0),f.vector),f("scale",new bt(1,1),f.vector),f("rotation",0,f.float,f.float.modulo(0,2*Math.PI),f.flagDegreesInEditor)]});var Wt=0;Rt.register({name:"Test",category:"Core",properties:[f("name","Oh right",f.string),f("enum","yksi",f.enum,f.enum.values("yksi","kaksi","kolme","neljä")),f("topBarHelper",new bt(0,1),f.vector),f("test"+ ++Wt,Wt,f.int),f("test"+ ++Wt,!1,f.bool),f("test"+ ++Wt,!0,f.bool)]});var qt={left:37,right:39,up:38,down:40,ctrl:17,appleLeft:91,appleRight:93,alt:18,shift:16,space:32,a:65,z:90,0:48,1:49,9:57,backspace:8,enter:13,esc:27},Ut={},Ht=[],$t=[];"undefined"!=typeof window&&(window.onkeydown=function(t){var e=t.which||t.keyCode;"input"==document.activeElement.nodeName.toLowerCase()&&e!==qt.esc||(Ut[e]=!0,Ht.forEach(function(t){return t(e)}))},window.onkeyup=function(t){var e=t.which||t.keyCode;Ut[e]=!1,$t.forEach(function(t){return t(e)})}),Rt.register({name:"Mover",properties:[f("change",new bt(10,10),f.vector),f("userControlled",!1,f.bool),f("speed",1,f.float),f("rotationSpeed",0,f.float,"Degrees per second",f.flagDegreesInEditor)],prototype:{onUpdate:function(t,e){if(this.userControlled){if(!this.entity.localMaster)return;var n=0,o=0;_(qt.left)&&(n-=1),_(qt.right)&&(n+=1),_(qt.up)&&(o-=1),_(qt.down)&&(o+=1),n&&(this.Transform.position.x+=n*this.speed*t),o&&(this.Transform.position.y+=o*this.speed*t),(n||o)&&(this.Transform.position=this.Transform.position),n&&this.rotationSpeed&&(this.Transform.rotation+=t*n*this.rotationSpeed)}else{var r=new bt(t,0).rotate(e*this.speed).multiply(this.change);this.Transform.position.set(this.Transform.position).add(r),this.rotationSpeed&&(this.Transform.rotation+=t*this.rotationSpeed)}}}}),Rt.register({name:"Rect",icon:"fa-stop",allowMultiple:!0,properties:[f("size",new bt(10,10),f.vector),f("style","red",f.string),f("randomStyle",!1,f.bool)],prototype:{init:function(){this.randomStyle&&(this.style="hsl("+(360*Math.random()|0)+", 100%, 40%)")},onDraw:function(t){var e=this.Transform.position.x-this.size.x/2*this.Transform.scale.x,n=this.Transform.position.y-this.size.y/2*this.Transform.scale.y,o=this.size.x*this.Transform.scale.x,r=this.size.y*this.Transform.scale.y;t.save(),t.fillStyle=this.style,t.translate(e+o/2,n+r/2),t.rotate(this.Transform.rotation),t.fillRect(-o/2,-r/2,o,r),t.restore()}}}),Rt.register({name:"Spawner",properties:[f("typeName","",f.string)],prototype:{onStart:function(){this.spawn()},onDrawHelper:function(t){this.Transform.position.x,this.Transform.scale.x,this.Transform.position.y,this.Transform.scale.y,this.Transform.scale.x,this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px FontAwesome",t.textAlign="center",t.fillText("",this.Transform.position.x+2,this.Transform.position.y),t.strokeText("",this.Transform.position.x+2,this.Transform.position.y),t.restore()},spawn:function(){var t=this,e=this.game.findChild("prt",function(e){return e.name===t.typeName});e&&Vt.createFromPrototype(e).spawnEntityToScene(this.Transform.position)}}}),Rt.register({name:"Trigger",allowMultiple:!0,properties:[f("trigger","playerComesNear",f.enum,f.enum.values("playerComesNear")),f("radius",40,f.float,f.float.range(0,1e3),f.visibleIf("trigger","playerComesNear")),f("action","win",f.enum,f.enum.values("win"))],prototype:{onDrawHelper:function(t){this.Transform.position.x,this.Transform.scale.x,this.Transform.position.y,this.Transform.scale.y,this.Transform.scale.x,this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px FontAwesome",t.textAlign="center",t.fillText("",this.Transform.position.x,this.Transform.position.y+15),t.strokeText("",this.Transform.position.x,this.Transform.position.y+15),t.restore()},preInit:function(){this.storeProp="__Trigger_"+this._componentId},onUpdate:function(){var t=this;if("playerComesNear"===this.trigger){var e=this.scene.getComponents("Mover"),n=[];e.forEach(function(t){return n.push(t.entity)});for(var o=this.radius*this.radius,r=this.Transform.position,i=0;i<n.length;++i)if(n[i].position.distanceSq(r)<o){if(!n[i][t.storeProp]&&t.launchTrigger(n[i])===!1)break;n[i][t.storeProp]=!0}else n[i][t.storeProp]=!1}},launchTrigger:function(t){return"win"===this.action&&(this.scene.win(),!1)}}});var Gt,Kt=!1;"undefined"!=typeof window&&P(),function(){var t=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(ht);ht.registerSerializable(t,"tes",function(e){return new t(e.id)});var e=new t,n=e.id;d("string"==typeof n&&n.length>10);var o=e.toJSON();d(o&&"object"==typeof o&&"string"==typeof o.id),e.delete(),e=ht.fromJSON(o),d("string"==typeof e.id&&e.id.length>10&&e.id===n),e.delete(),console.log("Serializable tests OK")}(),function(){var t=new Pt;d(0===t.components.size),d(null===t.getComponent("moi")),d(0===t.getComponents("moi").length),t.delete(),console.log("Entity tests OK")}(),function(){d(4===f.float.default().validate("4")),d(1===f.float.range(0,1).validate(3)),console.log("PropertyType tests OK")}(),Rt.register({name:"Example",description:"Description of what this component does",category:"Core",icon:"fa-bars",requirements:["Transform"],children:["Image","Image","Sound"],properties:[f("variable",.5,f.float,f.float.range(0,1),"Description of the property"),f("otherVar_iaerfperfjoierj","Hello",f.string,"Description of the property")],parentClass:Rt,prototype:{staticVariable:"Example class info",constructor:function(){this.hiddenVariable=3},preInit:function(){this.data={lotsOfData:123+this.variable+this.hiddenVariable}},init:function(){this.Transform.position.x=this.Transform.position.y+1,this.howToAccessChildren=[this.children.Image[0].property,this.children.Sound.property],this.SomeComponent=this.entity.getComponent("SomeComponent")},sleep:function(){this.data=null,this.SomeComponent=null,this.howToAccessChildren=null},delete:function(){}}});var Yt={},Qt={listen:function(t,e){return Yt.hasOwnProperty(t)||(Yt[t]=[]),Yt[t].push(e),function(){var n=Yt[t].indexOf(e);Yt[t].splice(n,1)}},dispatch:function(t){for(var e=[],n=arguments.length-1;n-- >0;)e[n]=arguments[n+1];if(Yt.hasOwnProperty(t))for(var o=0;o<Yt[t].length;++o)Yt[t][o].apply(null,e)},getLoadEventPromise:function(t){return new Promise(function(e){Qt.listen(t,e)})}},Xt=function(t){return ie.createTextNode(t)},Zt=function(t){return function(e){return typeof e===t}},te=Zt("string"),ee=Zt("number"),ne=Zt("function"),oe=function(t){return t&&t.nodeType},re=function(t){return t&&t.__redom_list},ie=document,ae="#".charCodeAt(0),se=".".charCodeAt(0),pe={},le=function(t){return pe[t]||M(t)};j.extend=function(t){var e=le(t);return j.bind(this,e)},R.extend=function(t,e,n,o){return R.bind(R,t,e,n,o)},z.extend=R.extend,R.prototype.update=function(t){void 0===t&&(t=[]);for(var e=this.View,n=this.key,o=ne(n),r=this.initData,i=new Array(t.length),a=this.views,s=n&&{},p=n&&this.lookup,l=0;l<t.length;l++){var c=t[l],u=void 0;if(n){var h=o?n(c):c[n];u=i[l]=p[h]||new e(r,c,l,t),s[h]=u,u.__id=h}else u=i[l]=a[l]||new e(r,c,l,t);var d=u.el;d.__redom_list&&(d=d.el),d.__redom_view=u,u.update&&u.update(c,l,t)}B(this,i),n&&(this.lookup=s),this.views=i},function(t,e){this.el=te(t)?j(t):t,this.Views=e}.prototype.update=function(t,e){if(t!==this.route){var n=this.Views,o=n[t];this.view=o&&new o,this.route=t,B(this.el,[this.view])}this.view&&this.view.update&&this.view.update(e)};var ce=function(t,e){var n=this;if(void 0===t&&(t="unknownClass.anotherClass"),void 0===e&&(e="fa-chevron-left"),this.modules=[],this.packButtonEnabled=!!e,this.el=j("div.moduleContainer.packable."+t,this.packButton=e&&j("i.packButton.button.iconButton.fa."+e),this.tabs=z("div.tabs",ue),this.moduleElements=j("div.moduleElements")),e){var o="moduleContainerPacked_"+t;pt(o)&&this.el.classList.add("packed"),this.el.onclick=function(){return st(o,""),n.el.classList.contains("packed")&&n.el.classList.remove("packed")||void 0},this.packButton.onclick=function(t){return n.el.classList.add("packed"),st(o,"true"),t.stopPropagation(),!1}}Qt.listen("registerModule_"+t.split(".")[0],function(t,e){var o=new t(e);o.el.classList.add("module-"+o.id),n.modules.push(o),n.el.classList.remove("noModules"),1!==n.modules.length&&o._hide(),N(n.moduleElements,o.el),n._updateTabs(),Qt.listen("activateModule_"+o.id,function(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];void 0===t&&(t=!0),t&&n.el.classList.remove("packed"),n._activateModule(o,e)})}),this._updateTabs()};ce.prototype.update=function(){var t=this;this.modules.forEach(function(e){e.update()!==!1?t._enableModule(e):t._disableModule(e)}),this._updateTabs()},ce.prototype._updateTabs=function(){if(this.tabs){this.tabs.update(this.modules),!this.packButtonEnabled&&this.modules.length<=1?this.tabs.el.style.display="none":this.tabs.el.style.display="block";var t=!this.modules.find(function(t){return t._enabled});this.el.classList.toggle("noModules",t)}},ce.prototype._activateModule=function(t,e){this.modules.forEach(function(e){e!==t&&e._hide()}),t._enabled=!0,t.activate.apply(t,e),t._show(),this._updateTabs()},ce.prototype._enableModule=function(t){if(!t._enabled){t._enabled=!0;this.modules.find(function(t){return t._selected})||this._activateModule(t),this._updateTabs()}},ce.prototype._disableModule=function(t){if(t._enabled){if(t._enabled=!1,t._selected){t._selected=!1;var e=this.modules.find(function(t){return t._enabled});e&&this._activateModule(e)}t._hide(),this._updateTabs()}};var ue=function(){var t=this;this.el=j("span.moduleTab.button"),this.module=null,this.el.onclick=function(){Qt.dispatch("activateModule_"+t.module.id)}};ue.prototype.update=function(t){this.module=t,this.el.textContent=t.name,this.el.classList.toggle("moduleSelected",t._selected),this.el.classList.toggle("moduleEnabled",t._enabled)};var he=function(){var t=this;this.moduleContainers=[];var e=function(){for(var e=[],n=arguments.length;n--;)e[n]=arguments[n];var o=new(Function.prototype.bind.apply(ce,[null].concat(e)));return t.moduleContainers.push(o),o};this.el=j("div.editorLayout",j("div.nonRight",e("top",null),j("div.bottomLeft",e("left","fa-chevron-left"),j("div.middle",e("center",null),e("bottom","fa-chevron-down")))),e("right","fa-chevron-right"))};he.prototype.update=function(){this.moduleContainers.forEach(function(t){return t.update()})};var de=function(){for(var t=arguments.length,e=Array(t);t--;)e[t]=arguments[t];this.type="module",this.name=this.name||"Module",this.id=this.id||"module",this.el=j.apply(void 0,["div.module"].concat(e)),this._selected=!0,this._enabled=!0};de.prototype.activate=function(){},de.prototype.update=function(){},de.prototype._show=function(){this.el.classList.remove("hidden"),this._selected=!0,this._enabled=!0},de.prototype._hide=function(){this.el.classList.add("hidden"),this._selected=!1},de.activateModule=function(t,e){for(var n=[],o=arguments.length-2;o-- >0;)n[o]=arguments[o+2];void 0===e&&(e=!0),Qt.dispatch.apply(Qt,["activateModule_"+t,e].concat(n))},de.packModuleContainer=function(t){document.querySelectorAll(".moduleContainer."+t)[0].classList.add("packed")},de.unpackModuleContainer=function(t){document.querySelectorAll(".moduleContainer."+t)[0].classList.remove("packed")},de.register=function(t,e){ye=ye.then(function(){Qt.dispatch("registerModule_"+e,t)})};var fe=1;de.registerTopButton=function(t,e){void 0===e&&(e=fe++),ye=ye.then(function(){Qt.dispatch("registerTopButton",t,e)})};var ye=new Promise(function(t){Qt.listen("registerModules",function(){ye.then(function(){Qt.dispatch("modulesRegistered")}),t()})}),me=0,ve=function(t){var e=t.title;void 0===e&&(e="Undefined popup");var n=t.cancelCallback;void 0===n&&(n=null);var o=t.width;void 0===o&&(o=null);var r=t.content;void 0===r&&(r=j("div","Undefined content")),this.el=j("div.popup",{style:{"z-index":1e3+me++}},new _e(this),j("div.popupContent",this.text=j("div.popupTitle",e),this.content=r)),this.cancelCallback=n,N(document.body,this.el)};ve.prototype.remove=function(){me--,this.el.parentNode.removeChild(this.el)};var ge=function(){var t=this;this.el=j("button.button",{onclick:function(){t.callback()}})};ge.prototype.update=function(t){if(this.el.textContent=t.text,t.icon){var e=j("i.fa."+t.icon);t.color&&(e.style.color=t.color),N(this.el,e,this.el.firstChild)}this.el.className=t.class?"button "+t.class:"button",this.callback=t.callback,t.color&&(this.el.style["border-color"]=t.color)};var _e=function(t){this.el=j("div.popupLayer",{onclick:function(){t.remove(),t.cancelCallback&&t.cancelCallback()}})},Ce=function(t){function e(){var n=this;t.call(this,{title:"Levels",width:"500px",content:j("div.levelSelectorButtons",this.buttons=z("div.levelSelectorButtons",Te),"Create: ",this.createButton=new ge)}),this.parent=parent,this.buttons.update(Lt.getChildren("lvl")),this.createButton.update({text:"New level",icon:"fa-area-chart",callback:function(){a(n);var t=new Ft;t.initWithPropertyValues({name:"New level"}),We.game.addChild(t),We.setLevel(t),We.select(t,n),n.remove(),setTimeout(function(){de.activateModule("level",!0,"focusOnProperty","name")},100)}}),O(this.el,"selectLevel",function(t){We.setLevel(t),n.remove(),We.select(t,n)}),O(this.el,"deleteLevel",function(t){confirm("Are you sure you want to delete level: "+t.name)&&(a(n),t.delete(),n.remove(),new e)})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(ve),Te=function(){this.el=j("div.levelItem",this.number=j("span"),this.selectButton=new ge,this.deleteButton=new ge)};Te.prototype.selectClicked=function(){x(this,"selectLevel",this.level)},
Te.prototype.deleteClicked=function(){x(this,"deleteLevel",this.level)},Te.prototype.update=function(t,e){var n=this;this.level=t,this.number.textContent=e+1+".",this.selectButton.update({text:t.name,icon:"fa-area-chart",callback:function(){return n.selectClicked()}}),this.deleteButton.update({text:"Delete",class:"dangerButton",icon:"fa-cross",callback:function(){return n.deleteClicked()}})};var we=function(t){function e(){var e=this;t.call(this,this.logo=j("img.logo.button.iconButton",{src:"../img/logo_reflection_medium.png"}),this.buttons=j("div.buttonContainer")),this.id="topbar",this.name="TopBar",Qt.listen("addTopButtonToTopBar",function(t){N(e.buttons,t)}),new be({text:"Levels",iconClass:"fa-area-chart",callback:function(){new Ce}})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(de);de.register(we,"top");var be=function(t){var e=this;void 0===t&&(t={});var n=t.text;void 0===n&&(n="Button");var o=t.callback,r=t.iconClass;void 0===r&&(r="fa-circle");var i=t.priority;void 0===i&&(i=1),this.priority=i||0,this.el=j("div.button.topIconTextButton",j("div.topIconTextButtonContent",this.icon=j("i.fa."+r),this.text=j("span",n))),this.el.onclick=function(){o&&o(e)},Je.then(function(){Qt.dispatch("addTopButtonToTopBar",e)})},Ee=Math.pow(10,3),Se={};Se.default=Se.string=function(t,e,n){var o=j("input",{oninput:function(){return e(o.value)},onchange:function(){return n(o.value)}});return N(t,o),function(t){return o.value=t}},Se.float=Se.int=function(t,e,n){var o=j("input",{type:"number",oninput:function(){return e(+o.value)},onchange:function(){return n(+o.value)}});return N(t,o),function(t){return o.value=Math.round(t*Ee)/Ee}},Se.bool=function(t,e,n){var o=j("input",{type:"checkbox",onchange:function(){n(o.checked),r.textContent=o.checked?"Yes":"No"}}),r=j("span");return N(t,j("label",o,r)),function(t){o.checked=t,r.textContent=t?"Yes":"No"}},Se.vector=function(t,e,n){function o(){return new bt(+r.value,+i.value)}var r=j("input.xInput",{type:"number",oninput:function(){return e(o())},onchange:function(){return n(o())}}),i=j("input",{type:"number",oninput:function(){return e(o())},onchange:function(){return n(o())}});return N(t,j("div",j("span","x:"),r,j("span","y:"),i)),function(t){r.value=Math.round(t.x*Ee)/Ee,i.value=Math.round(t.y*Ee)/Ee}},Se.enum=function(t,e,n,o){var r=j.apply(void 0,["select"].concat(o.validator.parameters.map(function(t){return j("option",t)})));return r.onchange=function(){n(r.value)},N(t,r),function(t){r.value=t}};var Ie=function(t){function e(e,n){var o=this;t.call(this,{title:"Add component",width:"500px",content:this.buttons=z("div",ge)}),this.parent=e;var r=Array.from(zt.values());r=r.map(function(t){return{text:t.componentName,color:t.color,icon:t.icon,callback:function(){o.addComponentToParent(t.componentName),n&&n()}}}),this.update(r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.addComponentToParent=function(t){if(a(this),["epr","prt"].indexOf(this.parent.threeLetterType)>=0){var e=new xt(t);return this.parent.addChild(e),e}d(!1)},e.prototype.update=function(t){this.buttons.update(t)},e}(ve),Pe=function(){var t=this;this.el=j("div.propertyEditor"),this.dirty=!0,this.editingProperty=!1,Qt.listen("change",function(e){"editorSelection"===e.type?t.dirty=!0:e.type===ft.setPropertyValue?t.item&&t.item.hasDescendant(e.reference)&&(e.origin===t?"ent"===t.item.threeLetterType&&(t.item.dispatch("changedInEditor"),Z(t.item,e)):t.dirty=!0):e.type===ft.addSerializableToTree?(e.parent===t.item||t.item&&t.item.hasDescendant(e.parent))&&(t.dirty=!0):e.type===ft.deleteSerializable?t.item&&t.item.hasDescendant(e.reference)&&(t.dirty=!0):e.type===ft.deleteAllChildren&&t.item&&t.item.hasDescendant(e.reference)&&(t.dirty=!0)}),O(this,"makingChanges",function(){a(t)}),O(this,"markPropertyEditorDirty",function(){t.dirty=!0}),O(this,"propertyEditorSelect",function(e){We.select(e,t)})};Pe.prototype.update=function(t,e){if(this.dirty&&($(this.el).empty(),t)){if(["prt","ent","epr"].indexOf(e)>=0&&1===t.length||1===t.length&&t[0]instanceof St){this.item=t[0];var n=new xe;n.update(this.item),N(this.el,n)}this.dirty=!1}};var xe=function t(){var e=this;this.el=j("div.container",this.title=j("div.containerTitle"),this.content=j("div.containerContent",this.properties=z("table",Oe,null,this.propertyEditor),this.containers=z("div",t,null,this.propertyEditor),this.controls=j("div"),j("i.button.logButton.fa.fa-eye",{onclick:function(){console.log(e.item),window.item=e.item,console.log("you can use variable 'item'");var t=j("span"," logged to console");N(e.title,t),setTimeout(function(){e.title.removeChild(t)},500)}}))),this.titleClickedCallback=null,this.title.onclick=function(){e.titleClickedCallback&&e.titleClickedCallback()},O(this,"propertyInherited",function(t){if("icd"===e.item.threeLetterType){e.item.generatedForPrototype.createAndAddPropertyForComponentData(e.item,t.name,t.value),x(e,"markPropertyEditorDirty")}})};xe.prototype.update=function(t){this.item=t,this.el.setAttribute("type",this.item.threeLetterType),this.controls.innerHTML="",this.titleClickedCallback=null,"icd"===this.item.threeLetterType?this.updateInheritedComponentData():"ent"===this.item.threeLetterType?this.updateEntity():"com"===this.item.threeLetterType?this.updateComponent():"prt"===this.item.threeLetterType?this.updatePrototype():"epr"===this.item.threeLetterType?this.updateEntityPrototype():this.item instanceof St&&this.updatePropertyOwner()},xe.prototype.updatePrototype=function(){var t=this,e=this.item.getInheritedComponentDatas();this.containers.update(e),this.properties.update(this.item.getChildren("prp")),N(this.controls,j("button.button",j("i.fa.fa-puzzle-piece"),"Add component",{onclick:function(){new Ie(t.item)}})),N(this.controls,j("button.button",j("i.fa.fa-clone"),"Clone type",{onclick:function(){x(t,"makingChanges");for(var e=t.item.clone(),n=e.name.match(/\d+$/),o=n?parseInt(n[0])+1:2,r=n?e.name.substring(0,e.name.length-n[0].length):e.name,i=r+o++;t.item.getParent().findChild("prt",function(t){return t.name===i});)i=r+o++;e.name=i,t.item.getParent().addChild(e),x(t,"propertyEditorSelect",e)}})),N(this.controls,j("button.dangerButton.button",j("i.fa.fa-times"),"Delete type",{onclick:function(){x(t,"makingChanges");var e=t.item.countEntityPrototypes(!0);e?confirm("Type "+t.item.name+" is used in levels "+e+" times. Are you sure you want to delete this type and all "+e+" instances that are using it?")&&t.item.delete():t.item.delete()}}))},xe.prototype.updateEntityPrototype=function(){var t=this,e=this.item.getInheritedComponentDatas();this.containers.update(e),this.properties.update(this.item.getChildren("prp")),N(this.controls,j("button.button",j("i.fa.fa-puzzle-piece"),"Add component",{onclick:function(){new Ie(t.item)}}))},xe.prototype.updateInheritedComponentData=function(){var t=this;this.updateComponentKindOfThing(this.item.componentClass);var e="pack"+this.item.generatedForPrototype.id+this.item.componentId,n=pt(e);"true"===n?this.el.classList.add("packed"):"false"===n?this.el.classList.remove("packed"):this.el.classList.toggle("packed",!this.item.ownComponentData),this.titleClickedCallback=function(){t.el.classList.toggle("packed"),st(e,t.el.classList.contains("packed")?"true":"false")};var o=this.item.ownComponentData&&this.item.ownComponentData.getParentComponentData(),r=!1;this.item.properties.forEach(function(e){e.id&&(r=!0),e.propertyType.visibleIf&&(e._editorVisibleIfTarget=t.item.properties.find(function(t){return t.name===e.propertyType.visibleIf.propertyName}))}),this.properties.update(this.item.properties),this.item.ownComponentData&&!o||N(this.controls,j("button.button","Show parent",{onclick:function(){x(t,"propertyEditorSelect",t.item.generatedForPrototype.getParentPrototype().findComponentDataByComponentId(t.item.componentId,!0).getParent()),x(t,"markPropertyEditorDirty")}})),"Transform"===this.item.componentClass.componentName&&"epr"===this.item.generatedForPrototype.threeLetterType||(this.item.componentClass.allowMultiple&&N(this.controls,j("button.button",j("i.fa.fa-clone"),"Clone",{onclick:function(){if(x(t,"makingChanges"),t.item.ownComponentData){var e=t.item.ownComponentData.clone();t.item.generatedForPrototype.addChild(e)}else{var n=new xt(t.item.componentClass.componentName);n.initWithChildren(),t.item.generatedForPrototype.addChild(n)}x(t,"markPropertyEditorDirty")}})),r&&N(this.controls,j("button.dangerButton.button",j("i.fa.fa-refresh"),"Reset",{onclick:function(){x(t,"makingChanges"),x(t,"markPropertyEditorDirty","fromReset"),t.item.ownComponentData.getParentComponentData()?t.item.ownComponentData.delete():t.item.ownComponentData.deleteChildren()}})),this.item.ownComponentData&&!o&&N(this.controls,j("button.dangerButton.button",j("i.fa.fa-times"),"Delete",{onclick:function(){x(t,"makingChanges"),x(t,"markPropertyEditorDirty"),t.item.ownComponentData.delete()}})))},xe.prototype.updateEntity=function(){this.title.textContent=this.item.prototype.name,this.containers.update(this.item.getListOfAllComponents())},xe.prototype.updateComponent=function(){this.updateComponentKindOfThing(this.item.constructor),this.properties.update(this.item.getChildren("prp"))},xe.prototype.updateComponentKindOfThing=function(t){this.title.textContent=t.componentName;var e=j("i.icon.fa."+t.icon);N(this.title,e),this.title.style.color=t.color,this.title.setAttribute("title",t.description),this.el.style["border-color"]=t.color},xe.prototype.updatePropertyOwner=function(){this.properties.update(this.item.getChildren("prp"))};var Oe=function(){this.el=j("tr.property",{name:""},this.name=j("td.nameCell"),this.content=j("td.propertyContent"))};Oe.prototype.reset=function(){var t=this.property.getParent();this.property.delete(),0===t._children.size&&t.getParentComponentData()&&t.delete(),x(this,"markPropertyEditorDirty")},Oe.prototype.oninput=function(t){try{this.property.propertyType.validator.validate(this.convertFromInputToPropertyValue(t)),this.el.removeAttribute("error")}catch(t){this.el.setAttribute("error","true")}},Oe.prototype.onchange=function(t){var e=this.property.value;try{x(this,"makingChanges"),this.property.value=this.property.propertyType.validator.validate(this.convertFromInputToPropertyValue(t)),this.property.id||x(this,"propertyInherited",this.property)}catch(t){this.property.value=e}this.setValueFromProperty(),this.el.removeAttribute("error")},Oe.prototype.setValueFromProperty=function(){var t=this.property.value;this.property.propertyType.getFlag(f.flagDegreesInEditor)&&(t=Math.round(180*t/Math.PI*10)/10),this.setValue(t)},Oe.prototype.convertFromInputToPropertyValue=function(t){return this.property.propertyType.getFlag(f.flagDegreesInEditor)?t*Math.PI/180:t},Oe.prototype.updateVisibleIf=function(){this.property._editorVisibleIfTarget&&$(this.el).toggleClass("hidden",this.property._editorVisibleIfTarget.value!==this.property.propertyType.visibleIf.value)},Oe.prototype.update=function(t){var e=this;this.visibleIfListener&&(this.visibleIfListener(),this.visibleIfListener=null),this.property=t,this.el.setAttribute("name",t.name),this.el.setAttribute("type",t.propertyType.type.name),this.name.textContent=t.propertyType.name,this.name.setAttribute("title",t.propertyType.name+" ("+t.propertyType.type.name+") "+t.propertyType.description),this.content.innerHTML="";var n=Se[this.property.propertyType.type.name]||Se.default;if(this.setValue=n(this.content,function(t){return e.oninput(t)},function(t){return e.onchange(t)},t.propertyType),this.setValueFromProperty(),this.el.classList.toggle("visibleIf",!!t.propertyType.visibleIf),t._editorVisibleIfTarget&&(this.updateVisibleIf(),this.visibleIfListener=t._editorVisibleIfTarget.listen("change",function(t){return rt(e.el)?e.updateVisibleIf():(e.visibleIfListener(),void(e.visibleIfListener=null))})),this.el.classList.toggle("ownProperty",!!this.property.id),this.property.id){var o=this.property.getParent();"cda"!==o.threeLetterType||"Transform"===o.name&&"epr"===o.getParent().threeLetterType?"com"===o.threeLetterType&&(this.name.style.color=o.constructor.color):(this.name.style.color=o.componentClass.color,N(this.content,j("i.fa.fa-window-close.button.resetButton.iconButton",{onclick:function(){x(e,"makingChanges"),e.reset()}})))}else this.name.style.color="inherit"};var Ne=function(t){function e(){t.call(this,this.propertyEditor=new Pe),this.id="type",this.name="Type"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.update=function(){if(1!=We.selection.items.length)return!1;if("prt"===We.selection.type)this.propertyEditor.update(We.selection.items,We.selection.type);else{if("ent"!==We.selection.type)return!1;this.propertyEditor.update(We.selection.items.map(function(t){return t.prototype.prototype}),We.selection.type)}},e.prototype.activate=function(t,e){"focusOnProperty"===t&&this.propertyEditor.el.querySelector(".property[name='"+e+"'] input").select()},e}(de);de.register(Ne,"right");var ke=function(t){function e(){t.call(this,this.propertyEditor=new Pe),this.id="instance",this.name="Instance"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.update=function(){return 1==We.selection.items.length&&("ent"!==We.selection.type?(console.log("hide",this.id),!1):void(Mt.isInInitialState()?this.propertyEditor.update(We.selection.items.map(function(t){return t.prototype}),"epr"):this.propertyEditor.update(We.selection.items,We.selection.type)))},e.prototype.activate=function(t,e){},e}(de);de.register(ke,"right");var Le=function(){},De={game:{},editor:{},level:{},scene:{},Vector:{}};De.game.get=function(){return Lt},De.editor.get=function(){return We},De.level.get=function(){return We.selectedLevel},De.scene.get=function(){return Mt},De.Vector.get=function(){return bt},Object.defineProperties(Le.prototype,De);var Ae=new Le;window.help=Ae;var Me=function(t){function e(){var e=this;t.call(this,this.canvas=j("canvas.anotherCanvas",{width:0,height:0}),j("div.pauseInfo","Paused. Editing instances will not affect the level."),j("i.fa.fa-pause.pauseInfo.topLeft"),j("i.fa.fa-pause.pauseInfo.topRight"),j("i.fa.fa-pause.pauseInfo.bottomLeft"),j("i.fa.fa-pause.pauseInfo.bottomRight")),this.el.classList.add("hidePauseButtons"),setInterval(function(){e.fixAspectRatio()},500),setTimeout(function(){e.fixAspectRatio()}),this.id="scene",this.name="Scene",Ae.sceneModule=this,this.newEntities=[],this.entityUnderMouse=null,this.previousMousePos=null,this.entitiesToMove=[],this.selectedEntities=[],this.selectionStart=null,this.selectionEnd=null,this.entitiesInSelection=[],this.playButton=new be({text:"Play",iconClass:"fa-play",callback:function(t){Mt&&(a(e),e.clearState(),Mt.playing?(Mt.pause(),e.draw()):Mt.play(),e.updatePlayPauseButtonStates())}}),this.stopButton=new be({text:"Reset",iconClass:"fa-stop",callback:function(t){a(e),e.stopAndReset()}}),Lt.listen("levelCompleted",function(){e.updatePlayPauseButtonStates(),e.draw()}),Qt.listen("setLevel",function(t){console.log("scenemodule.setLevel"),t?t.createScene(!1,e):Mt&&Mt.delete(e),e.updatePlayPauseButtonStates(),e.clearState(),e.draw()}),Qt.listen("prototypeClicked",function(t){if(Mt){e.clearState();var n=Vt.createFromPrototype(t,[]);n.position=new bt(e.canvas.width/2,e.canvas.height/2);var o=n.createEntity(e);e.newEntities.push(o),e.draw()}}),Qt.listen("change",function(t){t.origin!==e&&(a(e),q(t),e.draw())}),C(function(t){Mt&&(a(e),t===qt.esc?(e.clearState(),e.draw()):t===qt.backspace&&(X(e.selectedEntities),e.clearState(),e.draw()))}),T(this.el,function(t){if(Mt){a(e);var n=e.previousMousePos?t.clone().subtract(e.previousMousePos):t;e.entityUnderMouse=null,Q(e.newEntities,t),Y(e.entitiesToMove,n),K(e.entitiesToMove),Mt&&(Mt.playing||0!==e.newEntities.length||e.selectionEnd||(e.entityUnderMouse=H(t))),e.selectionEnd&&(e.selectionEnd.add(n),e.entitiesInSelection=G(e.selectionStart,e.selectionEnd)),e.previousMousePos=t,e.draw()}}),w(this.el,function(t){if(Mt&&t){a(e),e.newEntities.length>0?U(e.newEntities):e.entityUnderMouse?(e.selectedEntities.indexOf(e.entityUnderMouse)>=0||(_(qt.shift)||(e.selectedEntities.length=0),e.selectedEntities.push(e.entityUnderMouse)),(n=e.entitiesToMove).push.apply(n,e.selectedEntities),e.selectSelectedEntitiesInEditor()):(e.selectedEntities.length=0,e.selectionStart=t,e.selectionEnd=t.clone()),e.draw();var n}}),b(this.el,function(t){if(Mt){e.selectionStart=null,e.selectionEnd=null,e.entitiesToMove.length=0,e.entitiesInSelection.length>0&&((n=e.selectedEntities).push.apply(n,e.entitiesInSelection),e.entitiesInSelection.length=0,e.selectSelectedEntitiesInEditor()),e.draw();var n}})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.updatePlayPauseButtonStates=function(){Mt&&(Mt.playing?(this.el.classList.add("hidePauseButtons"),this.playButton.icon.className="fa fa-pause"):(this.el.classList.toggle("hidePauseButtons",Mt.isInInitialState()),this.playButton.icon.className="fa fa-play"))},e.prototype.fixAspectRatio=function(){if(this.canvas){var t=!1;this.canvas.width!==this.canvas.offsetWidth&&this.canvas.offsetWidth&&(this.canvas.width=this.canvas.offsetWidth,t=!0),this.canvas.height!==this.canvas.offsetHeight&&this.canvas.offsetHeight&&(this.canvas.height=this.canvas.offsetHeight,t=!0),t&&this.draw()}},e.prototype.draw=function(){Mt?Mt.playing||(this.filterDeadSelection(),Mt.draw(),Mt.dispatch("onDrawHelper",Mt.context),ot(Mt.getChildren("ent")),tt(this.entityUnderMouse),et(this.selectionStart,this.selectionEnd,this.entitiesInSelection),nt(this.selectedEntities)):this.drawInvalidScene()},e.prototype.drawInvalidScene=function(){this.canvas.width=this.canvas.width;var t=this.canvas.getContext("2d");t.font="30px arial",t.fillStyle="white",t.fillText("No level loaded.",10,35)},e.prototype.clearState=function(){this.deleteNewEntities(),this.entityUnderMouse=null,this.selectedEntities.length=0,this.entitiesToMove.length=0,this.selectionStart=null,this.selectionEnd=null},e.prototype.deleteNewEntities=function(){this.newEntities.forEach(function(t){t.prototype.delete(),t.delete()}),this.newEntities.length=0},e.prototype.selectSelectedEntitiesInEditor=function(){We.select(this.selectedEntities,this)},e.prototype.stopAndReset=function(){this.clearState(),"ent"===We.selection.type&&We.select(We.selection.items.map(function(t){return t.prototype.prototype}),this),Mt&&Mt.reset(this),this.playButton.icon.className="fa fa-play",this.updatePlayPauseButtonStates(),this.draw()},e.prototype.filterDeadSelection=function(){var t=this;it(this.selectedEntities),it(this.entitiesToMove);for(var e=this.newEntities.length-1;e>=0;--e)if(t.newEntities[e].prototype.prototype._alive===!1){var n=t.newEntities.splice(e,1)[0];n.prototype.delete(),n.delete()}},e}(de);de.register(Me,"center");var je=function(t){function e(){var e=this;t.call(this,this.addButton=j("span.addTypeButton.button.fa.fa-plus"),this.search=j("input"),this.searchIcon=j("i.fa.fa-search.searchIcon"),this.jstree=j("div")),this.id="types",this.name="Types",this.addButton.onclick=function(){a(e);var n=Nt.create(" New type");We.game.addChild(n),We.select(n),setTimeout(function(){t.activateModule("type",!0,"focusOnProperty","name")},100)};var n=!1;this.search.addEventListener("keyup",function(){n&&clearTimeout(n),n=setTimeout(function(){$(e.jstree).jstree().search(e.search.value.trim())},200)}),this.externalChange=!1,Qt.listen("change",function(t){var n=$(e.jstree).jstree(!0);if(n){if(e.externalChange=!0,"prt"===t.reference.threeLetterType)if(t.type===ft.addSerializableToTree){var o,r=t.parent;o="gam"===r.threeLetterType?"#":n.get_node(r.id),n.create_node(o,{text:t.reference.getChildren("prp")[0].value,id:t.reference.id})}else e.dirty=!0;else if(t.type===ft.setPropertyValue){var i=t.reference._parent;if(i&&"prt"===i.threeLetterType){var a=n.get_node(i.id);n.rename_node(a,t.value)}}else if("editorSelection"===t.type&&t.origin!=e)if("prt"===t.reference.type){var s=n.get_node(t.reference.items[0].id);n.deselect_all(),n.select_node(s)}else if("epr"===t.reference.type){var p=$(e.jstree).jstree(!0),l=p.get_node(t.reference.items[0].getParentPrototype().id);p.deselect_all(),p.select_node(l)}else if("ent"===t.reference.type){var c=n.get_node(t.reference.items[0].prototype.getParentPrototype().id);n.deselect_all(),n.select_node(c)}e.externalChange=!1}})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.update=function(){var t=this;if(!this.skipUpdate&&(this.jstreeInited||(this.dirty=!0),this.dirty)){var e=[];We.game.forEachChild("prt",function(t){var n=t.getParent();e.push({text:t.name,id:t.id,parent:"prt"===n.threeLetterType?n.id:"#"})},!0),this.jstreeInited?($(this.jstree).jstree(!0).settings.core.data=e,$(this.jstree).jstree("refresh")):($(this.jstree).attr("id","types-jstree").on("changed.jstree",function(e,o){if(!t.externalChange){var r=o.selected.map(n);We.select(r,t),1===r.length&&Qt.dispatch("prototypeClicked",r[0])}}).on("loaded.jstree refresh.jstree",function(){$(t.jstree).jstree(!0);We.selection.type,We.selection.type}).jstree({core:{check_callback:!0,data:e,force_text:!0},plugins:["types","dnd","sort","search"],types:{default:{icon:"fa fa-book"}},sort:function(t,e){return this.get_text(t).toLowerCase()>this.get_text(e).toLowerCase()?1:-1},dnd:{copy:!1},search:{fuzzy:!0,show_only_matches:!0,show_only_matches_children:!0,close_opened_onclear:!1}}),this.jstreeInited=!0),$(this.jstree).data("typesModule",this),this.dirty=!1}},e}(de);$(document).on("dnd_stop.vakata",function(t,e){var o=$("#types-jstree").jstree(!0);$("#types-jstree").data("typesModule");setTimeout(function(){var t,r=o.get_node(e.data.obj),i=e.data.nodes;t="#"===r.parent?We.game:n(r.parent);var s=i.map(n);s.forEach(d),s.forEach(function(e){a(o),e.move(t)})})}),de.register(je,"left");var Be=function(t){function e(){t.call(this,this.propertyEditor=new Pe),this.id="level",this.name="Level"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.update=function(){if(!We.selectedLevel)return!1;this.propertyEditor.update([We.selectedLevel],"lvl")},e.prototype.activate=function(t,e){"focusOnProperty"===t&&this.propertyEditor.el.querySelector(".property[name='"+e+"'] input").select()},e}(de);de.register(Be,"right");var ze=function(t){function e(){t.call(this,this.content=j("span","List of instances on the scene")),this.name="Instances",this.id="instances"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.update=function(){},e}(de);de.register(ze,"left");var Re=function(t){function e(){t.call(this,this.content=j("span","This is test 3")),this.id="test",this.name="Test3"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.update=function(){return!1},e}(de);de.register(Re,"bottom");var Ve=!1,Je=Qt.getLoadEventPromise("modulesRegistered"),Fe=Qt.getLoadEventPromise("loaded");Je.then(function(){Ve=!0,Qt.dispatch("loaded"),E(!0)}),Fe.then(function(){We.setLevel(Lt.getChildren("lvl")[0])}),setInterval(function(){We&&We.dirty&&We.update()},200),l(function(t){if(Qt.dispatch("change",t),t.type===ft.addSerializableToTree&&"gam"===t.reference.threeLetterType){We=new qe(t.reference),Qt.dispatch("registerModules",We)}We&&(t.type===ft.deleteSerializable&&"lvl"===t.reference.threeLetterType&&We&&We.selectedLevel===t.reference&&We.setLevel(null),We.dirty=!0,"editorSelection"!==t.type&&Ve&&"gam"===t.reference.getRoot().threeLetterType&&(We.saveNeeded=!0))});var We=null,qe=function(t){d(t),this.layout=new he,this.dirty=!0,this.game=t,this.selectedLevel=null,this.selection={type:"none",items:[],dirty:!0},N(document.body,this.layout)};qe.prototype.setLevel=function(t){t&&"lvl"===t.threeLetterType?this.selectedLevel=t:this.selectedLevel=null,this.select([],this),Qt.dispatch("setLevel",this.selectedLevel)},qe.prototype.select=function(t,e){Array.isArray(t)||(t=[t]),this.selection.items=[].concat(t);var n=Array.from(new Set(t.map(function(t){return t.threeLetterType})));0===n.length?this.selection.type="none":1===n.length?this.selection.type=n[0]:this.selection.type="mixed",this.dirty=!0,Qt.dispatch("change",{type:"editorSelection",reference:this.selection,origin:e}),this.update()},qe.prototype.update=function(){if(this.dirty&&this.game){this.layout.update();var t="update";this.saveNeeded&&(t+=" & save",this.save()),this.dirty=!1,this.saveNeeded=!1,console.log(t)}},qe.prototype.save=function(){localStorage.anotherGameId=this.game.id};var Ue=null;window.Property=Ct,window.PropertyType=f,window.Component=Rt,window.Prop=f,window.Serializable=ht,window.getSerializable=n,window.serializables=dt,window.setChangeOrigin=a,window.Game=At});
//# sourceMappingURL=explore.editor.min.js.map
