function assert(t,e){if(!t)throw new Error(e)}function addSerializable(t){if(serializables.has(t.id))throw new Error("Serializable id clash!");serializables.set(t.id,t)}function removeSerializable(t){if(!serializables.delete(t))throw new Error("Serializable not found!")}function char(){return BASE_64_CHARACTERS[Math.random()*CHAR_COUNT|0]}function createStringId(t,e){void 0===t&&(t="???"),void 0===e&&(e=16);for(var r=t,o=e-1;0!==o;--o)r+=char();return r}function PropertyType(t,e,r){for(var o=[],i=arguments.length-3;i-- >0;)o[i]=arguments[i+3];r=r();var n=r.validators.default(),a="";return o.forEach(function(t){"string"==typeof t?a=t:t&&t.validate?n=t:assert(!1,"invalid parameter "+t)}),new PropertyModel(t,r,n,e)}function addType(t){var e=t.name;void 0===e&&(e="");var r=t.validators;void 0===r&&(r={default:function(t){return t}});var o=t.toJSON;void 0===o&&(o=function(t){return t});var i=t.fromJSON;void 0===i&&(i=function(t){return t}),assert(e,"name missing from property type"),assert("function"==typeof r.default,"default validator missing from property type: "+e),assert("function"==typeof o,"invalid toJSON for property type: "+e),assert("function"==typeof i,"invalid fromJSON for property type: "+e);var n={name:e,validators:r,toJSON:o,fromJSON:i},a=function(){return n};Object.keys(r).forEach(function(t){a[t]=createValidator(t,r[t]),r[t]=a[t]}),PropertyType[e]=a}function createValidator(t,e){var r=function(){for(var r=arguments.length,o=Array(r);r--;)o[r]=arguments[r];var i=[].concat(o);return{validatorName:t,validatorParameters:i,validate:function(t){return e.apply(void 0,[t].concat(i))}}};return r.validatorName=t,r.validate=e,r}var serializables=new Map,BASE_64_CHARACTERS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",CHAR_COUNT=BASE_64_CHARACTERS.length,Serializable=function(t,e){void 0===e&&(e=!1),e?this.id=e:this.id=createStringId(t),addSerializable(this)};Serializable.prototype.delete=function(){removeSerializable(this.id)},Serializable.prototype.toJSON=function(){return{id:this.id}},Serializable.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},Serializable.fromJSON=function(t){return assert("string"==typeof t.id),new Serializable(null,t.id)};var Property=function(t){function e(e){t.call(this,"prp"),this.model=e,this.value=e.initialValue}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.toJSON=function(){return Object.assign(t.prototype.toJSON.call(this),{value:this.type.toJSON(this.value),modelId:this.model.id})},e.prototype.delete=function(){t.prototype.delete.call(this),this.model=null},e}(Serializable);Object.defineProperty(Property.prototype,"type",{get:function(){return this.model.type}}),Object.defineProperty(Property.prototype,"value",{set:function(t){this._value=this.model.validator.validate(t)},get:function(){return this._value}}),Object.defineProperty(Property.prototype,"initialValue",{get:function(){return this.model.initialValue}});var PropertyModel=function(t){function e(e,r,o,i){assert("string"==typeof e),assert("string"==typeof r.name),assert("function"==typeof o.validate),t.call(this,"pmo"),this.name=e,this.type=r,this.validator=o,this.initialValue=i}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.toJSON=function(){return Object.assign(t.prototype.toJSON.call(this),{name:this.name,type:this.type.name,validatorName:this.validator.validatorName,validatorParameters:this.validator.validatorParameters,initialValue:this.type.toJSON(this.initialValue)})},e.prototype.delete=function(){t.prototype.delete.call(this),this.type=null,this.validator=null},e}(Serializable);addType({name:"float",validators:{default:function(t){return t=parseFloat(t),assert(!isNaN(t),"invalid float: "+t),t},range:function(t,e,r){return t=parseFloat(t),assert(!isNaN(t),"invalid float: "+t),Math.min(r,Math.max(e,t))}},toJSON:function(t){return t},fromJSON:function(t){return t}}),addType({name:"string",validators:{default:function(t){return String(t)}},toJSON:function(t){return t},fromJSON:function(t){return t}});var componentClasses=new Map,Component=function(t){function e(e,r,o){var i=this;t.call(this,"com"),this.entity=r,this.env=o,this._properties={},this._componentModel=e,this.constructor.propertyModels.forEach(function(t){i._properties[t.name]=new Property(t)})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){assert(!this.env.entity.alive,"Do not call Component.delete!"),t.prototype.delete.call(this)},e.prototype._privateInit=function(){var t=this;this.constructor.requirements.forEach(function(e){t[e]=t.entity.getComponent(e),assert(t[e],"required component not found")});try{"function"==typeof this.onPrivateInit&&this.onPrivateInit()}catch(t){console.error(this.entity,this.constructor.name,"onPrivateInit",t)}},e.prototype._init=function(){try{"function"==typeof this.onInit&&this.onInit()}catch(t){console.error(this.entity,this.constructor.name,"onInit",t)}},e.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(t){console.error(this.entity,this.constructor.name,"sleep",t)}},e}(Serializable);Component.register=function(t, e){void 0===e&&(e={});var r=e.properties;void 0===r&&(r=[]);var o=e.category;void 0===o&&(o="Other");var i=e.requirements;void 0===i&&(i=[]),assert(!componentClasses.has(t.name),"Duplicate component class "+t.name),t.propertyModels=r,t.category=o,t.requirements=i,propertyModels.forEach(function(e){Object.defineProperty(t.prototype,e.name,{get:function(){return this._properties[e.name].value},set:function(t){this._properties[e.name].value=t}})}),componentClasses.set(t.name,t)};var properties=[PropertyType("x",0,PropertyType.float),PropertyType("y",0,PropertyType.float)],Position=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Component);Component.register(Position,{properties:properties,category:"Core",requirements:[]});
//# sourceMappingURL=engine.min.js.map
