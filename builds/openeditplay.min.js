!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){"use strict";function t(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function e(t,e){for(var n=0,i=t.length,r=e.priority;n<i;){var o=n+i>>>1;t[o].priority<r?n=o+1:i=o}return n}function n(t,e){void 0===e&&(e=1),It[t]=(It[t]||0)+e}function i(t){Pt[t]=Tt.now()}function r(t){var e=Tt.now()-Pt[t];Et[t]?Et[t]+=e:Et[t]=e}function o(t){xt.shift(),xt.push(t)}function s(t,e){void 0===t&&(t="???"),void 0===e&&(e=16);for(var n=t,i=e-1;i>=0;--i)n+=At[kt()*Ot|0];return n}function a(t,e){for(var n=0,i=t.length,r=e.priority;n<i;){var o=n+i>>>1;t[o].priority<r?n=o+1:i=o}return n}function p(t){void 0!==Bt[t.id]&&w(!1,"Serializable id clash "+t.id),Bt[t.id]=t}function l(t){return Bt[t]||null}function c(t){delete Bt[t]}function h(){Ut=null}function u(){return Ut}function d(t){t!==Ut&&(Ut=t,jt&&t&&t!==Wt&&(console.log("origin",Wt),Wt=t),Vt&&setTimeout(h,0))}function f(t,e){if(w(Ut,"Change without origin!"),e.id){var n={type:t,reference:e,id:e.id,external:Gt,origin:Ut};t===Jt.setPropertyValue?n.value=e._value:t===Jt.move?n.parent=e._parent:t===Jt.addSerializableToTree&&(n.parent=e._parent,delete n.id),jt&&console.log("change",n);for(var i=Ut,r=0;r<qt.length;++r)qt[r](n);Ut!==i&&(jt&&console.log("origin changed from",i,"to",Ut&&Ut.constructor||Ut),Ut=i)}}function y(t){if(d("external"),Gt)return t();Gt=!0,t(),Gt=!1}function m(t){if(t.packedChange)return t.packedChange;var e={};try{t.parent&&(t.parentId=t.parent.id),t.type===Jt.addSerializableToTree?t.reference?t.value=t.reference.toJSON():w(!1,"invalid change of type addSerializableToTree",t):void 0!==t.value&&(t.value=t.reference.propertyType.type.toJSON(t.value)),Object.keys(Ft).forEach(function(n){if(void 0!==t[n]){if("type"===n&&t[n]===Jt.setPropertyValue)return;e[Ft[n]]=t[n]}})}catch(t){console.log("PACK ERROR",t)}return e}function v(t){var e={packedChange:t};if(Object.keys(t).forEach(function(n){var i=zt[n];e[i]=t[n]}),e.type||(e.type=Jt.setPropertyValue),e.type===Jt.addSerializableToTree)e.id=e.value.id;else{if(e.reference=l(e.id),!e.reference)return console.error("received a change with unknown id",e,"packed:",t),null;e.id=e.reference.id}return e.parentId&&(e.parent=l(e.parentId)),e}function g(t){var e;y(function(){if(t.type===Jt.setPropertyValue)t.reference.value=t.reference.propertyType.type.fromJSON(t.value);else if(t.type===Jt.addSerializableToTree)if(t.parent){var n=Lt.fromJSON(t.value);t.parent.addChild(n),"ent"===n.threeLetterType&&(n.localMaster=!1)}else{var n=Lt.fromJSON(t.value);"sce"===n.threeLetterType&&(e=n)}else t.type===Jt.deleteAllChildren?t.reference.deleteChildren():t.type===Jt.deleteSerializable?t.reference.delete():t.type===Jt.move&&t.reference.move(t.parent)}),e&&e.play()}function w(t,e){if(!t&&(console.log("Assert",e,(new Error).stack,"\norigin",u()),!window.force))throw new Error(e)}function T(t,e,n){for(var i=arguments,r=[],o=3;o<arguments.length;o++)r[o-3]=i[o];n=n();var s=n.validators.default(),a="",p=[],l=null;return r.forEach(function(t,e){"string"==typeof t?a=t:t&&t.validate?s=t:t&&t.isFlag?p.push(t):t&&t.visibleIf?l=t:w(!1,"invalid parameter "+t+" idx "+e)}),new Xt(t,n,s,e,a,p,l)}function _(t){var e=t.name,n=void 0===e?"":e,i=t.validators,r=void 0===i?{default:function(t){return t}}:i,o=t.toJSON,s=void 0===o?function(t){return t}:o,a=t.fromJSON,p=void 0===a?function(t){return t}:a,l=t.clone,c=void 0===l?function(t){return t}:l;w(n,"name missing from property type"),w("function"==typeof r.default,"default validator missing from property type: "+n),w("function"==typeof s,"invalid toJSON for property type: "+n),w("function"==typeof p,"invalid fromJSON for property type: "+n);var h={name:n,validators:r,toJSON:s,fromJSON:p,clone:c},u=function(){return h};return Object.keys(r).forEach(function(t){u[t]=C(t,r[t]),r[t]=u[t]}),u}function C(t,e){var n=function(){for(var n=arguments,i=[],r=0;r<arguments.length;r++)i[r-0]=n[r];var o=i,s=[null].concat(i);return{validatorName:t,validate:function(t){return s[0]=t,e.apply(null,s)},parameters:o}};return n.validatorName=t,n.validate=e,n}function b(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function S(t){var e=t.toString(16);return 1==e.length?"0"+e:e}function E(t,e,n){return"#"+S(t)+S(e)+S(n)}function P(t){if(isNaN(t)||t===1/0||t===-(1/0))throw new Error("Invalid float: "+t)}function I(t,e){for(var n in e)t.setAttributeNS(ye,n,e[n])}function x(t,e){for(var n in e)t.dataset[n]=e[n]}function N(t,e,n){for(var i=n,r=0;r<e.length;r++){var o=e[r];if(o){var s=Te(o);s!==i?Se(s)?he(t,o,i):null!=o.length&&(i=N(t,o,i)):i=i.nextSibling}}return i}function A(t){document.body.style.filter="contrast(70%) brightness(130%) saturate(200%) sepia(40%) hue-rotate(300deg)";var e=xe("div",t,{style:{position:"fixed",display:"inline-block","max-width":"600%",top:"20%",width:"100%",padding:"40px 10%","font-size":"20px","z-index":"100000",color:"white",background:"#0c0c0c","text-align":"center","user-select":"auto !important","box-sizing":"border-box"}});he(document.body,e)}function O(t){return Je||(Je=je.autoDetectRenderer({view:t,autoResize:!0,antialias:!0}),Je.plugins.interaction&&Je.plugins.interaction.destroy()),Je}function k(t){t.children.sort(D)}function D(t,e){return t.y<e.y?-1:t.y>e.y?1:0}function L(t){return Fe[t]}function M(t,e){if(!Fe[e]){var n=t.getLocalBounds(),i={x:-n.x/n.width,y:-n.y/n.height};Fe[e]={texture:Je.generateTexture(t,je.SCALE_MODES.LINEAR,2),anchor:i}}return Fe[e]}function R(){var t=document.createElement("canvas");t.width=1,t.height=10;var e=t.getContext("2d"),n=e.createLinearGradient(0,0,0,8);return n.addColorStop(0,"#5c77ff"),n.addColorStop(1,"#90c9f6"),e.fillStyle=n,e.fillRect(0,0,1,10),t}function B(t){t.canvas&&t.backgroundGradient&&(t.backgroundGradient.width=t.canvas.width,t.backgroundGradient.height=t.canvas.height)}function j(t,e){w(!t._p2World),t._p2World=new qe.World({gravity:[0,9.81]}),t._p2World.sleepMode=qe.World.BODY_SLEEPING}function V(t,e){t._p2World.step(Ze,e,5)}function J(t){t._p2World&&t._p2World.clear(),delete t._p2World,delete t._p2Materials}function F(t){return t._p2World}function z(t,e){t._p2World.addBody(e)}function U(t,e){t._p2World.removeBody(e)}function W(t,e){t._p2Materials||(t._p2Materials={});var n=t._p2Materials;e=Object.assign({},Xe,e);var i=[e.friction,e.restitution,e.stiffness,e.relaxation,e.frictionStiffness,e.frictionRelaxation,e.surfaceVelocity].join(";");if(n[i])return n[i];var r=new qe.Material;r.options=e,n[i]=r;for(var o in n){var s=n[o],a=r.options,p=s.options,l=new qe.ContactMaterial(r,s,{friction:Math.min(a.friction,p.friction),restitution:Math.max(a.restitution,p.restitution),stiffness:Math.min(a.stiffness,p.stiffness),relaxation:(a.relaxation+p.relaxation)/2,frictionStiffness:Math.min(a.frictionStiffness,p.frictionStiffness),frictionRelaxation:(a.frictionRelaxation+p.frictionRelaxation)/2,surfaceVelocity:Math.max(a.surfaceVelocity,p.surfaceVelocity)});t._p2World.addContactMaterial(l)}return r}function G(t){return Qe[t]||!1}function q(t){return $e.push(t),function(){return $e.splice($e.indexOf(t),1)}}function H(t,e){return t.addEventListener("mousemove",function(n){for(var i=n.pageX,r=n.pageY,o=t;null!=o;)i-=o.offsetLeft,r-=o.offsetTop,o=o.offsetParent;t._mx=i,t._my=r,e&&e(new Qt(i,r))}),function(){return t.removeEventListener("mousemove",e)}}function Y(t,e){return t.addEventListener("mousedown",function(n){"number"==typeof t._mx?e(new Qt(t._mx,t._my)):e()}),function(){return t.removeEventListener("mousedown",e)}}function Z(t,e){return document.body.addEventListener("mouseup",function(n){"number"==typeof t._mx?e(new Qt(t._mx,t._my)):e()}),function(){return t.removeEventListener("mouseup",e)}}function X(t,e){"keydown"===t?window.onkeydown({keyCode:e}):"keyup"===t&&window.onkeyup({keyCode:e})}function K(t){on.push(t),en&&t()}function Q(t,e,n,i){void 0===i&&(i=0);var r,o=t.getParentPrototype();r=o?Q(o,e,n,i+1):{};var s=t.getChildren("cda");n&&(s=s.filter(n));for(var a,p=0;p<s.length;++p){a=s[p],r[a.componentId]||(r[a.componentId]={ownComponentData:null,componentClass:a.componentClass,componentId:a.componentId,propertyHash:{},threeLetterType:"icd",generatedForPrototype:e}),0===i&&(r[a.componentId].ownComponentData=a);for(var l=r[a.componentId].propertyHash,c=a.getChildren("prp"),h=void 0,u=0;u<c.length;++u)h=c[u],l[h.name]=0===i?h:h.clone(!0)}return r}function $(t,e){return t.componentClass.componentName.localeCompare(e.componentClass.componentName)}function tt(t,e){return void 0===e&&(e=""),fn._propertyTypesByName.name.createProperty({value:e,predefinedId:t+"_n"})}function et(t){var e=new sn("Transform",t+"_t"),n=e.componentClass._propertyTypesByName.position.createProperty({value:new Qt(0,0),predefinedId:t+"_p"});e.addChild(n);var i=e.componentClass._propertyTypesByName.scale.createProperty({value:new Qt(1,1),predefinedId:t+"_s"});e.addChild(i);var r=e.componentClass._propertyTypesByName.angle.createProperty({value:0,predefinedId:t+"_a"});return e.addChild(r),e}function nt(t){return t>.5?(1-t)/.5:t>.2?1:5*t}function it(t){return t>.5?1:.5+t}function rt(t,e,n){void 0===e&&(e=0),void 0===n&&(n={r:255,g:255,b:255,a:1});var i=t+"-"+e+"-"+n.r+"-"+n.g+"-"+n.b+"-"+n.a;if(!Sn[i]){var r=document.createElement("canvas");r.width=t,r.height=t;var o=r.getContext("2d"),s=o.createRadialGradient(.5*t,.5*t,.5*t*e,.5*t,.5*t,.5*t);s.addColorStop(0,"rgba("+n.r+", "+n.g+", "+n.b+", "+n.a+")"),s.addColorStop(1,"rgba("+n.r+", "+n.g+", "+n.b+", 0)"),o.fillStyle=s,o.fillRect(0,0,t,t),Sn[i]=Ve.Texture.fromCanvas(r)}return Sn[i]}function ot(t,e){return t>e?e:t<-e?-e:t}function st(t){return"sce"===t.reference._rootType}function at(t){for(var e=window.location.search.substring(1),n=e.split("&"),i=0;i<n.length;i++){var r=n[i].split("=");if(decodeURIComponent(r[0])==t)return decodeURIComponent(r[1])}console.log("Query variable %s not found",t)}function pt(t){En.serverToClientEnabled&&t.forEach(function(t){(t=v(t))&&g(t)})}function lt(t){if(console.log("receive gameData",t),!t)return console.error("Game data was not received");try{y(function(){Lt.fromJSON(t)}),localStorage.openEditPlayGameId=t.id,history.replaceState({},null,"?gameId="+t.id)}catch(t){console.error("Game is corrupt.",t),A("Game is corrupt.")}}function ct(t,e){if(!xn)return console.log("Could not send",t);t?xn.emit(t,e):xn.emit(e)}function ht(){if(!window.io)return console.error("socket.io not defined after window load.");xn=new io,window.s=xn,xn.on("connect",function(){xn.onevent=function(t){var e=t.data[0];"string"==typeof e?Nn[e](t.data[1]):pt(e)},xn.on("disconnect",function(){console.warn("Disconnected!"),A("Disconnected!"),En.serverToClientEnabled=!1,En.clientToServerEnabled=!1})})}function ut(){function t(t){if(e){var n=window.innerWidth,i=window.innerHeight;if(t||n!==On||i!==kn){e.style.width=n+"px",e.style.height=i+"px";var r=n*i,o=1;r>Dn&&(o=Math.sqrt(Dn/r)),en.renderer.resize(n*o,i*o),window.scrollTo(0,0),On=n,kn=i,Ct.dispatch("canvas resize",en)}}}if(en){var e=document.getElementById("screen");t(!0),setTimeout(t,50),setTimeout(t,400),setTimeout(t,1e3)}}function dt(t){t.preventDefault();var e=ft(t);Vn.forEach(function(n){var i=!!e.find(function(t){return n.contains(t)});n.setState(i,"touchstart"===t.type)})}function ft(t){for(var e=[],n=0;n<t.targetTouches.length;++n){var i=t.targetTouches[n];e.push(new Qt(i.clientX,i.clientY))}return e}function yt(){if(en){var t=!1,e=!1,n=!1,i=!1;en.getComponents("CharacterController").forEach(function(r){"player"===r.type&&(t=!0,"jumper"===r.controlType?(e=!0,0!==r.jumpSpeed&&(n=!0)):"top down"===r.controlType&&(i=!0))}),Bn.touchUp.setVisible(i),Bn.touchLeft.setVisible(t),Bn.touchRight.setVisible(t),Bn.touchDown.setVisible(i),Bn.touchJump.setVisible(n),Bn.touchA.setVisible(!0),Bn.touchB.setVisible(!1),Bn.touchUp.visible&&Bn.touchDown.visible?(Bn.touchLeft.setPosition(10,null,60),Bn.touchRight.setPosition(110,null,60),Bn.touchUp.setPosition(60,null,110),Bn.touchDown.setPosition(60,null,10),Bn.touchLeft.setContainsFunction(function(t){var e=vt(t);return e.x<0&&Math.abs(e.x)>Math.abs(e.y)&&e.length()<=Rn}),Bn.touchUp.setContainsFunction(function(t){var e=vt(t);return e.y<0&&Math.abs(e.y)>Math.abs(e.x)&&e.length()<=Rn}),Bn.touchRight.setContainsFunction(function(t){var e=vt(t);return e.x>0&&Math.abs(e.x)>Math.abs(e.y)&&e.length()<=Rn}),Bn.touchDown.setContainsFunction(function(t){var e=vt(t);return e.y>0&&Math.abs(e.y)>Math.abs(e.x)&&e.length()<=Rn})):(Bn.touchLeft.setPosition(10,null,20),Bn.touchRight.setPosition(90,null,20),Bn.touchLeft.setContainsFunction(function(t){var e=vt(t);return e.x<=0&&e.y>-Rn}),Bn.touchRight.setContainsFunction(function(t){var e=vt(t);return e.x>0&&e.y>-Rn&&e.x<Rn}));var r=jn.filter(function(t){return t.visible});r.forEach(function(t,e){var n=r.length-1-e;t.setPosition(null,10+20*n,20+70*e),0===e?t.setContainsFunction(function(e){var n=t.getPosition();return e.x>=n.x-Ln/2-15&&e.y>=n.y-Ln/2}):t.setContainsFunction(function(e){var n=t.getPosition();return e.y>=n.y-Ln/2&&e.y<=n.y+Ln/2&&e.x>=n.x-Ln/2-15})})}}function mt(){var t=Bn.touchLeft.getPosition(),e=Bn.touchRight.getPosition();return t.add(e).divideScalar(2)}function vt(t){var e=mt();return t.clone().subtract(e)}var gt="undefined"!=typeof window,wt="undefined"!=typeof module;if(gt&&wt)throw new Error("Can not be client and server at the same time.");var Tt,_t={},Ct={listen:function(t,n,i){void 0===i&&(i=0),n.priority=i+bt++/St,_t.hasOwnProperty(t)||(_t[t]=[]);var r=e(_t[t],n);return _t[t].splice(r,0,n),function(){var e=_t[t].indexOf(n);_t[t].splice(e,1)}},dispatch:function(t){for(var e=arguments,n=[],i=1;i<arguments.length;i++)n[i-1]=e[i];if(_t.hasOwnProperty(t))for(var r=_t[t],o=0;o<r.length;++o)r[o].apply(null,n)},getEventPromise:function(t){return new Promise(function(e){Ct.listen(t,e)})}},bt=0,St=1e10;Tt=gt?window.performance:{now:Date.now};for(var Et={},Pt={},It={},xt=[],Nt=0;Nt<480;++Nt)xt.push(0);var At="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Ot=At.length,kt=Math.random,Dt=new Map,Lt=function(){function t(t,e){void 0===t&&(t=!1),void 0===e&&(e=!1),w(this.threeLetterType,"Forgot to Serializable.registerSerializable your class?"),this._children=new Map,this._listeners={},this._rootType=this.isRoot?this.threeLetterType:null,e||(this.id=t?t:s(this.threeLetterType),p(this))}return t.prototype.makeUpAName=function(){return"Serializable"},t.prototype.delete=function(){return this._parent?(this._parent.deleteChild(this),!1):(this.deleteChildren(),this._alive=!1,this._rootType=null,this._listeners={},c(this.id),this._state|=t.STATE_DESTROY,!0)},t.prototype.deleteChildren=function(){this._children.size&&(this._children.forEach(function(t){t.forEach(function(t){t._parent=null,t.delete()})}),this._children.clear(),this._parent&&f(Jt.deleteAllChildren,this))},t.prototype.initWithChildren=function(e){return void 0===e&&(e=[]),w(!(this._state&t.STATE_INIT),"init already done"),this._state|=t.STATE_INIT,e.length>0&&this.addChildren(e),this},t.prototype.addChildren=function(t){for(var e=this,n=0;n<t.length;n++)e.addChild(t[n]);return this},t.prototype.addChild=function(e){return this._addChild(e),this._state|=t.STATE_ADDCHILD,this._rootType&&f(Jt.addSerializableToTree,e),this},t.prototype._addChild=function(e){w(null===e._parent);var n=this._children.get(e.threeLetterType);return void 0===n&&(n=[],this._children.set(e.threeLetterType,n)),n.push(e),e._parent=this,e._state|=t.STATE_ADDPARENT,e._rootType!==this._rootType&&e.setRootType(this._rootType),this},t.prototype.findChild=function(t,e,n){void 0===n&&(n=!1);var i=this._children.get(t);if(!i)return null;if(e){var r=i.find(e);if(r)return r;if(n)for(var o=0;o<i.length;++o){var s=i[o],a=s.findChild(t,e,!0);if(a)return a}return null}return i[0]},t.prototype.findParent=function(t,e){void 0===e&&(e=null);for(var n=this;n;){if(n.threeLetterType===t&&(!e||e(n)))return n;n=n._parent}return null},t.prototype.getRoot=function(){for(var t=this;t._parent;)t=t._parent;return t},t.prototype.deleteChild=function(t,e){return f(Jt.deleteSerializable,t),this._detachChild(t,e),t.delete(),this},t.prototype._detachChild=function(t,e){void 0===e&&(e=0);var n=this._children.get(t.threeLetterType);return w(n,"child not found"),n[e]!==t&&(e=n.indexOf(t)),w(e>=0,"child not found"),n.splice(e,1),0===n.length&&this._children.delete(t.threeLetterType),t._parent=null,t.setRootType(null),this},t.prototype.forEachChild=function(t,e,n){function i(i){i.forEach(function(i){e(i),n&&i.forEachChild(t,e,!0)})}return void 0===t&&(t=null),void 0===n&&(n=!1),t?i(this._children.get(t)||[]):this._children.forEach(i),this},t.prototype.move=function(t){return t._addChild(this._detach()),f(Jt.move,this),this},t.prototype._detach=function(){return this._parent&&this._parent._detachChild(this),this},t.prototype.getParent=function(){return this._parent||null},t.prototype.getChildren=function(t){return this._children.get(t)||[]},t.prototype.toJSON=function(){var t=this,e={id:this.id};if(this._children.size>0){var n=[];Array.from(this._children.keys()).sort(function(t,e){return"prt"===t?-1:1}).forEach(function(e){return n.push(t._children.get(e))}),e.c=(i=[]).concat.apply(i,n).map(function(t){return t.toJSON()})}return e;var i},t.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},t.prototype.clone=function(){var e=new this.constructor,n=[];return this.forEachChild(null,function(t){n.push(t.clone())}),e.initWithChildren(n),this._state|=t.STATE_CLONE,e},t.prototype.listen=function(t,e,n){var i=this;void 0===n&&(n=0),e.priority=n+Mt++/Rt,this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]);var r=a(this._listeners[t],e);return this._listeners[t].splice(r,0,e),function(){if(i._alive){var n=i._listeners[t].indexOf(e);n>=0&&i._listeners[t].splice(n,1)}}},t.prototype.dispatch=function(t,e,i,r){var o=this,s=this._listeners[t];if(s){n("Event "+t,s.length);for(var a=0;a<s.length;a++)try{s[a](e,i,r)}catch(e){console.error("Event "+t+" listener crashed.",o._listeners[t][a],e)}}},t.prototype.hasDescendant=function(t){var e=this;if(!t)return!1;for(var n=t._parent;n;){if(n===e)return!0;n=n._parent}return!1},t.prototype.setRootType=function(t){if(this._rootType!==t){this._rootType=t;var e;this._children.forEach(function(n){for(e=0;e<n.length;++e)n[e].setRootType(t)})}},t.prototype.isInTree=function(){return!!this._rootType},t.fromJSON=function(e){w("string"==typeof e.id&&e.id.length>5,"Invalid id.");var n=Dt.get(e.id.substring(0,3));w(n);var i;try{i=n(e)}catch(t){if(gt){if(window.force,!window.force)throw new Error}else console.log("Error fromJSON",t);return null}var r=e.c?e.c.map(function(e){return t.fromJSON(e)}).filter(Boolean):[];return i._state&t.STATE_INIT?i.addChildren(r):i.initWithChildren(r),i._state|=t.STATE_FROMJSON,i},t.registerSerializable=function(t,e,n){void 0===n&&(n=null),t.prototype.threeLetterType=e,w("string"==typeof e&&3===e.length),n||(n=function(e){return new t(e.id)}),Dt.set(e,n)},t}();Lt.prototype._parent=null,Lt.prototype._alive=!0,Lt.prototype._state=0,Lt.prototype._rootType=null,Lt.STATE_INIT=2,Lt.STATE_ADDCHILD=4,Lt.STATE_ADDPARENT=8,Lt.STATE_CLONE=16,Lt.STATE_DESTROY=32,Lt.STATE_FROMJSON=64,Lt.prototype.isRoot=!1,Object.defineProperty(Lt.prototype,"debug",{get:function(){var t=this,e=this.threeLetterType;"cda"===this.threeLetterType&&(e+="|"+this.name),this._children.forEach(function(n,i){e+="|",e+="prp"===i?t.getChildren("prp").map(function(t){return t.name+"="+t._value}).join(", "):i+"("+n.length+")"}),e+="|state: ";var n=[],i=function(e,i){t._state&e&&n.push(i)};return i(Lt.STATE_INIT,"init"),i(Lt.STATE_ADDCHILD,"add child"),i(Lt.STATE_ADDPARENT,"add parent"),i(Lt.STATE_CLONE,"clone"),i(Lt.STATE_DESTROY,"destroy"),i(Lt.STATE_FROMJSON,"from json"),e+=n.join(", ")}}),Object.defineProperty(Lt.prototype,"debugChildren",{get:function(){function t(t){return new function(){}}var e=[];this._children.forEach(function(t,n){e=e.concat(t)});var n=[];return e.forEach(function(e){var i=t(e.threeLetterType);i.debug=e.debug,i.ref=e,i.debugChildren=e.debugChildren;var r=e.debugChildArray;r&&r.length>0&&(i.children=r),n.push(i)}),n}});var Mt=0,Rt=1e10,Bt={},jt=0,Vt=0,Jt={addSerializableToTree:"a",setPropertyValue:"s",deleteSerializable:"d",move:"m",deleteAllChildren:"c"},Ft={id:"i",type:"t",value:"v",parentId:"p"},zt={};Object.keys(Ft).forEach(function(t){zt[Ft[t]]=t});var Ut,Wt,Gt=!1,qt=[],Ht=!0,Yt=null,Zt=function(e){function n(t){var n=t.value,i=t.predefinedId,r=t.name,o=t.propertyType,s=t.skipSerializableRegistering,a=void 0!==s&&s;w(r,"Property without a name can not exist"),e.call(this,i,a),this._initialValue=n,o?this.setPropertyType(o):(this.name=r,this._initialValueIsJSON=!0)}return t(n,e),n.prototype.makeUpAName=function(){return this.name},n.prototype.setPropertyType=function(t){this.propertyType=t;try{void 0!==this._initialValue?this.value=this._initialValueIsJSON?t.type.fromJSON(this._initialValue):this._initialValue:this.value=t.initialValue}catch(e){console.log("Invalid value",e,t,this),this.value=t.initialValue}this.name=t.name},n.prototype.clone=function(t){return void 0===t&&(t=!1),new n({value:this.propertyType.type.clone(this.value),name:this.name,propertyType:this.propertyType,skipSerializableRegistering:t})},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{v:this.type.toJSON(this.value),n:this.propertyType.name})},n}(Lt);Zt.prototype.propertyType=null,Object.defineProperty(Zt.prototype,"type",{get:function(){return this.propertyType.type}}),Object.defineProperty(Zt.prototype,"value",{set:function(t){this._value=this.propertyType.validator.validate(t),this.dispatch("change",this._value),Ht&&this._rootType&&(null===Yt||"sce"!==this._rootType||Yt(this))&&f(Jt.setPropertyValue,this)},get:function(){return this._value}}),Lt.registerSerializable(Zt,"prp",function(t){return new Zt({value:t.v,predefinedId:t.id,name:t.n})}),Object.defineProperty(Zt.prototype,"debug",{get:function(){return"prp "+this.name+"="+this.value}});var Xt=function(){function t(t,e,n,i,r,o,s){var a=this;void 0===o&&(o=[]),w("string"==typeof t),w(t[0]>="a"&&t[0]<="z","Name of a property must start with lower case letter."),w(e&&"string"==typeof e.name),w(n&&"function"==typeof n.validate),this.name=t,this.type=e,this.validator=n,this.initialValue=i,this.description=r,this.visibleIf=s,this.flags={},o.forEach(function(t){return a.flags[t.type]=t})}return t.prototype.getFlag=function(t){return this.flags[t.type]},t.prototype.createProperty=function(t){var e=void 0===t?{}:t,n=e.value,i=e.predefinedId,r=e.skipSerializableRegistering,o=void 0!==r&&r;return new Zt({propertyType:this,value:n,predefinedId:i,name:this.name,skipSerializableRegistering:o})},t}(),Kt=T;Kt.visibleIf=function(t,e){return w("string"==typeof t&&t.length),w(void 0!==e),{visibleIf:!0,propertyName:t,values:Array.isArray(e)?e:[e]}},T.flagDegreesInEditor=function(t,e){return void 0===e&&(e={}),e.isFlag=!0,e.type=t,e}("degreesInEditor");var Qt=function(){function t(t,e){this.x=t||0,this.y=e||0}return t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},t.prototype.addScalars=function(t,e){return this.x+=t,this.y+=e,this},t.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},t.prototype.subtractScalars=function(t,e){return this.x-=t,this.y-=e,this},t.prototype.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},t.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this},t.prototype.divide=function(t){return this.x/=t.x,this.y/=t.y,this},t.prototype.divideScalar=function(t){return this.x/=t,this.y/=t,this},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.lengthSq=function(){return this.x*this.x+this.y*this.y},t.prototype.setLength=function(t){var e=this.length();return 0===e?(this.x=t,this.y=0):this.multiplyScalar(t/e),this},t.prototype.getProjectionOn=function(t){var e=t.length();return 0===e?this.clone():t.clone().multiplyScalar(this.dot(t)/(e*e))},t.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},t.prototype.distanceSq=function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n},t.prototype.normalize=function(){return this.setLength(1)},t.prototype.horizontalAngle=function(){return Math.atan2(this.y,this.x)},t.prototype.verticalAngle=function(){return Math.atan2(this.x,this.y)},t.prototype.rotate=function(t){var e=this.x*Math.cos(t)-this.y*Math.sin(t);return this.y=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=e,this},t.prototype.rotateTo=function(t){return this.rotate(t-this.verticalAngle())},t.prototype.isEqualTo=function(t){return this.x===t.x&&this.y===t.y},t.prototype.isZero=function(){return!this.x&&!this.y},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.set=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.setScalars=function(t,e){return this.x=t,this.y=e,this},t.prototype.toString=function(){return"["+this.x+", "+this.y+"]"},t.prototype.toArray=function(){return[this.x,this.y]},t}();Qt.fromObject=function(t){return new Qt(t.x,t.y)},Qt.fromArray=function(t){return new Qt(t[0],t[1])};var $t=function(){function t(e,n,i){if(e&&e.constructor===t)this.r=e.r,this.g=e.g,this.b=e.b;else if("number"==typeof e)this.r=e,this.g=n,this.b=i;else if("string"==typeof e){var r=b(e);this.r=r.r,this.g=r.g,this.b=r.b}else w(!1,"Invalid Color parameters")}return t.prototype.toHexString=function(){return E(this.r,this.g,this.b)},t.prototype.toHexNumber=function(){return 256*this.r*256+256*this.g+this.b},t.prototype.toString=function(){return"["+this.r+","+this.g+","+this.b+"]"},t}(),te=Math.pow(10,4);Kt.float=_({name:"float",validators:{default:function(t){return t=parseFloat(t),P(t),t},range:function(t,e,n){return t=parseFloat(t),P(t),Math.min(n,Math.max(e,t))},modulo:function(t,e,n){t=parseFloat(t),P(t);var i=n-e;return t<e?t+=(1+((e-t)/i|0))*i:t>n-1e-7&&(t-=(1+((t-n)/i|0))*i),t}},toJSON:function(t){return Math.round(t*te)/te},fromJSON:function(t){return t}}),Kt.int=_({name:"int",validators:{default:function(t){return t=parseInt(t),P(t),t},range:function(t,e,n){return t=parseInt(t),P(t),Math.min(n,Math.max(e,t))}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Kt.vector=_({name:"vector",validators:{default:function(t){if(!(t instanceof Qt))throw new Error;return t=t.clone(),t.x=parseFloat(t.x),t.y=parseFloat(t.y),P(t.x),P(t.y),t}},toJSON:function(t){return{x:Math.round(t.x*te)/te,y:Math.round(t.y*te)/te}},fromJSON:function(t){return Qt.fromObject(t)},clone:function(t){return t.clone()}}),Kt.string=_({name:"string",validators:{default:function(t){return t?String(t):""}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Kt.bool=_({name:"bool",validators:{default:function(t){if("boolean"!=typeof t)throw new Error;return t}},toJSON:function(t){return t?1:0},fromJSON:function(t){return!!t}}),Kt.enum=_({name:"enum",validators:{default:function(){w(!1,"also specify enum values with Prop.enum.values('value1', 'value2', ...)")},values:function(t){for(var e=arguments,n=[],i=1;i<arguments.length;i++)n[i-1]=e[i];if(!Array.isArray(n))throw new Error;if("string"!=typeof t)throw new Error("val should be string");if(n.indexOf(t)<0)throw new Error("value "+t+" not in enum: ["+n+"]");return t}},toJSON:function(t){return t},fromJSON:function(t){return t}}),Kt.color=_({name:"color",validators:{default:function(t){var e=new $t(t);return w(e.r>=0&&e.r<256),w(e.g>=0&&e.g<256),w(e.b>=0&&e.b<256),e}},toJSON:function(t){return t.toHexString()},fromJSON:function(t){return new $t(t)}});var ee=function(e){function n(t){void 0===t&&(t=!1),e.call(this,t),w(Array.isArray(this.constructor._propertyTypes),"call PropertyOwner.defineProperties after class definition"),this._properties={}}return t(n,e),n.prototype.makeUpAName=function(){return this.name||"PropertyOwner"},n.prototype.initWithPropertyValues=function(t){var e=this;void 0===t&&(t={});var n=[];return Object.keys(t).forEach(function(i){var r=e.constructor._propertyTypesByName[i];w(r,"Invalid property "+i),n.push(r.createProperty({value:t[i]}))}),this.initWithChildren(n),this},n.prototype.initWithChildren=function(t){var n=this;void 0===t&&(t=[]),w(!(this._state&Lt.STATE_INIT),"init already done"),this._state|=Lt.STATE_INIT;var i=[],r=[];t.forEach(function(t){"prp"===t.threeLetterType?i.push(t):r.push(t)}),e.prototype.addChildren.call(this,r);var o=0;i.filter(function(t){return!t.propertyType}).forEach(function(t){var e=n.constructor._propertyTypesByName[t.name];if(!e)return console.log("Property of that name not defined",n.id,t.name,n),o++,void(t.isInvalid=!0);t.setPropertyType(e)}),o&&(i=i.filter(function(t){return!t.isInvalid}));var s={};return i.forEach(function(t){return s[t.name]=t}),this.constructor._propertyTypes.forEach(function(t){s[t.name]||i.push(t.createProperty())}),e.prototype.addChildren.call(this,i),this},n.prototype.addChild=function(t){if(w(this._state&Lt.STATE_INIT,this.constructor.componentName||this.constructor+" requires that initWithChildren will be called before addChild"),e.prototype.addChild.call(this,t),"prp"===t.threeLetterType){if(!t.propertyType){if(!this.constructor._propertyTypesByName[t.name])return void console.log("Property of that name not defined",this.id,t,this);t.setPropertyType(this.constructor._propertyTypesByName[t.name])}w(void 0===this._properties[t.propertyType.name],"Property already added"),this._properties[t.propertyType.name]=t}return this},n.prototype.createPropertyHash=function(){return this.getChildren("prp").map(function(t){return""+t._value}).join(",")},n.prototype.delete=function(){return!!e.prototype.delete.call(this)&&(this._properties={},!0)},n.prototype.deleteChild=function(t,n){return w("prp"!==t.threeLetterType,"Can not delete just one Property child."),e.prototype.deleteChild.call(this,t,n),this},n}(Lt);ee.defineProperties=function(t,e){t._propertyTypes=e,t._propertyTypesByName={},e.forEach(function(e){var n=e.name;w(void 0===t.prototype[n],"Property name "+n+" clashes"),t._propertyTypesByName[n]=e,Object.defineProperty(t.prototype,n,{get:function(){return this._properties[n].value},set:function(t){this._properties[n].value=t}})})};var ne="#".charCodeAt(0),ie=".".charCodeAt(0),re=function(t){for(var e=null,n=null,i=null,r=0,o=0,s=0;s<=t.length;s++){var a=t.charCodeAt(s),p=a===ne,l=a===ie,c=!a;(p||l||c)&&(0===r?e=0===s?"div":t.substring(o,s):1===r?n=t.substring(o,s):i?i+=" "+t.substring(o,s):i=t.substring(o,s),p?r=1:l&&(r=2),o=s+1)}return{tag:e,id:n,className:i}},oe=function(t,e){var n=re(t),i=n.tag,r=n.id,o=n.className,s=e?document.createElementNS(e,i):document.createElement(i);return r&&(s.id=r),o&&(e?s.setAttribute("class",o):s.className=o),s},se=function(t,e){var n=Te(t),i=Te(e);return e===i&&i.__redom_view&&(e=i.__redom_view),i.parentNode&&(ae(e,i,n),n.removeChild(i)),e},ae=function(t,e,n){var i=e.__redom_lifecycle;if(pe(i))return void(e.__redom_mounted=!1);var r=n;for(e.__redom_mounted&&de(e,"onunmount");r;){var o=r.__redom_lifecycle||{};for(var s in i)o[s]&&(o[s]-=i[s]);pe(o)&&(r.__redom_lifecycle=null),r=r.parentNode}},pe=function(t){if(null==t)return!0;for(var e in t)if(t[e])return!1;return!0},le=["onmount","onunmount"],ce="undefined"!=typeof window&&"ShadowRoot"in window,he=function(t,e,n){var i=Te(t),r=Te(e);e===r&&r.__redom_view&&(e=r.__redom_view),e!==r&&(r.__redom_view=e);var o=r.__redom_mounted,s=r.parentNode;return o&&s!==i&&ae(e,r,s),null!=n?i.insertBefore(r,Te(n)):i.appendChild(r),ue(e,r,i,s),e},ue=function(t,e,n,i){for(var r=e.__redom_lifecycle||(e.__redom_lifecycle={}),o=n===i,s=!1,a=0;a<le.length;a++){var p=le[a];!o&&t!==e&&p in t&&(r[p]=(r[p]||0)+1),r[p]&&(s=!0)}if(!s)return void(e.__redom_mounted=!0);var l=n,c=!1;if((o||!c&&l&&l.__redom_mounted)&&(de(e,o?"onremount":"onmount"),c=!0),!o)for(;l;){
var h=l.parentNode,u=l.__redom_lifecycle||(l.__redom_lifecycle={});for(var d in r)u[d]=(u[d]||0)+r[d];!c&&(l===document||ce&&l instanceof window.ShadowRoot||h&&h.__redom_mounted)&&(de(l,o?"onremount":"onmount"),c=!0),l=h}},de=function(t,e){"onmount"===e?t.__redom_mounted=!0:"onunmount"===e&&(t.__redom_mounted=!1);var n=t.__redom_lifecycle;if(n){var i=t.__redom_view,r=0;i&&i[e]&&i[e]();for(var o in n)o&&r++;if(r)for(var s=t.firstChild;s;){var a=s.nextSibling;de(s,e),s=a}}},fe=function(t,e,n){var i=Te(t);if(void 0!==n)i.style[e]=n;else if(_e(e))i.setAttribute("style",e);else for(var r in e)fe(i,r,e[r])},ye="http://www.w3.org/1999/xlink",me=function(t,e,n){var i=Te(t),r=i instanceof SVGElement;if(void 0!==n)if("style"===e)fe(i,n);else if(r&&be(n))i[e]=n;else if("dataset"===e)x(i,n);else if(!r&&(e in i||be(n)))i[e]=n;else{if(r&&"xlink"===e)return void I(i,n);i.setAttribute(e,n)}else for(var o in e)me(i,o,e[o])},ve=function(t){return document.createTextNode(null!=t?t:"")},ge=function(t,e){for(var n=0;n<e.length;n++){var i=e[n];(0===i||i)&&("function"==typeof i?i(t):_e(i)||Ce(i)?t.appendChild(ve(i)):Se(Te(i))?he(t,i):i.length?ge(t,i):"object"==typeof i&&me(t,i))}},we=function(t){return _e(t)?Ie(t):Te(t)},Te=function(t){return t.nodeType&&t||!t.el&&t||Te(t.el)},_e=function(t){return"string"==typeof t},Ce=function(t){return"number"==typeof t},be=function(t){return"function"==typeof t},Se=function(t){return t&&t.nodeType},Ee={},Pe=function(t){return Ee[t]||(Ee[t]=oe(t))},Ie=function(t){for(var e=arguments,n=[],i=arguments.length-1;i-- >0;)n[i]=e[i+1];var r;if(_e(t))r=Pe(t).cloneNode(!1);else{if(!Se(t))throw new Error("At least one argument required");r=t.cloneNode(!1)}return ge(r,n),r};Ie.extend=function(t){for(var e=arguments,n=[],i=arguments.length-1;i-- >0;)n[i]=e[i+1];var r=Pe(t);return Ie.bind.apply(Ie,[this,r].concat(n))};var xe=Ie,Ne=function(t){for(var e=arguments,n=[],i=arguments.length-1;i-- >0;)n[i]=e[i+1];for(var r=Te(t),o=N(t,n,r.firstChild);o;){var s=o.nextSibling;se(t,o),o=s}},Ae=function(t){return function(e){return e[t]}},Oe=function(t,e,n){this.View=t,this.initData=n,this.oldLookup={},this.lookup={},this.oldViews=[],this.views=[],null!=e&&(this.lookup={},this.key=be(e)?e:Ae(e))};Oe.prototype.update=function(t,e){for(var n=this,i=n.View,r=n.key,o=n.initData,s=null!=r,a=this.lookup,p={},l=new Array(t.length),c=this.views,h=0;h<t.length;h++){var u=t[h],d=void 0;if(s){var f=r(u);d=a[f]||new i(o,u,h,t),p[f]=d,d.__redom_id=f}else d=c[h]||new i(o,u,h,t);d.update&&d.update(u,h,t,e);Te(d.el).__redom_view=d,l[h]=d}this.oldViews=c,this.views=l,this.oldLookup=a,this.lookup=p};var ke=function(t,e,n,i){return new De(t,e,n,i)},De=function(t,e,n,i){this.__redom_list=!0,this.View=e,this.initData=i,this.views=[],this.pool=new Oe(e,n,i),this.el=we(t),this.keySet=null!=n};De.prototype.update=function(t,e){var n=this;void 0===t&&(t=[]);var i=this,r=i.keySet,o=this.views,s=r&&this.lookup;this.pool.update(t,e);var a=this.pool,p=a.views,l=a.lookup;if(r)for(var c=0;c<o.length;c++){var h=o[c].__redom_id;h in l||se(n,s[h])}Ne(this,p),r&&(this.lookup=l),this.views=p},De.extend=function(t,e,n,i){return De.bind(De,t,e,n,i)},ke.extend=De.extend,function(t,e){this.el=ve(""),this.visible=!1,this.view=null,this._placeholder=this.el,t instanceof Node?this._el=t:this._View=t,this._initData=e}.prototype.update=function(t,e){var n=this._placeholder,i=this.el.parentNode;if(t){if(!this.visible){if(this._el)return he(i,this._el,n),se(i,n),this.el=this._el,void(this.visible=t);var r=this._View,o=new r(this._initData);this.el=Te(o),this.view=o,he(i,o,n),se(i,n)}this.view&&this.view.update&&this.view.update(e)}else if(this.visible){if(this._el)return he(i,n,this._el),se(i,this._el),this.el=n,void(this.visible=t);he(i,n,this.view),se(i,this.view),this.el=n,this.view=null}this.visible=t},function(t,e,n){this.el=we(t),this.Views=e,this.initData=n}.prototype.update=function(t,e){if(t!==this.route){var n=this.Views,i=n[t];this.route=t,this.view=i&&new i(this.initData,e),Ne(this.el,[this.view])}this.view&&this.view.update&&this.view.update(e,t)};var Le="http://www.w3.org/2000/svg",Me={},Re=function(t){return Me[t]||(Me[t]=oe(t,Le))},Be=function(t){for(var e=arguments,n=[],i=arguments.length-1;i-- >0;)n[i]=e[i+1];var r;if(_e(t))r=Re(t).cloneNode(!1);else{if(!Se(t))throw new Error("At least one argument required");r=t.cloneNode(!1)}return ge(r,n),r};Be.extend=function(t){var e=Re(t);return Be.bind(this,e)},Be.ns=Le,window.sticky=A;var je;gt&&(je=window.PIXI,je.ticker.shared.stop());var Ve=je,Je=null,Fe={};Ct.listen("scene load level",function(t){var e=R(),n=new Ve.Sprite(Ve.Texture.fromCanvas(e));t.backgroundGradient=n,B(t),t.layers.static.addChild(n)}),Ct.listen("scene unload level",function(t){delete t.backgroundGradient}),Ct.listen("canvas resize",function(t){B(t)});var ze=[T("name","No name",T.string)],Ue=null,We="undefined"!=typeof window,Ge=function(e){function n(t){Ue&&console.error("Only one game allowed."),e.apply(this,arguments),We&&(Ue=this),setTimeout(function(){He.forEach(function(t){return t(Ue)})},1)}return t(n,e),n.prototype.initWithChildren=function(){e.prototype.initWithChildren.apply(this,arguments),f(Jt.addSerializableToTree,this)},n.prototype.delete=function(){return f(Jt.deleteSerializable,this),!!e.prototype.delete.call(this)&&(Ue===this&&(Ue=null),A("Game deleted"),!0)},n}(ee);ee.defineProperties(Ge,ze),Ge.prototype.isRoot=!0,Lt.registerSerializable(Ge,"gam",function(t){return t.c&&t.c.sort(function(t,e){return t.id.startsWith("prt")||t.id.startsWith("pfa")?-1:1}),new Ge(t.id)});var qe,He=[];qe=gt?window.p2:require("../src/external/p2");var Ye=qe,Ze=1/60,Xe={friction:.3,restitution:0,stiffness:1e6,relaxation:4,frictionStiffness:1e6,frictionRelaxation:4,surfaceVelocity:0},Ke={left:37,right:39,up:38,down:40,ctrl:17,appleLeft:91,appleRight:93,alt:18,shift:16,space:32,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,backspace:8,enter:13,esc:27,plus:187,minus:189,questionMark:191},Qe={},$e=[],tn=[];"undefined"!=typeof window&&(window.onkeydown=function(t){var e=t.which||t.keyCode;"input"==document.activeElement.nodeName.toLowerCase()&&e!==Ke.esc||Qe[e]||(Qe[e]=!0,$e.forEach(function(t){return t(e)}))},window.onkeyup=function(t){var e=t.which||t.keyCode;Qe[e]=!1,tn.forEach(function(t){return t(e)})});var en=null,nn={enableSleeping:!0},rn=function(e){function s(t){var n=this;if(void 0===t&&(t=!1),e.call(this,t),en)try{en.delete()}catch(t){console.warn("Deleting old scene failed",t)}en=this,window.scene=this,this.canvas=document.querySelector("canvas.openEditPlayCanvas"),this.renderer=O(this.canvas),this.mouseListeners=[H(this.canvas,function(t){return n.dispatch("onMouseMove",t)}),Y(this.canvas,function(t){return n.dispatch("onMouseDown",t)}),Z(this.canvas,function(t){return n.dispatch("onMouseUp",t)})],f(Jt.addSerializableToTree,this),on.forEach(function(t){return t()})}return t(s,e),s.prototype.makeUpAName=function(){return this.level?this.level.makeUpAName():"Scene"},s.prototype.loadLevel=function(t){function e(t){void 0===t&&(t=i.stage);var e=new Ve.Container;return t.addChild(e),e}var n=this;this.level=t,this.stage=new Ve.Container,this.cameraPosition=new Qt(0,0),this.cameraZoom=1;var i=this;this.layers={static:e(),background:e(),move:e(),ui:e()},this.layers.behind=e(this.layers.move),this.layers.main=e(this.layers.move),this.layers.front=e(this.layers.move),this.components=new Map,this.animationFrameId=null,this.playing=!1,this.time=0,this.won=!1,j(this,nn),Ct.dispatch("scene load level before entities",en,t),this.level.getChildren("epr").map(function(t){return t.createEntity(n)}),Ct.dispatch("scene load level",en,t)},s.prototype.unloadLevel=function(){var t=this.level;this.level=null,this.pause(),this.deleteChildren(),this.stage&&this.stage.destroy(),this.stage=null,this.layers=null,this.components.clear(),J(this),Ct.dispatch("scene unload level",en,t)},s.prototype.setCameraPositionToPlayer=function(){var t=new Qt(0,0),e=0;this.getComponents("CharacterController").forEach(function(n){n._rootType&&(t.add(n.Transform.position),e++)}),e>0&&this.cameraPosition.set(t.divideScalar(e))},s.prototype.updateCamera=function(){this.playing&&this.setCameraPositionToPlayer(),this.layers.move.pivot.set(this.cameraPosition.x-this.canvas.width/2/this.cameraZoom,this.cameraPosition.y-this.canvas.height/2/this.cameraZoom),this.layers.move.scale.set(this.cameraZoom,this.cameraZoom)},s.prototype.win=function(){this.won=!0},s.prototype.animFrame=function(){if(this.animationFrameId=null,this._alive&&this.playing){var t=performance.now(),e=.001*t,n=e-this._prevUpdate;o(n),n>.05&&(n=.05),this._prevUpdate=e,this.time+=n,d(this),i("Component updates"),this.dispatch("onUpdate",n,this.time),r("Component updates"),i("Physics"),V(this,n),r("Physics"),i("Draw"),this.draw(),r("Draw"),this.won&&(this.pause(),this.time=0,Ue.dispatch("levelCompleted"),this.reset()),this.requestAnimFrame()}},s.prototype.requestAnimFrame=function(){var t=this,e=function(){return t.animFrame()};window.requestAnimationFrame?this.animationFrameId=window.requestAnimationFrame(e):this.animationFrameId=setTimeout(e,16)},s.prototype.draw=function(){this.updateCamera(),[this.layers.behind,this.layers.main,this.layers.front].forEach(k),this.renderer.render(this.stage,null,!1),Ct.dispatch("scene draw",en),n("Draws")},s.prototype.isInInitialState=function(){return!this.playing&&0===this.time},s.prototype.reset=function(){if(this._alive){this.resetting=!0;var t=this.level;this.unloadLevel(),t&&this.loadLevel(t),delete this.resetting,this.dispatch("reset")}},s.prototype.pause=function(){this.playing&&(this.playing=!1,this.animationFrameId&&(window.requestAnimationFrame?window.cancelAnimationFrame(this.animationFrameId):clearTimeout(this.animationFrameId)),this.animationFrameId=null,this.dispatch("pause"))},s.prototype.play=function(){this.playing||(this._prevUpdate=.001*performance.now(),this.playing=!0,this.requestAnimFrame(),0===this.time&&this.dispatch("onStart"),this.dispatch("play"))},s.prototype.delete=function(){return!!e.prototype.delete.call(this)&&(this.unloadLevel(),en===this&&(en=null),this.mouseListeners&&(this.mouseListeners.forEach(function(t){return t()}),this.mouseListeners=null),this.renderer=null,!0)},s.prototype.addComponent=function(t){var e=this.components.get(t.constructor.componentName);e||(e=new Set,this.components.set(t.constructor.componentName,e)),e.add(t)},s.prototype.removeComponent=function(t){var e=this.components.get(t.constructor.componentName);w(e),w(e.delete(t))},s.prototype.getComponents=function(t){return this.components.get(t)||new Set},s.prototype.mouseToWorld=function(t){return new Qt(this.layers.move.pivot.x+t.x/this.cameraZoom,this.layers.move.pivot.y+t.y/this.cameraZoom)},s.prototype.setZoom=function(t){t&&(this.cameraZoom=t),this.dispatch("zoomChange",this.cameraZoom)},s}(Lt);rn.prototype.isRoot=!0,Lt.registerSerializable(rn,"sce");var on=[],sn=function(e){function n(t,n,i){void 0===n&&(n=!1),void 0===i&&(i=!1),e.call(this,n),this.name=t,this.componentClass=an.get(this.name),w(this.componentClass,"Component class not defined: "+t),this.componentClass.allowMultiple||(i="_"+t),this.componentId=i||s("cid",10)}return t(n,e),n.prototype.makeUpAName=function(){return this.name},n.prototype.addChild=function(t){if("prp"===t.threeLetterType&&!t.propertyType){if(!this.componentClass._propertyTypesByName[t.name])return void(gt?console.log("Property of that name not defined",this.id,t,this):console.log("Property of that name not defined",this.id,this.name,t.name));t.setPropertyType(this.componentClass._propertyTypesByName[t.name])}return e.prototype.addChild.call(this,t),this},n.prototype.clone=function(t){var e=!(!t||!t.cloneComponentId)&&this.componentId,i=new n(this.name,!1,e),r=[];return this.forEachChild(null,function(t){r.push(t.clone())}),i.initWithChildren(r),this._state|=Lt.STATE_CLONE,i},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{cid:this.componentId,n:this.name})},n.prototype.getInheritedProperties=function(t){void 0===t&&(t=0);var e={},n=this.getParentComponentData();return n&&n.getInheritedProperties(t+1).forEach(function(t){return e[t.name]=t}),this.getChildren("prp").forEach(function(n){e[n.name]=0===t?n:n.clone(!0)}),0===t?this.componentClass._propertyTypes.map(function(t){return e[t.name]||t.createProperty({skipSerializableRegistering:!0})}):Object.keys(e).map(function(t){return e[t]})},n.prototype.getParentComponentData=function(){var t=this;if(!this._parent)return null;for(var e=this._parent.getParentPrototype();e;){var n=e.findChild("cda",function(e){return e.componentId===t.componentId});if(n)return n;e=e.getParentPrototype()}return null},n.prototype.getPropertyOrCreate=function(t){var e=this.findChild("prp",function(e){return e.name===t});return e||(e=this.componentClass._propertyTypesByName[t].createProperty(),this.addChild(e)),e},n.prototype.getProperty=function(t){return this.findChild("prp",function(e){return e.name===t})},n.prototype.setValue=function(t,e){return this.getPropertyOrCreate(t).value=e,this},n.prototype.getValue=function(t){var e=this.getProperty(t);if(e)return e.value;var n=this.getParentComponentData();return n?n.getValue(t):this.componentClass._propertyTypesByName[t].initialValue},n.prototype.createComponent=function(){var t=this.getInheritedProperties(),e={};t.forEach(function(t){e[t.name]=t.value});var n=ln.create(this.name,e);return n._componentId=this.componentId,n},n}(Lt);Lt.registerSerializable(sn,"cda",function(t){return new sn(t.n,t.id,t.cid)});var an=new Map,pn=["onUpdate","onStart"],ln=function(e){function n(t){void 0===t&&(t=!1),e.call(this,t),this._componentId=null,this.scene=en,this.game=Ue,this._listenRemoveFunctions=[],this.entity=null}return t(n,e),n.prototype.makeUpAName=function(){return self.constructor.componentName},n.prototype.delete=function(){return this._parent=null,this.entity=null,e.prototype.delete.call(this),!0},n.prototype._addEventListener=function(t){var e=this[t],n=this,o="Component: "+n.constructor.componentName;this._listenRemoveFunctions.push(this.scene.listen(t,function(){i(o),e.apply(n,arguments),r(o)}))},n.prototype._preInit=function(){var t=this,e=this;this.constructor.requirements.forEach(function(t){e[t]=e.entity.getComponent(t),w(e[t],e.constructor.componentName+" requires component "+t+" but it is not found")}),this.forEachChild("com",function(t){return t._preInit()});for(var n=0;n<pn.length;++n)"function"==typeof t[pn[n]]&&t._addEventListener(pn[n]);"Transform"!==this.constructor.componentName&&this.scene&&this.scene.addComponent(this);try{"function"==typeof this.preInit&&this.preInit()}catch(t){console.error(this.entity,this.constructor.componentName,"preInit",t)}},n.prototype._init=function(){this.forEachChild("com",function(t){return t._init()});try{"function"==typeof this.init&&this.init()}catch(t){console.error(this.entity,this.constructor.componentName,"init",t)}},n.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(t){console.error(this.entity,this.constructor.componentName,"sleep",t)}"Transform"!==this.constructor.componentName&&this.scene&&this.scene.removeComponent(this),this.forEachChild("com",function(t){return t._sleep()}),this._listenRemoveFunctions.forEach(function(t){return t()}),this._listenRemoveFunctions.length=0},n.prototype.listenProperty=function(t,e,n){this._listenRemoveFunctions.push(t._properties[e].listen("change",n))},n.prototype.createComponentData=function(){var t=this,e=this.constructor.componentName,n=this.constructor._propertyTypes,i=new sn(e),r=[];return n.forEach(function(e){r.push(e.createProperty({value:t[e.name]}))}),i.initWithChildren(r),i},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{n:this.constructor.componentName,cid:this._componentId})},n}(ee);ln.create=function(t,e){void 0===e&&(e={});var n=an.get(t);w(n);var i=new n;return i.initWithPropertyValues(e),i},ln.createWithInheritedComponentData=function(t){var e=new t.componentClass;e._componentId=t.componentId;var n=t.properties.map(function(t){return t.clone()});return e.initWithChildren(n),e},ln.reservedPropertyNames=new Set(["id","constructor","delete","children","entity","env","init","preInit","sleep","toJSON","fromJSON"]),ln.reservedPrototypeMembers=new Set(["id","children","entity","env","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentData","toJSON","fromJSON"]),ln.register=function(e){var n=e.name,i=void 0===n?"":n,r=e.description,o=void 0===r?"":r,s=e.category,a=void 0===s?"Other":s,p=e.icon,l=void 0===p?"fa-puzzle-piece":p,c=e.color,h=void 0===c?"":c,u=e.properties,d=void 0===u?[]:u,f=e.requirements,y=void 0===f?["Transform"]:f,m=e.children,v=void 0===m?[]:m,g=e.parentClass,T=void 0===g?ln:g,_=e.prototype,C=void 0===_?{}:_,b=e.allowMultiple,S=void 0===b||b;e.requiesInitWhenEntityIsEdited;w(i,"Component must have a name."),w(i[0]>="A"&&i[0]<="Z","Component name must start with capital letter."),w(!an.has(i),"Duplicate component class "+i),Object.keys(C).forEach(function(t){ln.reservedPrototypeMembers.has(t)&&w(!1,"Component prototype can not have a reserved member: "+t)});var E=C.constructor,P=C.delete;delete C.constructor,delete C.delete;var I=function(e){function n(){e.apply(this,arguments),E&&E.call(this)}return t(n,e),n.prototype.delete=function(){return!!e.prototype.delete.call(this)&&(P&&P.call(this),!0)},n}(T);d.forEach(function(t){w(!ln.reservedPropertyNames.has(t.name),"Can not have property called "+t.name)}),ee.defineProperties(I,d),I.componentName=i,I.category=a,y.indexOf("Transform")<0&&y.push("Transform"),I.requirements=y,I.children=v,I.description=o,I.allowMultiple=S,I.icon=l;var x=i.split("").reduce(function(t,e){return t+e.charCodeAt(0)},0);return I.color=h||"hsla("+x%360+", 40%, 60%, 1)",C._name=i,Object.assign(I.prototype,C),an.set(I.componentName,I),I},Lt.registerSerializable(ln,"com",function(t){var e=new(an.get(t.n))(t.id);return e._componentId=t.cid||null,e});var cn="entity is already dead",hn=function(e){function i(t){void 0===t&&(t=!1),e.call(this,t),this.components=new Map,this.sleeping=!1,this.prototype=null,this.localMaster=!0,n("Create object")}return t(i,e),i.prototype.makeUpAName=function(){return this.prototype?this.prototype.makeUpAName():"Entity"},i.prototype.getComponent=function(t){w(this._alive,cn);var e=this.components.get(t);return void 0!==e?e[0]:null},i.prototype.getComponents=function(t){return w(this._alive,cn),this.components.get(t)||[]},i.prototype.getListOfAllComponents=function(){var t=[];return this.components.forEach(function(e,n){t.push.apply(t,e)}),t},i.prototype.clone=function(){var t=new i;t.prototype=this.prototype.clone(),t.sleeping=this.sleeping;var e=[];return this.components.forEach(function(t,n){e.push.apply(e,t.map(function(t){return t.clone()}))}),t.addComponents(e),t},i.prototype.addComponents=function(t,e){var n=this,r=(void 0===e?{}:e).fullInit,o=void 0===r||r;w(this._alive,cn),w(Array.isArray(t),"Parameter is not an array."),i.ENTITY_CREATION_DEBUGGING&&console.log("add components for",this.makeUpAName());for(var s=0;s<t.length;s++){var a=t[s];(n.components.get(a._name)||n.components.set(a._name,[]).get(a._name)).push(a),a.entity=n,a._parent=n,a.setRootType(n._rootType)}return this.sleeping||(i.preInitComponents(t),o&&i.initComponents(t)),this},i.preInitComponents=function(t){i.ENTITY_CREATION_DEBUGGING&&console.log("preInit components for",t[0].entity.makeUpAName());for(var e=0;e<t.length;e++)t[e]._preInit()},i.initComponents=function(t){i.ENTITY_CREATION_DEBUGGING&&console.log("init "+t.length+" components for",t[0].entity.makeUpAName());for(var e=0;e<t.length;e++)t[e]._init()},i.makeComponentsSleep=function(t){for(var e=0;e<t.length;e++)t[e]._sleep()},i.deleteComponents=function(t){for(var e=0;e<t.length;e++)t[e].delete()},i.prototype.sleep=function(){return w(this._alive,cn),!this.sleeping&&(this.components.forEach(function(t,e){return i.makeComponentsSleep(t)}),this.sleeping=!0,!0)},i.prototype.wakeUp=function(){return w(this._alive,cn),!!this.sleeping&&(this.components.forEach(function(t,e){return i.preInitComponents(t)}),this.components.forEach(function(t,e){return i.initComponents(t)}),this.sleeping=!1,!0)},i.prototype.delete=function(){return w(this._alive,cn),this.sleep(),!!e.prototype.delete.call(this)&&(this.components.forEach(function(t,e){return i.deleteComponents(t)}),this.components.clear(),n("Destroy object"),!0)},i.prototype.deleteComponent=function(t){var e=this.getComponents(t.constructor.componentName),n=e.indexOf(t);return w(n>=0),this.sleeping||t._sleep(),t.delete(),e.splice(n,1),this},i.prototype.setRootType=function(t){if(this._rootType!==t){i.ENTITY_CREATION_DEBUGGING&&console.log("entity added to tree",this.makeUpAName()),e.prototype.setRootType.call(this,t);var n;this.components.forEach(function(e,i){for(n=0;n<e.length;++n)e[n].setRootType(t)})}},i.prototype.toJSON=function(){w(this._alive,cn);var t=[];return this.components.forEach(function(e){e.forEach(function(e){t.push(e.toJSON())})}),Object.assign(e.prototype.toJSON.call(this),{c:t,proto:this.prototype.id})},i}(Lt);Object.defineProperty(hn.prototype,"position",{get:function(){return this.getComponent("Transform").position},set:function(t){this.getComponent("Transform").position=t}}),Lt.registerSerializable(hn,"ent",function(t){hn.ENTITY_CREATION_DEBUGGING&&console.log("creating entity from json",t);var e=new hn(t.id);return e.prototype=getSerializable(t.proto),hn.ENTITY_CREATION_DEBUGGING&&console.log("created entity from json",e),t.comp&&e.addComponents((t.c||t.comp).map(Lt.fromJSON)),e}),hn.ENTITY_CREATION_DEBUGGING=!1;var un=[T("name","No name",T.string)],dn=function(e){function n(){e.apply(this,arguments),this.previouslyCreatedEntity=null}return t(n,e),n.prototype.makeUpAName=function(){return this.name||"Prototype"},n.prototype.addChild=function(t){"cda"!==t.threeLetterType||t.componentClass.allowMultiple||w(null===this.findChild("cda",function(e){return e.componentId===t.componentId}),"Can't have multiple "+t.name+" components. See Component.allowMultiple"),e.prototype.addChild.call(this,t)},n.prototype.getParentPrototype=function(){return this._parent&&"prt"===this._parent.threeLetterType?this._parent:null},n.prototype.getInheritedComponentDatas=function(t){void 0===t&&(t=null);for(var e,n=Q(this,this,t),i=Object.keys(n).map(function(t){return n[t]}),r=0;r<i.length;++r)e=i[r],e.properties=e.componentClass._propertyTypes.map(function(t){return e.propertyHash[t.name]||t.createProperty({skipSerializableRegistering:!0})}),delete e.propertyHash;return i.sort($)},n.prototype.createAndAddPropertyForComponentData=function(t,e,n){var i=t.componentClass._propertyTypesByName[e];w(i,"Invalid propertyName",e,t);var r=this.findChild("cda",function(e){return e.componentId===t.componentId}),o=!1;r||(console.log("no component data. create one",this,t),r=new sn(t.componentClass.componentName,!1,t.componentId),o=!0);var s=r.findChild("prp",function(t){return t.name===e});return s?(s.value=n,s):(s=i.createProperty({value:n}),r.addChild(s),o&&this.addChild(r),s)},n.prototype.findComponentDataByComponentId=function(t,e){void 0===e&&(e=!1);var n=this.findChild("cda",function(e){return e.componentId===t});if(n)return n;if(e){var i=this.getParentPrototype();if(i)return i.findComponentDataByComponentId(t,e)}return null},n.prototype.getOwnComponentDataOrInherit=function(t){var e=this.findComponentDataByComponentId(t,!1);if(!e){var n=this.findComponentDataByComponentId(t,!0);if(!n)return null;e=new sn(n.name,!1,t),this.addChild(e)}return e},n.prototype.findOwnProperty=function(t,e){var n=this.findComponentDataByComponentId(t);return n?n.getProperty(e):null},n.prototype.createEntity=function(t,e){void 0===e&&(e=!1);var n=new hn,i=this.getInheritedComponentDatas(),r=i.map(ln.createWithInheritedComponentData);return n.addComponents(r,{fullInit:!1}),n.prototype=this,t&&t.addChild(n),hn.ENTITY_CREATION_DEBUGGING&&console.log("create entity",this.makeUpAName()),this.forEachChild("epr",function(t){return t.createEntity(n,!0)}),hn.initComponents(r),this.previouslyCreatedEntity=n,e||Ct.dispatch("new entity created",n),n},n.prototype.getValue=function(t,e){var n=this.findComponentDataByComponentId(t,!0);return n?n.getValue(e):void 0},n.prototype.countEntityPrototypes=function(t){var e=this;if(void 0===t&&(t=!1),"prt"!==this.threeLetterType)return 0;for(var n=0,i=Ue.getChildren("lvl"),r=i.length-1;r>=0;r--)for(var o=i[r].getChildren("epr"),s=o.length-1;s>=0;s--)o[s].prototype===e&&n++;return t&&this.forEachChild("prt",function(t){return n+=t.countEntityPrototypes(!0)}),n},n.prototype.delete=function(){var t=this;return this._gameRoot=this._gameRoot||this.getRoot(),!!e.prototype.delete.call(this)&&("prt"===this.threeLetterType&&"gam"===this._gameRoot.threeLetterType&&this._gameRoot.forEachChild("lvl",function(e){for(var n=e.getChildren("epr"),i=n.length-1;i>=0;i--)n[i].prototype===t&&e.deleteChild(n[i],i)}),this.previouslyCreatedEntity=null,!0)},n}(ee);ee.defineProperties(dn,un),dn.create=function(t){return(new dn).initWithPropertyValues({name:t})},Lt.registerSerializable(dn,"prt");var fn=function(e){function n(t){void 0===t&&(t=!1),e.apply(this,arguments),this.prototype=null}return t(n,e),n.prototype.makeUpAName=function(){var t=this.findChild("prp",function(t){return"name"===t.name});return t&&t.value?t.value:this.prototype?this.prototype.makeUpAName():"EntityPrototype"},n.prototype.getTransform=function(){return this.findChild("cda",function(t){return"Transform"===t.name})},n.prototype.getParentPrototype=function(){return this.prototype||null},n.prototype.clone=function(){var t=this,e=new n;e.prototype=this.prototype;var i=e.id,r=[];return this.forEachChild(null,function(e){if("prp"===e.threeLetterType&&"name"===e.name){var n=new Zt({value:e.propertyType.type.clone(e.value),name:e.name,propertyType:t.propertyType,predefinedId:i+"_n"});r.push(n)}else if("cda"===e.threeLetterType&&"Transform"===e.name){var o=new sn("Transform",i+"_t"),s=o.componentClass._propertyTypesByName.position.createProperty({value:e.findChild("prp",function(t){return"position"===t.name}).value,predefinedId:i+"_p"});o.addChild(s);var a=e.findChild("prp",function(t){return"scale"===t.name});if(a){var p=o.componentClass._propertyTypesByName.scale.createProperty({value:a.value,predefinedId:i+"_s"});o.addChild(p)}var l=e.findChild("prp",function(t){return"angle"===t.name});if(l){var c=o.componentClass._propertyTypesByName.angle.createProperty({value:l.value,predefinedId:i+"_a"});o.addChild(c)}r.push(o)}else"cda"===e.threeLetterType?r.push(e.clone({cloneComponentId:!0})):r.push(e.clone())}),e.initWithChildren(r),this._state|=Lt.STATE_CLONE,e},n.prototype.toJSON=function(){var t=this,e=this.getTransform(),n={id:this.id};this.prototype&&(n.t=this.prototype.id);var i=[];this._children.forEach(function(t){i.push(t)});var r=(a=[]).concat.apply(a,i).filter(function(n){return n!==e&&n!==t._properties.name});r.length>0&&(n.c=r.map(function(t){return t.toJSON()}));var o=T.float().toJSON,s=function(t){"name"===t.name?t.value&&(n.n=t.value):"position"===t.name?n.p=t.type.toJSON(t.value):"scale"===t.name?t.value.isEqualTo(new Qt(1,1))||(n.s=t.type.toJSON(t.value)):"angle"===t.name&&0!==t.value&&(n.a=o(t.value))};return s(this._properties.name),e.getChildren("prp").forEach(s),n;var a},n.prototype.spawnEntityToScene=function(t,e){t&&(e&&(this.getTransform().getPropertyOrCreate("position").value=e),this.createEntity(t))},n.prototype.setRootType=function(t){this._rootType!==t&&(w(this.getTransform(),"EntityPrototype must have a Transform"),e.prototype.setRootType.call(this,t))},n}(dn);Object.defineProperty(fn.prototype,"position",{get:function(){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value},set:function(t){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value=t}}),fn.createFromPrototype=function(t){var e=new fn;e.prototype=t;var n=e.id,i=t.findChild("cda",function(t){return"Transform"===t.name}),r="pfa"===t.threeLetterType;!r&&i&&w(!1,"Prototype (prt) can not have a Transform component"),r&&!i&&w(!1,"Prefab (pfa) must have a Transform component");var o=tt(n),s=et(n);return r&&i&&(s.setValue("scale",i.getValue("scale")),s.setValue("angle",i.getValue("angle"))),e.initWithChildren([o,s]),w(e.getTransform(),"EntityPrototype must have a Transform"),e},fn.create=function(t,e){void 0===t&&(t="Empty"),void 0===e&&(e=new Qt(0,0));var n=new fn,i=et(n.id);i.setValue("position",e);var r=tt(n.id,t);return n.initWithChildren([r,i]),n},Lt.registerSerializable(fn,"epr",function(t){var e=new fn(t.id);e.prototype=t.t?l(t.t):null,t.t&&!e.prototype&&console.warn("EntityPrototype thougt it had a prototype or prefab "+t.t+" but it was not found.");var n=t.id+"_n",i=t.id+"_t",r=t.id+"_p",o=t.id+"_s",s=t.id+"_a",a=dn._propertyTypesByName.name.createProperty({value:void 0===t.n?"":t.n,predefinedId:n}),p=new sn("Transform",i),c=an.get("Transform"),h=c._propertyTypesByName.position.createProperty({value:Qt.fromObject(t.p),predefinedId:r});p.addChild(h);var u=c._propertyTypesByName.scale.createProperty({value:t.s&&Qt.fromObject(t.s)||new Qt(1,1),predefinedId:o});p.addChild(u);var d=c._propertyTypesByName.angle.createProperty({value:t.a||0,predefinedId:s});return p.addChild(d),e.initWithChildren([a,p]),e});var yn=function(e){function n(t){void 0===t&&(t=!1),e.apply(this,arguments)}return t(n,e),n.prototype.makeUpAName=function(){var t=this.findChild("prp",function(t){return"name"===t.name});return t&&t.value||"Prefab"},n.prototype.createEntity=function(){return fn.createFromPrototype(this).createEntity()},n.prototype.getParentPrototype=function(){return null},n}(dn);yn.createFromPrototype=function(t){var e=t.getInheritedComponentDatas(),n=e.map(function(t){return new sn(t.componentClass.componentName,null,t.componentId).initWithChildren(t.properties.map(function(t){return t.clone()}))});n.push(t._properties.name.clone());var i=(new yn).initWithChildren(n);return i.name=t.name||t.prototype&&t.prototype.makeUpAName()||"Prefab",i},Lt.registerSerializable(yn,"pfa");var mn=[T("name","No name",T.string)],vn=function(e){function n(t){e.apply(this,arguments)}return t(n,e),n.prototype.createScene=function(t){return void 0===t&&(t=!1),t||new rn,en.loadLevel(this),en},n.prototype.isEmpty=function(){return 0===this.getChildren("epr").length},n}(ee);ee.defineProperties(vn,mn),Lt.registerSerializable(vn,"lvl"),ln.register({name:"Transform",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[T("position",new Qt(0,0),T.vector),T("scale",new Qt(1,1),T.vector),T("angle",0,T.float,T.float.modulo(0,2*Math.PI),T.flagDegreesInEditor)],prototype:{constructor:function(){this.layer=this.scene.layers.main},preInit:function(){this.container=new Ve.Container,this.container._debug=this.entity.makeUpAName()+" "+this.name,this.container.position.set(this.position.x,this.position.y),this.container.scale.set(this.scale.x,this.scale.y),this.container.rotation=this.angle},init:function(){var t=this,e=this.getParentTransform();e?(e.container.addChild(this.container),e.listen("globalTransformChanged",function(){t.dispatch("globalTransformChanged",t)})):this.layer.addChild(this.container);var n=function(){t.dispatch("globalTransformChanged",t)};this.listenProperty(this,"position",function(e){t.container.position.set(e.x,e.y),n()}),this.listenProperty(this,"angle",function(e){t.container.rotation=e,n()}),this.listenProperty(this,"scale",function(e){t.container.scale.set(e.x,e.y),n()})},getParentTransform:function(){if(void 0!==this.parentTransform)return this.parentTransform;var t=this.entity.getParent();return t&&"ent"===t.threeLetterType?this.parentTransform=t.getComponent("Transform"):this.parentTransform=null,this.parentTransform},getGlobalPosition:function(){
return Qt.fromObject(this.layer.toLocal(gn,this.container,wn))},getGlobalAngle:function(){for(var t=this.angle,e=this.getParentTransform();e;)t+=e.angle,e=e.getParentTransform();return t},setGlobalPosition:function(t){this.position=t.set(this.container.parent.toLocal(t,this.layer,wn))},sleep:function(){this.container.destroy(),this.container=null,delete this.parentTransform}}});var gn=new Ve.Point,wn=new Ve.Point;ln.register({name:"TransformVariance",category:"Logic",description:"Adds random factor to object's transform/orientation.",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[T("positionVariance",new Qt(0,0),T.vector),T("scaleVariance",new Qt(0,0),T.vector),T("angleVariance",0,T.float,T.float.range(0,Math.PI),T.flagDegreesInEditor)],prototype:{onStart:function(){this.positionVariance.isZero()||(this.Transform.position=this.Transform.position.add(this.positionVariance.clone().multiplyScalar(-1+2*Math.random()))),this.scaleVariance.isZero()||(this.Transform.scale=this.Transform.scale.add(this.scaleVariance.clone().multiplyScalar(Math.random()))),this.angleVariance&&(this.Transform.angle+=this.angleVariance*(-1+2*Math.random()))}}}),ln.register({name:"Shape",category:"Graphics",icon:"fa-stop",allowMultiple:!0,description:"Draws shape on the screen.",properties:[T("type","rectangle",T.enum,T.enum.values("rectangle","circle","convex")),T("radius",20,T.float,T.visibleIf("type",["circle","convex"])),T("size",new Qt(20,20),T.vector,T.visibleIf("type","rectangle")),T("points",3,T.int,T.int.range(3,16),T.visibleIf("type","convex")),T("topPointDistance",.5,T.float,T.float.range(.001,1),T.visibleIf("type","convex"),"Only works with at most 8 points"),T("fillColor",new $t(222,222,222),T.color),T("borderColor",new $t(255,255,255),T.color),T("borderWidth",1,T.float,T.float.range(0,30))],prototype:{init:function(){var t=this;this.initSprite(),this.Transform.listen("globalTransformChanged",function(t){});var e=function(){t.updateTexture()};["type","radius","size","fillColor","borderColor","borderWidth","points","topPointDistance"].forEach(function(n){t.listenProperty(t,n,e)})},initSprite:function(){var t=this.getTextureAndAnchor();this.sprite=new Ve.Sprite(t.texture),this.sprite.anchor.set(t.anchor.x,t.anchor.y),this.Transform.container.addChild(this.sprite)},updateTexture:function(){var t=this.getTextureAndAnchor();this.sprite.texture=t.texture,this.sprite.anchor.set(t.anchor.x,t.anchor.y)},getTextureAndAnchor:function(){var t=this.createPropertyHash(),e=L(t);if(!e){var n=this.createGraphics();e=M(n,t),n.destroy()}return e},createGraphics:function(){var t=new Qt(1,1),e=new Ve.Graphics;if("rectangle"===this.type){var n=-this.size.x/2*t.x,i=-this.size.y/2*t.y,r=this.size.x*t.x,o=this.size.y*t.y;e.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),e.beginFill(this.fillColor.toHexNumber()),e.drawRect(n,i,r,o),e.endFill()}else if("circle"===this.type){var s=(t.x+t.y)/2;e.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),e.beginFill(this.fillColor.toHexNumber()),e.drawCircle(0,0,this.radius*s),e.endFill()}else if("convex"===this.type){var a=this.getConvexPoints(Ve.Point,!1);a.push(a[0]),e.lineStyle(this.borderWidth,this.borderColor.toHexNumber(),1),e.beginFill(this.fillColor.toHexNumber()),e.drawPolygon(a),e.endFill()}return e},getConvexPoints:function(t,e){var n=this;void 0===t&&(t=Qt),void 0===e&&(e=!0);var i,r,o=2*Math.PI/this.points,s=.5!==this.topPointDistance&&this.points<=8;if(s){var a=Math.PI-o,p=2*Math.sin(o/2),l=1-p*Math.cos(a/2);3===this.points?(i=.2,r=5):8===this.points?(i=l,r=3):(i=l,r=5)}for(var c=[],h=0,u=0;u<this.points;++u){var d=Math.sin(h)*n.radius,f=Math.cos(h)*n.radius;s&&0===u&&(f*=n.topPointDistance>.5?1+(n.topPointDistance-.5)*(r-1):2*n.topPointDistance*(1-i)+i),c.push(new t(d,-f)),h+=o}if(s){var y=c.reduce(function(t,e){return t+e.y},0)/this.points;c.forEach(function(t){return t.y-=y})}if(e){var m=this.Transform.scale;1===m.x&&1===m.y||c.forEach(function(t){t.x*=m.x,t.y*=m.y})}return c},sleep:function(){this.sprite.destroy(),this.sprite=null}}}),ln.register({name:"Sprite",category:"Graphics",icon:"fa-stop",allowMultiple:!0,description:"Draws a sprite on the screen.",properties:[],prototype:{init:function(){this.initSprite(),this.listenProperty(this.Transform,"position",function(t){}),this.listenProperty(this.Transform,"angle",function(t){}),this.listenProperty(this.Transform,"scale",function(t){})},initSprite:function(){this.sprite=Ve.Sprite.fromImage("/img/sprite.png"),this.sprite.anchor.set(.5,.5);this.Transform;this.scene.layers.main.addChild(this.sprite)},sleep:function(){this.sprite.destroy(),this.sprite=null}}}),ln.register({name:"Spawner",category:"Logic",description:"Spawns types to world.",properties:[T("typeName","",T.string),T("trigger","start",T.enum,T.enum.values("start","interval")),T("interval",10,T.float,T.float.range(.1,1e6),T.visibleIf("trigger","interval"),"Interval in seconds")],prototype:{constructor:function(){this.lastSpawn=0},init:function(){this.lastSpawn=this.scene.time},onStart:function(){"start"===this.trigger&&this.spawn()},onUpdate:function(){this.scene.time>this.lastSpawn+this.interval&&this.spawn()},onDrawHelper:function(t){this.Transform.position.x,this.Transform.scale.x,this.Transform.position.y,this.Transform.scale.y,this.Transform.scale.x,this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px FontAwesome",t.textAlign="center",t.fillText("",this.Transform.position.x+2,this.Transform.position.y),t.strokeText("",this.Transform.position.x+2,this.Transform.position.y),t.restore()},spawn:function(){var t=this,e=this.game.findChild("prt",function(e){return e.name===t.typeName},!0);if(e){var n=fn.createFromPrototype(e);n.spawnEntityToScene(this.scene,this.Transform.position),n.delete(),this.lastSpawn=this.scene.time}}}}),ln.register({name:"Trigger",description:"When _ then _.",category:"Logic",allowMultiple:!0,properties:[T("trigger","playerComesNear",T.enum,T.enum.values("playerComesNear")),T("radius",40,T.float,T.float.range(0,1e3),T.visibleIf("trigger","playerComesNear")),T("action","win",T.enum,T.enum.values("win"))],prototype:{preInit:function(){this.storeProp="__Trigger_"+this._componentId},onUpdate:function(){var t=this;if("playerComesNear"===this.trigger){var e=this.scene.getComponents("CharacterController"),n=[];e.forEach(function(t){return n.push(t.entity)});for(var i=this.radius*this.radius,r=this.Transform.position,o=0;o<n.length;++o)if(n[o].position.distanceSq(r)<i){if(!n[o][t.storeProp]&&t.launchTrigger(n[o])!==!1)break;n[o][t.storeProp]=!0}else n[o][t.storeProp]=!1}},launchTrigger:function(t){return"win"===this.action&&(this.scene.win(),!1)}}});var Tn={dynamic:Ye.Body.DYNAMIC,kinematic:Ye.Body.KINEMATIC,static:Ye.Body.STATIC},_n=Ye.Body.SLEEPING,Cn=Ye.Body.STATIC;ln.register({name:"Physics",category:"Dynamics",description:'Forms physical rules for <span style="color: #84ce84;">Shapes</span>.',icon:"fa-stop",allowMultiple:!1,properties:[T("type","dynamic",T.enum,T.enum.values("dynamic","static")),T("density",1,T.float,T.float.range(0,100),T.visibleIf("type","dynamic")),T("drag",.1,T.float,T.float.range(0,1),T.visibleIf("type","dynamic")),T("rotationalDrag",.1,T.float,T.float.range(0,1),T.visibleIf("type","dynamic")),T("bounciness",0,T.float,T.float.range(0,1)),T("friction",.1,T.float,T.float.range(0,1))],requirements:["Shape"],requiesInitWhenEntityIsEdited:!0,prototype:{inited:!1,init:function(){var t=this;this.inited=!0;for(var e=function(e){return function(n){!t.updatingOthers&&t.body&&(e(n),"dynamic"===t.type&&t.body.wakeUp())}},n=this.entity.getComponents("Shape"),i=["type","size","radius","points","topPointDistance"],r=0;r<n.length;++r)!function(r){i.forEach(function(i){t.listenProperty(n[r],i,e(function(){return t.updateShape()}))})}(r);this.listenProperty(this.Transform,"position",e(function(e){t.body.position=e.toArray().map(function(t){return.02*t}),t.body.updateAABB()})),this.listenProperty(this.Transform,"angle",e(function(e){t.body.angle=e,t.body.updateAABB()})),this.listenProperty(this.Transform,"scale",e(function(e){return t.updateShape()})),this.listenProperty(this,"density",e(function(e){t.body.setDensity(.3*e)})),this.listenProperty(this,"friction",e(function(e){return t.updateMaterial()})),this.listenProperty(this,"drag",e(function(e){return t.body.damping=e})),this.listenProperty(this,"rotationalDrag",e(function(e){t.body.angularDamping=e>.98?1:e,t.body.fixedRotation=1===e,t.body.updateMassProperties()})),this.listenProperty(this,"type",e(function(e){t.body.type=e[t.type],t.entity.sleep(),t.entity.wakeUp()})),this.listenProperty(this,"bounciness",e(function(e){return t.updateMaterial()})),this._rootType&&this.createBody()},createBody:function(){w(!this.body),this.body=new Ye.Body({type:Tn[this.type],position:[.02*this.Transform.position.x,.02*this.Transform.position.y],angle:this.Transform.angle,velocity:[0,0],angularVelocity:0,sleepTimeLimit:.6,sleepSpeedLimit:.3,damping:this.drag,angularDamping:this.rotationalDrag>.98?1:this.rotationalDrag,fixedRotation:1===this.rotationalDrag}),this.updateShape(),this.body.entity=this.entity,z(this.scene,this.body)},updateShape:function(){var t=this;if(this.body.shapes.length>0){w(!F(this.scene).stepping);for(var e=this.body.shapes,n=0;n<e.length;++n)e[n].body=null;e.length=0}var i=this.entity.getComponents("Shape"),r=this.Transform.scale;i.forEach(function(e){var n;if("rectangle"===e.type)n=new Ye.Box({width:.02*e.size.x*r.x,height:.02*e.size.y*r.y});else if("circle"===e.type){var i=(r.x+r.y)/2;n=new Ye.Circle({radius:.02*e.radius*i})}else"convex"===e.type&&(n=new Ye.Convex({vertices:e.getConvexPoints().map(function(t){return[.02*t.x,.02*t.y]})}));n&&t.body.addShape(n)}),this.updateMass(),this.updateMaterial()},updateMaterial:function(){var t=W(this.scene,{friction:this.friction,restitution:this.bounciness});this.body.shapes.forEach(function(e){return e.material=t})},updateMass:function(){"dynamic"===this.type&&this.body.setDensity(.3*this.density)},setRootType:function(t){return t&&this.inited&&this.createBody(),ln.prototype.setRootType.call(this,t)},onUpdate:function(){var t=this.body;if(t&&t.sleepState!==_n&&t.type!==Cn){this.updatingOthers=!0;var e=new Qt(50*t.position[0],50*t.position[1]);this.Transform.position.isEqualTo(e)||(this.Transform.position=e),this.Transform.angle!==t.angle&&(this.Transform.angle=t.angle),this.updatingOthers=!1}},sleep:function(){this.body&&(U(this.scene,this.body),this.body=null),this.inited=!1},getMass:function(){return this.body.mass},applyForce:function(t){this.body.applyForce(t.toArray()),this.body.wakeUp()},setAngularForce:function(t){this.body.angularForce=t,this.body.wakeUp()}}}),ln.register({name:"Lifetime",description:"Set the object to be destroyed after a time period",category:"Logic",icon:"fa-bars",requirements:["Transform"],properties:[T("lifetime",3,T.float,T.float.range(.01,1e3),"Life time seconds")],parentClass:ln,prototype:{onUpdate:function(){this.scene.time-this.startTime>=this.lifetime&&this.entity&&this.entity.delete()},init:function(){this.startTime=this.scene.time}}}),ln.register({name:"Particles",category:"Graphics",description:"Particle engine gives eye candy.",allowMultiple:!0,properties:[T("startColor",new $t("#68c07f"),T.color),T("endColor",new $t("#59abc0"),T.color),T("alpha",1,T.float,T.float.range(0,1)),T("particleSize",10,T.float,T.float.range(1,100)),T("particleCount",30,T.int,T.int.range(0,1e4)),T("particleLifetime",1,T.float,T.float.range(.1,10),"in seconds"),T("particleHardness",.2,T.float,T.float.range(0,1)),T("blendMode","add",T.enum,T.enum.values("add","normal")),T("spawnType","circle",T.enum,T.enum.values("circle","rectangle")),T("spawnRadius",20,T.float,T.float.range(0,1e3),T.visibleIf("spawnType","circle")),T("spawnRandom",.5,T.float,T.float.range(0,1),T.visibleIf("spawnType","circle")),T("spawnRect",new Qt(50,50),T.vector,T.visibleIf("spawnType","rectangle")),T("speedToOutside",50,T.float,T.float.range(-1e3,1e3),T.visibleIf("spawnType","circle")),T("speed",new Qt(0,0),T.vector),T("speedRandom",0,T.float,T.float.range(0,1e3),"Max random velocity to random direction"),T("acceleration",new Qt(0,0),T.vector),T("globalCoordinates",!0,T.bool),T("followObject",.4,T.float,T.float.range(0,1),T.visibleIf("globalCoordinates",!0))],prototype:{init:function(){var t=this;this.container=new Ve.Container,this.updateTexture(),["particleSize","particleHardness","alpha"].forEach(function(e){t.listenProperty(t,e,function(){t.updateTexture()})}),this.listenProperty(this,"blendMode",function(e){t.particles&&t.particles.forEach(function(t){t.sprite&&(t.sprite.blendMode=bn[e])})}),this.scene.layers.main.addChild(this.container),this.initParticles(),["particleLifetime","particleCount"].forEach(function(e){t.listenProperty(t,e,function(){t.initParticles()})}),this.updateGlobalCoordinatesProperty(),this.listenProperty(this,"globalCoordinates",function(){t.updateGlobalCoordinatesProperty()}),this.Physics=this.entity.getComponent("Physics")},updateGlobalCoordinatesProperty:function(){var t=this;this.positionListener&&(this.positionListener(),this.positionListener=null),this.globalCoordinates?(this.particles.forEach(function(e){e.sprite&&(e.sprite.x+=t.container.position.x,e.sprite.y+=t.container.position.y)}),this.container.position.set(0,0)):(this.positionListener=this.Transform._properties.position.listen("change",function(e){t.container.position.set(e.x,e.y)}),this.container.position.set(this.Transform.position.x,this.Transform.position.y),this.particles.forEach(function(e){e.sprite&&(e.sprite.x-=t.container.position.x,e.sprite.y-=t.container.position.y)}))},updateTexture:function(){var t=this;this.texture=rt(this.particleSize,.9*this.particleHardness,{r:255,g:255,b:255,a:this.alpha}),this.particles&&this.particles.forEach(function(e){e.sprite&&(e.sprite.texture=t.texture)})},initParticles:function(){var t=this;this.particles&&this.particles.forEach(function(t){t.sprite&&t.sprite.destroy()}),this.particles=[];for(var e=this.particleLifetime/this.particleCount,n=this.scene.time+Math.random()*e,i=0;i<this.particleCount;++i)t.particles.push({alive:!1,nextBirth:n+i*e})},resetParticle:function(t){if(t.vx=this.speed.x,t.vy=this.speed.y,this.speedRandom>0){var e=this.speedRandom*Math.random(),n=Math.random()*Math.PI*2;t.vx+=Math.sin(n)*e,t.vy+=Math.cos(n)*e}if("circle"===this.spawnType){var i=this.spawnRadius;this.spawnRandom>0&&(i=this.spawnRandom*Math.random()*i+(1-this.spawnRandom)*i);var r=Math.random()*Math.PI*2;t.sprite.x=Math.cos(r)*i,t.sprite.y=Math.sin(r)*i,0!==this.speedToOutside&&(t.vx+=Math.cos(r)*this.speedToOutside,t.vy+=Math.sin(r)*this.speedToOutside)}else t.sprite.x=-this.spawnRect.x/2+Math.random()*this.spawnRect.x,t.sprite.y=-this.spawnRect.y/2+Math.random()*this.spawnRect.y;if(t.age=this.scene.time-t.nextBirth,t.nextBirth+=this.particleLifetime,this.globalCoordinates&&(t.sprite.x+=this.Transform.position.x,t.sprite.y+=this.Transform.position.y,this.Physics&&this.Physics.body)){var o=this.Physics.body.velocity;t.vx=t.vx+this.followObject*o[0]/.02,t.vy=t.vy+this.followObject*o[1]/.02}},onUpdate:function(t,e){for(var n,i,r,o,s,a=this,p=this.particleLifetime,l=1/p,c=this.particles,h=this.acceleration.x*t,u=this.acceleration.y*t,d=this.startColor,f=this.endColor,y=0;y<this.particleCount;y++){if(s=c[y],!s.alive){if(!(e>=s.nextBirth))continue;s.sprite=new Ve.Sprite(a.texture),s.sprite.blendMode=bn[a.blendMode],s.sprite.anchor.set(.5,.5),s.alive=!0,a.resetParticle(s),a.container.addChild(s.sprite)}n=s.sprite,i=n.transform.position,s.age+=t,o=s.age*l,o>=1?(a.resetParticle(s),o=s.age*l):(s.vx+=h,s.vy+=u,i.x+=s.vx*t,i.y+=s.vy*t),n.tint=function(t){var e=1-t;return 65536*(d.r*e+f.r*t|0)+256*(d.g*e+f.g*t|0)+(d.b*e+f.b*t|0)}(o),n.alpha=nt(o),r=it(o),n.scale.set(r,r)}},sleep:function(){this.particles=null,this.container.destroy(),this.container=null,this.positionListener&&(this.positionListener(),this.positionListener=null)}}});var bn={add:gt?Ve.BLEND_MODES.ADD:0,normal:gt?Ve.BLEND_MODES.NORMAL:0},Sn={};ln.register({name:"CharacterController",description:"Lets user control the object.",category:"Dynamics",allowMultiple:!1,properties:[T("type","player",T.enum,T.enum.values("player","AI")),T("keyboardControls","arrows or WASD",T.enum,T.enum.values("arrows","WASD","arrows or WASD")),T("controlType","jumper",T.enum,T.enum.values("jumper","top down")),T("jumpSpeed",300,T.float,T.float.range(0,1e3),T.visibleIf("controlType","jumper")),T("jumpAddedToVelocity",.4,T.float,T.float.range(0,1),T.visibleIf("controlType","jumper"),"1 means that jump speed is added to y velocity when object has y velocity."),T("breakInTheAir",!0,T.bool,T.visibleIf("controlType","jumper")),T("speed",200,T.float,T.float.range(0,1e3)),T("acceleration",2e3,T.float,T.float.range(0,1e4)),T("breaking",2e3,T.float,T.float.range(0,1e4))],prototype:{init:function(){var t=this;this.Physics=this.entity.getComponent("Physics"),this.lastJumpTime=0,this.keyListener=q(function(e){"jumper"===t.controlType&&t.scene.playing&&("arrows"===t.keyboardControls?e===Ke.up&&t.jump():"WASD"===t.keyboardControls?e===Ke.w&&t.jump():"arrows or WASD"===t.keyboardControls?e!==Ke.up&&e!==Ke.w||t.jump():w(!1,"Invalid CharacterController.keyboardControls"))})},sleep:function(){this.keyListener&&(this.keyListener(),this.keyListener=null)},getInput:function(){return"arrows"===this.keyboardControls?{up:G(Ke.up),down:G(Ke.down),left:G(Ke.left),right:G(Ke.right)}:"WASD"===this.keyboardControls?{up:G(Ke.w),down:G(Ke.s),left:G(Ke.a),right:G(Ke.d)}:"arrows or WASD"===this.keyboardControls?{up:G(Ke.up)||G(Ke.w),down:G(Ke.down)||G(Ke.s),left:G(Ke.left)||G(Ke.a),right:G(Ke.right)||G(Ke.d)}:void w(!1,"Invalid CharacterController.keyboardControls")},onUpdate:function(t,e){var n=this.getInput(),i=n.up,r=n.down,o=n.left,s=n.right,a=0,p=0;s&&a++,o&&a--,i&&p--,r&&p++,"top down"===this.controlType?this.moveTopDown(a,p,t):"jumper"===this.controlType&&this.moveJumper(a,p,t)},moveTopDown:function(t,e,n){if(this.Physics){if(this.Physics.body){var i=this.Physics.body.velocity;i[0]=.02*ot(this.calculateNewVelocity(i[0]/.02,t,n),this.speed),i[1]=.02*ot(this.calculateNewVelocity(i[1]/.02,e,n),this.speed)}}else if(0!==t||0!==e){var r=this.Transform,o=r.position,s=this.speed*n;r.position=new Qt(o.x+t*s,o.y+e*s)}},moveJumper:function(t,e,n){if(!this.Physics||!this.Physics.body)return!1;var i=this.Physics.body.velocity;i[0]=.02*this.calculateNewVelocity(i[0]/.02,t,n)},jump:function(){if(this.scene.time>this.lastJumpTime+.1&&this.checkIfCanJump()){this.lastJumpTime=this.scene.time;var t=this.Physics.body.velocity;if(t[1]>0)t[1]=.02*-this.jumpSpeed;else{for(var e=Qt.fromArray(t),n=F(this.scene).narrowphase.contactEquations,i=this.Physics.body,r=n.length-1;r>=0;--r){var o=n[r];if(o.bodyA===i||o.bodyB===i){var s=Qt.fromArray(o.normalA);o.bodyB===i&&s.multiplyScalar(-1);var a=e.dot(s);a<0&&e.subtract(s.multiplyScalar(a))}}t[1]=e.y*this.jumpAddedToVelocity-.02*this.jumpSpeed}}},checkIfCanJump:function(){if(!this.Physics||"jumper"!==this.controlType)return!1;var t=F(this.scene).narrowphase.contactEquations,e=this.Physics.body;if(!e)return!1;if(e.sleepState===Ye.Body.SLEEPING)return!0;for(var n=t.length-1;n>=0;--n){var i=t[n];if(i.bodyA===e||i.bodyB===e){var r=i.normalA[1];if(i.bodyB===e&&(r*=-1),r>.5)return!0}}return!1},calculateNewVelocity:function(t,e,n){if(0!==e)t>=this.speed&&e>0||t<=-this.speed&&e<0||(t+=e*this.acceleration*n,e<0&&t<-this.speed&&(t=-this.speed),e>0&&t>this.speed&&(t=this.speed));else if(0!==t&&("jumper"!==this.controlType||this.breakInTheAir||this.checkIfCanJump())){var i=Math.abs(t);i-=this.breaking*n,i<0&&(i=0),t=t>0?i:-i}return t}}});var En={context:null,serverToClientEnabled:!0,clientToServerEnabled:!1},Pn=[],In={};!function(t){w("function"==typeof t),qt.push(t)}(function(t){if(!t.external&&En.clientToServerEnabled&&!st(t)){if(t.type===Jt.setPropertyValue){var e=In[t.id];e&&Pn.splice(Pn.indexOf(e),1),In[t.id]=t}Pn.push(t),An&&An()}});var xn,Nn={data:function(t){var e=t.profile,n=t.gameData,i=t.editAccess;localStorage.openEditPlayUserId=e.id,localStorage.openEditPlayUserToken=e.userToken,i||Ct.dispatch("noEditAccess"),delete e.userToken,window.user=e,lt(n)},identifyYourself:function(){if(Ue)return location.reload();var t=at("gameId")||localStorage.openEditPlayGameId;ct("identify",{userId:localStorage.openEditPlayUserId,userToken:localStorage.openEditPlayUserToken,gameId:t,context:En.context})},errorMessage:function(t){var e=t.message,n=t.isFatal,i=t.data;console.error("Server sent "+(n?"FATAL ERROR":"error")+":",e,i),n&&A(e)}},An=function(t,e,n){function i(){s=Date.now(),o=null,n()}function r(t){o=setTimeout(i,t)}if(void 0===e&&(e="soon"),!["instant","soon","next"].includes(e))throw new Error("Invalid callbackLimitMode");var o=null,s=0;return function(n){if(!o){var a=s+t-Date.now();if(a>0)r(a);else{var p=n||e;"instant"===p?i():"soon"===p?r(0):"next"===p&&r(t)}}}}(200,"soon",function(){if(xn&&0!==Pn.length&&En.clientToServerEnabled){var t=Pn.map(m);Pn.length=0,In={},console.log("send change",t),ct("",t)}});window.addEventListener("load",ht);var On=null,kn=null;window.addEventListener("resize",ut),K(ut);var Dn=6e5,Ln=70,Mn=function(){function t(t,e,n){this.elementId=t,this.element=null,this.keyBinding=e,this.state=!1,this.visible=!1,this.requireTouchStart=n,this.containsFunc=null}return t.prototype.initElement=function(){this.element||(this.element=document.getElementById(this.elementId))},t.prototype.setPosition=function(t,e,n){t?this.element.style.left=t+"px":this.element.style.right=e+"px",this.element.style.bottom=n+"px"},t.prototype.getPosition=function(){var t=document.getElementById("screen"),e=parseInt(t.style.width),n=parseInt(t.style.height),i=parseInt(this.element.style.left),r=parseInt(this.element.style.right),o=parseInt(this.element.style.bottom),s=isNaN(i)?e-r-this.element.offsetWidth/2:i+this.element.offsetWidth/2,a=n-o-this.element.offsetHeight/2;return new Qt(s,a)},t.prototype.contains=function(t){return!!this.visible&&(this.containsFunc?this.containsFunc.call(this,t):this.getPosition().distance(t)<=Ln/2)},t.prototype.setContainsFunction=function(t){this.containsFunc=t},t.prototype.setVisible=function(t){this.visible!==t&&(this.visible=t,this.element.style.display=t?"inline-block":"none")},t.prototype.setState=function(t,e){var n=this.state;!this.requireTouchStart||this.state||e?this.state=!!t:this.state=!1,this.state!==n&&(this.state?(this.element.classList.add("pressed"),X("keydown",this.keyBinding)):(this.element.classList.remove("pressed"),X("keyup",this.keyBinding)))},t}(),Rn=110,Bn={touchUp:new Mn("touchUp",Ke.up),touchDown:new Mn("touchDown",Ke.down),touchLeft:new Mn("touchLeft",Ke.left),touchRight:new Mn("touchRight",Ke.right),touchJump:new Mn("touchJump",Ke.up,!0),touchA:new Mn("touchA",Ke.space,!0),touchB:new Mn("touchB",Ke.b,!0)},jn=[Bn.touchJump,Bn.touchA,Bn.touchB],Vn=Object.keys(Bn).map(function(t){return Bn[t]});window.addEventListener("load",function(){document.addEventListener("touchmove",dt,{passive:!1}),document.addEventListener("touchstart",dt,{passive:!1}),document.addEventListener("touchend",dt,{passive:!1}),document.addEventListener("scroll",function(t){return t.preventDefault()},{passive:!1}),window.IS_TOUCH_DEVICE="ontouchstart"in window||navigator.maxTouchPoints,window.IS_TOUCH_DEVICE&&document.body.classList.add("touch"),window.navigator.standalone&&document.body.classList.add("nativeFullscreen"),Vn.forEach(function(t){return t.initElement()})}),K(function(){en.listen("onStart",function(){return yt()})}),function(){Ht=!1}(),function(t){En=Object.assign(En,t)}({serverToClientEnabled:!0,clientToServerEnabled:!1,context:"play"}),function(t){He.push(t),console.log("real ts"),Ue&&t(Ue)}(function(t){function e(){var e=t.getChildren("lvl");n>=e.length&&(n=0),e[n].createScene().play()}var n=0;e(),t.listen("levelCompleted",function(){n++,e()})}),q(function(t){t===Ke.space&&en&&en.win()})});
//# sourceMappingURL=openeditplay.min.js.map
