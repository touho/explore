{"version":3,"file":"openeditplay.min.js","sources":["../src/util/assert.ts","../src/core/eventDispatcher.ts","../src/core/change.ts","../src/core/serializable.ts","../src/core/propertyType.ts","../src/util/color.ts","../src/core/dataTypes.ts","../node_modules/redom/dist/redom.es.js","../src/util/popup.ts","../src/features/graphics.ts","../src/modules/backgroundGradient.ts","../src/features/physics.ts","../src/util/input.ts","../src/util/performance.ts","../src/core/scene.ts","../src/core/serializableManager.ts","../src/core/prototype.ts","../src/core/entityPrototype.ts","../src/components/Physics.ts","../src/components/Particles.ts","../src/util/algorithm.ts","../src/components/Animation.ts","../src/core/net.ts","../src/player/canvasResize.ts","../src/player/touchControlManager.ts","../src/util/circularDependencyDetector.ts","../src/util/environment.ts","../src/core/property.ts","../src/util/vector.ts","../src/core/propertyOwner.ts","../src/core/game.ts","../src/editor/editorEventDispatcher.ts","../src/core/component.ts","../src/core/componentData.ts","../src/core/entity.ts","../src/core/prefab.ts","../src/core/level.ts","../src/components/Transform.ts","../src/components/TransformVariance.ts","../src/components/Shape.ts","../src/components/Sprite.ts","../src/components/Spawner.ts","../src/components/Trigger.ts","../src/components/Lifetime.ts","../src/components/CharacterController.ts","../src/features/animation/animation.ts","../src/util/callLimiter.ts","../src/player/TouchControl.ts","../src/player/main.ts"],"sourcesContent":["// @ifndef OPTIMIZE\nexport const changeGetter = {\n\tget: () => null // override this\n};\n// @endif\n\nexport default function assert(condition, ...messages) {\n\t// @ifndef OPTIMIZE\n\tif (!condition) {\n\t\tconsole.warn('Assert', ...messages, '\\norigin', changeGetter.get());\n\t\tconsole.log(new Error().stack); // In own log call so that browser console can map from from bundle files to .ts files.\n\n\t\tdebugger; // Check console for error messages\n\n\t\tif (!window['force'])\n\t\t\tthrow new Error(messages.join('; '));\n\t}\n\t// @endif\n}\n","import { CircularDependencyDetector } from \"../util/circularDependencyDetector\";\n\nexport enum GameEvent {\n    SCENE_START = 'scene start',\n    SCENE_PLAY = 'scene play',\n    SCENE_PAUSE = 'scene pause',\n    SCENE_RESET = 'scene reset',\n    SCENE_DRAW = 'scene draw', // parameters(scene: Scene)\n    SCENE_ZOOM_CHANGED = 'zoom changed',\n    GAME_LEVEL_COMPLETED = 'game level completed',\n    PROPERTY_VALUE_CHANGE = 'property change',\n    GLOBAL_CHANGE_OCCURED = 'change',\n    GLOBAL_SCENE_CREATED = 'scene created',\n    GLOBAL_GAME_CREATED = 'game created',\n    GLOBAL_ENTITY_CLICKED = 'global entity clicked', // parameters(entity, component)\n    ENTITY_CLICKED = 'entity clicked', // parameters(component)\n}\n\nexport type ListenerFunction = Function & { priority?: number };\n\nexport let eventDispatcherCallbacks = {\n    eventDispatchedCallback: null // (eventName, listenerCount) => void\n};\n\nconst globalCircularDependencyDetector = new CircularDependencyDetector();\n\nexport default class EventDispatcher {\n    _listeners: { [event in GameEvent]?: Array<ListenerFunction> } = {};\n\n    // priority should be a whole number between -100000 and 100000. a smaller priority number means that it will be executed first.\n    listen(event: GameEvent, callback: ListenerFunction, priority = 0) {\n        (callback as any).priority = priority + (listenerCounter++ / NUMBER_BIGGER_THAN_LISTENER_COUNT);\n        if (!this._listeners.hasOwnProperty(event)) {\n            this._listeners[event] = [];\n        }\n        let index = decideIndexOfListener(this._listeners[event], callback);\n        this._listeners[event].splice(index, 0, callback);\n        return () => {\n            let eventListeners = this._listeners[event];\n            if (!eventListeners) return; // listeners probably already deleted\n\n            let index = eventListeners.indexOf(callback);\n            if (index >= 0)\n                eventListeners.splice(index, 1);\n        };\n    }\n    dispatch(event: GameEvent, a?, b?, c?) {\n        let listeners = this._listeners[event];\n        if (!listeners)\n            return;\n\n        let circularDependencyEvent = (a && a.reference) ? (event + a.reference.id) : event;\n        globalCircularDependencyDetector.enter(circularDependencyEvent, {\n            this: this, a, b, c\n        });\n\n        if (eventDispatcherCallbacks.eventDispatchedCallback)\n            eventDispatcherCallbacks.eventDispatchedCallback(event, listeners.length);\n\n        for (let i = 0; i < listeners.length; i++) {\n            // @ifndef OPTIMIZE\n            try {\n                // @endif\n\n                listeners[i](a, b, c);\n\n                // @ifndef OPTIMIZE\n            } catch (e) {\n                console.error(`Event ${event} listener crashed.`, this._listeners[event][i], e);\n            }\n            // @endif\n        }\n\n        globalCircularDependencyDetector.leave(circularDependencyEvent);\n    }\n\n    /**\n     * This is separate function for optimization.\n     * Returns promise that has value array, containing all results from listeners.\n     * Promise can reject.\n     *\n     * Handler of this kind of events should return either a value or a Promise.\n     */\n    dispatchWithResults(event: GameEvent, a?, b?, c?) {\n        let listeners = this._listeners[event];\n        if (!listeners)\n            return Promise.all([]);\n\n        let results = [];\n\n        if (eventDispatcherCallbacks.eventDispatchedCallback)\n            eventDispatcherCallbacks.eventDispatchedCallback(event, listeners.length);\n\n        for (let i = 0; i < listeners.length; i++) {\n            // @ifndef OPTIMIZE\n            try {\n                // @endif\n\n                results.push(listeners[i](a, b, c));\n\n                // @ifndef OPTIMIZE\n            } catch (e) {\n                console.error(`Event ${event} listener crashed.`, this._listeners[event][i], e);\n            }\n            // @endif\n        }\n\n        let promises = results.map(res => res instanceof Promise ? res : Promise.resolve(res));\n        return Promise.all(promises);\n    }\n\n    delete() {\n        this._listeners = {};\n    }\n}\n\nexport let globalEventDispatcher = new EventDispatcher();\nglobalEventDispatcher['globalEventDispatcher'] = true; // for debugging\n\nlet listenerCounter = 0;\nconst NUMBER_BIGGER_THAN_LISTENER_COUNT = 10000000000;\n\nfunction decideIndexOfListener(array, callback) {\n    let low = 0,\n        high = array.length,\n        priority = callback.priority;\n\n    while (low < high) {\n        let mid = low + high >>> 1;\n        if (array[mid].priority < priority) low = mid + 1;\n        else high = mid;\n    }\n    return low;\n}\n","import assert, { changeGetter as assertChangeGetter } from '../util/assert';\nimport Serializable, { serializableCallbacks } from './serializable';\nimport Property from './property';\nimport EventDispatcher, { GameEvent, globalEventDispatcher } from './eventDispatcher';\nimport { CircularDependencyDetector } from '../util/circularDependencyDetector';\n\nlet DEBUG_CHANGES = 0;\nlet CHECK_FOR_INVALID_ORIGINS = 1; // TODO: Do stuff in editor with this set to true to find nasty bugs.\n\nexport type Change = {\n\ttype: string;\n\treference: Serializable;\n\tid: string;\n\texternal: boolean; // caused by network\n\torigin?: any; // exists in editor, but not in optimized release\n\tvalue?: any;\n\tparent?: Serializable;\n}\n\n// reference parameters are not sent over net. they are helpers in local game instance\nexport let changeType = {\n\taddSerializableToTree: 'a', // parentId, reference\n\tsetPropertyValue: 's', // id, value\n\tdeleteSerializable: 'd', // id\n\tmove: 'm', // id, parentId\n\tdeleteAllChildren: 'c', // id\n};\n\nlet circularDependencyDetector = new CircularDependencyDetector();\nlet origin;\n\n// @ifndef OPTIMIZE\nlet previousVisualOrigin;\nfunction resetOrigin() {\n\torigin = null;\n}\nexport function getChangeOrigin() {\n\treturn origin;\n}\nassertChangeGetter.get = getChangeOrigin;\n// @endif\nexport function setChangeOrigin(_origin) {\n\t// @ifndef OPTIMIZE\n\tif (_origin !== origin) {\n\t\torigin = _origin;\n\t\tif (DEBUG_CHANGES && _origin && _origin !== previousVisualOrigin) {\n\t\t\tconsole.log('origin', previousVisualOrigin);\n\t\t\tpreviousVisualOrigin = _origin;\n\t\t}\n\n\t\tif (CHECK_FOR_INVALID_ORIGINS)\n\t\t\tsetTimeout(resetOrigin, 0);\n\t}\n\t// @endif\n}\n\nlet externalChange = false;\n\n// addChange needs to be called if editor, server or net game needs to share changes\nexport function addChange(type: string, reference: Serializable) {\n\t// @ifndef OPTIMIZE\n\tassert(origin, 'Change without origin!');\n\tconst circularEventId = type + (reference && reference.threeLetterType)\n\tcircularDependencyDetector.enter(circularEventId)\n\t// @endif\n\n\tif (!reference.id) return circularDependencyDetector.leave(circularEventId);\n\n\tlet change: Change = {\n\t\ttype,\n\t\treference,\n\t\tid: reference.id,\n\t\texternal: externalChange,\n\t\torigin // exists in editor, but not in optimized release\n\t};\n\tif (type === changeType.setPropertyValue) {\n\t\tchange.value = (reference as Property)._value;\n\t} else if (type === changeType.move) {\n\t\tchange.parent = reference._parent;\n\t} else if (type === changeType.addSerializableToTree) {\n\t\tchange.parent = reference._parent;\n\t\tdelete change.id;\n\t}\n\n\t// @ifndef OPTIMIZE\n\tif (DEBUG_CHANGES)\n\t\tconsole.log('change', change);\n\n\tlet previousOrigin = origin;\n\t// @endif\n\n\tglobalEventDispatcher.dispatch(GameEvent.GLOBAL_CHANGE_OCCURED, change);\n\n\t// @ifndef OPTIMIZE\n\tif (origin !== previousOrigin) {\n\t\tif (DEBUG_CHANGES)\n\t\t\tconsole.log('origin changed from', previousOrigin, 'to', origin && origin.constructor || origin);\n\t\torigin = previousOrigin;\n\t}\n\t// @endif\n\n\tcircularDependencyDetector.leave(circularEventId)\n}\n\nexport function executeExternal(callback) {\n\texecuteWithOrigin('external', () => {\n\t\tif (externalChange) return callback();\n\t\texternalChange = true;\n\t\tcallback();\n\t\texternalChange = false;\n\t});\n}\n\nexport function executeWithOrigin(origin, task) {\n\tconst oldOrigin = origin;\n\tsetChangeOrigin(origin);\n\ttask();\n\tsetChangeOrigin(oldOrigin);\n}\n","import assert from '../util/assert';\nimport { changeType, addChange } from './change';\nimport { isClient } from '../util/environment';\nimport EventDispatcher, { globalEventDispatcher, GameEvent } from './eventDispatcher';\n\nexport const serializableCallbacks = {\n\taddSerializable: (serializable: Serializable) => { },\n\tremoveSerializable: (serializableId: string) => { },\n};\n\nconst CHARACTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; // 62 chars\nconst CHAR_COUNT = CHARACTERS.length;\n\nconst random = Math.random;\nexport function createStringId(threeLetterPrefix = '???', characters = 16) {\n\tlet id = threeLetterPrefix;\n\tfor (let i = characters - 1; i >= 0; --i)\n\t\tid += CHARACTERS[random() * CHAR_COUNT | 0];\n\treturn id;\n}\n\nlet serializableClasses = new Map();\n\nexport default class Serializable extends EventDispatcher {\n\tid: string;\n\tthreeLetterType: string;\n\tisRoot: boolean;\n\t_children: Map<string, Array<Serializable>> = new Map();\n\t_rootType: string;\n\t_parent: Serializable;\n\t_alive: boolean;\n\t_state: number;\n\n\tconstructor(predefinedId: string = '', skipSerializableRegistering = false) {\n\t\tsuper();\n\t\t// @ifndef OPTIMIZE\n\t\tassert(this.threeLetterType, 'Forgot to Serializable.registerSerializable your class?');\n\t\t// @endif\n\t\tthis._rootType = this.isRoot ? this.threeLetterType : null;\n\t\tif (skipSerializableRegistering)\n\t\t\treturn;\n\t\tif (predefinedId) {\n\t\t\tthis.id = predefinedId;\n\t\t} else {\n\t\t\tthis.id = createStringId(this.threeLetterType);\n\t\t}\n\t\t/*\n\t\tif (this.id.startsWith('?'))\n\t\t\tthrow new Error('?');\n\t\t\t*/\n\t\tserializableCallbacks.addSerializable(this);\n\t}\n\tmakeUpAName() {\n\t\treturn 'Serializable';\n\t}\n\tdelete() {\n\t\tsuper.delete();\n\t\tif (this._parent) {\n\t\t\tthis._parent.deleteChild(this);\n\t\t\treturn false;\n\t\t}\n\t\tthis.deleteChildren();\n\t\tthis._alive = false;\n\t\tthis._rootType = null;\n\t\tserializableCallbacks.removeSerializable(this.id);\n\t\tthis._state |= Serializable.STATE_DESTROY;\n\t\treturn true;\n\t}\n\tdeleteChildren() {\n\t\tif (this._children.size) {\n\t\t\tthis._children.forEach(array => {\n\t\t\t\tarray.forEach(child => {\n\t\t\t\t\tchild._parent = null;\n\t\t\t\t\tchild.delete();\n\t\t\t\t});\n\t\t\t});\n\t\t\tthis._children.clear();\n\n\t\t\tif (this._parent) {\n\t\t\t\taddChange(changeType.deleteAllChildren, this);\n\t\t\t}\n\t\t}\n\t}\n\t// this is called right after constructor\n\tinitWithChildren(children: Array<Serializable> = []) {\n\t\tassert(!(this._state & Serializable.STATE_INIT), 'init already done');\n\t\tthis._state |= Serializable.STATE_INIT;\n\t\tif (children.length > 0)\n\t\t\tthis.addChildren(children);\n\t\treturn this;\n\t}\n\taddChildren(children) {\n\t\tfor (let i = 0; i < children.length; i++)\n\t\t\tthis.addChild(children[i]);\n\t\treturn this;\n\t}\n\taddChild(child: Serializable): Serializable {\n\t\tthis._addChild(child);\n\n\t\tthis._state |= Serializable.STATE_ADDCHILD;\n\n\t\tif (this._rootType)\n\t\t\taddChange(changeType.addSerializableToTree, child);\n\t\treturn this;\n\t}\n\t_addChild(child: Serializable) {\n\t\tassert(child._parent === null);\n\n\t\tlet array = this._children.get(child.threeLetterType);\n\t\tif (array === undefined) {\n\t\t\tarray = [];\n\t\t\tthis._children.set(child.threeLetterType, array);\n\t\t}\n\t\tarray.push(child);\n\t\tchild._parent = this;\n\t\tchild._state |= Serializable.STATE_ADDPARENT;\n\n\t\tif (child._rootType !== this._rootType) // tiny optimization\n\t\t\tchild.setRootType(this._rootType);\n\n\t\treturn this;\n\t}\n\tfindChild(threeLetterType: string, filterFunction: (s: Serializable) => boolean, deep: boolean = false) {\n\t\tlet array = this._children.get(threeLetterType);\n\t\tif (!array) return null;\n\t\tif (filterFunction) {\n\t\t\tlet foundChild = array.find(filterFunction);\n\t\t\tif (foundChild) {\n\t\t\t\treturn foundChild;\n\t\t\t} else if (deep) {\n\t\t\t\tfor (let i = 0; i < array.length; ++i) {\n\t\t\t\t\tlet child = array[i];\n\t\t\t\t\tlet foundChild = child.findChild(threeLetterType, filterFunction, true);\n\t\t\t\t\tif (foundChild)\n\t\t\t\t\t\treturn foundChild;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t} else {\n\t\t\treturn array[0];\n\t\t}\n\t}\n\tfindParent(threeLetterType: string, filterFunction: (Serializable) => boolean = null) {\n\t\tlet serializable: Serializable = this;\n\t\twhile (serializable) {\n\t\t\tif (serializable.threeLetterType === threeLetterType && (!filterFunction || filterFunction(serializable)))\n\t\t\t\treturn serializable;\n\t\t\tserializable = serializable._parent;\n\t\t}\n\t\treturn null;\n\t}\n\tgetRoot() {\n\t\tlet serializable: Serializable = this;\n\t\twhile (serializable._parent) {\n\t\t\tserializable = serializable._parent;\n\t\t}\n\t\treturn serializable;\n\t}\n\t// idx is optional\n\tdeleteChild(child: Serializable, idx?: number) {\n\t\taddChange(changeType.deleteSerializable, child);\n\t\tthis._detachChild(child, idx);\n\t\tchild.delete();\n\t\treturn this;\n\t}\n\t// idx is optional\n\t_detachChild(child: Serializable, idx: number = 0) {\n\t\tlet array = this._children.get(child.threeLetterType);\n\t\tassert(array, 'child not found');\n\t\tif (array[idx] !== child)\n\t\t\tidx = array.indexOf(child);\n\t\tassert(idx >= 0, 'child not found');\n\t\tarray.splice(idx, 1);\n\t\tif (array.length === 0)\n\t\t\tthis._children.delete(child.threeLetterType);\n\t\tchild._parent = null;\n\t\tchild.setRootType(null);\n\n\t\treturn this;\n\t}\n\tforEachChild(threeLetterType: string = null, callback: (s: Serializable) => void, deep: boolean = false) {\n\t\tfunction processArray(array) {\n\t\t\tarray.forEach(child => {\n\t\t\t\tcallback(child);\n\t\t\t\tdeep && child.forEachChild(threeLetterType, callback, true);\n\t\t\t});\n\t\t}\n\t\tif (threeLetterType) {\n\t\t\tprocessArray(this._children.get(threeLetterType) || []);\n\t\t} else {\n\t\t\tthis._children.forEach(processArray);\n\t\t}\n\t\treturn this;\n\t}\n\tmove(newParent: Serializable) {\n\n\t\tnewParent._addChild(this._detach());\n\t\taddChange(changeType.move, this);\n\n\t\treturn this;\n\t}\n\t_detach() {\n\t\tthis._parent && this._parent._detachChild(this);\n\t\treturn this;\n\t}\n\tgetParent() {\n\t\treturn this._parent || null;\n\t}\n\tgetChildren(threeLetterType: string) {\n\t\treturn this._children.get(threeLetterType) || [];\n\t}\n\ttoJSON() {\n\t\tlet json: any = {\n\t\t\tid: this.id\n\t\t};\n\t\tif (this._children.size > 0) {\n\t\t\tlet arrays = [];\n\t\t\t// prototypes must come before a level\n\t\t\tArray.from(this._children.keys()).sort((a, b) => a === 'prt' ? -1 : 1)\n\t\t\t\t.forEach(key => arrays.push(this._children.get(key)));\n\t\t\tjson.c = [].concat(...arrays).map(child => child.toJSON());\n\t\t}\n\t\treturn json;\n\t}\n\ttoString() {\n\t\treturn JSON.stringify(this.toJSON(), null, 4);\n\t}\n\tclone() {\n\t\tlet obj: Serializable = new (this.constructor as any)();\n\t\tlet children = [];\n\t\tthis.forEachChild(null, child => {\n\t\t\tchildren.push(child.clone());\n\t\t});\n\t\tobj.initWithChildren(children);\n\t\tthis._state |= Serializable.STATE_CLONE;\n\t\treturn obj;\n\t}\n\thasDescendant(child: Serializable) {\n\t\tif (!child) return false;\n\t\tlet parent = child._parent;\n\t\twhile (parent) {\n\t\t\tif (parent === this) return true;\n\t\t\tparent = parent._parent;\n\t\t}\n\t\treturn false;\n\t}\n\tsetRootType(rootType: string) {\n\t\tif (this._rootType === rootType)\n\t\t\treturn;\n\t\tthis._rootType = rootType;\n\n\t\t// Optimized\n\t\tlet i;\n\t\tthis._children.forEach(childArray => {\n\t\t\tfor (i = 0; i < childArray.length; ++i) {\n\t\t\t\tchildArray[i].setRootType(rootType);\n\t\t\t}\n\t\t});\n\t}\n\tisInTree() {\n\t\treturn !!this._rootType;\n\t}\n\tstatic fromJSON(json: any) {\n\t\tassert(typeof json.id === 'string' && json.id.length > 5, 'Invalid id.');\n\t\tlet fromJSON = serializableClasses.get(json.id.substring(0, 3));\n\t\tassert(fromJSON);\n\t\tlet obj;\n\t\ttry {\n\t\t\tobj = fromJSON(json);\n\t\t} catch (e) {\n\t\t\tif (isClient) {\n\t\t\t\tconsole.error(e);\n\t\t\t\tif (!window['force'])\n\t\t\t\t\tdebugger; // Type 'force = true' in console to ignore failed imports.\n\n\t\t\t\tif (!window['force'])\n\t\t\t\t\tthrow new Error();\n\t\t\t} else {\n\t\t\t\tconsole.log('Error fromJSON', e);\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\t\tlet children = json.c ? json.c.map(child => Serializable.fromJSON(child)).filter(Boolean) : [];\n\t\tif (obj._state & Serializable.STATE_INIT)\n\t\t\tobj.addChildren(children);\n\t\telse\n\t\t\tobj.initWithChildren(children);\n\t\tobj._state |= Serializable.STATE_FROMJSON;\n\t\treturn obj;\n\t}\n\tstatic registerSerializable(Class: { new(...args): Serializable }, threeLetterType: string, fromJSON: (json: any) => Serializable = null) {\n\t\tClass.prototype.threeLetterType = threeLetterType;\n\t\tassert(typeof threeLetterType === 'string' && threeLetterType.length === 3);\n\t\tif (!fromJSON)\n\t\t\tfromJSON = json => new Class(json.id);\n\t\tserializableClasses.set(threeLetterType, fromJSON);\n\t}\n\n\tstatic STATE_INIT: number = 2;\n\tstatic STATE_ADDCHILD: number = 4;\n\tstatic STATE_ADDPARENT: number = 8;\n\tstatic STATE_CLONE: number = 16;\n\tstatic STATE_DESTROY: number = 32;\n\tstatic STATE_FROMJSON: number = 64;\n}\n\nSerializable.prototype._parent = null;\nSerializable.prototype._alive = true;\nSerializable.prototype._state = 0;\nSerializable.prototype._rootType = null;\n\nSerializable.prototype.isRoot = false; // If this should be a root node\nObject.defineProperty(Serializable.prototype, 'debug', {\n\tget() {\n\t\tlet info = this.threeLetterType;\n\n\t\tif (this.threeLetterType === 'cda')\n\t\t\tinfo += '|' + this.name;\n\n\t\tthis._children.forEach((value, key) => {\n\t\t\tinfo += '|';\n\t\t\tif (key === 'prp')\n\t\t\t\tinfo += this.getChildren('prp').map(p => `${p.name}=${p._value}`).join(', ');\n\t\t\telse\n\t\t\t\tinfo += `${key}(${value.length})`;\n\t\t});\n\n\t\tinfo += '|state: ';\n\n\t\tlet states = [];\n\t\tlet logState = (state, stateString) => {\n\t\t\tif (this._state & state)\n\t\t\t\tstates.push(stateString);\n\t\t};\n\n\t\tlogState(Serializable.STATE_INIT, 'init');\n\t\tlogState(Serializable.STATE_ADDCHILD, 'add child');\n\t\tlogState(Serializable.STATE_ADDPARENT, 'add parent');\n\t\tlogState(Serializable.STATE_CLONE, 'clone');\n\t\tlogState(Serializable.STATE_DESTROY, 'destroy');\n\t\tlogState(Serializable.STATE_FROMJSON, 'from json');\n\n\t\tinfo += states.join(', ');\n\n\t\treturn info;\n\t}\n});\nObject.defineProperty(Serializable.prototype, 'debugChildren', {\n\tget() {\n\t\tlet c = [];\n\t\tthis._children.forEach((value, key) => {\n\t\t\tc = c.concat(value);\n\t\t});\n\n\t\tlet children = [];\n\n\t\tfunction createDebugObject(type) {\n\t\t\tif (type === 'gam') return new function Game() { };\n\t\t\tif (type === 'sce') return new function Scene() { };\n\t\t\tif (type === 'prt') return new function Prototype() { };\n\t\t\tif (type === 'prp') return new function Property() { };\n\t\t\tif (type === 'cda') return new function ComponentData() { };\n\t\t\tif (type === 'com') return new function Component() { };\n\t\t\tif (type === 'epr') return new function EntityPrototype() { };\n\t\t\tif (type === 'ent') return new function Entity() { };\n\t\t\tif (type === 'lvl') return new function Level() { };\n\t\t\tif (type === 'pfa') return new function Prefab() { };\n\t\t\treturn new function Other() { };\n\t\t}\n\n\t\tc.forEach(child => {\n\t\t\tlet obj = createDebugObject(child.threeLetterType);\n\n\t\t\tobj.debug = child.debug;\n\t\t\tobj.ref = child;\n\t\t\tobj.debugChildren = child.debugChildren;\n\t\t\tlet c = child.debugChildArray;\n\t\t\tif (c && c.length > 0)\n\t\t\t\tobj.children = c;\n\t\t\tchildren.push(obj);\n\t\t});\n\n\t\treturn children;\n\t}\n});\n\n/**\n * If a serializable is a ancestor of another serializable, it is filtered out from the list\n */\nexport function filterChildren(serializables: Array<Serializable>) {\n\tlet idSet = new Set(serializables.map(s => s.id));\n\treturn serializables.filter(serializable => {\n\t\tlet parent = serializable.getParent();\n\t\twhile (parent) {\n\t\t\tif (idSet.has(parent.id))\n\t\t\t\treturn false;\n\t\t\tparent = parent.getParent();\n\t\t}\n\t\treturn true;\n\t});\n}\n","import assert from '../util/assert';\nimport Property from './property';\nimport { DataTypeContainer } from './dataTypes';\n// info about type, validator, validatorParameters, initialValue\n\nexport class PropertyType {\n\tflags: any;\n\tconstructor(\n\t\tpublic name: string,\n\t\tpublic type: DataType,\n\t\tpublic validator,\n\t\tpublic initialValue,\n\t\tpublic description: string,\n\t\tflags: Array<any> = [],\n\t\tpublic visibleIf\n\t) {\n\t\tassert(name[0] >= 'a' && name[0] <= 'z', 'Name of a property must start with lower case letter.');\n\t\tassert(type && typeof type.name === 'string');\n\t\tassert(validator && typeof validator.validate === 'function');\n\n\t\tthis.name = name;\n\t\tthis.type = type;\n\t\tthis.validator = validator;\n\t\tthis.initialValue = initialValue;\n\t\tthis.description = description;\n\t\tthis.visibleIf = visibleIf;\n\t\tthis.flags = {};\n\t\tflags.forEach(f => this.flags[f.type] = f);\n\t}\n\tgetFlag(flag: Flag) {\n\t\treturn this.flags[flag.type];\n\t}\n\tcreateProperty({\n\t\tvalue,\n\t\tpredefinedId,\n\t\tskipSerializableRegistering = false\n\t}: CreatePropertyParameters = {}) {\n\t\treturn new Property({\n\t\t\tpropertyType: this,\n\t\t\tvalue,\n\t\t\tpredefinedId,\n\t\t\tname: this.name,\n\t\t\tskipSerializableRegistering\n\t\t});\n\t}\n}\n\ntype CreatePropertyParameters = {\n\tvalue?: any;\n\tpredefinedId?: string;\n\tskipSerializableRegistering?: boolean;\n}\n\nexport interface PropType extends Function, DataTypeContainer {\n\tvisibleIf?: (propertyName: string, value: any) => any;\n}\n\n/*\n\tBeautiful way of creating property types\n\n\toptionalParameters:\n\t\tdescription: 'Example',\n\t\tvalidator: PropertyType.\n */\n/**\n *\n * @param propertyName - name of property. name will be converted propertyName -> Property Name in editor.\n * @param defaultValue - initial value of property\n * @param type - Prop.<type>, for example Prop.int, Prop.bool, prop.float\n * @param optionalParameters - \"description\", validator Prop.float.range(0, 1)\n */\nconst Prop: PropType = function Prop(propertyName: string, defaultValue: any, type: DataTypeDefinition, ...optionalParameters) {\n\tlet dataType = type();\n\tlet validator = dataType.validators.default();\n\tlet description = '';\n\tlet flags = [];\n\tlet visibleIf = null;\n\toptionalParameters.forEach((p, idx) => {\n\t\tif (typeof p === 'string')\n\t\t\tdescription = p;\n\t\telse if (p && p.validate)\n\t\t\tvalidator = p;\n\t\telse if (p && p.isFlag)\n\t\t\tflags.push(p);\n\t\telse if (p && p.visibleIf)\n\t\t\tvisibleIf = p;\n\t\telse\n\t\t\tassert(false, 'invalid parameter ' + p + ' idx ' + idx);\n\t});\n\treturn new PropertyType(propertyName, dataType, validator, defaultValue, description, flags, visibleIf);\n};\n\nexport default Prop;\n\n// if value is string, property must be value\n// if value is an array, property must be one of the values\nProp.visibleIf = function (propertyName: string, value: any) {\n\tassert(typeof propertyName === 'string' && propertyName.length);\n\tassert(typeof value !== 'undefined');\n\treturn {\n\t\tvisibleIf: true,\n\t\tpropertyName,\n\t\tvalues: Array.isArray(value) ? value : [value]\n\t};\n};\n\ntype Flag = {\n\ttype: string;\n\tisFlag: boolean;\n};\nfunction createFlag(type: string, func: any = {}): Flag {\n\tfunc.isFlag = true;\n\tfunc.type = type;\n\treturn func;\n}\n\nexport interface PropType {\n\tflagDegreesInEditor?: Flag;\n}\nProp.flagDegreesInEditor = createFlag('degreesInEditor');\n\ntype DataType = {\n\tname: string;\n\tvalidators?: { [s: string]: Function };\n\ttoJSON?: Function;\n\tfromJSON?: Function;\n\tclone?: Function;\n\tequal?: (a, b) => boolean\n};\nexport type DataTypeDefinition = Function;\n\nexport function createDataType({\n\tname = '',\n\tvalidators = { default: x => x }, // default must exist. if value is a reference(object), validator should copy the value.\n\ttoJSON = x => x,\n\tfromJSON = x => x,\n\tclone = x => x,\n\tequal = (a, b) => a === b\n}: DataType): DataTypeDefinition {\n\tassert(name, 'name missing from property type');\n\tassert(typeof validators.default === 'function', 'default validator missing from property type: ' + name);\n\tassert(typeof toJSON === 'function', 'invalid toJSON for property type: ' + name);\n\tassert(typeof fromJSON === 'function', 'invalid fromJSON for property type: ' + name);\n\n\tlet type: DataType = {\n\t\tname,\n\t\tvalidators,\n\t\ttoJSON,\n\t\tfromJSON,\n\t\tclone,\n\t\tequal\n\t};\n\tlet createType = () => type;\n\n\tObject.keys(validators).forEach(validatorName => {\n\t\tcreateType[validatorName] = createValidator(validatorName, validators[validatorName]);\n\t\tvalidators[validatorName] = createType[validatorName];\n\t});\n\treturn createType;\n}\n\ntype Validator = {\n\tvalidate?: Function,\n\tvalidatorName?: string,\n\tparameters?: Array<any>\n};\n\nfunction createValidator(name: string, validatorFunction: Function): Validator {\n\tlet validator: any = function (...args): Validator {\n\t\tlet parameters = args;\n\t\tlet validatorArgs = [null, ...args];\n\t\treturn {\n\t\t\tvalidatorName: name,\n\t\t\tvalidate: function (x) {\n\t\t\t\tvalidatorArgs[0] = x;\n\t\t\t\treturn validatorFunction.apply(null, validatorArgs);\n\t\t\t},\n\t\t\tparameters\n\t\t};\n\t};\n\tvalidator.validatorName = name;\n\tvalidator.validate = validatorFunction;\n\treturn validator;\n}\n","import assert from './assert'\n\nfunction isColor(color) {\n\n}\n\nexport class Color {\n\tr: number;\n\tg: number;\n\tb: number;\n\tconstructor(r: number | Color | string, g?: number, b?: number) {\n\t\tif (r instanceof Color) {\n\t\t\tthis.r = r.r;\n\t\t\tthis.g = r.g;\n\t\t\tthis.b = r.b;\n\t\t} else if (typeof r === 'number') {\n\t\t\tthis.r = Math.round(r);\n\t\t\tthis.g = Math.round(g);\n\t\t\tthis.b = Math.round(b);\n\t\t} else if (typeof r === 'string') {\n\t\t\tlet rgb = hexToRgb(r);\n\t\t\tthis.r = rgb.r;\n\t\t\tthis.g = rgb.g;\n\t\t\tthis.b = rgb.b;\n\t\t} else {\n\t\t\tassert(false, 'Invalid Color parameters');\n\t\t}\n\t}\n\ttoHexString() {\n\t\treturn rgbToHex(this.r, this.g, this.b);\n\t}\n\ttoHexNumber() {\n\t\treturn this.r * 256 * 256 + this.g * 256 + this.b;\n\t}\n\ttoString() {\n\t\treturn `[${this.r},${this.g},${this.b}]`;\n\t}\n\t/**\n\t *\n\t * @param color Color to interpolate to\n\t * @param t 0 .. 1\n\t */\n\tinterpolateLinear(color: Color, t: number) {\n\t\treturn new Color(\n\t\t\tthis.r + (color.r - this.r) * t,\n\t\t\tthis.g + (color.g - this.g) * t,\n\t\t\tthis.b + (color.b - this.b) * t\n\t\t);\n\t}\n\tinterpolateCubic(color: Color, control1: Color, control2: Color, t: number) {\n\t\tlet t2 = 1 - t;\n\t\treturn new Color(\n\t\t\tt2 ** 3 * this.r +\n\t\t\t\t3 * t2 * t2 * t * control1.r +\n\t\t\t\t3 * t2 * t * t * control2.r +\n\t\t\t\tt ** 3 * color.r,\n\t\t\tt2 ** 3 * this.g +\n\t\t\t\t3 * t2 * t2 * t * control1.g +\n\t\t\t\t3 * t2 * t * t * control2.g +\n\t\t\t\tt ** 3 * color.g,\n\t\t\tt2 ** 3 * this.b +\n\t\t\t\t3 * t2 * t2 * t * control1.b +\n\t\t\t\t3 * t2 * t * t * control2.b +\n\t\t\t\tt ** 3 * color.b\n\t\t);\n\t}\n\tisEqualTo(other: Color) {\n\t\treturn this.r === other.r && this.g === other.g && this.b === other.b;\n\t}\n\tstatic fromHexString(hexString: string) {\n\t\tlet rgb = hexToRgb(hexString);\n\t\treturn new Color(rgb.r, rgb.g, rgb.b);\n\t}\n}\n\nexport function hexToRgb(hex) {\n\tvar result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n\treturn result ? {\n\t\tr: parseInt(result[1], 16),\n\t\tg: parseInt(result[2], 16),\n\t\tb: parseInt(result[3], 16)\n\t} : null;\n}\n\nexport function componentToHex(c: number) {\n\tvar hex = c.toString(16);\n\treturn hex.length == 1 ? \"0\" + hex : hex;\n}\n\nexport function rgbToHex(r: number, g: number, b: number) {\n\treturn \"#\" + componentToHex(r) + componentToHex(g) + componentToHex(b);\n}\n\nexport function isHexString(hex: string) {\n\treturn hex && hex.match(/^#[0-9a-f]{6}$/i) ? true : false;\n}\n","import assert from '../util/assert';\nimport Prop, { createDataType, PropType, DataTypeDefinition } from './propertyType';\nimport Vector from '../util/vector';\nimport { isHexString, Color } from '../util/color';\n\nfunction validateFloat(val) {\n\tif (isNaN(val) || val === Infinity || val === -Infinity)\n\t\tthrow new Error('Invalid float: ' + val);\n}\n\nconst FLOAT_JSON_PRECISION = 4;\nconst FLOAT_JSON_PRECISION_MULTIPLIER = Math.pow(10, FLOAT_JSON_PRECISION);\nconst FLOAT_DELTA = 0.0000001;\n\nexport interface DataTypeContainer {\n\tfloat?: Function & {\n\t\trange?: (min: number, max: number) => number,\n\t\tmodulo?: (min: number, max: number) => number\n\t};\n}\nProp.float = createDataType({\n\tname: 'float',\n\tvalidators: {\n\t\tdefault(x) {\n\t\t\tx = parseFloat(x);\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tvalidateFloat(x);\n\t\t\t// @endif\n\t\t\treturn x;\n\t\t},\n\t\t// PropertyType.float.range(min, max)\n\t\trange(x: number, min: number, max: number): number {\n\t\t\tx = Number(x);\n\t\t\tvalidateFloat(x);\n\t\t\treturn Math.min(max, Math.max(min, x));\n\t\t},\n\t\tmodulo(x, min, max) {\n\t\t\tx = Number(x);\n\t\t\tvalidateFloat(x);\n\n\t\t\tlet range = max - min;\n\n\t\t\tif (x < min) {\n\t\t\t\tx += (((min - x) / range | 0) + 1) * range;\n\t\t\t} else if (x > max - FLOAT_DELTA) {\n\t\t\t\tx -= (((x - max) / range | 0) + 1) * range;\n\t\t\t}\n\n\t\t\treturn x;\n\t\t}\n\t},\n\ttoJSON: x => Math.round(x * FLOAT_JSON_PRECISION_MULTIPLIER) / FLOAT_JSON_PRECISION_MULTIPLIER,\n\tfromJSON: x => x\n});\n\nexport interface DataTypeContainer {\n\tint?: Function & {\n\t\trange?: (min: number, max: number) => number\n\t};\n}\nProp.int = createDataType({\n\tname: 'int',\n\tvalidators: {\n\t\tdefault(x) {\n\t\t\tx = parseInt(x);\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tvalidateFloat(x);\n\t\t\t// @endif\n\t\t\treturn x;\n\t\t},\n\t\t// PropertyType.float.range(min, max)\n\t\trange(x, min, max) {\n\t\t\tx = parseInt(x);\n\t\t\tvalidateFloat(x);\n\t\t\treturn Math.min(max, Math.max(min, x));\n\t\t}\n\t},\n\ttoJSON: x => x,\n\tfromJSON: x => x\n});\n\nexport interface DataTypeContainer { vector?: DataTypeDefinition; }\nProp.vector = createDataType({\n\tname: 'vector',\n\tvalidators: {\n\t\tdefault(vec) {\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tif (!(vec instanceof Vector))\n\t\t\t\tthrow new Error();\n\t\t\t// @endif\n\t\t\tvec = vec.clone();\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tvec.x = parseFloat(vec.x);\n\t\t\tvec.y = parseFloat(vec.y);\n\t\t\tvalidateFloat(vec.x);\n\t\t\tvalidateFloat(vec.y);\n\t\t\t// @endif\n\t\t\treturn vec;\n\t\t}\n\t},\n\ttoJSON: vec => ({\n\t\tx: Math.round(vec.x * FLOAT_JSON_PRECISION_MULTIPLIER) / FLOAT_JSON_PRECISION_MULTIPLIER,\n\t\ty: Math.round(vec.y * FLOAT_JSON_PRECISION_MULTIPLIER) / FLOAT_JSON_PRECISION_MULTIPLIER\n\t}),\n\tfromJSON: vec => Vector.fromObject(vec),\n\tclone: vec => vec.clone(),\n\tequal: (a: Vector, b: Vector) => a.isEqualTo(b)\n});\n\nexport interface DataTypeContainer { string?: DataTypeDefinition; }\nProp.string = createDataType({\n\tname: 'string',\n\tvalidators: {\n\t\tdefault: x => x ? String(x) : ''\n\t},\n\ttoJSON: x => x,\n\tfromJSON: x => x\n});\n\n// longString can have longer length in editor input\nexport interface DataTypeContainer { longString?: DataTypeDefinition; }\nProp.longString = createDataType({\n\tname: 'longString',\n\tvalidators: {\n\t\tdefault: x => x ? String(x) : ''\n\t},\n\ttoJSON: x => x,\n\tfromJSON: x => x\n});\n\nexport interface DataTypeContainer { bool?: DataTypeDefinition; }\nProp.bool = createDataType({\n\tname: 'bool',\n\tvalidators: {\n\t\tdefault(x) {\n\t\t\tif (typeof x !== 'boolean')\n\t\t\t\tthrow new Error();\n\t\t\treturn x;\n\t\t}\n\t},\n\ttoJSON: x => x ? 1 : 0,\n\tfromJSON: x => !!x\n});\n\nexport interface DataTypeContainer {\n\tenum?: Function & {\n\t\tvalues?: (...values: Array<string>) => string\n\t};\n}\nProp.enum = createDataType({\n\tname: 'enum',\n\tvalidators: {\n\t\tdefault() {\n\t\t\tassert(false, `also specify enum values with Prop.enum.values('value1', 'value2', ...)`);\n\t\t},\n\t\tvalues(x, ...values) {\n\t\t\tif (!Array.isArray(values))\n\t\t\t\tthrow new Error();\n\t\t\tif (typeof x !== 'string')\n\t\t\t\tthrow new Error('val should be string');\n\t\t\tif (values.indexOf(x) < 0)\n\t\t\t\tthrow new Error(`value ${x} not in enum: [${values}]`);\n\t\t\treturn x;\n\t\t}\n\t},\n\ttoJSON: x => x,\n\tfromJSON: x => x\n});\n\nexport interface DataTypeContainer { color?: DataTypeDefinition; }\nProp.color = createDataType({\n\tname: 'color',\n\tvalidators: {\n\t\tdefault(color) {\n\t\t\tlet newColor = new Color(color);\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tassert(newColor.r >= 0 && newColor.r < 256);\n\t\t\tassert(newColor.g >= 0 && newColor.g < 256);\n\t\t\tassert(newColor.b >= 0 && newColor.b < 256);\n\t\t\t// @endif\n\t\t\treturn newColor;\n\t\t}\n\t},\n\ttoJSON: x => x.toHexString(),\n\tfromJSON: x => new Color(x),\n\tequal: (a: Color, b: Color) => a.isEqualTo(b)\n});\n","var HASH = '#'.charCodeAt(0);\nvar DOT = '.'.charCodeAt(0);\n\nvar TAG_NAME = 0;\nvar ID = 1;\nvar CLASS_NAME = 2;\n\nvar parseQuery = function (query) {\n  var tag = null;\n  var id = null;\n  var className = null;\n  var mode = TAG_NAME;\n  var offset = 0;\n\n  for (var i = 0; i <= query.length; i++) {\n    var char = query.charCodeAt(i);\n    var isHash = char === HASH;\n    var isDot = char === DOT;\n    var isEnd = !char;\n\n    if (isHash || isDot || isEnd) {\n      if (mode === TAG_NAME) {\n        if (i === 0) {\n          tag = 'div';\n        } else {\n          tag = query.substring(offset, i);\n        }\n      } else if (mode === ID) {\n        id = query.substring(offset, i);\n      } else {\n        if (className) {\n          className += ' ' + query.substring(offset, i);\n        } else {\n          className = query.substring(offset, i);\n        }\n      }\n\n      if (isHash) {\n        mode = ID;\n      } else if (isDot) {\n        mode = CLASS_NAME;\n      }\n\n      offset = i + 1;\n    }\n  }\n\n  return { tag: tag, id: id, className: className };\n};\n\nvar createElement = function (query, ns) {\n  var ref = parseQuery(query);\n  var tag = ref.tag;\n  var id = ref.id;\n  var className = ref.className;\n  var element = ns ? document.createElementNS(ns, tag) : document.createElement(tag);\n\n  if (id) {\n    element.id = id;\n  }\n\n  if (className) {\n    if (ns) {\n      element.setAttribute('class', className);\n    } else {\n      element.className = className;\n    }\n  }\n\n  return element;\n};\n\nvar unmount = function (parent, child) {\n  var parentEl = getEl(parent);\n  var childEl = getEl(child);\n\n  if (child === childEl && childEl.__redom_view) {\n    // try to look up the view if not provided\n    child = childEl.__redom_view;\n  }\n\n  if (childEl.parentNode) {\n    doUnmount(child, childEl, parentEl);\n\n    parentEl.removeChild(childEl);\n  }\n\n  return child;\n};\n\nvar doUnmount = function (child, childEl, parentEl) {\n  var hooks = childEl.__redom_lifecycle;\n\n  if (hooksAreEmpty(hooks)) {\n    childEl.__redom_mounted = false;\n    return;\n  }\n\n  var traverse = parentEl;\n\n  if (childEl.__redom_mounted) {\n    trigger(childEl, 'onunmount');\n  }\n\n  while (traverse) {\n    var parentHooks = traverse.__redom_lifecycle || {};\n\n    for (var hook in hooks) {\n      if (parentHooks[hook]) {\n        parentHooks[hook] -= hooks[hook];\n      }\n    }\n\n    if (hooksAreEmpty(parentHooks)) {\n      traverse.__redom_lifecycle = null;\n    }\n\n    traverse = traverse.parentNode;\n  }\n};\n\nvar hooksAreEmpty = function (hooks) {\n  if (hooks == null) {\n    return true;\n  }\n  for (var key in hooks) {\n    if (hooks[key]) {\n      return false;\n    }\n  }\n  return true;\n};\n\nvar hookNames = ['onmount', 'onunmount'];\nvar shadowRootAvailable = typeof window !== 'undefined' && 'ShadowRoot' in window;\n\nvar mount = function (parent, child, before) {\n  var parentEl = getEl(parent);\n  var childEl = getEl(child);\n\n  if (child === childEl && childEl.__redom_view) {\n    // try to look up the view if not provided\n    child = childEl.__redom_view;\n  }\n\n  if (child !== childEl) {\n    childEl.__redom_view = child;\n  }\n\n  var wasMounted = childEl.__redom_mounted;\n  var oldParent = childEl.parentNode;\n\n  if (wasMounted && (oldParent !== parentEl)) {\n    doUnmount(child, childEl, oldParent);\n  }\n\n  if (before != null) {\n    parentEl.insertBefore(childEl, getEl(before));\n  } else {\n    parentEl.appendChild(childEl);\n  }\n\n  doMount(child, childEl, parentEl, oldParent);\n\n  return child;\n};\n\nvar doMount = function (child, childEl, parentEl, oldParent) {\n  var hooks = childEl.__redom_lifecycle || (childEl.__redom_lifecycle = {});\n  var remount = (parentEl === oldParent);\n  var hooksFound = false;\n\n  for (var i = 0; i < hookNames.length; i++) {\n    var hookName = hookNames[i];\n\n    if (!remount && (child !== childEl) && (hookName in child)) {\n      hooks[hookName] = (hooks[hookName] || 0) + 1;\n    }\n    if (hooks[hookName]) {\n      hooksFound = true;\n    }\n  }\n\n  if (!hooksFound) {\n    childEl.__redom_mounted = true;\n    return;\n  }\n\n  var traverse = parentEl;\n  var triggered = false;\n\n  if (remount || (!triggered && (traverse && traverse.__redom_mounted))) {\n    trigger(childEl, remount ? 'onremount' : 'onmount');\n    triggered = true;\n  }\n\n  if (remount) {\n    return;\n  }\n\n  while (traverse) {\n    var parent = traverse.parentNode;\n    var parentHooks = traverse.__redom_lifecycle || (traverse.__redom_lifecycle = {});\n\n    for (var hook in hooks) {\n      parentHooks[hook] = (parentHooks[hook] || 0) + hooks[hook];\n    }\n\n    if (!triggered && (traverse === document || (shadowRootAvailable && (traverse instanceof window.ShadowRoot)) || (parent && parent.__redom_mounted))) {\n      trigger(traverse, remount ? 'onremount' : 'onmount');\n      triggered = true;\n    }\n\n    traverse = parent;\n  }\n};\n\nvar trigger = function (el, eventName) {\n  if (eventName === 'onmount') {\n    el.__redom_mounted = true;\n  } else if (eventName === 'onunmount') {\n    el.__redom_mounted = false;\n  }\n\n  var hooks = el.__redom_lifecycle;\n\n  if (!hooks) {\n    return;\n  }\n\n  var view = el.__redom_view;\n  var hookCount = 0;\n\n  view && view[eventName] && view[eventName]();\n\n  for (var hook in hooks) {\n    if (hook) {\n      hookCount++;\n    }\n  }\n\n  if (hookCount) {\n    var traverse = el.firstChild;\n\n    while (traverse) {\n      var next = traverse.nextSibling;\n\n      trigger(traverse, eventName);\n\n      traverse = next;\n    }\n  }\n};\n\nvar setStyle = function (view, arg1, arg2) {\n  var el = getEl(view);\n\n  if (arg2 !== undefined) {\n    el.style[arg1] = arg2;\n  } else if (isString(arg1)) {\n    el.setAttribute('style', arg1);\n  } else {\n    for (var key in arg1) {\n      setStyle(el, key, arg1[key]);\n    }\n  }\n};\n\n/* global SVGElement */\n\nvar xlinkns = 'http://www.w3.org/1999/xlink';\n\nvar setAttr = function (view, arg1, arg2) {\n  var el = getEl(view);\n  var isSVG = el instanceof SVGElement;\n\n  if (arg2 !== undefined) {\n    if (arg1 === 'style') {\n      setStyle(el, arg2);\n    } else if (isSVG && isFunction(arg2)) {\n      el[arg1] = arg2;\n    } else if (arg1 === 'dataset') {\n      setData(el, arg2);\n    } else if (!isSVG && (arg1 in el || isFunction(arg2))) {\n      el[arg1] = arg2;\n    } else {\n      if (isSVG && (arg1 === 'xlink')) {\n        setXlink(el, arg2);\n        return;\n      }\n      el.setAttribute(arg1, arg2);\n    }\n  } else {\n    for (var key in arg1) {\n      setAttr(el, key, arg1[key]);\n    }\n  }\n};\n\nfunction setXlink (el, obj) {\n  for (var key in obj) {\n    el.setAttributeNS(xlinkns, key, obj[key]);\n  }\n}\n\nfunction setData (el, obj) {\n  for (var key in obj) {\n    el.dataset[key] = obj[key];\n  }\n}\n\nvar text = function (str) { return document.createTextNode((str != null) ? str : ''); };\n\nvar parseArguments = function (element, args) {\n  for (var i = 0; i < args.length; i++) {\n    var arg = args[i];\n\n    if (arg !== 0 && !arg) {\n      continue;\n    }\n\n    // support middleware\n    if (typeof arg === 'function') {\n      arg(element);\n    } else if (isString(arg) || isNumber(arg)) {\n      element.appendChild(text(arg));\n    } else if (isNode(getEl(arg))) {\n      mount(element, arg);\n    } else if (arg.length) {\n      parseArguments(element, arg);\n    } else if (typeof arg === 'object') {\n      setAttr(element, arg);\n    }\n  }\n};\n\nvar ensureEl = function (parent) { return isString(parent) ? html(parent) : getEl(parent); };\nvar getEl = function (parent) { return (parent.nodeType && parent) || (!parent.el && parent) || getEl(parent.el); };\n\nvar isString = function (a) { return typeof a === 'string'; };\nvar isNumber = function (a) { return typeof a === 'number'; };\nvar isFunction = function (a) { return typeof a === 'function'; };\n\nvar isNode = function (a) { return a && a.nodeType; };\n\nvar htmlCache = {};\n\nvar memoizeHTML = function (query) { return htmlCache[query] || (htmlCache[query] = createElement(query)); };\n\nvar html = function (query) {\n  var args = [], len = arguments.length - 1;\n  while ( len-- > 0 ) args[ len ] = arguments[ len + 1 ];\n\n  var element;\n\n  if (isString(query)) {\n    element = memoizeHTML(query).cloneNode(false);\n  } else if (isNode(query)) {\n    element = query.cloneNode(false);\n  } else if (isFunction(query)) {\n    var Query = query;\n    element = new (Function.prototype.bind.apply( Query, [ null ].concat( args) ));\n  } else {\n    throw new Error('At least one argument required');\n  }\n\n  parseArguments(getEl(element), args);\n\n  return element;\n};\n\nhtml.extend = function (query) {\n  var args = [], len = arguments.length - 1;\n  while ( len-- > 0 ) args[ len ] = arguments[ len + 1 ];\n\n  var clone = memoizeHTML(query);\n\n  return html.bind.apply(html, [ this, clone ].concat( args ));\n};\n\nvar el = html;\nvar h = html;\n\nvar setChildren = function (parent) {\n  var children = [], len = arguments.length - 1;\n  while ( len-- > 0 ) children[ len ] = arguments[ len + 1 ];\n\n  var parentEl = getEl(parent);\n  var current = traverse(parent, children, parentEl.firstChild);\n\n  while (current) {\n    var next = current.nextSibling;\n\n    unmount(parent, current);\n\n    current = next;\n  }\n};\n\nfunction traverse (parent, children, _current) {\n  var current = _current;\n\n  for (var i = 0; i < children.length; i++) {\n    var child = children[i];\n\n    if (!child) {\n      continue;\n    }\n\n    var childEl = getEl(child);\n\n    if (childEl === current) {\n      current = current.nextSibling;\n      continue;\n    }\n\n    if (isNode(childEl)) {\n      mount(parent, child, current);\n      continue;\n    }\n\n    if (child.length != null) {\n      current = traverse(parent, child, current);\n    }\n  }\n\n  return current;\n}\n\nvar propKey = function (key) { return function (item) { return item[key]; }; };\n\nvar listPool = function (View, key, initData) {\n  return new ListPool(View, key, initData);\n};\n\nvar ListPool = function ListPool (View, key, initData) {\n  this.View = View;\n  this.initData = initData;\n  this.oldLookup = {};\n  this.lookup = {};\n  this.oldViews = [];\n  this.views = [];\n\n  if (key != null) {\n    this.lookup = {};\n    this.key = isFunction(key) ? key : propKey(key);\n  }\n};\nListPool.prototype.update = function update (data, context) {\n  var ref = this;\n    var View = ref.View;\n    var key = ref.key;\n    var initData = ref.initData;\n  var keySet = key != null;\n\n  var oldLookup = this.lookup;\n  var newLookup = {};\n\n  var newViews = new Array(data.length);\n  var oldViews = this.views;\n\n  for (var i = 0; i < data.length; i++) {\n    var item = data[i];\n    var view = (void 0);\n\n    if (keySet) {\n      var id = key(item);\n      view = oldLookup[id] || new View(initData, item, i, data);\n      newLookup[id] = view;\n      view.__redom_id = id;\n    } else {\n      view = oldViews[i] || new View(initData, item, i, data);\n    }\n    view.update && view.update(item, i, data, context);\n\n    var el = getEl(view.el);\n    el.__redom_view = view;\n    newViews[i] = view;\n  }\n\n  this.oldViews = oldViews;\n  this.views = newViews;\n\n  this.oldLookup = oldLookup;\n  this.lookup = newLookup;\n};\n\nvar list = function (parent, View, key, initData) {\n  return new List(parent, View, key, initData);\n};\n\nvar List = function List (parent, View, key, initData) {\n  this.__redom_list = true;\n  this.View = View;\n  this.initData = initData;\n  this.views = [];\n  this.pool = new ListPool(View, key, initData);\n  this.el = ensureEl(parent);\n  this.keySet = key != null;\n};\nList.prototype.update = function update (data, context) {\n    var this$1 = this;\n    if ( data === void 0 ) data = [];\n\n  var ref = this;\n    var keySet = ref.keySet;\n  var oldViews = this.views;\n  var oldLookup = keySet && this.lookup;\n\n  this.pool.update(data, context);\n  var ref$1 = this.pool;\n    var views = ref$1.views;\n    var lookup = ref$1.lookup;\n\n  if (keySet) {\n    for (var i = 0; i < oldViews.length; i++) {\n      var id = oldViews[i].__redom_id;\n      if (!(id in lookup)) {\n        unmount(this$1, oldLookup[id]);\n      }\n    }\n  }\n\n  setChildren(this, views);\n\n  if (keySet) {\n    this.lookup = lookup;\n  }\n  this.views = views;\n};\n\nList.extend = function (parent, View, key, initData) {\n  return List.bind(List, parent, View, key, initData);\n};\n\nlist.extend = List.extend;\n\n/* global Node */\n\nvar place = function (View, initData) {\n  return new Place(View, initData);\n};\n\nvar Place = function Place (View, initData) {\n  this.el = text('');\n  this.visible = false;\n  this.view = null;\n  this._placeholder = this.el;\n  if (View instanceof Node) {\n    this._el = View;\n  } else {\n    this._View = View;\n  }\n  this._initData = initData;\n};\nPlace.prototype.update = function update (visible, data) {\n  var placeholder = this._placeholder;\n  var parentNode = this.el.parentNode;\n\n  if (visible) {\n    if (!this.visible) {\n      if (this._el) {\n        mount(parentNode, this._el, placeholder);\n        unmount(parentNode, placeholder);\n        this.el = this._el;\n        this.visible = visible;\n        return;\n      }\n      var View = this._View;\n      var view = new View(this._initData);\n\n      this.el = getEl(view);\n      this.view = view;\n\n      mount(parentNode, view, placeholder);\n      unmount(parentNode, placeholder);\n    }\n    this.view && this.view.update && this.view.update(data);\n  } else {\n    if (this.visible) {\n      if (this._el) {\n        mount(parentNode, placeholder, this._el);\n        unmount(parentNode, this._el);\n        this.el = placeholder;\n        this.visible = visible;\n        return;\n      }\n      mount(parentNode, placeholder, this.view);\n      unmount(parentNode, this.view);\n\n      this.el = placeholder;\n      this.view = null;\n    }\n  }\n  this.visible = visible;\n};\n\nvar router = function (parent, Views, initData) {\n  return new Router(parent, Views, initData);\n};\n\nvar Router = function Router (parent, Views, initData) {\n  this.el = ensureEl(parent);\n  this.Views = Views;\n  this.initData = initData;\n};\nRouter.prototype.update = function update (route, data) {\n  if (route !== this.route) {\n    var Views = this.Views;\n    var View = Views[route];\n\n    this.route = route;\n    this.view = View && new View(this.initData, data);\n\n    setChildren(this.el, [ this.view ]);\n  }\n  this.view && this.view.update && this.view.update(data, route);\n};\n\nvar ns = 'http://www.w3.org/2000/svg';\n\nvar svgCache = {};\n\nvar memoizeSVG = function (query) { return svgCache[query] || (svgCache[query] = createElement(query, ns)); };\n\nvar svg = function (query) {\n  var args = [], len = arguments.length - 1;\n  while ( len-- > 0 ) args[ len ] = arguments[ len + 1 ];\n\n  var element;\n\n  if (isString(query)) {\n    element = memoizeSVG(query).cloneNode(false);\n  } else if (isNode(query)) {\n    element = query.cloneNode(false);\n  } else if (isFunction(query)) {\n    var Query = query;\n    element = new (Function.prototype.bind.apply( Query, [ null ].concat( args) ));\n  } else {\n    throw new Error('At least one argument required');\n  }\n\n  parseArguments(getEl(element), args);\n\n  return element;\n};\n\nsvg.extend = function (query) {\n  var clone = memoizeSVG(query);\n\n  return svg.bind(this, clone);\n};\n\nsvg.ns = ns;\n\nvar s = svg;\n\nexport { el, h, html, list, List, listPool, ListPool, mount, unmount, place, Place, router, Router, setAttr, setStyle, setChildren, s, svg, text };\n","import {el, mount} from 'redom';\n\nexport function stickyNonModalErrorPopup(text) {\n\tdocument.body.style.filter = 'contrast(70%) brightness(130%) saturate(200%) sepia(40%) hue-rotate(300deg)';\n\n\tlet popup = el('div', text, {\n\t\tstyle: {\n\t\t\t'position': 'fixed',\n\t\t\t'display': 'inline-block',\n\t\t\t'max-width': '600%',\n\t\t\t'top': '20%',\n\t\t\t'width': '100%',\n\t\t\t'padding': '40px 10%',\n\t\t\t'font-size': '20px',\n\t\t\t'z-index': '100000',\n\t\t\t'color': 'white',\n\t\t\t'background': '#0c0c0c',\n\t\t\t'text-align': 'center',\n\t\t\t'user-select': 'auto !important',\n\t\t\t'box-sizing': 'border-box'\n\t\t}\n\t});\n\n\tmount(document.body, popup);\n}\n\nwindow.sticky = stickyNonModalErrorPopup;\n","import { isClient } from '../util/environment';\nimport Vector from '../util/vector';\n\nlet PIXI;\n\nif (isClient) {\n\tPIXI = window['PIXI'];\n\tPIXI.ticker.shared.stop();\n}\n\nexport default PIXI;\n\nlet renderer = null; // Only one PIXI renderer supported for now\n\nexport function getRenderer(canvas: HTMLCanvasElement) {\n\t/*\n\treturn {\n\t\trender: () => {},\n\t\tresize: () => {}\n\t};\n\t*/\n\n\tif (!renderer) {\n\t\trenderer = PIXI.autoDetectRenderer({\n\t\t\tview: canvas,\n\t\t\tautoResize: true,\n\t\t\tantialias: true\n\t\t});\n\n\t\t// Interaction plugin uses ticker that runs in the background. Destroy it to save CPU.\n\t\t// if (renderer.plugins.interaction) // if interaction is left out from pixi build, interaction is no defined\n\t\t// renderer.plugins.interaction.destroy();\n\t}\n\n\treturn renderer;\n}\n\nexport function sortDisplayObjects(container) {\n\tcontainer.children.sort(sortFunc);\n}\nfunction sortFunc(a, b) {\n\tif (a.y < b.y)\n\t\treturn -1;\n\telse if (a.y > b.y)\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\nlet texturesAndAnchors: { [hash: string]: { texture: any, anchor: any, graphicsObject, containsPoint: Function } } = {};\nexport function resetTexturesAndAnchors() {\n\tfor (let i in texturesAndAnchors) {\n\t\ttexturesAndAnchors[i].texture.destroy();\n\t\ttexturesAndAnchors[i].graphicsObject.destroy();\n\t}\n\ttexturesAndAnchors = {};\n}\nexport function getHashedTextureAndAnchor(hash) {\n\treturn texturesAndAnchors[hash];\n}\n/**\n *\n * @param graphicsObject You should not destroy this object after generating texture. It is used for collision testing\n * @param hash\n */\nexport function generateTextureAndAnchor(graphicsObject, hash) {\n\tif (!texturesAndAnchors[hash]) {\n\t\tlet bounds = graphicsObject.getLocalBounds();\n\t\tlet anchor = {\n\t\t\tx: -bounds.x / bounds.width,\n\t\t\ty: -bounds.y / bounds.height\n\t\t};\n\t\ttexturesAndAnchors[hash] = {\n\t\t\ttexture: renderer.generateTexture(graphicsObject, PIXI.SCALE_MODES.LINEAR, 2),\n\t\t\tanchor,\n\t\t\tgraphicsObject,\n\t\t\tcontainsPoint: (point) => {\n\t\t\t\t// Code copied from PIXI.js http://pixijs.download/release/docs/core_graphics_Graphics.js.html#line29\n\n\t\t\t\tfor (let i = 0; i < graphicsObject.graphicsData.length; ++i) {\n\t\t\t\t\tconst data = graphicsObject.graphicsData[i];\n\t\t\t\t\tif (!data.fill) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tif (data.shape) {\n\t\t\t\t\t\tif (data.shape.contains(point.x, point.y)) {\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t}\n\t\t};\n\t}\n\treturn texturesAndAnchors[hash];\n}\n\nconst hitTestCanvas = document.createElement('canvas');\nhitTestCanvas.width = 1;\nhitTestCanvas.height = 1;\nconst hitTestContext = hitTestCanvas.getContext('2d');\nexport function hitTest(sprite, pixiCoordinates: Vector, stage) {\n\tlet localBounds = sprite.getLocalBounds();\n\tlet textureSource = sprite.texture.baseTexture.source;\n\n\tlet localMousePoint = sprite.toLocal(pixiCoordinates, stage);\n\n\tlet xPart = (localMousePoint.x - localBounds.x) / (localBounds.width);\n\tlet yPart = (localMousePoint.y - localBounds.y) / (localBounds.height);\n\n\tif (xPart < 0 || xPart > 1 || yPart < 0 || yPart > 1) {\n\t\treturn false;\n\t}\n\n\thitTestCanvas.width = hitTestCanvas.width; // A way to reset contents of the canvas\n\thitTestContext.drawImage(textureSource, textureSource.width * xPart | 0, textureSource.height * yPart | 0, 1, 1, 0, 0, 1, 1);\n\tlet imageData = hitTestContext.getImageData(0, 0, 1, 1);\n\n\t/*\n\tPosition debugging\n\tconst c = document.createElement('canvas');\n\tc.setAttribute('style', 'position: fixed;top:0px;left:0px;');\n\tc.width = src.width;\n\tc.height = src.height;\n\tconst co = c.getContext('2d');\n\tco.drawImage(src, 0, 0);\n\tco.fillStyle = `rgb(${imageData.data[0]},${imageData.data[1]},${imageData.data[2]})`; ['red', 'green', 'blue', 'purple', 'white', 'yellow'][Math.random() * 6 | 0];\n\tco.strokeStyle = 'purple';\n\n\tco.fillRect((src.width * xPart | 0) - 10, (src.width * yPart | 0) - 10, 20, 20);\n\tco.strokeRect(xPart * c.width - 10, yPart * c.height - 10, 20, 20);\n\tdocument.body.appendChild(c);\n\t*/\n\n\treturn imageData.data[3] > 30; // Alpha channel is over 30/255\n}\n","import PIXI from '../features/graphics';\nimport Scene from '../core/scene';\nimport { globalEventDispatcher } from '../core/eventDispatcher';\n\nfunction createCanvas() {\n\tconst RESOLUTION = 10;\n\tvar canvas = document.createElement('canvas');\n\tcanvas.width  = 1;\n\tcanvas.height = RESOLUTION;\n\tvar ctx = canvas.getContext('2d');\n\tvar gradient = ctx.createLinearGradient(0, 0, 0, RESOLUTION * 0.8);\n\t// gradient.addColorStop(0, \"#5886c8\");\n\t// gradient.addColorStop(1, \"#9eb6d5\");\n\tgradient.addColorStop(0, \"#5c77ff\");\n\tgradient.addColorStop(1, \"#90c9f6\");\n\tctx.fillStyle = gradient;\n\tctx.fillRect(0, 0, 1, RESOLUTION);\n\treturn canvas;\n}\n\nglobalEventDispatcher.listen('scene load level', (scene: Scene) => {\n\tlet gradientCanvas = createCanvas();\n\tlet sprite = new PIXI.Sprite(PIXI.Texture.fromCanvas(gradientCanvas));\n\tscene['backgroundGradient'] = sprite;\n\tupdateSceneBackgroundGradient(scene);\n\tscene.layers.static.addChild(sprite);\n});\n\nglobalEventDispatcher.listen('scene unload level', (scene: Scene) => {\n\tdelete scene['backgroundGradient'];\n});\n\nglobalEventDispatcher.listen('canvas resize', (scene: Scene) => {\n\tupdateSceneBackgroundGradient(scene);\n});\n\nfunction updateSceneBackgroundGradient(scene: Scene) {\n\tif (!scene.canvas || !scene['backgroundGradient'])\n\t\treturn;\n\n\tscene['backgroundGradient'].width = scene.canvas.width;\n\tscene['backgroundGradient'].height = scene.canvas.height;\n};\n","import assert from '../util/assert';\nimport { isClient } from '../util/environment';\n\nlet p2;\nif (isClient)\n\tp2 = window.p2;\nelse\n\tp2 = require('../src/external/p2');\n\nexport default p2;\n\nexport function createWorld(owner, options) {\n\tassert(!owner._p2World);\n\towner._p2World = new p2.World({\n\t\tgravity: [0, 9.81]\n\t\t// gravity: [0, 0]\n\t});\n\n\t// Stress test says that Body sleeping performs better than Island sleeping when idling.\n\towner._p2World.sleepMode = p2.World.BODY_SLEEPING;\n}\n// const MAX_PHYSICS_DT = 0.2;\nconst PHYSICS_DT = 1 / 60;\nexport function updateWorld(owner, dt) {\n\towner._p2World.step(PHYSICS_DT, dt, 5);\n\t// owner._p2World.step(dt, dt, 10);\n}\nexport function deleteWorld(owner) {\n\tif (owner._p2World)\n\t\towner._p2World.clear()\n\tdelete owner._p2World;\n\tdelete owner._p2Materials;\n}\nexport function getWorld(owner) {\n\treturn owner._p2World;\n}\nexport function addBody(owner, body) {\n\towner._p2World.addBody(body);\n}\nexport function deleteBody(owner, body) {\n\towner._p2World.removeBody(body);\n}\n\n// export function addContactMaterial(owner, A, B, options) {\n// \towner._p2World.addContactMaterial(new p2.ContactMaterial(A, B, options));\n// }\n\nconst defaultMaterialOptions = {\n\tfriction: 0.3,\n\trestitution: 0,\n\tstiffness: 1e6, // Hardness of the contact. Less stiffness will make the objects penetrate more, and will make the contact act more like a spring than a contact force.\n\trelaxation: 4, // Original: 3. Small number makes bounce. Big number makes object stay inside another object.\n\tfrictionStiffness: 1e6, // Stiffness of the resulting friction force. For most cases, the value of this property should be a large number. I cannot think of any case where you would want less frictionStiffness.\n\tfrictionRelaxation: 4, // Relaxation of the resulting friction force. The default value should be good for most simulations.\n\tsurfaceVelocity: 0 // Will add surface velocity to this material. If bodyA rests on top if bodyB, and the surface velocity is positive, bodyA will slide to the right.\n};\n\nexport function createMaterial(owner, options) {\n\tif (!owner._p2Materials)\n\t\towner._p2Materials = {};\n\tlet materials = owner._p2Materials;\n\toptions = Object.assign({}, defaultMaterialOptions, options);\n\tlet hash = [\n\t\toptions.friction,\n\t\toptions.restitution,\n\t\toptions.stiffness,\n\t\toptions.relaxation,\n\t\toptions.frictionStiffness,\n\t\toptions.frictionRelaxation,\n\t\toptions.surfaceVelocity\n\t].join(';');\n\n\tif (materials[hash])\n\t\treturn materials[hash];\n\n\tlet material = new p2.Material();\n\tmaterial.options = options;\n\tmaterials[hash] = material;\n\n\t// TODO: When physics entities are edited, new materials are created.\n\t// Should somehow remove old unused materials and contact materials.\n\n\tfor (var h in materials) {\n\t\tlet m = materials[h];\n\t\tlet o1 = material.options;\n\t\tlet o2 = m.options;\n\t\tlet contactMaterial = new p2.ContactMaterial(material, m, {\n\t\t\tfriction:\t\t\t\tMath.min(o1.friction, o2.friction),\n\t\t\trestitution:\t\t\tMath.max(o1.restitution, o2.restitution), // If one is bouncy and other is not, collision is bouncy.\n\t\t\tstiffness:\t\t\t\tMath.min(o1.stiffness, o2.stiffness),\n\t\t\trelaxation:\t\t\t\t(o1.relaxation + o2.relaxation) / 2,\n\t\t\tfrictionStiffness:\t\tMath.min(o1.frictionStiffness, o2.frictionStiffness),\n\t\t\tfrictionRelaxation:\t\t(o1.frictionRelaxation + o2.frictionRelaxation) / 2,\n\t\t\tsurfaceVelocity:\t\tMath.max(o1.surfaceVelocity, o2.surfaceVelocity)\n\t\t});\n\t\towner._p2World.addContactMaterial(contactMaterial);\n\t}\n\n\treturn material;\n}\n","import Vector from './vector';\n\nexport function keyPressed(key) {\n\treturn keys[key] || false;\n}\n\nexport function listenKeyDown(handler) {\n\tkeyDownListeners.push(handler);\n\treturn () => keyDownListeners.splice(keyDownListeners.indexOf(handler), 1);\n}\nexport function listenKeyUp(handler) {\n\tkeyUpListeners.push(handler);\n\treturn () => keyUpListeners.splice(keyUpListeners.indexOf(handler), 1);\n}\n\nexport const key = {\n\tleft: 37,\n\tright: 39,\n\tup: 38,\n\tdown: 40,\n\tctrl: 17,\n\tappleLeft: 91,\n\tappleRight: 93,\n\talt: 18,\n\tshift: 16,\n\tspace: 32,\n\ta: 65,\n\tb: 66,\n\tc: 67,\n\td: 68,\n\te: 69,\n\tf: 70,\n\tg: 71,\n\th: 72,\n\ti: 73,\n\tj: 74,\n\tk: 75,\n\tl: 76,\n\tm: 77,\n\tn: 78,\n\to: 79,\n\tp: 80,\n\tq: 81,\n\tr: 82,\n\ts: 83,\n\tt: 84,\n\tu: 85,\n\tv: 86,\n\tw: 87,\n\tx: 88,\n\ty: 89,\n\tz: 90,\n\t'0': 48,\n\t'1': 49,\n\t'2': 50,\n\t'3': 51,\n\t'4': 52,\n\t'5': 53,\n\t'6': 54,\n\t'7': 55,\n\t'8': 56,\n\t'9': 57,\n\tbackspace: 8,\n\tenter: 13,\n\tesc: 27,\n\tplus: 187,\n\tminus: 189,\n\tquestionMark: 191\n};\n\nlet mouseDown = false;\nexport function isMouseButtonDown() {\n\treturn mouseDown;\n}\n\n\ndocument.addEventListener('mousedown', event => event.button === 0 && (mouseDown = true));\ndocument.addEventListener('mouseup', event => event.button === 0 && (mouseDown = false));\n\nexport function listenMouseMove(element: HTMLElement, handler: (vec: Vector, event?) => void): () => void {\n\tlet domHandler = event => {\n\t\tlet x = event.pageX;\n\t\tlet y = event.pageY;\n\t\tlet el = element;\n\t\twhile (el != null) {\n\t\t\tx -= el.offsetLeft;\n\t\t\ty -= el.offsetTop;\n\t\t\tel = <HTMLElement>el.offsetParent;\n\t\t}\n\n\t\telement['_mx'] = x;\n\t\telement['_my'] = y;\n\n\t\thandler && handler(new Vector(x, y), event);\n\t};\n\telement.addEventListener('mousemove', domHandler);\n\treturn () => element.removeEventListener('mousemove', domHandler);\n}\n// Requires listenMouseMove on the same element to get the mouse position\nexport function listenMouseDown(element: HTMLElement, handler: (vec?: Vector, event?) => void) {\n\tlet domHandler = event => {\n\t\tif (event.button !== 0)\n\t\t\treturn;\n\n\t\tif (typeof element['_mx'] === 'number')\n\t\t\thandler(new Vector(element['_mx'], element['_my']), event);\n\t\telse\n\t\t\thandler(null, event);\n\t};\n\telement.addEventListener('mousedown', domHandler);\n\treturn () => element.removeEventListener('mousedown', domHandler);\n}\n// Requires listenMouseMove on the same element to get the mouse position\nexport function listenMouseUp(element: HTMLElement, handler: (vec?: Vector, event?) => void) {\n\t// listen document body because many times mouse is accidentally dragged outside of element\n\tlet domHandler = event => {\n\t\tif (typeof element['_mx'] === 'number')\n\t\t\thandler(new Vector(element['_mx'], element['_my']), event);\n\t\telse\n\t\t\thandler(null, event);\n\t};\n\tdocument.body.addEventListener('mouseup', domHandler);\n\treturn () => document.body.removeEventListener('mouseup', domHandler);\n}\n\n////////////////////////////////////\n\n\nlet keys = {};\nlet keyDownListeners = [];\nlet keyUpListeners = [];\n\n\nif (typeof window !== 'undefined') {\n\n\twindow.onkeydown = event => {\n\t\tlet keyCode = event.which || event.keyCode;\n\n\t\tif (document.activeElement.nodeName.toLowerCase() == \"input\" && keyCode !== key.esc)\n\t\t\treturn;\n\n\t\tif (!keys[keyCode]) {\n\t\t\tkeys[keyCode] = true;\n\t\t\tkeyDownListeners.forEach(l => l(keyCode));\n\t\t}\n\n\t\t// console.log(keyCode);\n\t};\n\twindow.onkeyup = event => {\n\t\tlet key = event.which || event.keyCode;\n\t\tkeys[key] = false;\n\t\tkeyUpListeners.forEach(l => l(key));\n\t};\n}\n\nexport function simulateKeyEvent(eventName: 'keydown' | 'keyup', keyCode: number) {\n\tif (eventName === 'keydown') {\n\t\twindow.onkeydown({\n\t\t\tkeyCode\n\t\t} as any);\n\t} else if (eventName === 'keyup') {\n\t\twindow.onkeyup({\n\t\t\tkeyCode\n\t\t} as any);\n\t}\n}\n","import { isClient } from './environment';\nimport { editorEventDispacher } from \"../editor/editorEventDispatcher\";\nimport { eventDispatcherCallbacks } from '../core/eventDispatcher';\n\nconst UPDATE_INTERVAL = 1000; //ms\n\nlet performance;\nperformance = isClient ? window.performance : { now: Date.now };\n\nlet snapshotPerformance = []; // is static data for UPDATE_INTERVAL. then it changes.\nlet cumulativePerformance = {}; // will be reseted every UPDATE_INTERVAL\nlet currentPerformanceMeters = {}; // very short term\n\nlet perSecondSnapshot = [];\nlet currentPerSecondMeters = {};\nexport function eventHappened(name, count = 1) {\n\t// @ifndef OPTIMIZE\n\tif (['Event performance snapshot', 'Event perSecond snapshot'].includes(name)) return;\n\tcurrentPerSecondMeters[name] = (currentPerSecondMeters[name] || 0) + count;\n\t// @endif\n}\neventDispatcherCallbacks.eventDispatchedCallback = (eventName, count) => eventHappened(`Event ${eventName}`, count);\n\nexport function start(name) {\n\t// @ifndef OPTIMIZE\n\tcurrentPerformanceMeters[name] = performance.now();\n\t// @endif\n}\n\nexport function stop(name) {\n\t// @ifndef OPTIMIZE\n\tlet millis = performance.now() - currentPerformanceMeters[name];\n\tif (cumulativePerformance[name])\n\t\tcumulativePerformance[name] += millis;\n\telse\n\t\tcumulativePerformance[name] = millis;\n\t// @endif\n}\n\nlet performanceInterval = null;\nexport function startPerformanceUpdates() {\n\tperformanceInterval = setInterval(() => {\n\t\tprintPrivatePerformance(cumulativePerformance);\n\n\t\tsnapshotPerformance = performanceObjectToPublicArray(cumulativePerformance);\n\t\tcumulativePerformance = {};\n\t\teditorEventDispacher.dispatch('performance snapshot', snapshotPerformance);\n\n\t\tperSecondSnapshot = perSecondObjectToPublicArray(currentPerSecondMeters);\n\t\tcurrentPerSecondMeters = {};\n\t\teditorEventDispacher.dispatch('perSecond snapshot', perSecondSnapshot);\n\t}, UPDATE_INTERVAL);\n}\n\nfunction printPrivatePerformance(object) {\n\tlet msg = '';\n\tObject.keys(object).filter(key => key.startsWith('#')).map(key => ({\n\t\tname: key,\n\t\tvalue: object[key] / UPDATE_INTERVAL\n\t})).sort((a, b) => {\n\t\treturn a.value < b.value ? 1 : -1;\n\t}).forEach(perf => {\n\t\tmsg += `\\n   ${perf.name.substring(1)}: ${perf.value * 100}`;\n\t});\n\tif (msg)\n\t\tconsole.log('#Performance:' + msg);\n}\n\nfunction performanceObjectToPublicArray(object) {\n\treturn Object.keys(object).filter(key => !key.startsWith('#')).map(key => ({\n\t\tname: key,\n\t\tvalue: object[key] / UPDATE_INTERVAL\n\t})).sort((a, b) => {\n\t\treturn a.value < b.value ? 1 : -1;\n\t});\n}\nfunction perSecondObjectToPublicArray(object) {\n\treturn Object.keys(object).map(key => ({\n\t\tname: key,\n\t\tcount: object[key]\n\t})).sort((a, b) => a.name.localeCompare(b.name));\n}\n\nexport let FRAME_MEMORY_LENGTH = 60 * 8;\nlet frameTimes = [];\nfor (let i = 0; i < FRAME_MEMORY_LENGTH; ++i) {\n\tframeTimes.push(0);\n}\nexport function setFrameTime(seconds) {\n\t// @ifndef OPTIMIZE\n\tframeTimes.shift();\n\tframeTimes.push(seconds);\n\t// @endif\n}\nexport function getFrameTimes() {\n\treturn frameTimes;\n}\n","import Serializable from './serializable';\nimport assert from '../util/assert';\nimport { game } from './game';\nimport { addChange, changeType, setChangeOrigin } from './change';\nimport { createWorld, deleteWorld, updateWorld } from '../features/physics';\nimport { listenMouseMove, listenMouseDown, listenMouseUp, listenKeyDown, key, keyPressed } from '../util/input';\nimport { default as PIXI, getRenderer, sortDisplayObjects } from '../features/graphics';\nimport * as performanceTool from '../util/performance';\nimport Vector from '../util/vector';\n\nimport Level from './level';\nimport { Component } from './component';\nimport EntityPrototype from './entityPrototype';\nimport { GameEvent, globalEventDispatcher } from './eventDispatcher';\n\nlet scene: Scene = null;\nexport { scene };\n\nconst physicsOptions = {\n\tenableSleeping: true\n};\n\nexport default class Scene extends Serializable {\n\tcanvas: HTMLCanvasElement;\n\trenderer: any;\n\tmouseListeners: Array<() => void>;\n\tlevel: Level;\n\tstage: PIXI.Container;\n\tcameraPosition: Vector;\n\tcameraZoom: number;\n\tlayers: { [s: string]: PIXI.Container } = {};\n\tcomponents: Map<string, Set<Component>>;\n\tanimationFrameId: any;\n\tplaying: boolean;\n\ttime: number;\n\twon: boolean;\n\t_prevUpdate: number;\n\tresetting: boolean = false;\n\tpixelDensity: Vector = new Vector(1, 1);\n\n\tconstructor(predefinedId?) {\n\t\tsuper(predefinedId);\n\n\t\tif (scene) {\n\t\t\ttry {\n\t\t\t\tscene.delete();\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn('Deleting old scene failed', e);\n\t\t\t}\n\t\t}\n\t\tscene = this;\n\n\t\tthis.canvas = document.querySelector('canvas.openEditPlayCanvas');\n\t\tthis.renderer = getRenderer(this.canvas);\n\n\t\tthis.mouseListeners = [\n\t\t\tlistenMouseMove(this.canvas, mousePosition => this.dispatch('onMouseMove', mousePosition)),\n\t\t\tlistenMouseDown(this.canvas, mousePosition => this.dispatch('onMouseDown', mousePosition)),\n\t\t\tlistenMouseUp(this.canvas, mousePosition => this.dispatch('onMouseUp', mousePosition))\n\t\t];\n\n\t\taddChange(changeType.addSerializableToTree, this);\n\n\t\tglobalEventDispatcher.dispatch(GameEvent.GLOBAL_SCENE_CREATED, this);\n\t}\n\tmakeUpAName() {\n\t\tif (this.level)\n\t\t\treturn this.level.makeUpAName();\n\t\telse\n\t\t\treturn 'Scene';\n\t}\n\n\tloadLevel(level: Level) {\n\t\tthis.level = level;\n\n\t\tthis.stage = new PIXI.Container();\n\t\tthis.cameraPosition = new Vector(0, 0);\n\t\tthis.cameraZoom = 1;\n\n\t\tlet self = this;\n\t\tfunction createLayer(parent = self.stage): PIXI.Container {\n\t\t\tlet layer = new PIXI.Container();\n\t\t\tparent.addChild(layer);\n\t\t\treturn layer;\n\t\t}\n\t\tthis.layers = {\n\t\t\tstatic: createLayer(), // doesn't move when camera does\n\t\t\tbackground: createLayer(), // moves a little when camera does\n\t\t\tmove: createLayer(), // moves with camera\n\t\t\tui: createLayer() // doesn't move, is on front\n\t\t};\n\t\tthis.layers.behind = createLayer(this.layers.move);\n\t\tthis.layers.main = createLayer(this.layers.move);\n\t\tthis.layers.front = createLayer(this.layers.move);\n\n\t\t// this.bloom = new PIXI.filters.AdvancedBloomFilter();\n\t\t// this.layers.move.filters = [this.bloom];\n\n\t\t// To make component based entity search fast:\n\t\tthis.components = new Map(); // componentName -> Set of components\n\n\t\tthis.animationFrameId = null;\n\t\tthis.playing = false;\n\t\tthis.time = 0;\n\t\tthis.won = false;\n\n\t\tcreateWorld(this, physicsOptions);\n\n\t\tglobalEventDispatcher.dispatch('scene load level before entities', scene, level);\n\n\t\tthis.level.getChildren('epr').map((epr: EntityPrototype) => epr.createEntity(this));\n\n\t\tglobalEventDispatcher.dispatch('scene load level', scene, level);\n\n\t\t// this.draw();\n\t}\n\tunloadLevel() {\n\t\tlet level = this.level;\n\t\tthis.level = null;\n\n\t\tthis.pause();\n\n\t\tthis.deleteChildren();\n\n\t\tif (this.stage)\n\t\t\tthis.stage.destroy();\n\t\tthis.stage = null;\n\n\t\tthis.layers = {};\n\n\t\tthis.components.clear();\n\n\t\tdeleteWorld(this);\n\n\t\tglobalEventDispatcher.dispatch('scene unload level', scene, level);\n\t}\n\n\tsetCameraPositionToPlayer() {\n\t\tlet pos = new Vector(0, 0);\n\t\tlet count = 0;\n\t\tthis.getComponents('CharacterController').forEach(characterController => {\n\t\t\tif (characterController._rootType) {\n\t\t\t\tpos.add(characterController.Transform.getGlobalPosition());\n\t\t\t\tcount++;\n\t\t\t}\n\t\t});\n\t\tif (count > 0) {\n\t\t\tthis.cameraPosition.set(pos.divideScalar(count));\n\t\t}\n\t}\n\n\tupdateCamera() {\n\t\tif (this.playing) {\n\t\t\tthis.setCameraPositionToPlayer();\n\t\t}\n\t\t// pivot is camera top left corner position\n\t\tthis.layers.move.pivot.set(this.cameraPosition.x - this.canvas.width / 2 / this.cameraZoom, this.cameraPosition.y - this.canvas.height / 2 / this.cameraZoom);\n\t\tthis.layers.move.scale.set(this.cameraZoom, this.cameraZoom);\n\t}\n\n\twin() {\n\t\tthis.won = true;\n\t}\n\n\tanimFrame() {\n\t\tthis.animationFrameId = null;\n\t\tif (!this._alive || !this.playing) return;\n\n\t\tlet timeInMilliseconds = performance.now();\n\t\tlet t = 0.001 * timeInMilliseconds;\n\t\tlet dt = t - this._prevUpdate;\n\n\t\tperformanceTool.setFrameTime(dt);\n\n\t\tif (dt > 0.05)\n\t\t\tdt = 0.05;\n\t\tthis._prevUpdate = t;\n\t\tthis.time += dt;\n\n\t\tsetChangeOrigin(this);\n\n\t\t// Update logic\n\t\tperformanceTool.start('Component updates');\n\t\tthis.dispatch('onUpdate', dt, this.time);\n\t\tperformanceTool.stop('Component updates');\n\n\t\t// performanceTool.start('Component up2');\n\t\t// let set = this.getComponents('Spawner');\n\t\t// let sceneTime = this.time;\n\t\t// set.forEach(comp => {\n\t\t// \tif (sceneTime > comp.lastSpawn + comp.interval)\n\t\t// \t\tcomp.spawn();\n\t\t// });\n\t\t// performanceTool.stop('Component up2');\n\n\t\t// Update physics\n\t\tperformanceTool.start('Physics');\n\t\tupdateWorld(this, dt);\n\t\tperformanceTool.stop('Physics');\n\n\t\t// // Update logic\n\t\t// performanceTool.start('Component post updates');\n\t\t// this.dispatch('onPostPhysicsUpdate', dt, this.time);\n\t\t// performanceTool.stop('Component post updates');\n\n\t\t// Update graphics\n\t\tperformanceTool.start('Draw');\n\t\tthis.draw();\n\t\tperformanceTool.stop('Draw');\n\n\t\tif (this.won) {\n\t\t\tthis.pause();\n\t\t\tthis.time = 0;\n\t\t\tgame.dispatch(GameEvent.GAME_LEVEL_COMPLETED);\n\t\t\tthis.reset();\n\t\t}\n\n\t\tthis.requestAnimFrame();\n\t}\n\n\trequestAnimFrame() {\n\t\tlet callback = () => this.animFrame();\n\t\tif (window.requestAnimationFrame)\n\t\t\tthis.animationFrameId = window.requestAnimationFrame(callback);\n\t\telse\n\t\t\tthis.animationFrameId = setTimeout(callback, 16);\n\t}\n\n\tdraw() {\n\t\tthis.updateCamera();\n\n\t\t[this.layers.behind, this.layers.main, this.layers.front].forEach(sortDisplayObjects);\n\n\t\tthis.renderer.render(this.stage, null, false);\n\n\t\tthis.dispatch(GameEvent.SCENE_DRAW, scene);\n\t\tperformanceTool.eventHappened('Draws');\n\t}\n\n\tisInInitialState() {\n\t\treturn !this.playing && this.time === 0;\n\t}\n\n\treset() {\n\t\tif (!this._alive)\n\t\t\treturn; // scene has been replaced by another one\n\n\t\tthis.resetting = true;\n\n\t\tlet level = this.level;\n\t\tthis.unloadLevel();\n\n\t\tif (level)\n\t\t\tthis.loadLevel(level);\n\n\t\t// this.draw(); // we might be doing ok even without draw.\n\t\t// player mode starts mainloop and editor may want to control the drawing more.\n\n\t\tdelete this.resetting;\n\n\t\tthis.dispatch(GameEvent.SCENE_RESET);\n\t}\n\n\tpause() {\n\t\tif (!this.playing) return;\n\n\t\tthis.playing = false;\n\t\tif (this.animationFrameId) {\n\t\t\tif (window.requestAnimationFrame)\n\t\t\t\twindow.cancelAnimationFrame(this.animationFrameId);\n\t\t\telse\n\t\t\t\tclearTimeout(this.animationFrameId);\n\t\t}\n\t\tthis.animationFrameId = null;\n\n\t\tthis.dispatch(GameEvent.SCENE_PAUSE);\n\t}\n\n\tplay() {\n\t\tif (this.playing) return;\n\n\t\tthis._prevUpdate = 0.001 * performance.now();\n\t\tthis.playing = true;\n\n\t\tthis.requestAnimFrame();\n\n\t\tif (this.time === 0)\n\t\t\tthis.dispatch(GameEvent.SCENE_START);\n\n\t\tthis.dispatch(GameEvent.SCENE_PLAY);\n\t}\n\n\tdelete() {\n\t\tif (!super.delete()) return false;\n\n\t\tthis.unloadLevel();\n\n\t\tif (scene === this)\n\t\t\tscene = null;\n\n\t\tif (this.mouseListeners) {\n\t\t\tthis.mouseListeners.forEach(listener => listener());\n\t\t\tthis.mouseListeners = null;\n\t\t}\n\n\t\tthis.renderer = null; // Do not call renderer.destroy(). Same renderer is used by all scenes for now.\n\n\t\treturn true;\n\t}\n\n\t// To make component based entity search fast:\n\taddComponent(component: Component) {\n\t\tlet set = this.components.get(component.componentClass.componentName);\n\t\tif (!set) {\n\t\t\tset = new Set();\n\t\t\tthis.components.set(component.componentClass.componentName, set);\n\t\t}\n\t\tset.add(component);\n\t}\n\n\tremoveComponent(component: Component) {\n\t\tlet set = this.components.get(component.componentClass.componentName);\n\t\tassert(set);\n\t\tassert(set.delete(component));\n\t}\n\n\tgetComponents(componentName) {\n\t\treturn this.components.get(componentName) || new Set;\n\t}\n\n\tmouseToWorld(mousePosition: Vector) {\n\t\treturn new Vector(\n\t\t\tthis.layers.move.pivot.x + mousePosition.x / this.cameraZoom * this.pixelDensity.x,\n\t\t\tthis.layers.move.pivot.y + mousePosition.y / this.cameraZoom * this.pixelDensity.y\n\t\t);\n\t}\n\tworldToMouse(worldPosition: Vector) {\n\t\treturn new Vector(\n\t\t\t(worldPosition.x - this.layers.move.pivot.x) * this.cameraZoom / this.pixelDensity.x,\n\t\t\t(worldPosition.y - this.layers.move.pivot.y) * this.cameraZoom / this.pixelDensity.y\n\t\t);\n\t}\n\tmouseToPIXI(mousePosition: Vector) {\n\t\treturn mousePosition.clone().multiply(this.pixelDensity);\n\t}\n\tscreenPixelsToWorldPixels(screenPixels: number) {\n\t\treturn screenPixels / this.cameraZoom * this.pixelDensity.x;\n\t}\n\tgetEntitiesAtScreenPoint(screenPoint: Vector) {\n\t\tfor (const child of this.stage.children) {\n\n\t\t}\n\t}\n\n\tsetZoom(zoomLevel) {\n\t\tif (zoomLevel)\n\t\t\tthis.cameraZoom = zoomLevel;\n\t\tthis.dispatch(GameEvent.SCENE_ZOOM_CHANGED, this.cameraZoom);\n\t}\n\n\tresizeCanvas(gameResolution: Vector, screenResolution?: Vector) {\n\t\tthis.renderer.resize(gameResolution.x, gameResolution.y);\n\n\t\tif (screenResolution) {\n\t\t\tthis.pixelDensity.setScalars(gameResolution.x / screenResolution.x, gameResolution.y / screenResolution.y);\n\t\t} else {\n\t\t\tthis.pixelDensity.setScalars(1, 1);\n\t\t}\n\t}\n}\nScene.prototype.isRoot = true;\n\nSerializable.registerSerializable(Scene, 'sce');\n\nexport function forEachScene(listener) {\n\tglobalEventDispatcher.listen(GameEvent.GLOBAL_SCENE_CREATED, listener);\n\n\tif (scene)\n\t\tlistener(scene);\n}\n","import assert, { changeGetter as assertChangeGetter } from '../util/assert';\nimport Serializable, { serializableCallbacks } from './serializable';\n\nexport let serializables = {};\n\nexport function addSerializable(serializable: Serializable) {\n// @ifndef OPTIMIZE\n\tif (serializables[serializable.id] !== undefined)\n\t\tassert(false, (\"Serializable id clash \" + (serializable.id)));\n// @endif\n\tserializables[serializable.id] = serializable;\n}\nserializableCallbacks.addSerializable = addSerializable;\n\nexport function getSerializable(id: string) {\n\treturn serializables[id] || null;\n}\n\nexport function hasSerializable(id: string) {\n\treturn Boolean(serializables[id]);\n}\n\nexport function removeSerializable(id: string) {\n\t/* When deleting a scene, this function is called a lot of times\n\tif (!serializables[id])\n\t\tthrow new Error('Serializable not found!');\n\t*/\n\tdelete serializables[id];\n}\nserializableCallbacks.removeSerializable = removeSerializable;\n","import Serializable, { createStringId } from './serializable';\nimport assert from '../util/assert';\nimport Prop, { PropertyType } from './propertyType';\nimport PropertyOwner from './propertyOwner';\nimport ComponentData from './componentData';\nimport Entity from './entity';\nimport { game } from './game';\nimport { Component } from './component';\nimport EntityPrototype from './entityPrototype';\nimport Level from './level';\nimport { globalEventDispatcher, GameEvent } from './eventDispatcher';\nimport Property from './property';\n\nlet propertyTypes = [\n\tProp('name', 'No name', Prop.string)\n];\n\nexport default class Prototype extends PropertyOwner {\n\tpreviouslyCreatedEntity: Entity;\n\tname: string; // Hack to reveal PropertyOwner property\n\tsiblingId: string;\n\n\tstatic _propertyTypes: Array<PropertyType>;\n\tstatic _propertyTypesByName: { [s: string]: PropertyType };\n\n\tconstructor(predefinedId?: string, siblingId?: string) {\n\t\tsuper(predefinedId);\n\t\tthis.previouslyCreatedEntity = null;\n\t\tthis.siblingId = siblingId || Prototype.createSiblingId()\n\t}\n\n\tstatic createSiblingId() {\n\t\treturn createStringId('', 6)\n\t}\n\n\tmakeUpAName() {\n\t\treturn this.name || 'Prototype';\n\t}\n\n\taddChild(child: Serializable): Prototype {\n\t\t// if (child.threeLetterType === 'cda' && !child.componentClass.allowMultiple)\n\t\tif (child instanceof ComponentData && !(child as ComponentData).componentClass.allowMultiple)\n\t\t\tassert(this.findChild('cda', (cda: ComponentData) => cda.componentId === child.componentId) === null, `Can't have multiple ${child.name} components. See Component.allowMultiple`);\n\t\tsuper.addChild(child);\n\t\treturn this;\n\t}\n\tgetParentPrototype(): Prototype {\n\t\treturn this._parent && this._parent.threeLetterType === 'prt' ? this._parent as Prototype : null;\n\t}\n\n\t/**\n\t * \"\" = path to current prototype\n\t * \"abc\" = path to child prototype that has siblingId \"abc\"\n\t * \"abc/def/ghi\" = path to child of child of child.\n\t */\n\tgetPrototypePath(childTarget: Prototype) {\n\t\tlet path = '';\n\t\twhile (childTarget && childTarget !== this) {\n\t\t\tif (path) {\n\t\t\t\tpath = childTarget.siblingId + '/' + path\n\t\t\t} else {\n\t\t\t\tpath = childTarget.siblingId\n\t\t\t}\n\t\t\tchildTarget = childTarget.getParent() as Prototype\n\t\t}\n\t\tif (childTarget === this) {\n\t\t\treturn path;\n\t\t}\n\t\treturn null;\n\t}\n\tgetPrototypeByPath(path) {\n\t\tif (typeof path !== 'string') {\n\t\t\t// assert(false, 'did not find prototype by path')\n\t\t\treturn null\n\t\t}\n\t\tlet siblingIds = path.split('/').filter(Boolean)\n\t\tlet prototype = this\n\t\tfor (const siblingId of siblingIds) {\n\t\t\tprototype = prototype.findChild(this.threeLetterType, (prt: Prototype) => prt.siblingId === siblingId)\n\t\t\tif (!prototype) {\n\t\t\t\t// assert(false, 'did not find prototype by path')\n\t\t\t\treturn null\n\t\t\t}\n\t\t}\n\t\treturn prototype\n\t}\n\n\t/*\n\tfilter filters component datas\n\n\tReturns JSON:\n\t[\n\t\t{\n\t\t\townComponent: false, // component of a parent prototype\n\t\t\tcomponentClass: [object Object],\n\t\t\tcomponentId: <componentId>,\n\t\t\tthreeLetterType: 'icd',\n\t \t\tgeneratedForPrototype: <this>,\n\t\t\tproperties: [\n\t\t\t\t{ id missing }\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t ownComponentData: <ComponentData> || null, // null if this prototype has 0 properties defined\n\t\t\t componentClass: [object Object],\n\t\t\t componentId: <componentId>,\n\t\t\t threeLetterType: 'icd',\n\t\t\t generatedForPrototype: <this>,\n\t\t\t properties: [\n\t\t\t \t{ id found if own property } // some properties might be from parent prototypes and thus missing id\n\t\t\t ]\n\t\t }\n\t]\n\t */\n\tgetInheritedComponentDatas(filter: (cda: ComponentData) => boolean = null) {\n\t\tlet data = getDataFromPrototype(this, this, filter);\n\t\tlet array = Object.keys(data).map(key => data[key]);\n\t\tlet inheritedComponentData: InheritedComponentData = null;\n\t\tfor (let i = 0; i < array.length; ++i) {\n\t\t\tinheritedComponentData = array[i];\n\t\t\tinheritedComponentData.properties = inheritedComponentData.componentClass._propertyTypes.map(propertyType => {\n\t\t\t\treturn inheritedComponentData.propertyHash[propertyType.name]\n\t\t\t\t\t|| propertyType.createProperty({ skipSerializableRegistering: true });\n\t\t\t});\n\t\t\tdelete inheritedComponentData.propertyHash;\n\t\t}\n\n\t\treturn array.sort(sortInheritedComponentDatas);\n\t}\n\n\thasComponentData(componentName) {\n\t\tlet componentData = this.findChild('cda', (cda: ComponentData) => cda.name === componentName);\n\t\tif (componentData) {\n\t\t\treturn true;\n\t\t}\n\t\tlet parentPrototype = this.getParentPrototype();\n\t\tif (parentPrototype) {\n\t\t\treturn parentPrototype.hasComponentData(componentName);\n\t\t}\n\t\treturn false;\n\t}\n\n\tcreateAndAddPropertyForComponentData(inheritedComponentData, propertyName, propertyValue) {\n\t\tlet propertyType = inheritedComponentData.componentClass._propertyTypesByName[propertyName] as PropertyType;\n\t\tassert(propertyType, 'Invalid propertyName', propertyName, inheritedComponentData);\n\t\tlet componentData = this.findChild('cda', (componentData: ComponentData) => componentData.componentId === inheritedComponentData.componentId);\n\t\tlet componentDataIsNew = false;\n\t\tif (!componentData) {\n\t\t\tconsole.log('no component data. create one', this, inheritedComponentData);\n\t\t\tcomponentData = new ComponentData(inheritedComponentData.componentClass.componentName, false, inheritedComponentData.componentId);\n\t\t\tcomponentDataIsNew = true;\n\t\t}\n\t\tlet property = componentData.findChild('prp', property => property.name === propertyName);\n\t\tif (property) {\n\t\t\tproperty.value = propertyValue;\n\t\t\treturn property;\n\t\t}\n\n\t\tproperty = propertyType.createProperty({\n\t\t\tvalue: propertyValue,\n\t\t});\n\t\tcomponentData.addChild(property);\n\n\t\tif (componentDataIsNew)\n\t\t\tthis.addChild(componentData);\n\n\t\treturn property;\n\t}\n\n\tfindComponentDataByComponentId(componentId: string, alsoFindFromParents = false): ComponentData {\n\t\tlet child = this.findChild('cda', (componentData: ComponentData) => componentData.componentId === componentId) as ComponentData;\n\t\tif (child)\n\t\t\treturn child;\n\t\tif (alsoFindFromParents) {\n\t\t\tlet parent = this.getParentPrototype();\n\t\t\tif (parent)\n\t\t\t\treturn parent.findComponentDataByComponentId(componentId, alsoFindFromParents);\n\t\t}\n\t\treturn null;\n\t}\n\n\tgetOwnComponentDataOrInherit(componentId: string) {\n\t\tlet componentData = this.findComponentDataByComponentId(componentId, false);\n\t\tif (!componentData) {\n\t\t\tlet inheritedComponentData = this.findComponentDataByComponentId(componentId, true);\n\t\t\tif (!inheritedComponentData)\n\t\t\t\treturn null;\n\n\t\t\tcomponentData = new ComponentData(inheritedComponentData.name, false, componentId);\n\t\t\tthis.addChild(componentData);\n\t\t}\n\t\treturn componentData;\n\t}\n\n\tfindOwnProperty(componentId, propertyName) {\n\t\tlet componentData = this.findComponentDataByComponentId(componentId);\n\t\tif (componentData) {\n\t\t\treturn componentData.getProperty(propertyName);\n\t\t}\n\t\treturn null;\n\t}\n\n\t// Parent is needed so that we can init children knowing who is the parent\n\tcreateEntity(parent?: Serializable, _skipNewEntityEvent = false) {\n\t\tlet entity = new Entity();\n\n\t\tlet inheritedComponentDatas = this.getInheritedComponentDatas();\n\t\tlet components = inheritedComponentDatas.map(Component.createWithInheritedComponentData);\n\t\tentity.addComponents(components, { fullInit: false }); // Only do preInit\n\n\t\tentity.prototype = this;\n\n\t\tif (parent)\n\t\t\tparent.addChild(entity);\n\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('create entity', this.makeUpAName());\n\n\t\tthis.forEachChild('epr', (epr: EntityPrototype) => epr.createEntity(entity, true));\n\t\t// let childEntityPrototypes = this.getChildren('epr');\n\t\t// childEntityPrototypes.forEach(epr => epr.createEntity(entity));\n\n\t\tthis.previouslyCreatedEntity = entity;\n\n\t\t// Components have only been preinited. Lets call the init now.\n\t\tEntity.initComponents(components);\n\n\t\tif (!_skipNewEntityEvent)\n\t\t\tglobalEventDispatcher.dispatch('new entity created', entity);\n\n\t\treturn entity;\n\t}\n\n\tgetValue(componentId, propertyName) {\n\t\tlet componentData = this.findComponentDataByComponentId(componentId, true);\n\t\tif (componentData)\n\t\t\treturn componentData.getValue(propertyName);\n\t\telse\n\t\t\treturn undefined;\n\t}\n\n\tcountEntityPrototypes(findChildren = false) {\n\t\tlet entityPrototypeCount = 0;\n\t\tlet levelIds = new Set();\n\n\t\tif (this.threeLetterType !== 'prt') {\n\t\t\treturn {\n\t\t\t\tentityPrototypeCount,\n\t\t\t\tlevelIds\n\t\t\t};\n\t\t}\n\n\t\tlet levels = game.getChildren('lvl');\n\t\tfor (let i = levels.length - 1; i >= 0; i--) {\n\t\t\tlet entityPrototypes = levels[i].getChildren('epr') as Array<EntityPrototype>;\n\t\t\tlet foundInThisLevel = false;\n\t\t\tfor (let j = entityPrototypes.length - 1; j >= 0; j--) {\n\t\t\t\tif (entityPrototypes[j].prototype === this) {\n\t\t\t\t\tentityPrototypeCount++;\n\t\t\t\t\tfoundInThisLevel = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (foundInThisLevel) {\n\t\t\t\tlevelIds.add(levels[i].id);\n\t\t\t}\n\t\t}\n\n\t\tif (findChildren)\n\t\t\tthis.forEachChild('prt', (prt: Prototype) => {\n\t\t\t\tlet results = prt.countEntityPrototypes(true);\n\t\t\t\tentityPrototypeCount += results.entityPrototypeCount;\n\t\t\t\tresults.levelIds.forEach(levelId => levelIds.add(levelId));\n\t\t\t});\n\n\t\treturn {\n\t\t\tentityPrototypeCount,\n\t\t\tlevelIds\n\t\t};\n\t}\n\n\t/**\n\t * Only works for Prefabs and Prototypes. Not for EntityPrototypes.\n\t */\n\tgetEntityPrototypesThatUseThisPrototype() {\n\t\tlet entityPrototypes: EntityPrototype[] = [];\n\t\tlet levels: Set<Level> = new Set();\n\n\t\tif (this.threeLetterType !== 'prt' && this.threeLetterType !== 'pfa') {\n\t\t\treturn {\n\t\t\t\tentityPrototypes,\n\t\t\t\tlevels\n\t\t\t};\n\t\t}\n\n\t\tlet levelArray = game.getChildren('lvl') as Level[];\n\t\tfor (let i = levelArray.length - 1; i >= 0; i--) {\n\t\t\tlet foundInThisLevel = false;\n\n\t\t\tlevelArray[i].forEachChild('epr', (epr: EntityPrototype) => {\n\t\t\t\tif (epr.prototype === this) {\n\t\t\t\t\tentityPrototypes.push(epr);\n\t\t\t\t\tfoundInThisLevel = true;\n\t\t\t\t}\n\t\t\t}, true);\n\n\t\t\tif (foundInThisLevel) {\n\t\t\t\tlevels.add(levelArray[i]);\n\t\t\t}\n\t\t}\n\n\t\tthis.forEachChild(this.threeLetterType, (prt: Prototype) => {\n\t\t\tlet results = prt.getEntityPrototypesThatUseThisPrototype();\n\t\t\tentityPrototypes.push(...entityPrototypes);\n\t\t\tresults.levels.forEach((level: Level) => levels.add(level));\n\t\t});\n\n\t\treturn {\n\t\t\tentityPrototypes,\n\t\t\tlevels\n\t\t};\n\t}\n\n\tdelete() {\n\t\tlet _gameRoot = this.getRoot();\n\t\tif (!super.delete()) return false;\n\t\tif (this.threeLetterType === 'prt' && _gameRoot.threeLetterType === 'gam') {\n\t\t\t_gameRoot.forEachChild('lvl', (lvl: Level) => {\n\t\t\t\tlet items = lvl.getChildren('epr') as Array<EntityPrototype>;\n\t\t\t\tfor (let i = items.length - 1; i >= 0; i--) {\n\t\t\t\t\tif (items[i].prototype === this) {\n\t\t\t\t\t\tlvl.deleteChild(items[i], i);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tthis.previouslyCreatedEntity = null;\n\t\treturn true;\n\t}\n\n\tclone() {\n\t\tlet clone = super.clone() as any as Prototype;\n\t\tclone.siblingId = this.siblingId\n\t\treturn clone\n\t}\n\n\tcloneWithNewSiblingId() {\n\t\tlet clone = this.clone()\n\t\tclone.siblingId = Prototype.createSiblingId()\n\t\treturn clone\n\t}\n\n\ttoJSON() {\n\t\tlet json = super.toJSON();\n\t\tjson.si = this.siblingId;\n\t\treturn json;\n\t}\n\tstatic create(name: string) {\n\t\treturn new Prototype().initWithPropertyValues({ name });\n\t};\n}\nPropertyOwner.defineProperties(Prototype, propertyTypes);\n\nSerializable.registerSerializable(Prototype, 'prt', json => {\n\treturn new Prototype(json.id, json.si);\n});\n\nexport type InheritedComponentData = {\n\townComponentData: ComponentData;\n\tcomponentClass: typeof Component;\n\tcomponentId: string,\n\tpropertyHash?: { [propName: string]: Property }; // First this exists but will be deleted at the end.\n\tproperties?: Property[]; // In the end, this exists.\n\tthreeLetterType: 'icd';\n\tgeneratedForPrototype: Prototype;\n};\n\nfunction getDataFromPrototype(prototype: Prototype, originalPrototype: Prototype, filter?: (cda: ComponentData) => boolean, _depth = 0): { [componentId: string]: InheritedComponentData } {\n\tlet data: { [componentId: string]: InheritedComponentData } = null;\n\n\tlet parentPrototype = prototype.getParentPrototype() as Prototype;\n\tif (parentPrototype)\n\t\tdata = getDataFromPrototype(parentPrototype, originalPrototype, filter, _depth + 1);\n\telse\n\t\tdata = {}; // Top level\n\n\tlet componentDatas = prototype.getChildren('cda') as any as Array<ComponentData>;\n\tif (filter)\n\t\tcomponentDatas = componentDatas.filter(filter);\n\tlet componentData: ComponentData = null;\n\tfor (let i = 0; i < componentDatas.length; ++i) {\n\t\tcomponentData = componentDatas[i];\n\n\t\tif (!data[componentData.componentId]) {\n\t\t\t// Most parent version of this componentId\n\t\t\tdata[componentData.componentId] = {\n\t\t\t\t// ownComponent = true if the original prototype is the first one introducing this componentId\n\t\t\t\townComponentData: null, // will be given value if the original prototype has this componentId\n\t\t\t\tcomponentClass: componentData.componentClass,\n\t\t\t\tcomponentId: componentData.componentId,\n\t\t\t\tpropertyHash: {},\n\t\t\t\tthreeLetterType: 'icd',\n\t\t\t\tgeneratedForPrototype: originalPrototype,\n\t\t\t};\n\t\t}\n\n\t\tif (_depth === 0) {\n\t\t\tdata[componentData.componentId].ownComponentData = componentData;\n\t\t}\n\n\t\tlet propertyHash = data[componentData.componentId].propertyHash;\n\n\t\tlet properties = componentData.getChildren('prp') as Property[];\n\t\tlet property: Property = null;\n\t\tfor (let j = 0; j < properties.length; ++j) {\n\t\t\tproperty = properties[j];\n\t\t\t// Newest version of a property always overrides old property\n\t\t\tpropertyHash[property.name] = _depth === 0 ? property : property.clone(true);\n\t\t}\n\t};\n\n\treturn data;\n}\n\nfunction sortInheritedComponentDatas(a: InheritedComponentData, b: InheritedComponentData) {\n\treturn a.componentClass.componentName.localeCompare(b.componentClass.componentName);\n}\n","import Prototype from './prototype';\nimport Property from './property';\nimport Serializable from './serializable';\nimport { getSerializable } from './serializableManager';\nimport { Prop, componentClasses } from './component';\nimport ComponentData from './componentData';\nimport assert from '../util/assert';\nimport Vector from '../util/vector';\nimport Prefab from './prefab';\nimport PropertyOwner from './propertyOwner';\nimport { PropertyType } from './propertyType';\nimport { selectInEditor } from '../editor/editorSelection';\nimport { GameEvent, globalEventDispatcher } from './eventDispatcher';\n\nlet propertyTypes = [\n\t// Prop('name2', 'No name', Prop.string)\n];\n\n// EntityPrototype is a prototype that always has one Transform ComponentData and optionally other ComponentDatas also.\n// Entities are created based on EntityPrototypes\nexport default class EntityPrototype extends Prototype {\n\n\t// this._parent is level or another entityPrototype, not prototype as in type or prefab. We need a link to parent-prototype. That's why we have prototype property\n\t/**\n\t * prototype stays the same whole EntityPrototype lifetime. It can not change. It is not and will be not supported by server communication.\n\t */\n\tprototype: Prototype = null;\n\n\tconstructor(predefinedId?, siblingId?: string) {\n\t\tsuper(predefinedId, siblingId);\n\t}\n\n\tmakeUpAName(): string {\n\t\tlet nameProperty = this.findChild('prp', (property: Property) => property.name === 'name');\n\t\tif (nameProperty && nameProperty.value)\n\t\t\treturn nameProperty.value;\n\t\telse if (this.prototype)\n\t\t\treturn this.prototype.makeUpAName();\n\t\telse\n\t\t\treturn 'EntityPrototype';\n\t}\n\n\tgetTransform() {\n\t\treturn this.findChild('cda', (cda: ComponentData) => cda.name === 'Transform') as ComponentData;\n\t}\n\tgetParentPrototype(): Prototype {\n\t\treturn this.prototype || null;\n\t}\n\tclone() {\n\t\tlet obj = new EntityPrototype(null, this.siblingId);\n\t\tobj.prototype = this.prototype;\n\t\tlet id = obj.id;\n\t\tlet children = [];\n\t\tthis.forEachChild(null, child => {\n\t\t\tif (child.threeLetterType === 'prp' && (child as Property).name === 'name') {\n\t\t\t\tlet property = new Property({\n\t\t\t\t\tvalue: (child as Property).propertyType.type.clone((child as Property).value),\n\t\t\t\t\tname: (child as Property).name,\n\t\t\t\t\tpropertyType: (child as Property).propertyType,\n\t\t\t\t\tpredefinedId: id + '_n'\n\t\t\t\t});\n\t\t\t\tchildren.push(property);\n\t\t\t} else if (child.threeLetterType === 'cda' && (child as ComponentData).name === 'Transform') {\n\t\t\t\tlet transform = new ComponentData('Transform', id + '_t');\n\n\t\t\t\t// Transform component data always has a position\n\t\t\t\tlet position = transform.componentClass._propertyTypesByName.position.createProperty({\n\t\t\t\t\tvalue: child.findChild('prp', (prp: Property) => prp.name === 'position').value,\n\t\t\t\t\tpredefinedId: id + '_p'\n\t\t\t\t});\n\t\t\t\ttransform.addChild(position);\n\n\t\t\t\tlet oldScaleProperty = child.findChild('prp', (prp: Property) => prp.name === 'scale');\n\t\t\t\tif (oldScaleProperty) {\n\t\t\t\t\tlet scale = transform.componentClass._propertyTypesByName.scale.createProperty({\n\t\t\t\t\t\tvalue: oldScaleProperty.value,\n\t\t\t\t\t\tpredefinedId: id + '_s'\n\t\t\t\t\t});\n\t\t\t\t\ttransform.addChild(scale);\n\t\t\t\t}\n\n\t\t\t\tlet oldAngleProperty = child.findChild('prp', (prp: Property) => prp.name === 'angle');\n\t\t\t\tif (oldAngleProperty) {\n\t\t\t\t\tlet angle = transform.componentClass._propertyTypesByName.angle.createProperty({\n\t\t\t\t\t\tvalue: oldAngleProperty.value,\n\t\t\t\t\t\tpredefinedId: id + '_a'\n\t\t\t\t\t});\n\t\t\t\t\ttransform.addChild(angle);\n\t\t\t\t}\n\n\t\t\t\tchildren.push(transform);\n\t\t\t} else if (child.threeLetterType === 'cda') {\n\t\t\t\tchildren.push((child as ComponentData).clone({ cloneComponentId: true }));\n\t\t\t} else {\n\t\t\t\tchildren.push(child.clone());\n\t\t\t}\n\t\t});\n\t\tobj.initWithChildren(children);\n\t\tthis._state |= Serializable.STATE_CLONE;\n\t\treturn obj;\n\t}\n\tcloneWithNewSiblingId() {\n\t\tlet clone = this.clone()\n\t\tclone.siblingId = Prototype.createSiblingId()\n\t\treturn clone\n\t}\n\n\ttoJSON() {\n\t\t/*\n\t\tlet json = super.toJSON();\n\t\tjson.t = this.prototype.id;\n\t\treturn json;\n\t\t*/\n\n\t\t// Below optimization reduces size 88%. child id's have to be generated based on this.id\n\n\t\tlet Transform = this.getTransform();\n\t\tlet json: any = {\n\t\t\tid: this.id,\n\t\t\tsi: this.siblingId\n\t\t};\n\t\tif (this.prototype)\n\t\t\tjson.t = this.prototype.id; // might be prototype or prefab or may not exist. .t as in type\n\n\t\tlet childArrays = [];\n\t\tthis._children.forEach(child => {\n\t\t\tchildArrays.push(child);\n\t\t});\n\t\tlet children = [].concat(...childArrays).filter(child => {\n\t\t\treturn child !== Transform && child !== this._properties.name;\n\t\t});\n\t\tif (children.length > 0)\n\t\t\tjson.c = children.map(child => child.toJSON());\n\n\t\tlet floatToJSON = Prop.float().toJSON;\n\t\tlet handleProperty = prp => {\n\t\t\tif (prp.name === 'name') {\n\t\t\t\tif (prp.value)\n\t\t\t\t\tjson.n = prp.value;\n\t\t\t} else if (prp.name === 'position') {\n\t\t\t\tjson.p = prp.type.toJSON(prp.value);\n\t\t\t} else if (prp.name === 'scale') {\n\t\t\t\tif (!prp.value.isEqualTo(new Vector(1, 1))) {\n\t\t\t\t\tjson.s = prp.type.toJSON(prp.value);\n\t\t\t\t}\n\t\t\t} else if (prp.name === 'angle') {\n\t\t\t\tif (prp.value !== 0)\n\t\t\t\t\tjson.a = floatToJSON(prp.value);\n\t\t\t}\n\t\t};\n\t\thandleProperty(this._properties.name);\n\n\t\tTransform.getChildren('prp').forEach(handleProperty);\n\t\treturn json;\n\t}\n\tspawnEntityToScene(scene, position) {\n\t\tif (!scene)\n\t\t\treturn null;\n\n\t\tif (position) {\n\t\t\tthis.getTransform().getPropertyOrCreate('position').value = position;\n\t\t}\n\n\t\treturn this.createEntity(scene);\n\t}\n\n\t/**\n\t * This function creates a new EntityPrototype and this one will be deleted.\n\t */\n\treplaceWithVersionThatIsDetachedFromPrototype() {\n\t\tlet entityPrototype = new EntityPrototype();\n\t\t// Leave entityPrototype.prototype null to detach\n\n\t\tlet inheritedComponentDatas = this.getInheritedComponentDatas();\n\t\tlet componentDatas: ComponentData[] = inheritedComponentDatas.map(icd => {\n\t\t\treturn new ComponentData(icd.componentClass.componentName, null, icd.componentId)\n\t\t\t\t.initWithChildren(icd.properties.map(prp => prp.clone()));\n\t\t}) as ComponentData[];\n\n\t\tentityPrototype.initWithChildren(componentDatas);\n\t\tentityPrototype.name = this.makeUpAName();\n\n\t\tlet parent = this.getParent();\n\n\t\tthis.delete();\n\n\t\tif (parent) {\n\t\t\tparent.addChild(entityPrototype);\n\t\t}\n\n\t\treturn entityPrototype;\n\t}\n\n\t/**\n\t * WARNING! Only Transform and name are preserved. All other data is lost.\n\t * This should only be called with a prefab that has been created using:\n\t * Prefab.createFromPrototype(entityPrototype)\n\t * This function creates a new EntityPrototype and this one will be deleted\n\t * */\n\treplaceWithVersionThatIsAttachedToPrototype(prototype: Prototype) {\n\t\tlet newEntityPrototype = EntityPrototype.createFromPrototype(prototype);\n\t\tlet thisTransform = this.getTransform();\n\t\tlet Transform = newEntityPrototype.getTransform();\n\t\tTransform.componentClass._propertyTypes.forEach((propertyType: PropertyType) => {\n\t\t\tTransform.setValue(propertyType.name, thisTransform.getValue(propertyType.name));\n\t\t});\n\t\tnewEntityPrototype.name = this.name;\n\n\t\tlet parent = this.getParent();\n\n\t\tthis.delete();\n\n\t\tif (parent) {\n\t\t\tparent.addChild(newEntityPrototype);\n\t\t}\n\t\treturn newEntityPrototype;\n\t}\n\n\t// Optimize this away\n\tsetRootType(rootType) {\n\t\tif (this._rootType === rootType)\n\t\t\treturn;\n\t\tassert(this.getTransform(), 'EntityPrototype must have a Transform');\n\t\tsuper.setRootType(rootType);\n\t\treturn this;\n\t}\n\t/**\n\t * If Transform or Transform.position is missing, they are added.\n\t * prototype can also be Prefab which extends Prototype.\n\t */\n\tstatic createFromPrototype(prototype: Prototype) {\n\t\tif (prototype.threeLetterType === 'pfa') {\n\t\t\treturn (prototype as Prefab).createEntityPrototype();\n\t\t}\n\n\t\t// DEPRECATED\n\t\tconsole.log(`This isn't used anymore because we don't anymore have \"Types\" which are plain Prototypes`);\n\n\t\tlet entityPrototype = new EntityPrototype();\n\t\tentityPrototype.prototype = prototype;\n\t\tlet id = entityPrototype.id;\n\n\t\tlet prototypeTransform = prototype.findChild('cda', (cda: ComponentData) => cda.name === 'Transform');\n\n\t\tif (prototypeTransform)\n\t\t\tassert(false, 'Prototype (prt) can not have a Transform component');\n\n\t\tlet name = createEntityPrototypeNameProperty(id);\n\t\tlet transform = createEntityPrototypeTransform(id);\n\n\t\tentityPrototype.initWithChildren([name, transform]);\n\n\t\t// @ifndef OPTIMIZE\n\t\tassert(entityPrototype.getTransform(), 'EntityPrototype must have a Transform');\n\t\t// @endif\n\n\t\treturn entityPrototype;\n\t}\n\n\tstatic create(name = 'Empty', position = new Vector(0, 0)) {\n\t\tlet entityPrototype = new EntityPrototype();\n\t\tlet transform = createEntityPrototypeTransform(entityPrototype.id);\n\t\ttransform.setValue('position', position);\n\n\t\tlet nameProperty = createEntityPrototypeNameProperty(entityPrototype.id, name);\n\n\t\tentityPrototype.initWithChildren([nameProperty, transform]);\n\t\treturn entityPrototype;\n\t}\n\n\tget position() {\n\t\treturn this.getTransform().findChild('prp', (prp: Property) => prp.name === 'position').value;\n\t}\n\tset position(position) {\n\t\tthis.getTransform().findChild('prp', (prp: Property) => prp.name === 'position').value = position;\n\t}\n}\n\n// PropertyOwner.defineProperties(EntityPrototype, propertyTypes);\n\nexport function createEntityPrototypeNameProperty(entityPrototypeId, name = '') {\n\treturn EntityPrototype._propertyTypesByName.name.createProperty({\n\t\tvalue: name,\n\t\tpredefinedId: entityPrototypeId + '_n'\n\t});\n}\n\nexport function createEntityPrototypeTransform(entityPrototypeId) {\n\tlet transform = new ComponentData('Transform', entityPrototypeId + '_t');\n\n\tlet position = transform.componentClass._propertyTypesByName.position.createProperty({\n\t\tvalue: new Vector(0, 0),\n\t\tpredefinedId: entityPrototypeId + '_p'\n\t});\n\ttransform.addChild(position);\n\n\tlet scale = transform.componentClass._propertyTypesByName.scale.createProperty({\n\t\tvalue: new Vector(1, 1),\n\t\tpredefinedId: entityPrototypeId + '_s'\n\t});\n\ttransform.addChild(scale);\n\n\tlet angle = transform.componentClass._propertyTypesByName.angle.createProperty({\n\t\tvalue: 0,\n\t\tpredefinedId: entityPrototypeId + '_a'\n\t});\n\ttransform.addChild(angle);\n\n\treturn transform;\n}\n\nSerializable.registerSerializable(EntityPrototype, 'epr', json => {\n\tlet entityPrototype = new EntityPrototype(json.id, json.si);\n\tentityPrototype.prototype = json.t ? getSerializable(json.t) : null;\n\n\t// assert(!json.t || entityPrototype.prototype, `Prototype or Prefab ${json.t} not found`); // .t as in type\n\tif (json.t && !entityPrototype.prototype) {\n\t\tconsole.error(`EntityPrototype ${json.id} thought it had a prototype or prefab ${json.t} but it was not found.`);\n\t}\n\n\tlet nameId = json.id + '_n';\n\tlet transformId = json.id + '_t';\n\tlet positionId = json.id + '_p';\n\tlet scaleId = json.id + '_s';\n\tlet angleId = json.id + '_a';\n\n\tlet name = Prototype._propertyTypesByName.name.createProperty({\n\t\tvalue: json.n === undefined ? '' : json.n,\n\t\tpredefinedId: nameId\n\t});\n\n\tlet transformData = new ComponentData('Transform', transformId);\n\tlet transformClass = componentClasses.get('Transform');\n\n\tlet position = transformClass._propertyTypesByName.position.createProperty({\n\t\tvalue: Vector.fromObject(json.p), // in the future, everything will be using p instead of x and y.\n\t\tpredefinedId: positionId\n\t});\n\ttransformData.addChild(position);\n\n\tlet scale = transformClass._propertyTypesByName.scale.createProperty({\n\t\tvalue: json.s && Vector.fromObject(json.s) || new Vector(1, 1),\n\t\tpredefinedId: scaleId\n\t});\n\ttransformData.addChild(scale);\n\n\tlet angle = transformClass._propertyTypesByName.angle.createProperty({\n\t\tvalue: json.a || 0,\n\t\tpredefinedId: angleId\n\t});\n\ttransformData.addChild(angle);\n\n\tentityPrototype.initWithChildren([name, transformData]);\n\n\treturn entityPrototype;\n});\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\nimport p2, { addBody, deleteBody, createMaterial, getWorld } from '../features/physics';\nimport assert from '../util/assert';\n\nconst PHYSICS_SCALE = 1 / 50;\nexport { PHYSICS_SCALE };\nconst PHYSICS_SCALE_INV = 1 / PHYSICS_SCALE;\n\nconst DENSITY_SCALE = 3 / 10;\n\nconst type = {\n\tdynamic: p2.Body.DYNAMIC,\n\tkinematic: p2.Body.KINEMATIC,\n\tstatic: p2.Body.STATIC\n};\n\nconst SLEEPING = p2.Body.SLEEPING;\nconst STATIC = p2.Body.STATIC;\n\nComponent.register({\n\tname: 'Physics',\n\tcategory: 'Dynamics',\n\tdescription: 'Forms physical rules for <span style=\"color: #84ce84;\">Shapes</span>.',\n\ticon: 'fa-stop',\n\tallowMultiple: false,\n\tproperties: [\n\t\tProp('type', 'dynamic', Prop.enum, Prop.enum.values('dynamic', 'static')),\n\t\tProp('density', 1, Prop.float, Prop.float.range(0, 100), Prop.visibleIf('type', 'dynamic')),\n\t\tProp('drag', 0.1, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('type', 'dynamic')),\n\t\tProp('rotationalDrag', 0.1, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('type', 'dynamic')),\n\t\tProp('bounciness', 0, Prop.float, Prop.float.range(0, 1)),\n\t\tProp('friction', 0.1, Prop.float, Prop.float.range(0, 1))\n\t],\n\trequirements: [\n\t\t'Shape'\n\t],\n\trequiresInitWhenEntityIsEdited: true,\n\tprototype: {\n\t\tinited: false,\n\t\tinit() {\n\t\t\tthis.inited = true;\n\t\t\tlet update = callback => {\n\t\t\t\treturn value => {\n\t\t\t\t\tif (!this.updatingOthers && this.body) {\n\t\t\t\t\t\tcallback(value);\n\t\t\t\t\t\tif (this.type === 'dynamic')\n\t\t\t\t\t\t\tthis.body.wakeUp();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tlet Shapes = this.entity.getComponents('Shape');\n\t\t\tconst shapePropertiesThatShouldUpdateShape = [\n\t\t\t\t'type',\n\t\t\t\t'size',\n\t\t\t\t'radius',\n\t\t\t\t'points',\n\t\t\t\t'topPointDistance'\n\t\t\t];\n\t\t\tfor (let i = 0; i < Shapes.length; ++i) {\n\t\t\t\tshapePropertiesThatShouldUpdateShape.forEach(property => {\n\t\t\t\t\tthis.listenProperty(Shapes[i], property, update(() => this.updateShape()));\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.listenProperty(this.Transform, 'position', update(position => {\n\t\t\t\tthis.body.position = fromTransformToBodyPosition(this.Transform);\n\t\t\t\tthis.body.updateAABB();\n\t\t\t}));\n\t\t\tthis.listenProperty(this.Transform, 'angle', update(angle => {\n\t\t\t\tlet globalAngle = this.Transform.getGlobalAngle();\n\t\t\t\tthis.body.angle = globalAngle;\n\t\t\t\tthis.body.updateAABB();\n\t\t\t}));\n\t\t\tthis.listenProperty(this.Transform, 'scale', update(scale => this.updateShape()));\n\t\t\tthis.listenProperty(this, 'density', update(density => {\n\t\t\t\tthis.body.setDensity(density * DENSITY_SCALE);\n\t\t\t}));\n\t\t\tthis.listenProperty(this, 'friction', update(friction => this.updateMaterial()));\n\t\t\tthis.listenProperty(this, 'drag', update(drag => this.body.damping = drag));\n\t\t\tthis.listenProperty(this, 'rotationalDrag', update(rotationalDrag => {\n\t\t\t\tthis.body.angularDamping = rotationalDrag > 0.98 ? 1 : rotationalDrag;\n\t\t\t\tthis.body.fixedRotation = rotationalDrag === 1;\n\t\t\t\tthis.body.updateMassProperties();\n\t\t\t}));\n\t\t\tthis.listenProperty(this, 'type', update(type => {\n\t\t\t\tthis.body.type = type[this.type];\n\t\t\t\tthis.entity.sleep();\n\t\t\t\tthis.entity.wakeUp();\n\t\t\t}));\n\t\t\tthis.listenProperty(this, 'bounciness', update(bounciness => this.updateMaterial()));\n\n\t\t\tif (this._rootType)\n\t\t\t\tthis.createBody();\n\t\t},\n\t\t// This is here because createBody in init() doesn't have access to Transform's global position because parents are inited later.\n\t\tonStart() {\n\t\t\tthis.body.position = fromTransformToBodyPosition(this.Transform);\n\t\t\tthis.body.angle = this.Transform.getGlobalAngle();\n\t\t\tthis.updateShape();\n\t\t},\n\t\tcreateBody() {\n\t\t\tassert(!this.body);\n\n\t\t\tthis.body = new p2.Body({\n\t\t\t\ttype: type[this.type],\n\n\t\t\t\t// position and angle are updated at onStart\n\t\t\t\tposition: [0, 0], // fromTransformToBodyPosition(this.Transform),\n\t\t\t\tangle: 0, // this.Transform.getGlobalAngle(),\n\t\t\t\tvelocity: [0, 0],\n\t\t\t\tangularVelocity: 0,\n\t\t\t\tsleepTimeLimit: 0.6,\n\t\t\t\tsleepSpeedLimit: 0.3,\n\t\t\t\tdamping: this.drag,\n\t\t\t\tangularDamping: this.rotationalDrag > 0.98 ? 1 : this.rotationalDrag,\n\t\t\t\tfixedRotation: this.rotationalDrag === 1\n\t\t\t});\n\t\t\t// this.updateShape(); // This is done at onStart. No need to do it here.\n\n\t\t\tthis.body.entity = this.entity;\n\n\t\t\taddBody(this.scene, this.body);\n\t\t},\n\t\tupdateShape() {\n\t\t\tif (this.body.shapes.length > 0) {\n\t\t\t\t// We update instead of create.\n\t\t\t\t// Should remove existing shapes\n\n\t\t\t\t// The library does not support updating shapes during the step.\n\t\t\t\tlet world = getWorld(this.scene);\n\t\t\t\tassert(!world.stepping);\n\n\t\t\t\tlet shapes = this.body.shapes;\n\t\t\t\tfor (let i = 0; i < shapes.length; ++i) {\n\t\t\t\t\tshapes[i].body = null;\n\t\t\t\t}\n\t\t\t\tshapes.length = 0;\n\t\t\t}\n\n\t\t\tlet Shapes = this.entity.getComponents('Shape');\n\t\t\tlet scale = this.Transform.getGlobalScale();\n\n\t\t\tShapes.forEach(Shape => {\n\t\t\t\tlet shape;\n\n\t\t\t\tif (Shape.type === 'rectangle') {\n\t\t\t\t\tshape = new p2.Box({\n\t\t\t\t\t\twidth: Shape.size.x * PHYSICS_SCALE * scale.x,\n\t\t\t\t\t\theight: Shape.size.y * PHYSICS_SCALE * scale.y\n\t\t\t\t\t});\n\t\t\t\t} else if (Shape.type === 'circle') {\n\t\t\t\t\tlet averageScale = (scale.x + scale.y) / 2;\n\n\t\t\t\t\tshape = new p2.Circle({\n\t\t\t\t\t\tradius: Shape.radius * PHYSICS_SCALE * averageScale\n\t\t\t\t\t});\n\t\t\t\t} else if (Shape.type === 'convex') {\n\t\t\t\t\tshape = new p2.Convex({\n\t\t\t\t\t\tvertices: Shape.getConvexPoints().map(p => ([p.x * PHYSICS_SCALE, p.y * PHYSICS_SCALE]))\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (shape)\n\t\t\t\t\tthis.body.addShape(shape);\n\t\t\t});\n\n\t\t\tthis.updateMass();\n\t\t\tthis.updateMaterial();\n\t\t},\n\t\tupdateMaterial()  {\n\t\t\tlet material = createMaterial(this.scene, {\n\t\t\t\tfriction: this.friction,\n\t\t\t\trestitution: this.bounciness,\n\t\t\t\t// stiffness: 1e6,\n\t\t\t\t// relaxation: 4,\n\t\t\t\t// frictionStiffness: 1e6,\n\t\t\t\t// frictionRelaxation: 4,\n\t\t\t\t// surfaceVelocity: 0\n\t\t\t});\n\t\t\tthis.body.shapes.forEach(s => s.material = material);\n\t\t},\n\t\tupdateMass() {\n\t\t\tif (this.type === 'dynamic')\n\t\t\t\tthis.body.setDensity(this.density * DENSITY_SCALE);\n\t\t},\n\t\tsetRootType(rootType) {\n\t\t\tif (rootType) {\n\t\t\t\tif (this.inited)\n\t\t\t\t\tthis.createBody();\n\t\t\t}\n\t\t\treturn Component.prototype.setRootType.call(this, rootType);\n\t\t},\n\t\tonUpdate() {\n\t\t\tlet b = this.body;\n\t\t\tif (!b || b.sleepState === SLEEPING || b.type === STATIC)\n\t\t\t\treturn;\n\n\t\t\tthis.updatingOthers = true;\n\n\t\t\t// TODO: find out should these be optimized.\n\t\t\tlet newGlobalPosition = fromBodyPositionToGlobalVector(b.position);\n\t\t\tlet oldGlobalPosition = this.Transform.getGlobalPosition();\n\t\t\tif (!oldGlobalPosition.isEqualTo(newGlobalPosition))\n\t\t\t\tthis.Transform.setGlobalPosition(newGlobalPosition);\n\n\t\t\tif (this.Transform.getGlobalAngle() !== b.angle)\n\t\t\t\tthis.Transform.setGlobalAngle(b.angle);\n\n\t\t\tthis.updatingOthers = false;\n\t\t},\n\t\tsleep() {\n\t\t\tif (this.body) {\n\t\t\t\tdeleteBody(this.scene, this.body);\n\t\t\t\tthis.body = null;\n\t\t\t}\n\t\t\tthis.inited = false;\n\t\t},\n\t\tgetMass() {\n\t\t\treturn this.body.mass;\n\t\t},\n\t\tapplyForce(forceVector) {\n\t\t\tthis.body.applyForce(forceVector.toArray());\n\t\t\tthis.body.wakeUp();\n\t\t},\n\t\tsetAngularForce(force) {\n\t\t\tthis.body.angularForce = force;\n\t\t\tthis.body.wakeUp();\n\t\t}\n\t}\n});\n\nfunction fromTransformToBodyPosition(Transform): Array<number> {\n\treturn Transform.getGlobalPosition().toArray().map(x => x * PHYSICS_SCALE);\n}\nfunction fromBodyPositionToGlobalVector(bodyPosition): Vector {\n\treturn Vector.fromArray(bodyPosition).multiplyScalar(PHYSICS_SCALE_INV);\n}\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\nimport { Color } from '../util/color';\nimport { default as PIXI, generateTextureAndAnchor, getHashedTextureAndAnchor } from '../features/graphics';\nimport { isClient } from '../util/environment';\n\nimport { PHYSICS_SCALE } from './Physics';\nimport { GameEvent } from '../core/eventDispatcher';\nimport Entity from '../core/entity';\n\nComponent.register({\n\tname: 'Particles',\n\tcategory: 'Graphics',\n\tdescription: 'Particle engine gives eye candy.',\n\tallowMultiple: true,\n\tproperties: [\n\t\tProp('startColor', new Color('#68c07f'), Prop.color),\n\t\tProp('endColor', new Color('#59abc0'), Prop.color),\n\t\tProp('alpha', 1, Prop.float, Prop.float.range(0, 1)),\n\t\tProp('particleSize', 10, Prop.float, Prop.float.range(1, 100)),\n\t\tProp('particleCount', 30, Prop.int, Prop.int.range(0, 10000)),\n\t\tProp('particleLifetime', 1, Prop.float, Prop.float.range(0.1, 10), 'in seconds'),\n\t\tProp('particleHardness', 0.2, Prop.float, Prop.float.range(0, 1)),\n\t\tProp('blendMode', 'add', Prop.enum, Prop.enum.values('add', 'normal')),\n\t\tProp('spawnType', 'circle', Prop.enum, Prop.enum.values('circle', 'rectangle')),\n\t\tProp('spawnRadius', 20, Prop.float, Prop.float.range(0, 1000), Prop.visibleIf('spawnType', 'circle')),\n\t\tProp('spawnRandom', 0.5, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('spawnType', 'circle')),\n\t\tProp('spawnRect', new Vector(50, 50), Prop.vector, Prop.visibleIf('spawnType', 'rectangle')),\n\t\tProp('speedToOutside', 50, Prop.float, Prop.float.range(-1000, 1000), Prop.visibleIf('spawnType', 'circle')),\n\t\tProp('speed', new Vector(0, 0), Prop.vector),\n\t\tProp('speedRandom', 0, Prop.float, Prop.float.range(0, 1000), 'Max random velocity to random direction'),\n\t\tProp('acceleration', new Vector(0, 0), Prop.vector),\n\t\tProp('globalCoordinates', true, Prop.bool),\n\t\tProp('followObject', 0.4, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('globalCoordinates', true))\n\t],\n\tprototype: {\n\t\tinit() {\n\t\t\t//ParticleContainer does not work properly!\n\n\t\t\t// maxSize < 40 will crash\n\t\t\t// With many Particle-components with few particles, this is deadly-expensive.\n\t\t\t// And also crashes now and then with low maxValue.\n\t\t\t// this.container = new PIXI.particles.ParticleContainer(5000, {\n\t\t\t// \tposition: true,\n\t\t\t// \talpha: true,\n\t\t\t// \tscale: false,\n\t\t\t// \trotation: false,\n\t\t\t// \tuvs: false\n\t\t\t// });\n\n\n\t\t\t// Use normal container instead\n\t\t\tthis.container = new PIXI.Container();\n\n\t\t\t// Texture\n\t\t\tthis.updateTexture();\n\t\t\t['particleSize', 'particleHardness', 'alpha'].forEach(propertyName => {\n\t\t\t\tthis.listenProperty(this, propertyName, () => {\n\t\t\t\t\tthis.updateTexture();\n\t\t\t\t});\n\t\t\t});\n\n\t\t\t// Blend mode\n\t\t\tthis.listenProperty(this, 'blendMode', blendMode => {\n\t\t\t\tif (!this.particles)\n\t\t\t\t\treturn;\n\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite)\n\t\t\t\t\t\tp.sprite.blendMode = blendModes[blendMode];\n\t\t\t\t});\n\t\t\t});\n\n\t\t\t// this.scene.layers.main.addChild(this.container);\n\n\t\t\tthis.initParticles();\n\t\t\t['particleLifetime', 'particleCount'].forEach(propertyName => {\n\t\t\t\tthis.listenProperty(this, propertyName, () => {\n\t\t\t\t\tthis.initParticles();\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.updateGlobalCoordinatesProperty();\n\t\t\tthis.listenProperty(this, 'globalCoordinates', () => {\n\t\t\t\tthis.updateGlobalCoordinatesProperty();\n\t\t\t});\n\n\t\t\tlet physicsEntity = this.entity as Entity;\n\t\t\twhile (physicsEntity && physicsEntity.threeLetterType === 'ent' && !this.Physics) {\n\t\t\t\tthis.Physics = physicsEntity.getComponent('Physics');\n\t\t\t\tphysicsEntity = physicsEntity.getParent() as Entity;\n\t\t\t}\n\t\t},\n\n\t\tupdateGlobalCoordinatesProperty() {\n\t\t\tif (this.positionListener) {\n\t\t\t\tthis.positionListener();\n\t\t\t\tthis.positionListener = null;\n\t\t\t}\n\t\t\tif (this.globalCoordinates) {\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite) {\n\t\t\t\t\t\tp.sprite.x += this.container.position.x;\n\t\t\t\t\t\tp.sprite.y += this.container.position.y;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\t// this.container.position.set(0, 0);\n\t\t\t\tthis.container.setParent(this.scene.layers.main);\n\t\t\t} else {\n\t\t\t\t/*\n\t\t\t\tthis.positionListener = this.Transform.listen('globalTransformChanged', Transform => {\n\t\t\t\t\tlet position = Transform.getGlobalPosition();\n\t\t\t\t\tthis.container.position.set(position.x, position.y);\n\t\t\t\t});\n\t\t\t\t*/\n\t\t\t\t// this.container.position.set(this.Transform.position.x, this.Transform.position.y);\n\t\t\t\tthis.container.setParent(this.Transform.container);\n\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite) {\n\t\t\t\t\t\tp.sprite.x -= this.container.position.x;\n\t\t\t\t\t\tp.sprite.y -= this.container.position.y;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\n\t\tupdateTexture() {\n\t\t\tthis.texture = getParticleTexture(this.particleSize, this.particleHardness * 0.9, { r: 255, g: 255, b: 255, a: this.alpha });\n\t\t\t// this.container.baseTexture = this.texture;\n\t\t\tif (this.particles) {\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite)\n\t\t\t\t\t\tp.sprite.texture = this.texture;\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\n\t\tinitParticles() {\n\t\t\tif (this.particles) {\n\t\t\t\tthis.particles.forEach(p => {\n\t\t\t\t\tif (p.sprite)\n\t\t\t\t\t\tp.sprite.destroy();\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.particles = [];\n\t\t\tlet interval = this.particleLifetime / this.particleCount;\n\t\t\tlet firstBirth = this.scene.time + Math.random() * interval;\n\t\t\tfor (let i = 0; i < this.particleCount; ++i) {\n\t\t\t\tthis.particles.push({\n\t\t\t\t\talive: false,\n\t\t\t\t\tnextBirth: firstBirth + i * interval\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\n\t\tresetParticle(p) {\n\n\t\t\tp.vx = this.speed.x;\n\t\t\tp.vy = this.speed.y;\n\t\t\tif (this.speedRandom > 0) {\n\t\t\t\tlet randomSpeed = this.speedRandom * Math.random();\n\t\t\t\tlet randomAngle = Math.random() * Math.PI * 2;\n\t\t\t\tp.vx += Math.sin(randomAngle) * randomSpeed;\n\t\t\t\tp.vy += Math.cos(randomAngle) * randomSpeed;\n\t\t\t}\n\n\t\t\t// Calculate starting position\n\t\t\tif (this.spawnType === 'circle') {\n\t\t\t\tlet r = this.spawnRadius;\n\t\t\t\tif (this.spawnRandom > 0) {\n\t\t\t\t\tr = this.spawnRandom * Math.random() * r + (1 - this.spawnRandom) * r;\n\t\t\t\t}\n\t\t\t\tlet angle = Math.random() * Math.PI * 2;\n\t\t\t\tp.sprite.x = Math.cos(angle) * r;\n\t\t\t\tp.sprite.y = Math.sin(angle) * r;\n\t\t\t\tif (this.speedToOutside !== 0) {\n\t\t\t\t\tp.vx += Math.cos(angle) * this.speedToOutside;\n\t\t\t\t\tp.vy += Math.sin(angle) * this.speedToOutside;\n\t\t\t\t}\n\t\t\t} else if (this.spawnType === 'rectangle') {\n\t\t\t\t// Rectangle\n\t\t\t\tp.sprite.x = -this.spawnRect.x / 2 + Math.random() * this.spawnRect.x;\n\t\t\t\tp.sprite.y = -this.spawnRect.y / 2 + Math.random() * this.spawnRect.y;\n\t\t\t}\n\n\t\t\tp.age = this.scene.time - p.nextBirth;\n\t\t\tp.nextBirth += this.particleLifetime;\n\n\t\t\tif (this.globalCoordinates) {\n\t\t\t\t// Change sprite position from Transform coordinates to main layer coordinates.\n\t\t\t\tVector.fromObject(this.container.toLocal(p.sprite.position, this.Transform.container, p.sprite.position));\n\n\t\t\t\tif (this.Physics && this.Physics.body) {\n\t\t\t\t\tlet vel = this.Physics.body.velocity;\n\t\t\t\t\tp.vx = p.vx + this.followObject * vel[0] / PHYSICS_SCALE;\n\t\t\t\t\tp.vy = p.vy + this.followObject * vel[1] / PHYSICS_SCALE;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tonUpdate(dt, t) {\n\t\t\tconst particleLifetime = this.particleLifetime;\n\t\t\tconst invParticleLifetime = 1 / particleLifetime;\n\t\t\tconst particles = this.particles;\n\t\t\tconst accelerationX = this.acceleration.x * dt;\n\t\t\tconst accelerationY = this.acceleration.y * dt;\n\n\t\t\t// Fast color interpolation\n\t\t\tconst startColor = this.startColor;\n\t\t\tconst endColor = this.endColor;\n\t\t\tfunction colorLerp(lerp) {\n\t\t\t\tlet startMultiplier = 1 - lerp;\n\t\t\t\tlet r = (startColor.r * startMultiplier + endColor.r * lerp) | 0; // to int\n\t\t\t\tlet g = (startColor.g * startMultiplier + endColor.g * lerp) | 0;\n\t\t\t\tlet b = (startColor.b * startMultiplier + endColor.b * lerp) | 0;\n\t\t\t\treturn 65536 * r + 256 * g + b;\n\t\t\t}\n\n\t\t\tlet sprite,\n\t\t\t\tspritePos,\n\t\t\t\tscale,\n\t\t\t\tlerp,\n\t\t\t\tp\n\t\t\t\t;\n\n\t\t\tfor (let i = 0; i < this.particleCount; i++) {\n\t\t\t\tp = particles[i];\n\n\t\t\t\tif (!p.alive) {\n\t\t\t\t\t// Not alive\n\t\t\t\t\tif (t >= p.nextBirth) {\n\t\t\t\t\t\t// The birth!\n\t\t\t\t\t\tp.sprite = new PIXI.Sprite(this.texture);\n\t\t\t\t\t\tp.sprite.blendMode = blendModes[this.blendMode];\n\t\t\t\t\t\tp.sprite.anchor.set(0.5, 0.5);\n\t\t\t\t\t\tp.alive = true;\n\t\t\t\t\t\tthis.resetParticle(p);\n\t\t\t\t\t\tthis.container.addChild(p.sprite);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Is alive\n\n\t\t\t\tsprite = p.sprite;\n\t\t\t\tspritePos = sprite.transform.position;\n\n\t\t\t\tp.age += dt;\n\t\t\t\tlerp = p.age * invParticleLifetime;\n\t\t\t\tif (lerp >= 1) {\n\t\t\t\t\tthis.resetParticle(p);\n\t\t\t\t\tlerp = p.age * invParticleLifetime;\n\t\t\t\t} else {\n\t\t\t\t\tp.vx += accelerationX;\n\t\t\t\t\tp.vy += accelerationY;\n\t\t\t\t\tspritePos.x += p.vx * dt;\n\t\t\t\t\tspritePos.y += p.vy * dt;\n\t\t\t\t}\n\n\t\t\t\tsprite.tint = colorLerp(lerp);\n\n\t\t\t\tsprite.alpha = alphaLerp(lerp);\n\n\t\t\t\tscale = scaleLerp(lerp);\n\t\t\t\tsprite.scale.set(scale, scale);\n\n\t\t\t}\n\t\t},\n\n\t\tsleep() {\n\t\t\tthis.particles = null;\n\n\t\t\tthis.container.destroy();\n\t\t\tthis.container = null;\n\n\t\t\tif (this.positionListener) {\n\t\t\t\tthis.positionListener();\n\t\t\t\tthis.positionListener = null;\n\t\t\t}\n\n\t\t\t// do not destroy textures. we can reuse them.\n\t\t}\n\t}\n});\n\nfunction alphaLerp(lerp) {\n\tif (lerp > 0.5) {\n\t\treturn (1 - lerp) / 0.5;\n\t} else if (lerp > 0.2) {\n\t\treturn 1;\n\t} else {\n\t\treturn lerp * 5;\n\t}\n}\n\nfunction scaleLerp(lerp) {\n\tif (lerp > 0.5) {\n\t\treturn 1;\n\t} else {\n\t\treturn 0.5 + lerp;\n\t}\n}\n\nconst blendModes = {\n\tadd: isClient ? PIXI.BLEND_MODES.ADD : 0,\n\tnormal: isClient ? PIXI.BLEND_MODES.NORMAL : 0\n};\n\nlet textureCache = {};\n\n// size: pixels\n// gradientHardness: 0..1\nfunction getParticleTexture(size, gradientHardness = 0, rgb = { r: 255, g: 255, b: 255, a: 1 }) {\n\tlet hash = `${size}-${gradientHardness}-${rgb.r}-${rgb.g}-${rgb.b}-${rgb.a}`;\n\tif (!textureCache[hash]) {\n\t\tlet canvas = document.createElement('canvas');\n\t\tcanvas.width = size;\n\t\tcanvas.height = size;\n\t\tlet context = canvas.getContext('2d');\n\t\tvar gradient = context.createRadialGradient(\n\t\t\tsize * 0.5,\n\t\t\tsize * 0.5,\n\t\t\tsize * 0.5 * (gradientHardness), // inner r\n\t\t\tsize * 0.5,\n\t\t\tsize * 0.5,\n\t\t\tsize * 0.5 // outer r\n\t\t);\n\t\tgradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${rgb.a})`);\n\t\tgradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0)`);\n\t\tcontext.fillStyle = gradient;\n\t\tcontext.fillRect(0, 0, size, size);\n\t\ttextureCache[hash] = PIXI.Texture.fromCanvas(canvas);\n\t}\n\treturn textureCache[hash];\n}\n","export function removeTheDeadFromArray(array) {\n\tfor (let i = array.length - 1; i >= 0; --i) {\n\t\tif (array[i]._alive === false)\n\t\t\tarray.splice(i, 1);\n\t}\n}\n\nexport function absLimit(value, absMax) {\n\tif (value > absMax)\n\t\treturn absMax;\n\telse if (value < -absMax)\n\t\treturn -absMax;\n\telse\n\t\treturn value;\n}\n","import { Component, Prop } from '../core/component';\nimport { animation } from '../features/animation/animation';\nimport { getSerializable } from '../core/serializableManager';\nimport EntityPrototype from '../core/entityPrototype';\nimport Entity from '../core/entity';\nimport assert from '../util/assert';\nimport Property from '../core/property';\nimport Vector from '../util/vector';\nimport { PropertyType } from '../core/propertyType';\nimport { Color } from '../util/color';\n\n// Export so that other components can have this component as parent\nexport default Component.register({\n\tname: 'Animation',\n\tdescription: 'Allows animation of children',\n\tcategory: 'Graphics', // You can also make up new categories.\n\ticon: 'fa-bars', // Font Awesome id\n\tproperties: [\n\t\tProp('animationData', '{}', Prop.longString, 'temporary var for development')\n\t],\n\tallowMultiple: false, // see prototype.ts clone(). Would need multi-component support\n\tprototype: {\n\t\tanimator: null,\n\t\tconstructor() {\n\t\t},\n\t\tpreInit() {\n\t\t},\n\t\tinit() {\n\t\t\tthis.listenProperty(this, 'animationData', () => this.loadAnimation());\n\t\t\tthis.loadAnimation();\n\t\t},\n\t\tonUpdate(dt) {\n\t\t\tthis.animator.update(dt);\n\t\t},\n\t\tloadAnimation() {\n\t\t\tif (this.animator) {\n\t\t\t\tthis.animator.delete();\n\t\t\t}\n\t\t\tthis.animator = new Animator(animation.parseAnimationData(this.animationData), this);\n\t\t},\n\t\tsleep() {\n\t\t\tthis.animator.delete();\n\t\t\tthis.animator = null;\n\t\t}\n\t}\n});\n\nconst controlPointDistanceFactor = 0.33333; // 0.33333333;\n\nclass Animator {\n\ttime: number = 0;\n\tanimations: AnimatorAnimation[];\n\tcurrentAnimation: AnimatorAnimation;\n\tconstructor(animationData: animation.AnimationData, public component: Component) {\n\t\tthis.animations = animationData.animations.map(anim => new AnimatorAnimation(anim, component.entity.prototype));\n\t\tthis.currentAnimation = this.animations[0];\n\t}\n\tupdate(dt) {\n\t\tif (!this.currentAnimation) {\n\t\t\treturn;\n\t\t}\n\t\tconst animationLength = this.currentAnimation.frames / this.currentAnimation.fps;\n\t\tthis.time += dt;\n\t\tif (this.time >= animationLength) {\n\t\t\tthis.time -= animationLength;\n\t\t}\n\t\tlet totalFrames = this.currentAnimation.frames;\n\t\tlet frame = this.time / animationLength * totalFrames + 1;\n\t\tthis.currentAnimation.setFrame(frame);\n\t}\n\tsetAnimation(name: string) {\n\t\tif (!name) {\n\t\t\tthis.time = 0;\n\t\t\tthis.currentAnimation = null;\n\t\t\tthis.component.entity.resetComponents();\n\t\t\treturn;\n\t\t}\n\t\tlet anim = this.animations.find(anim => anim.name === name);\n\t\tif (anim) {\n\t\t\tthis.currentAnimation = anim;\n\t\t\tthis.time = 0;\n\t\t}\n\t}\n\tdelete() {\n\t\tdelete this.animations;\n\t\tdelete this.currentAnimation;\n\t}\n}\n\nclass AnimatorAnimation {\n\tname: string;\n\ttracks: AnimatorTrack[];\n\tframes: number;\n\tfps: number;\n\tconstructor(animationJSON: animation.AnimationDataAnimation, rootEntityPrototype: EntityPrototype) {\n\t\tthis.name = animationJSON.name;\n\t\tthis.frames = animationJSON.frames || animation.DEFAULT_FRAME_COUNT;\n\t\tthis.fps = animationJSON.fps || animation.DEFAULT_FRAME_RATE;\n\t\tthis.tracks = animationJSON.tracks.map(trackData => new AnimatorTrack(trackData, this.frames, rootEntityPrototype));\n\t}\n\tsetFrame(frame: number) {\n\t\tassert(frame >= 1 && frame < this.frames + 1, 'invalid frame number: ' + frame);\n\t\tfor (let track of this.tracks) {\n\t\t\ttrack.setFrame(frame);\n\t\t}\n\t}\n}\n\nclass AnimatorTrack {\n\tentityPrototype: EntityPrototype;\n\tentity: Entity;\n\tanimatedProperty: Property;\n\tcurrentKeyFrameIndex: number = 0;\n\tkeyFrames: Array<{\n\t\tframe: number;\n\t\tvalue: any;\n\t\tcontrol1: any;\n\t\tcontrol2: any;\n\t}> = [];\n\tconstructor(trackData: animation.AnimationDataTrack, public frames: number, rootEntityPrototype: EntityPrototype) {\n\t\tthis.entityPrototype = rootEntityPrototype.getPrototypeByPath(trackData.path) as EntityPrototype;\n\t\tif (!this.entityPrototype) {\n\t\t\tconsole.warn('Animation path did not match anything:', trackData.path)\n\t\t\treturn\n\t\t}\n\t\tlet componentData = this.entityPrototype.findComponentDataByComponentId(trackData.cId, true);\n\t\tlet componentName = componentData.componentClass.componentName;\n\t\tthis.entity = this.entityPrototype.previouslyCreatedEntity;\n\t\tassert(this.entity, 'must have entity');\n\t\tlet component = this.entity.getComponents(componentName).find(c => c._componentId === trackData.cId);\n\t\tassert(component, 'component must be found');\n\t\tthis.animatedProperty = component._properties[trackData.prpName];\n\t\tlet keyFrameFrames = Object.keys(trackData.keyFrames).map(key => ~~key).sort((a, b) => a - b);\n\n\t\tfor (let frame of keyFrameFrames) {\n\t\t\tlet value = this.animatedProperty.propertyType.type.fromJSON(trackData.keyFrames[frame]);\n\t\t\tthis.keyFrames.push({\n\t\t\t\tframe,\n\t\t\t\tvalue,\n\t\t\t\tcontrol1: value,\n\t\t\t\tcontrol2: value\n\t\t\t});\n\t\t}\n\t\tlet propertyTypeName = this.animatedProperty.propertyType.type.name;\n\t\tlet propertyType = this.animatedProperty.propertyType;\n\t\tconst color = value => Math.min(Math.max(value, 0), 255);\n\t\tfor (let i = 0; i < this.keyFrames.length; i++) {\n\t\t\tlet prev = this.keyFrames[i];\n\t\t\tlet curr = this.keyFrames[(i + 1) % this.keyFrames.length];\n\t\t\tlet next = this.keyFrames[(i + 2) % this.keyFrames.length];\n\n\t\t\tif (propertyTypeName === 'float') {\n\t\t\t\tlet controlPoints;\n\t\t\t\tif (propertyType.getFlag(Prop.flagDegreesInEditor)) {\n\t\t\t\t\t// It's angle we are dealing with.\n\t\t\t\t\tcontrolPoints = calculateControlPointsForScalar(\n\t\t\t\t\t\tgetClosestAngle(curr.value, prev.value),\n\t\t\t\t\t\tcurr.value,\n\t\t\t\t\t\tgetClosestAngle(curr.value, next.value)\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tcontrolPoints = calculateControlPointsForScalar(prev.value, curr.value, next.value);\n\t\t\t\t}\n\t\t\t\tcurr.control1 = controlPoints.control1;\n\t\t\t\tcurr.control2 = controlPoints.control2;\n\t\t\t} else if (propertyTypeName === 'vector') {\n\t\t\t\tlet prevValue = prev.value as Vector;\n\t\t\t\tlet currValue = curr.value as Vector;\n\t\t\t\tlet nextValue = next.value as Vector;\n\n\t\t\t\tlet prevToCurr = currValue.clone().subtract(prevValue);\n\t\t\t\tlet currToNext = nextValue.clone().subtract(currValue);\n\n\t\t\t\tlet angleFactor = (Math.PI - prevToCurr.angleTo(currToNext)) / Math.PI;\n\t\t\t\tangleFactor *= 2;\n\t\t\t\tif (angleFactor > 1) {\n\t\t\t\t\tangleFactor = 1\n\t\t\t\t}\n\n\t\t\t\t// Look at this cool way to reduce sqrt calls to 1! :D\n\t\t\t\t// let smallerDistance = Math.sqrt(Math.min(prevToCurr.lengthSq(), currToNext.lengthSq()))\n\t\t\t\tlet controlPointDistance = controlPointDistanceFactor * angleFactor * 0.5 * (prevToCurr.length() + currToNext.length())\n\n\n\t\t\t\t// let angleFactor = prevToCurr.closestAngleTo(currToNext) * 2 / Math.PI;\n\n\t\t\t\tlet prevKeyFrameFrames = curr.frame - prev.frame;\n\t\t\t\tif (prevKeyFrameFrames <= 0) {\n\t\t\t\t\tprevKeyFrameFrames += this.frames;\n\t\t\t\t}\n\n\t\t\t\tlet currKeyFrameFrames = next.frame - curr.frame;\n\t\t\t\tif (currKeyFrameFrames <= 0) {\n\t\t\t\t\tcurrKeyFrameFrames += this.frames;\n\t\t\t\t}\n\n\t\t\t\tlet speedIncreaseSq = Math.sqrt(prevKeyFrameFrames / currKeyFrameFrames);\n\n\t\t\t\t// let controlPointDistance = Math.max(prevToCurr.length(), currToNext.length()) * controlPointDistanceFactor * angleFactor;\n\t\t\t\tlet prevControlDist = controlPointDistance;\n\t\t\t\tlet nextControlDist = controlPointDistance;\n\n\t\t\t\tif (speedIncreaseSq > 1) {\n\t\t\t\t\tnextControlDist /= speedIncreaseSq;\n\t\t\t\t\tprevControlDist *= speedIncreaseSq;\n\t\t\t\t} else {\n\t\t\t\t\tprevControlDist *= speedIncreaseSq;\n\t\t\t\t\tnextControlDist /= speedIncreaseSq;\n\t\t\t\t}\n\n\t\t\t\tlet prevNextDirection = nextValue.clone().subtract(prevValue).setLength(1);\n\n\t\t\t\tcurr.control1 = currValue.clone().subtract(prevNextDirection.clone().multiplyScalar(prevControlDist));\n\t\t\t\tcurr.control2 = currValue.clone().add(prevNextDirection.multiplyScalar(nextControlDist));\n\n\t\t\t\t// let xControl = calculateControlPointsForScalar(prev.value.x, curr.value.x, next.value.x);\n\t\t\t\t// let yControl = calculateControlPointsForScalar(prev.value.y, curr.value.y, next.value.y);\n\t\t\t\t// curr.control1 = new Vector(xControl.control1, yControl.control1);\n\t\t\t\t// curr.control2 = new Vector(xControl.control2, yControl.control2);\n\t\t\t} else if (propertyTypeName === 'color') {\n\t\t\t\tlet rControl = calculateControlPointsForScalar(prev.value.r, curr.value.r, next.value.r);\n\t\t\t\tlet gControl = calculateControlPointsForScalar(prev.value.g, curr.value.g, next.value.g);\n\t\t\t\tlet bControl = calculateControlPointsForScalar(prev.value.b, curr.value.b, next.value.b);\n\t\t\t\tcurr.control1 = new Color(color(rControl.control1), color(gControl.control1), color(bControl.control1));\n\t\t\t\tcurr.control2 = new Color(color(rControl.control2), color(gControl.control2), color(bControl.control2));\n\t\t\t}\n\t\t}\n\t}\n\t/**\n\t * @param frame float because of interpolation\n\t */\n\tsetFrame(frame: number) {\n\t\tlet keyFrames = this.keyFrames;\n\t\tif (keyFrames.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet prev, next;\n\n\t\t// This is optimal enough. This for loop takes 0 time compared to setting the property value.\n\t\tfor (let i = 0; i < keyFrames.length; i++) {\n\t\t\tif (keyFrames[i].frame > frame) {\n\t\t\t\tnext = keyFrames[i];\n\t\t\t\tprev = keyFrames[(i - 1 + keyFrames.length) % keyFrames.length];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (!prev) {\n\t\t\tprev = keyFrames[keyFrames.length - 1];\n\t\t\tnext = keyFrames[0];\n\t\t}\n\n\t\tlet newValue;\n\t\tif (prev === next) {\n\t\t\tnewValue = prev.value;\n\t\t} else {\n\t\t\tlet prevFrame: number = prev.frame;\n\t\t\tif (prevFrame > frame) {\n\t\t\t\tprevFrame -= this.frames;\n\t\t\t}\n\n\t\t\tlet nextFrame: number = next.frame;\n\t\t\tif (nextFrame < frame) {\n\t\t\t\tnextFrame += this.frames;\n\t\t\t}\n\n\t\t\tlet t = (frame - prevFrame) / (nextFrame - prevFrame);\n\t\t\tnewValue = interpolateBezier(prev.value, prev.control2, next.control1, next.value, t, this.animatedProperty.propertyType);\n\t\t\t// newValue = interpolateLinear(prev.value, next.value, t, this.animatedProperty.propertyType);\n\t\t}\n\n\t\tif (this.animatedProperty.value !== newValue) {\n\t\t\tthis.animatedProperty.value = newValue;\n\t\t}\n\t\treturn newValue;\n\t}\n}\n\n// Returns angle that is at most Math.PI away.\nfunction getClosestAngle(origin, target) {\n\tlet diff = target - origin;\n\tif (diff > Math.PI) {\n\t\treturn target - Math.PI * 2;\n\t} else if (diff < -Math.PI) {\n\t\treturn target + Math.PI * 2;\n\t}\n\treturn target;\n}\n\nfunction interpolateBezier(fromValue, control1Value, control2Value, targetValue, t: number, propertyType: PropertyType) {\n\tlet typeName = propertyType.type.name;\n\tif (typeName === 'float') {\n\t\tif (propertyType.getFlag(Prop.flagDegreesInEditor)) {\n\t\t\t// It's angle we are dealing with.\n\t\t\tcontrol1Value = getClosestAngle(fromValue, control1Value);\n\t\t\tcontrol2Value = getClosestAngle(fromValue, control2Value);\n\t\t\ttargetValue = getClosestAngle(fromValue, targetValue);\n\t\t}\n\t\tlet t2 = 1 - t;\n\t\treturn t2 ** 3 * fromValue +\n\t\t\t3 * t2 * t2 * t * control1Value +\n\t\t\t3 * t2 * t * t * control2Value +\n\t\t\tt ** 3 * targetValue;\n\t} else if (typeName === 'vector') {\n\t\treturn fromValue.interpolateCubic(targetValue, control1Value, control2Value, t);\n\t} else if (typeName === 'color') {\n\t\treturn fromValue.interpolateCubic(targetValue, control1Value, control2Value, t);\n\t} else {\n\t\treturn fromValue;\n\t}\n}\n\nfunction bezier(fromValue, control1Value, control2Value, targetValue, t) {\n\tlet t2 = 1 - t;\n\treturn t2 ** 3 * fromValue +\n\t\t3 * t2 * t2 * t * control1Value +\n\t\t3 * t2 * t * t * control2Value +\n\t\tt ** 3 * targetValue;\n}\nwindow.bezier = bezier\n\nfunction interpolateLinear(fromValue, targetValue, t: number, propertyType: PropertyType) {\n\tlet typeName = propertyType.type.name;\n\tif (typeName === 'float') {\n\t\tif (propertyType.getFlag(Prop.flagDegreesInEditor)) {\n\t\t\t// It's angle we are dealing with.\n\t\t\ttargetValue = getClosestAngle(fromValue, targetValue);\n\t\t}\n\t\treturn fromValue + t * (targetValue - fromValue);\n\t} else if (typeName === 'vector') {\n\t\treturn fromValue.interpolateLinear(targetValue, t);\n\t} else if (typeName === 'color') {\n\t\treturn fromValue.interpolateLinear(targetValue, t);\n\t} else {\n\t\treturn fromValue;\n\t}\n}\n\nfunction calculateControlPointsForScalar(prev: number, curr: number, next: number) {\n\treturn {\n\t\tcontrol1: curr + (prev - next) / 3,\n\t\tcontrol2: curr + (next - prev) / 3\n\t}\n\n\tif (curr >= prev && curr >= next || curr <= prev && curr <= next) {\n\t\treturn {\n\t\t\tcontrol1: curr,\n\t\t\tcontrol2: curr\n\t\t};\n\t}\n\n\tlet prevDist = Math.abs(curr - prev);\n\tlet nextDist = Math.abs(next - curr);\n\n\tlet prevNextDirection = (next - prev) < 0 ? -1 : 1;\n\n\treturn {\n\t\tcontrol1: curr - prevNextDirection * prevDist * controlPointDistanceFactor,\n\t\tcontrol2: curr + prevNextDirection * nextDist * controlPointDistanceFactor,\n\t};\n}\n\nfunction calculateControlPointsForScalar2(prev: number, curr: number, next: number) {\n\tlet prevDist = Math.abs(curr - prev);\n\tlet nextDist = Math.abs(next - curr);\n\tlet dist = Math.min(prevDist, nextDist);\n\n\tlet prevNextDirection = (next - prev) < 0 ? -1 : 1;\n\n\treturn {\n\t\tcontrol1: curr - prevNextDirection * prevDist * controlPointDistanceFactor,\n\t\tcontrol2: curr + prevNextDirection * nextDist * controlPointDistanceFactor,\n\t};\n}\n","import {\n\texecuteExternal,\n\tchangeType,\n\tChange\n} from './change'\nimport Serializable from './serializable';\nimport {game} from './game';\nimport {limit} from '../util/callLimiter';\nimport {stickyNonModalErrorPopup} from \"../util/popup\";\nimport assert from '../util/assert';\nimport { getSerializable } from './serializableManager';\nimport Property from './property';\nimport { GameEvent, globalEventDispatcher } from './eventDispatcher';\nimport { isServer } from '../util/environment';\n\nlet options = {\n\tcontext: null, // 'play' or 'edit'. This is communicated to server. Doesn't affect client.\n\tserverToClientEnabled: true,\n\tclientToServerEnabled: false\n};\n\nexport function configureNetSync(_options) {\n\toptions = Object.assign(options, _options);\n}\n\nlet changes = [];\nlet valueChanges = {}; // id => change\n\nfunction isInSceneTree(change) {\n\treturn change.reference._rootType === 'sce';\n}\n\nfunction getQueryVariable(variable) {\n\tvar query = window.location.search.substring(1);\n\tvar vars = query.split('&');\n\tfor (var i = 0; i < vars.length; i++) {\n\t\tvar pair = vars[i].split('=');\n\t\tif (decodeURIComponent(pair[0]) == variable) {\n\t\t\treturn decodeURIComponent(pair[1]);\n\t\t}\n\t}\n\tconsole.log('Query variable %s not found', variable);\n}\n\nfunction changeReceivedOverNet(packedChanges) {\n\tif (!options.serverToClientEnabled)\n\t\treturn;\n\tpackedChanges.forEach(change => {\n\t\tchange = unpackChange(change);\n\t\tif (change) {\n\t\t\texecuteChange(change);\n\t\t}\n\t});\n}\nfunction gameReceivedOverNet(gameData) {\n\tconsole.log('receive gameData', gameData);\n\tif (!gameData)\n\t\treturn console.error('Game data was not received');\n\ttry {\n\t\texecuteExternal(() => {\n\t\t\tSerializable.fromJSON(gameData);\n\t\t\tglobalEventDispatcher.dispatch(GameEvent.GLOBAL_GAME_CREATED, game);\n\t\t});\n\t\tlocalStorage.openEditPlayGameId = gameData.id;\n\t\t// location.replace(`${location.origin}${location.pathname}?gameId=${gameData.id}`);\n\t\thistory.replaceState({}, null, `?gameId=${gameData.id}`);\n\t} catch(e) {\n\t\tconsole.error('Game is corrupt.', e);\n\t\tstickyNonModalErrorPopup('Game is corrupt.');\n\t}\n}\n\nglobalEventDispatcher.listen(GameEvent.GLOBAL_CHANGE_OCCURED, change => {\n\tif (change.external || !options.clientToServerEnabled)\n\t\treturn; // Don't send a change that you have received.\n\n\tif (isInSceneTree(change)) // Don't sync scene\n\t\treturn;\n\n\tif (change.type === changeType.setPropertyValue) {\n\t\tlet duplicateChange = valueChanges[change.id];\n\t\tif (duplicateChange) {\n\t\t\tchanges.splice(changes.indexOf(duplicateChange), 1);\n\t\t}\n\t\tvalueChanges[change.id] = change;\n\t}\n\tchanges.push(change);\n\n\tif (sendChanges)\n\t\tsendChanges();\n});\n\nfunction parseSocketMessage(message) {\n\tlet type = message.split(' ')[0];\n\tlet body = message.substring(type.length + 1);\n\tif (body.length > 0)\n\t\tbody = JSON.parse(body);\n\n\tconsole.log('parseSocketMessage', type, body);\n\n\treturn {\n\t\ttype,\n\t\tbody\n\t};\n}\n\nfunction sendSocketMessage(eventName, data) {\n\tif (!socket)\n\t\treturn console.log('Could not send', eventName);\n\n\tif (eventName)\n\t\tsocket.emit(eventName, data);\n\telse\n\t\tsocket.emit(data);\n}\n\nlet listeners = {\n\tdata(result) {\n\t\tlet {profile, gameData, editAccess} = result;\n\t\tlocalStorage.openEditPlayUserId = profile.id;\n\t\tlocalStorage.openEditPlayUserToken = profile.userToken;\n\n\t\tif (!editAccess) {\n\t\t\tglobalEventDispatcher.dispatch('noEditAccess');\n\t\t}\n\n\t\tdelete profile.userToken;\n\t\twindow.user = profile;\n\n\t\tgameReceivedOverNet(gameData);\n\t},\n\tidentifyYourself() {\n\t\tif (game)\n\t\t\treturn location.reload();\n\n\t\tlet gameId = getQueryVariable('gameId') || localStorage.openEditPlayGameId;\n\t\tlet userId = localStorage.openEditPlayUserId; // if doesn't exist, server will create one\n\t\tlet userToken = localStorage.openEditPlayUserToken; // if doesn't exist, server will create one\n\t\tlet context = options.context;\n\t\tsendSocketMessage('identify', {userId, userToken, gameId, context});\n\t},\n\terrorMessage(result) {\n\t\tlet {message, isFatal, data} = result;\n\t\tconsole.error(`Server sent ${isFatal ? 'FATAL ERROR' : 'error'}:`, message, data);\n\t\tif (isFatal) {\n\t\t\tstickyNonModalErrorPopup(message);\n\t\t\t// document.body.textContent = message;\n\t\t}\n\t}\n};\n\nlet sendChanges = limit(200, 'soon', () => {\n\tif (!socket || changes.length === 0 || !options.clientToServerEnabled)\n\t\treturn;\n\n\tlet packedChanges = changes.map(packChange);\n\tchanges.length = 0;\n\tvalueChanges = {};\n\tconsole.log('send change', packedChanges);\n\tsendSocketMessage('', packedChanges);\n});\n\nlet socket;\nfunction connect() {\n\tif (isServer) {\n\t\t// Electron app, not using sockets\n\t\tgameReceivedOverNet({\n\t\t\tid: 'gam_dumb',\n\t\t\tc: [{\"id\":\"prtrQ10Xvlt26lKIsrk\",\"c\":[{\"id\":\"cdaP5MbwTHjlNTtsbOf\",\"c\":[{\"id\":\"prp7GBI7ptGoOB0czCf\",\"v\":1,\"n\":\"rotationalDrag\"}],\"cid\":\"_Physics\",\"n\":\"Physics\"},{\"id\":\"cdalev0lEyN36HMU1yq\",\"cid\":\"_CharacterController\",\"n\":\"CharacterController\"},{\"id\":\"cdatyGx2WHvS86caySN\",\"cid\":\"cidhFIVThaem3\",\"n\":\"Shape\"},{\"id\":\"prp_testPrototypeName\",\"v\":\"Actor\",\"n\":\"name\"}],\"si\":\"M19cq\"},{\"id\":\"prte2f3KiHuM0sF8fGr\",\"c\":[{\"id\":\"cdaUTyhrNmhJgbj3hWz\",\"c\":[{\"id\":\"prptvjNMPCRfYOB18By\",\"v\":\"static\",\"n\":\"type\"}],\"cid\":\"_Physics\",\"n\":\"Physics\"},{\"id\":\"cdayHf6lKxMHybf1UDm\",\"cid\":\"cidAqAv86xu0G\",\"n\":\"Shape\"},{\"id\":\"prpQUR3Ei2tKQ10XL40\",\"v\":\"Static\",\"n\":\"name\"}],\"si\":\"XaLeF\"},{\"id\":\"prtTsDqevlt2okzITrF\",\"c\":[{\"id\":\"cda9QvRA0RtxAJ2Y73E\",\"cid\":\"cidPNowJEkdoK\",\"n\":\"Shape\"},{\"id\":\"cdaGVd0cK6exGIvPlm8\",\"cid\":\"_Physics\",\"n\":\"Physics\"},{\"id\":\"prpcCUqrxeQMOamqIbc\",\"v\":\"Dynamic\",\"n\":\"name\"}],\"si\":\"OXlXy\"},{\"id\":\"lvloRefeYW72V69c3Q1\",\"c\":[{\"id\":\"eprBsqCAnWgyaoVfyiM\",\"si\":\"GxMPD\",\"c\":[{\"id\":\"cdaEpszsej3gKpA0ZaQ\",\"cid\":\"cidW8yFNDGQX9\",\"n\":\"Shape\"},{\"id\":\"cdadevJLE9pHC8ITKrc\",\"c\":[{\"id\":\"prpHBLerc9GTmQe5JBO\",\"v\":\"static\",\"n\":\"type\"}],\"cid\":\"_Physics\",\"n\":\"Physics\"}],\"n\":\"Floor\",\"p\":{\"x\":-182.1158,\"y\":78.5093},\"s\":{\"x\":4.0126,\"y\":0.5846}},{\"id\":\"eprCyIXOLETKXtrmRzf\",\"si\":\"GxMPD\",\"c\":[{\"id\":\"cdaQXPj6dFUQBtbOREZ\",\"cid\":\"_CharacterController\",\"n\":\"CharacterController\"},{\"id\":\"cdaRpjAVXeYHIAvRPtQ\",\"c\":[{\"id\":\"prpDPLnUOytA2bb2gXF\",\"v\":\"circle\",\"n\":\"type\"}],\"cid\":\"cidW8yFNDGQX9\",\"n\":\"Shape\"},{\"id\":\"cdazw3hJYQKgeidpVbB\",\"c\":[{\"id\":\"prpwFGr3IBoruOTBIbr\",\"v\":\"dynamic\",\"n\":\"type\"}],\"cid\":\"_Physics\",\"n\":\"Physics\"}],\"n\":\"guy\",\"p\":{\"x\":-72.9377,\"y\":-12.0532}},{\"id\":\"eprTK6vWjNyLCU2lmC3\",\"si\":\"GxMPD\",\"c\":[{\"id\":\"cdaFtZvXSTpnde2mCaw\",\"c\":[{\"id\":\"prpHcFA2HUNovmcJw7D\",\"v\":\"static\",\"n\":\"type\"}],\"cid\":\"_Physics\",\"n\":\"Physics\"},{\"id\":\"cdaw8rjFsM9mw8jMbEz\",\"cid\":\"cidW8yFNDGQX9\",\"n\":\"Shape\"}],\"n\":\"Floor\",\"p\":{\"x\":-254.0626,\"y\":33.7312},\"s\":{\"x\":4.0126,\"y\":0.5846}},{\"id\":\"epra8MzE4b0YWUS8bAu\",\"si\":\"GxMPD\",\"c\":[{\"id\":\"cdaZr6GMN5zlVAHCl2X\",\"c\":[{\"id\":\"prpRxYyZV8HU42ht82h\",\"v\":\"static\",\"n\":\"type\"}],\"cid\":\"_Physics\",\"n\":\"Physics\"},{\"id\":\"cdarBCjhtof8Sy9pDdt\",\"cid\":\"cidW8yFNDGQX9\",\"n\":\"Shape\"}],\"n\":\"Floor\",\"p\":{\"x\":-75.4687,\"y\":42.7656},\"s\":{\"x\":4.0126,\"y\":0.5846}},{\"id\":\"prpfI8ByaPzgGnGavwE\",\"v\":\"Level 1\",\"n\":\"name\"}]}]\n\t\t})\n\n\t\t// TODO: Save stuff to file system\n\n\t\treturn\n\t}\n\n\tlet io = window['io'];\n\tif (!io) {\n\t\treturn console.error('socket.io not defined after window load.');\n\t}\n\n\tsocket = new io();\n\tsocket.on('connect', () => {\n\t\tsocket.onevent = packet => {\n\t\t\tlet param1 = packet.data[0];\n\t\t\tif (typeof param1 === 'string') {\n\t\t\t\tlisteners[param1](packet.data[1]);\n\t\t\t} else {\n\t\t\t\t// Optimized change-event\n\t\t\t\tchangeReceivedOverNet(param1);\n\t\t\t}\n\t\t};\n\t\tsocket.on('disconnect', () => {\n\t\t\tconsole.warn('Disconnected!');\n\t\t\tstickyNonModalErrorPopup('Disconnected!');\n\t\t\toptions.serverToClientEnabled = false;\n\t\t\toptions.clientToServerEnabled = false;\n\t\t});\n\t});\n}\nwindow.addEventListener('load', connect);\n\nlet keyToShortKey = {\n\tid: 'i', // obj.id\n\ttype: 't', // changeType.*\n\tvalue: 'v', // value after toJSON\n\tparentId: 'p' // obj._parent.id\n};\nlet shortKeyToKey = {};\nObject.keys(keyToShortKey).forEach(k => {\n\tshortKeyToKey[keyToShortKey[k]] = k;\n});\n\nfunction packChange(change) {\n\tif (change.packedChange)\n\t\treturn change.packedChange; // optimization\n\n\tlet packed = {};\n\ttry {\n\t\tif (change.parent)\n\t\t\tchange.parentId = change.parent.id;\n\n\t\tif (change.type === changeType.addSerializableToTree) {\n\t\t\tif (change.reference) {\n\t\t\t\tchange.value = change.reference.toJSON();\n\t\t\t} else {\n\t\t\t\tassert(false, 'invalid change of type addSerializableToTree', change);\n\t\t\t}\n\t\t} else if (change.value !== undefined) {\n\t\t\tchange.value = change.reference.propertyType.type.toJSON(change.value);\n\t\t}\n\n\t\tObject.keys(keyToShortKey).forEach(key => {\n\t\t\tif (change[key] !== undefined) {\n\t\t\t\tif (key === 'type' && change[key] === changeType.setPropertyValue) return; // optimize most common type\n\t\t\t\tpacked[keyToShortKey[key]] = change[key];\n\t\t\t}\n\t\t});\n\t} catch (e) {\n\t\tconsole.log('PACK ERROR', e);\n\t}\n\treturn packed;\n}\n\nfunction unpackChange(packedChange): Change {\n\tlet change: any = {\n\t\tpackedChange // optimization\n\t};\n\tObject.keys(packedChange).forEach(shortKey => {\n\t\tlet key = shortKeyToKey[shortKey];\n\t\tchange[key] = packedChange[shortKey];\n\t});\n\tif (!change.type)\n\t\tchange.type = changeType.setPropertyValue;\n\n\tif (change.type === changeType.addSerializableToTree) {\n\t\t// reference does not exist because it has not been created yet\n\t\tchange.id = change.value.id;\n\t} else {\n\t\tchange.reference = getSerializable(change.id);\n\t\tif (change.reference) {\n\t\t\tchange.id = change.reference.id;\n\t\t} else {\n\t\t\tconsole.error('received a change with unknown id', change, 'packed:', packedChange);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tif (change.parentId)\n\t\tchange.parent = getSerializable(change.parentId);\n\treturn change as Change;\n}\n\nfunction executeChange(change: Change) {\n\tlet newScene;\n\n\texecuteExternal(() => {\n\t\tif (change.type === changeType.setPropertyValue) {\n\t\t\t(change.reference as Property).value = (change.reference as Property).propertyType.type.fromJSON(change.value);\n\t\t} else if (change.type === changeType.addSerializableToTree) {\n\t\t\tif (change.parent) {\n\t\t\t\tlet obj = Serializable.fromJSON(change.value);\n\t\t\t\tchange.parent.addChild(obj);\n\t\t\t\tif (obj.threeLetterType === 'ent') {\n\t\t\t\t\tobj.localMaster = false;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tlet obj = Serializable.fromJSON(change.value); // Scene does not need a parent\n\t\t\t\tif (obj.threeLetterType === 'sce')\n\t\t\t\t\tnewScene = obj;\n\t\t\t}\n\t\t} else if (change.type === changeType.deleteAllChildren) {\n\t\t\tchange.reference.deleteChildren();\n\t\t} else if (change.type === changeType.deleteSerializable) {\n\t\t\tchange.reference.delete();\n\t\t} else if (change.type === changeType.move) {\n\t\t\tchange.reference.move(change.parent);\n\t\t}\n\t});\n\n\tif (newScene)\n\t\tnewScene.play();\n}\n","import { scene, forEachScene } from '../core/scene';\nimport debug from './debug'\n\nimport Vector from '../util/vector';\nimport { globalEventDispatcher } from '../core/eventDispatcher';\n\nlet previousWidth = null;\nlet previousHeight = null;\nfunction resizeCanvas() {\n\tif (!scene)\n\t\treturn;\n\n\tlet screen = document.getElementById('screen');\n\n\tfunction setSize(force: boolean = false) {\n\t\tif (!screen)\n\t\t\treturn;\n\n\t\tlet width = window.innerWidth;\n\t\tlet height = window.innerHeight;\n\n\t\tif (!force && width === previousWidth && height === previousHeight)\n\t\t\treturn;\n\n\t\tscreen.style.width = width + 'px';\n\t\tscreen.style.height = height + 'px';\n\n\t\t// Here you can change the resolution of the canvas\n\t\tlet pixels = width * height;\n\t\tlet quality = 1;\n\t\tif (pixels > MAX_PIXELS) {\n\t\t\tquality = Math.sqrt(MAX_PIXELS / pixels);\n\t\t}\n\n\t\tlet screenResolution = new Vector(width, height);\n\t\tlet gameResolution = screenResolution.clone().multiplyScalar(quality);\n\n\t\tscene.resizeCanvas(gameResolution, screenResolution);\n\t\t// scene.renderer.resize(width * quality, height * quality);\n\n\t\twindow.scrollTo(0, 0);\n\n\t\tpreviousWidth = width;\n\t\tpreviousHeight = height;\n\n\t\tglobalEventDispatcher.dispatch('canvas resize', scene);\n\n\t\t// Lets see if it has changed after 200ms.\n\t\tsetTimeout(() => setSize(), 200);\n\t}\n\n\tsetSize(true);\n\n\t// setTimeout(setSize, 50);\n\t// setTimeout(setSize, 400);\n\t// setTimeout(setSize, 1000);\n}\n\nwindow.addEventListener('resize', resizeCanvas);\nforEachScene(resizeCanvas);\n\nconst MAX_PIXELS = 800 * 600;\n","import {keyPressed, key, listenKeyDown, simulateKeyEvent} from '../util/input'\nimport {forEachScene, scene} from '../core/scene';\nimport Vector from '../util/vector';\nimport { default as TouchControl, CONTROL_SIZE } from './TouchControl';\nimport debug from './debug'\nimport { GameEvent } from '../core/eventDispatcher';\n\nconst ARROW_HITBOX_RADIUS = 110;\n\nconst controls: { [s: string]: TouchControl; } = {\n\ttouchUp:\tnew TouchControl('touchUp',\t\tkey.up),\n\ttouchDown:\tnew TouchControl('touchDown',\tkey.down),\n\ttouchLeft:\tnew TouchControl('touchLeft',\tkey.left),\n\ttouchRight:\tnew TouchControl('touchRight',\tkey.right),\n\ttouchJump:\tnew TouchControl('touchJump',\tkey.up, true),\n\ttouchA:\t\tnew TouchControl('touchA',\t\tkey.space, true),\n\ttouchB:\t\tnew TouchControl('touchB',\t\tkey.b, true)\n};\nconst rightHandControlArray = [controls.touchJump, controls.touchA, controls.touchB];\nconst controlArray = Object.keys(controls).map(key => controls[key]);\n\nwindow.addEventListener('load', () => {\n\tdocument.addEventListener(\"touchmove\", touchChange, {passive: false});\n\tdocument.addEventListener(\"touchstart\", touchChange, {passive: false});\n\tdocument.addEventListener(\"touchend\", touchChange, {passive: false});\n\tdocument.addEventListener(\"scroll\", event => event.preventDefault(), {passive: false});\n\n\twindow.IS_TOUCH_DEVICE = 'ontouchstart' in window || navigator.maxTouchPoints;\n\tif (window.IS_TOUCH_DEVICE)\n\t\tdocument.body.classList.add('touch');\n\n\tif (window.navigator.standalone)\n\t\tdocument.body.classList.add('nativeFullscreen');\n\n\tcontrolArray.forEach(control => control.initElement());\n});\n\nfunction touchChange(event) {\n\tevent.preventDefault();\n\n\tlet touchCoordinates = getTouchCoordinates(event);\n\tcontrolArray.forEach(control => {\n\t\tlet isPressed = !!touchCoordinates.find(coord => control.contains(coord));\n\t\tcontrol.setState(isPressed, event.type === 'touchstart');\n\t});\n}\n\nfunction getTouchCoordinates(touchEvent) {\n\tlet touchCoordinates = [];\n\tfor (let i = 0; i < touchEvent.targetTouches.length; ++i) {\n\t\tlet touch = touchEvent.targetTouches[i];\n\t\ttouchCoordinates.push(new Vector(touch.clientX,touch.clientY));\n\t}\n\treturn touchCoordinates;\n}\n\nforEachScene(() => {\n\tscene.listen(GameEvent.SCENE_START, () => positionControls());\n});\n\nfunction positionControls() {\n\tif (!scene)\n\t\treturn;\n\n\tlet\n\t\tplayerFound = false,\n\t\tjumperFound = false,\n\t\tjumpSpeedFound = false,\n\t\ttopDownFound = false,\n\t\tnextLevelButton = true // Press A to reset. Temp solution.\n\t;\n\n\tlet characterControllers = scene.getComponents('CharacterController');\n\tcharacterControllers.forEach(characterController => {\n\t\tif (characterController.type === 'player') {\n\t\t\tplayerFound = true;\n\t\t\tif (characterController.controlType === 'jumper') {\n\t\t\t\tjumperFound = true;\n\t\t\t\tif (characterController.jumpSpeed !== 0) {\n\t\t\t\t\tjumpSpeedFound = true;\n\t\t\t\t}\n\t\t\t} else if (characterController.controlType === 'top down') {\n\t\t\t\ttopDownFound = true;\n\t\t\t}\n\t\t}\n\t});\n\n\tcontrols.touchUp.setVisible(topDownFound);\n\tcontrols.touchLeft.setVisible(playerFound);\n\tcontrols.touchRight.setVisible(playerFound);\n\tcontrols.touchDown.setVisible(topDownFound);\n\tcontrols.touchJump.setVisible(jumpSpeedFound);\n\tcontrols.touchA.setVisible(nextLevelButton); // Temp solution.\n\tcontrols.touchB.setVisible(false);\n\n\tif (controls.touchUp.visible && controls.touchDown.visible) {\n\t\tcontrols.touchLeft.setPosition(10, null, 60);\n\t\tcontrols.touchRight.setPosition(110, null, 60);\n\t\tcontrols.touchUp.setPosition(60, null, 110);\n\t\tcontrols.touchDown.setPosition(60, null, 10);\n\n\t\tcontrols.touchLeft.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.x < 0 && Math.abs(rel.x) > Math.abs(rel.y) && rel.length() <= ARROW_HITBOX_RADIUS;\n\t\t});\n\n\t\tcontrols.touchUp.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.y < 0 && Math.abs(rel.y) > Math.abs(rel.x) && rel.length() <= ARROW_HITBOX_RADIUS;\n\t\t});\n\n\t\tcontrols.touchRight.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.x > 0 && Math.abs(rel.x) > Math.abs(rel.y) && rel.length() <= ARROW_HITBOX_RADIUS;\n\t\t});\n\n\t\tcontrols.touchDown.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.y > 0 && Math.abs(rel.y) > Math.abs(rel.x) && rel.length() <= ARROW_HITBOX_RADIUS;\n\t\t});\n\t} else {\n\t\tcontrols.touchLeft.setPosition(10, null, 20);\n\t\tcontrols.touchRight.setPosition(90, null, 20);\n\n\t\tcontrols.touchLeft.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.x <= 0 && rel.y > -ARROW_HITBOX_RADIUS;\n\t\t});\n\t\tcontrols.touchRight.setContainsFunction(point => {\n\t\t\tlet rel = getRelativePositionToArrowCenter(point);\n\t\t\treturn rel.x > 0 && rel.y > -ARROW_HITBOX_RADIUS && rel.x < ARROW_HITBOX_RADIUS;\n\t\t});\n\t}\n\n\tconst SIDE_BUTTON_EXTRA_LEFT_HITBOX = 15; // pixels\n\tlet visibleRightHandControls = rightHandControlArray.filter(control => control.visible);\n\tvisibleRightHandControls.forEach((control, idx) => {\n\t\tlet idxFromRightWall = visibleRightHandControls.length - 1 - idx;\n\t\tcontrol.setPosition(null, 10 + idxFromRightWall * 20, 20 + idx * 70);\n\n\t\tif (idx === 0) {\n\t\t\t// Bottom right corner control\n\t\t\tcontrol.setContainsFunction(point => {\n\t\t\t\tlet pos = control.getPosition();\n\t\t\t\treturn point.x >= pos.x - CONTROL_SIZE / 2 - SIDE_BUTTON_EXTRA_LEFT_HITBOX && point.y >= pos.y - CONTROL_SIZE / 2;\n\t\t\t});\n\t\t} else {\n\t\t\tcontrol.setContainsFunction(point => {\n\t\t\t\tlet pos = control.getPosition();\n\t\t\t\treturn point.y >= pos.y - CONTROL_SIZE / 2 && point.y <= pos.y + CONTROL_SIZE / 2 && point.x >= pos.x - CONTROL_SIZE / 2 - SIDE_BUTTON_EXTRA_LEFT_HITBOX;\n\t\t\t});\n\t\t}\n\t});\n}\n\nfunction getArrowCenter() {\n\tlet leftPos = controls.touchLeft.getPosition();\n\tlet rightPos = controls.touchRight.getPosition();\n\tlet center = leftPos.add(rightPos).divideScalar(2);\n\treturn center;\n}\nfunction getRelativePositionToArrowCenter(point) {\n\tlet center = getArrowCenter();\n\treturn point.clone().subtract(center);\n}\n","import assert from \"./assert\";\n\nconst SAVE_STACK_TRACE = false;\n\nexport class CircularDependencyDetector {\n    currentType: string = null;\n    chain: any[] = [];\n    timeout: any = null;\n\n    enter(type, data = null) {\n        this.chain.push({\n            type,\n            data,\n            stack: SAVE_STACK_TRACE ? (new Error()).stack : null\n        });\n        if (type !== this.currentType) {\n            if (this.chain.find((link, i) => link.type === type && i !== this.chain.length - 1)) {\n                console.warn('Change event circular dependency');\n                console.log('################################');\n                for (const part of this.chain) {\n                    console.warn(`%c${part.type}`, 'font-weight: bold; font-size: 16px');\n                    if (part.data && typeof part.data === 'object') {\n                        for (const key in part.data) {\n                            if (part.data[key] != null)\n                                console.warn(key + ':', part.data[key]);\n                        }\n                    } else {\n                        console.warn(part.data);\n                    }\n                    console.warn(part.stack || 'Turn SAVE_STACK_TRACE on to see stack traces. It will slow down the engine.');\n                    console.log('--------------------------------------');\n                }\n                assert(false, 'Change event circular dependency');\n            }\n            this.currentType = type;\n            if (!this.timeout) {\n                this.timeout = setTimeout(() => this.reset(), 0);\n            }\n        }\n    }\n    leave(type) {\n        if (this.chain.length > 0 && this.chain[this.chain.length - 1].type === type) {\n            this.chain.pop();\n            this.currentType = this.chain.length > 0 ? this.chain[this.chain.length - 1].type : null;\n        }\n    }\n    reset() {\n        this.currentType = null;\n        this.chain.length = 0;\n        this.timeout = null;\n    }\n}\n\nfunction test() {\n    let c = new CircularDependencyDetector();\n    c.enter('a');\n    c.enter('a');\n    c.enter('b');\n    c.enter('b');\n    c.leave('b');\n    c.leave('b');\n    c.enter('a');\n}\n\ntest();\n","let isClient = typeof window !== 'undefined';\nlet isServer = typeof module !== 'undefined';\n\n// In Electron app, both are true\n// if (isClient && isServer)\n// \tthrow new Error('Can not be client and server at the same time.');\n\nexport { isClient, isServer };\n","import Serializable from './serializable';\nimport { addChange, changeType, setChangeOrigin } from './change';\nimport assert from '../util/assert';\nimport * as performanceTool from '../util/performance';\nimport { PropertyType } from './propertyType';\nimport { GameEvent, globalEventDispatcher } from './eventDispatcher';\n\nlet gameChangesEnabled = true;\nlet sceneChangesEnabled = false;\nlet sceneChangeFilter: (prp: Property) => boolean = null;\n\nlet changesEnabled = false;\nlet scenePropertyFilter = null;\n// true / false to enable / disable property value change sharing.\n// if object is passed, changes are only sent\nexport function filterSceneChanges(_scenePropertyFilter) {\n\tscenePropertyFilter = _scenePropertyFilter;\n\tchangesEnabled = true;\n}\n\nexport function disableAllChanges() {\n\tchangesEnabled = false;\n}\n\nexport function enableAllChanges() {\n\tchangesEnabled = true;\n}\n\nexport function setPropertyChangeSettings(enableGameChanges: boolean, enableSceneChanges: boolean | ((prp: Property) => boolean)) {\n\tgameChangesEnabled = enableGameChanges\n\tsceneChangesEnabled = !!enableSceneChanges\n\tsceneChangeFilter = typeof enableSceneChanges === 'function' ? enableSceneChanges : null\n}\n\nexport function executeWithoutEntityPropertyChangeCreation(task) {\n\tlet oldChangesEnabled = changesEnabled;\n\tchangesEnabled = false;\n\ttask();\n\tchangesEnabled = oldChangesEnabled;\n}\n\n// Object of a property\nexport default class Property extends Serializable {\n\t_value: any;\n\t_initialValue: any;\n\tname: any;\n\tpropertyType: PropertyType;\n\t_initialValueIsJSON: boolean = false;\n\n\t// set skipSerializableRegistering=true if you are not planning to add this property to the hierarchy\n\t// if you give propertyType, value in real value form\n\t// if you don't give propertyType (give it later), value as JSON form\n\tconstructor({ value, predefinedId = '', name, propertyType = null, skipSerializableRegistering = false }) {\n\t\tsuper(predefinedId, skipSerializableRegistering);\n\t\tassert(name, 'Property without a name can not exist');\n\t\tthis._initialValue = value;\n\t\tif (propertyType)\n\t\t\tthis.setPropertyType(propertyType);\n\t\telse {\n\t\t\tthis.name = name;\n\t\t\tthis._initialValueIsJSON = true;\n\t\t}\n\t}\n\tmakeUpAName() {\n\t\treturn this.name;\n\t}\n\tsetPropertyType(propertyType) {\n\t\tthis.propertyType = propertyType;\n\t\ttry {\n\t\t\tif (this._initialValue !== undefined)\n\t\t\t\tthis.value = this._initialValueIsJSON ? propertyType.type.fromJSON(this._initialValue) : this._initialValue;\n\t\t\telse\n\t\t\t\tthis.value = propertyType.initialValue;\n\t\t} catch (e) {\n\t\t\tconsole.log('Invalid value', e, propertyType, this);\n\t\t\tthis.value = propertyType.initialValue;\n\t\t}\n\t\tthis.name = propertyType.name;\n\t}\n\tclone(skipSerializableRegistering = false) {\n\t\treturn new Property({\n\t\t\tvalue: this.propertyType.type.clone(this.value),\n\t\t\tname: this.name,\n\t\t\tpropertyType: this.propertyType,\n\t\t\tskipSerializableRegistering\n\t\t});\n\t}\n\ttoJSON() {\n\t\treturn Object.assign(super.toJSON(), {\n\t\t\tv: this.type.toJSON(this.value),\n\t\t\tn: this.propertyType.name\n\t\t});\n\t}\n\n\tvalueEquals(otherValue) {\n\t\treturn this.propertyType.type.equal(this._value, otherValue);\n\t}\n\n\tget type() {\n\t\treturn this.propertyType.type;\n\t}\n\n\tset value(newValue) {\n\t\tlet oldValue = this._value;\n\t\tthis._value = this.propertyType.validator.validate(newValue);\n\n\t\tthis.dispatch(GameEvent.PROPERTY_VALUE_CHANGE, this._value, oldValue);\n\t\tif (this._rootType === 'gam') {\n\t\t\tif (gameChangesEnabled) {\n\t\t\t\taddChange(changeType.setPropertyValue, this);\n\t\t\t}\n\t\t} else if (sceneChangesEnabled && (!sceneChangeFilter || sceneChangeFilter(this))) {\n\t\t\taddChange(changeType.setPropertyValue, this);\n\t\t}\n\t}\n\tget value() {\n\t\treturn this._value;\n\t}\n}\nProperty.prototype.propertyType = null;\n\nSerializable.registerSerializable(Property, 'prp', json => {\n\treturn new Property({\n\t\tvalue: json.v,\n\t\tpredefinedId: json.id,\n\t\tname: json.n\n\t});\n});\n\nObject.defineProperty(Property.prototype, 'debug', {\n\tget() {\n\t\treturn `prp ${this.name}=${this.value}`;\n\t}\n});\n","export default class Vector {\n\tx: number;\n\ty: number;\n\tconstructor(x: number, y: number) {\n\t\tthis.x = x || 0;\n\t\tthis.y = y || 0;\n\t}\n\tadd(vec: Vector) {\n\t\tthis.x += vec.x;\n\t\tthis.y += vec.y;\n\t\treturn this;\n\t}\n\taddScalars(x: number, y: number) {\n\t\tthis.x += x;\n\t\tthis.y += y;\n\t\treturn this;\n\t}\n\tsubtract(vec: Vector) {\n\t\tthis.x -= vec.x;\n\t\tthis.y -= vec.y;\n\t\treturn this;\n\t}\n\tsubtractScalars(x: number, y: number) {\n\t\tthis.x -= x;\n\t\tthis.y -= y;\n\t\treturn this;\n\t}\n\tmultiply(vec: Vector) {\n\t\tthis.x *= vec.x;\n\t\tthis.y *= vec.y;\n\t\treturn this;\n\t}\n\tmultiplyScalar(scalar: number) {\n\t\tthis.x *= scalar;\n\t\tthis.y *= scalar;\n\t\treturn this;\n\t}\n\tdivide(vec: Vector) {\n\t\tthis.x /= vec.x;\n\t\tthis.y /= vec.y;\n\t\treturn this;\n\t}\n\tdivideScalar(scalar: number) {\n\t\tthis.x /= scalar;\n\t\tthis.y /= scalar;\n\t\treturn this;\n\t}\n\tdot(vec: Vector) {\n\t\treturn this.x * vec.x + this.y * vec.y;\n\t}\n\tlength(): number {\n\t\treturn Math.sqrt(this.x * this.x + this.y * this.y);\n\t}\n\tlengthSq(): number {\n\t\treturn this.x * this.x + this.y * this.y;\n\t}\n\tsetLength(newLength: number) {\n\t\tlet oldLength = this.length();\n\n\t\tif (oldLength === 0) {\n\t\t\tthis.x = newLength;\n\t\t\tthis.y = 0;\n\t\t} else {\n\t\t\tthis.multiplyScalar(newLength / oldLength);\n\t\t}\n\t\treturn this;\n\t}\n\tgetProjectionOn(vec: Vector) {\n\t\tlet length = vec.length();\n\t\tif (length === 0)\n\t\t\treturn this.clone();\n\t\telse\n\t\t\treturn vec.clone().multiplyScalar(this.dot(vec) / (length * length));\n\t}\n\tdistance(vec: Vector) {\n\t\tlet dx = this.x - vec.x,\n\t\t\tdy = this.y - vec.y;\n\t\treturn Math.sqrt(dx * dx + dy * dy);\n\t}\n\tdistanceSq(vec: Vector) {\n\t\tlet dx = this.x - vec.x,\n\t\t\tdy = this.y - vec.y;\n\t\treturn dx * dx + dy * dy;\n\t}\n\t// returns 0 .. pi\n\tangleTo(vec: Vector) {\n\t\tlet lengthPart = this.length() * vec.length();\n\t\tif (lengthPart > 0) {\n\t\t\treturn Math.acos(this.dot(vec) / lengthPart);\n\t\t} else {\n\t\t\treturn 0;\n\t\t}\n\t}\n\t// returns 0 .. pi / 2\n\tclosestAngleTo(vec: Vector) {\n\t\tlet angle = Math.abs(this.angleTo(vec));\n\t\tif (angle > Math.PI * 0.5) {\n\t\t\treturn Math.abs(Math.PI - angle);\n\t\t} else {\n\t\t\treturn angle;\n\t\t}\n\t}\n\tnormalize() {\n\t\treturn this.setLength(1);\n\t}\n\thorizontalAngle() {\n\t\treturn Math.atan2(this.y, this.x);\n\t}\n\tverticalAngle() {\n\t\treturn Math.atan2(this.x, this.y);\n\t}\n\trotate(angle: number) {\n\t\tlet x = this.x * Math.cos(angle) - this.y * Math.sin(angle);\n\t\tthis.y = this.x * Math.sin(angle) + this.y * Math.cos(angle);\n\t\tthis.x = x;\n\n\t\treturn this;\n\t}\n\trotateTo(angle: number) {\n\t\treturn this.rotate(angle - this.verticalAngle());\n\t}\n\tisEqualTo(vec: Vector) {\n\t\treturn this.x === vec.x && this.y === vec.y;\n\t}\n\tisZero(): boolean {\n\t\treturn !this.x && !this.y;\n\t}\n\tclone(): Vector {\n\t\treturn new Vector(this.x, this.y);\n\t}\n\tset(vec: Vector) {\n\t\tthis.x = vec.x;\n\t\tthis.y = vec.y;\n\t\treturn this;\n\t}\n\tsetScalars(x: number, y: number) {\n\t\tthis.x = x;\n\t\tthis.y = y;\n\t\treturn this;\n\t}\n\ttoString(): string {\n\t\treturn `[${this.x}, ${this.y}]`;\n\t}\n\ttoArray(): Array<number> {\n\t\treturn [this.x, this.y];\n\t}\n\tinterpolateLinear(other: Vector, t: number): Vector {\n\t\treturn new Vector(this.x + (other.x - this.x) * t, this.y + (other.y - this.y) * t);\n\t}\n\tinterpolateCubic(other: Vector, control1: Vector, control2: Vector, t: number): Vector {\n\t\tlet t2 = 1 - t;\n\t\treturn new Vector(\n\t\t\tt2 ** 3 * this.x +\n\t\t\t3 * t2 * t2 * t * control1.x +\n\t\t\t3 * t2 * t * t * control2.x +\n\t\t\tt ** 3 * other.x,\n\t\t\tt2 ** 3 * this.y +\n\t\t\t3 * t2 * t2 * t * control1.y +\n\t\t\t3 * t2 * t * t * control2.y +\n\t\t\tt ** 3 * other.y);\n\t}\n\n\tstatic fromObject(obj: { x: number, y: number }) {\n\t\treturn new Vector(obj.x, obj.y);\n\t};\n\tstatic fromArray(obj) {\n\t\treturn new Vector(obj[0], obj[1]);\n\t};\n}\n","import Serializable from './serializable';\nimport assert from '../util/assert';\nimport { getSerializable } from './serializableManager';\nimport { PropertyType } from './propertyType';\nexport { default as Prop } from './propertyType';\nimport Property from './property';\n\nexport interface PropertyOwnerClass {\n\t_propertyTypes: Array<PropertyType>;\n\t_propertyTypesByName: { [s: string]: PropertyType };\n}\n\nexport default class PropertyOwner extends Serializable {\n\t_properties: { [name: string]: Property } = {};\n\t_propertyOwnerClass: PropertyOwnerClass; // use prototype's value\n\n\tconstructor(predefinedId?: string) {\n\t\tsuper(predefinedId);\n\t\tassert(Array.isArray(this._propertyOwnerClass._propertyTypes), 'call PropertyOwner.defineProperties after class definition');\n\t}\n\tmakeUpAName() {\n\t\treturn (this as any).name || 'PropertyOwner';\n\t}\n\t// Just a helper\n\tinitWithPropertyValues(values: { [key: string]: any } = {}) {\n\t\tlet children = [];\n\n\t\tObject.keys(values).forEach(propName => {\n\t\t\tlet propertyType = this._propertyOwnerClass._propertyTypesByName[propName];\n\t\t\tassert(propertyType, 'Invalid property ' + propName);\n\t\t\tchildren.push(propertyType.createProperty({\n\t\t\t\tvalue: values[propName]\n\t\t\t}));\n\t\t});\n\t\tthis.initWithChildren(children);\n\t\treturn this;\n\t}\n\tinitWithChildren(children: Array<Serializable> = []) {\n\t\tassert(!(this._state & Serializable.STATE_INIT), 'init already done');\n\t\tthis._state |= Serializable.STATE_INIT;\n\n\t\tlet propChildren: Array<Property> = [];\n\t\tlet otherChildren: Array<Serializable> = [];\n\t\t// Separate Property children and other children\n\t\tchildren.forEach(child => {\n\t\t\tif (child.threeLetterType === 'prp') {\n\t\t\t\tpropChildren.push(child as Property);\n\t\t\t} else {\n\t\t\t\totherChildren.push(child);\n\t\t\t}\n\t\t});\n\t\tsuper.addChildren(otherChildren);\n\n\t\tlet invalidPropertiesCount = 0;\n\n\t\tlet propertyIdToInvalid = {};\n\n\t\t// Make sure Properties have a PropertyType. They don't work without it.\n\t\tpropChildren.filter(prop => !prop.propertyType).forEach(prop => {\n\t\t\tlet propertyType = (this.constructor as any as PropertyOwnerClass)._propertyTypesByName[prop.name];\n\t\t\tif (!propertyType) {\n\t\t\t\tconsole.log('Property of that name not defined', this.id, prop.name, this);\n\t\t\t\tinvalidPropertiesCount++;\n\t\t\t\tpropertyIdToInvalid[prop.id] = true;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tprop.setPropertyType(propertyType);\n\t\t});\n\t\tif (invalidPropertiesCount)\n\t\t\tpropChildren = propChildren.filter(p => !propertyIdToInvalid[p.id]);\n\n\t\t// Make sure all PropertyTypes have a matching Property\n\t\tlet nameToProp = {};\n\t\tpropChildren.forEach(c => nameToProp[c.name] = c);\n\t\tthis._propertyOwnerClass._propertyTypes.forEach(propertyType => {\n\t\t\tif (!nameToProp[propertyType.name])\n\t\t\t\tpropChildren.push(propertyType.createProperty());\n\t\t});\n\n\t\tsuper.addChildren(propChildren);\n\t\treturn this;\n\t}\n\taddChild(child: Serializable): PropertyOwner {\n\t\tassert(this._state & Serializable.STATE_INIT, this.constructor + ' requires that initWithChildren will be called before addChild');\n\t\tsuper.addChild(child);\n\t\tif (child.threeLetterType === 'prp') {\n\t\t\tif (!(child as Property).propertyType) {\n\t\t\t\tif (!this._propertyOwnerClass._propertyTypesByName[(child as Property).name]) {\n\t\t\t\t\tconsole.log('Property of that name not defined', this.id, child, this);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t(child as Property).setPropertyType(this._propertyOwnerClass._propertyTypesByName[(child as Property).name]);\n\t\t\t}\n\t\t\tassert(this._properties[(child as Property).propertyType.name] === undefined, 'Property already added');\n\t\t\tthis._properties[(child as Property).propertyType.name] = (child as Property);\n\t\t}\n\t\treturn this;\n\t}\n\tcreatePropertyHash() {\n\t\treturn this.getChildren('prp').map(property => '' + (property as Property)._value).join(',');\n\t}\n\tdelete() {\n\t\tif (!super.delete()) return false;\n\t\tthis._properties = {};\n\t\treturn true;\n\t}\n\t// idx is optional\n\tdeleteChild(child: Serializable, idx?: number) {\n\t\tassert(child.threeLetterType !== 'prp', 'Can not delete just one Property child.');\n\t\tsuper.deleteChild(child, idx);\n\t\treturn this;\n\t}\n\n\tstatic defineProperties(Class: { new(...args): Serializable }, propertyTypes: Array<PropertyType>) {\n\t\tClass.prototype._propertyOwnerClass = Class;\n\t\tlet ClassAsTypeHolder = Class as any as PropertyOwnerClass;\n\t\t// debugger;\n\t\tif (!ClassAsTypeHolder._propertyTypes) {\n\t\t\tClassAsTypeHolder._propertyTypes = [];\n\t\t}\n\t\tClassAsTypeHolder._propertyTypes.push(...propertyTypes);\n\t\tClassAsTypeHolder._propertyTypesByName = {};\n\n\t\tClassAsTypeHolder._propertyTypes.forEach(propertyType => {\n\t\t\tconst propertyTypeName = propertyType.name;\n\t\t\tassert(!Class.prototype.hasOwnProperty(propertyTypeName), 'Property name ' + propertyTypeName + ' clashes');\n\t\t\tClassAsTypeHolder._propertyTypesByName[propertyTypeName] = propertyType;\n\t\t\tObject.defineProperty(Class.prototype, propertyTypeName, {\n\t\t\t\tget() {\n\t\t\t\t\tif (!this._properties[propertyTypeName])\n\t\t\t\t\t\tdebugger;\n\t\t\t\t\treturn this._properties[propertyTypeName].value;\n\t\t\t\t},\n\t\t\t\tset(value) {\n\t\t\t\t\tthis._properties[propertyTypeName].value = value;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n}\n","// @flow\n\nimport Serializable from './serializable'\nimport { addChange, changeType, getChangeOrigin } from './change';\nimport PropertyOwner, { Prop } from './propertyOwner';\nimport {stickyNonModalErrorPopup} from '../util/popup'\nimport '../modules';\nimport { globalEventDispatcher, GameEvent } from './eventDispatcher';\n\nconsole.log('%cOpen Edit Play', 'color: #666; font-size: 16px; text-shadow: 0px 0px 1px #777;');\n\nlet propertyTypes = [\n\tProp('name', 'No name', Prop.string)\n];\n\nlet game: Game = null; // only one game at the time\nexport { game };\n\nlet isClient = typeof window !== 'undefined';\n\nexport default class Game extends PropertyOwner {\n\tconstructor(predefinedId?: string) {\n\t\tif (game)\n\t\t\tconsole.error('Only one game allowed.');\n\n\t\t/*\n\t\tif (isClient) {\n\t\t\tif (game) {\n\t\t\t\ttry {\n\t\t\t\t\tgame.delete();\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.warn('Deleting old game failed', e);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t*/\n\n\t\tsuper(predefinedId);\n\n\t\tif (isClient) {\n\t\t\tgame = this;\n\t\t}\n\t}\n\tinitWithChildren(children: Array<Serializable> = []) {\n\t\tlet val = super.initWithChildren(children);\n\t\taddChange(changeType.addSerializableToTree, this);\n\t\treturn val;\n\t}\n\tdelete() {\n\t\taddChange(changeType.deleteSerializable, this);\n\t\tif (!super.delete()) return false;\n\n\t\tif (game === this)\n\t\t\tgame = null;\n\n\t\tstickyNonModalErrorPopup('Game deleted');\n\n\t\treturn true;\n\t}\n}\nPropertyOwner.defineProperties(Game, propertyTypes);\n\nGame.prototype.isRoot = true;\n\n/*\n// Export so that other components can have this component as parent\nComponent.register({\n\tname: 'GameProperties',\n\tdescription: 'Contains all game specific settings',\n\tcategory: 'MainProperties',\n\tallowMultiple: false,\n\tproperties: [\n\t\tProp('gameProperty1', 3, Prop.float, Prop.float.range(0.01, 1000))\n\t]\n});\n*/\n\nSerializable.registerSerializable(Game, 'gam', json => {\n\tif (json.c) {\n\t\tjson.c.sort((a, b) => {\n\t\t\tif (a.id.startsWith('prt') || a.id.startsWith('pfa'))\n\t\t\t\treturn -1;\n\t\t\telse\n\t\t\t\treturn 1;\n\t\t});\n\t}\n\treturn new Game(json.id);\n});\n\nlet gameCreateListeners = [];\nexport function forEachGame(listener: (game: Game) => void) {\n\tglobalEventDispatcher.listen(GameEvent.GLOBAL_GAME_CREATED, listener);\n\n\tif (game)\n\t\tlistener(game);\n}\n","import EventDispatcher, { GameEvent, ListenerFunction } from \"../core/eventDispatcher\";\n\nexport enum EditorEvent {\n    EDITOR_CHANGE = 'editor change',\n    EDITOR_REGISTER_MODULES = 'registerModules', // parameters(editor)\n    EDITOR_SCENE_TOOL_CHANGED = 'scene tool changed', // parameters(editor)\n    EDITOR_REGISTER_HELP_VARIABLE = 'define help variable', // parameters(name, value)\n    EDITOR_DELETE_CONFIRMATION = 'delete confirmation', // handlerCallback return true|false|Promise wether deletion should succeed.\n    EDITOR_PRE_DELETE_SELECTION = 'pre delete selection',\n    EDITOR_LOADED = 'editor loaded',\n    EDITOR_RESET = 'reset',\n    EDITOR_FORCE_UPDATE = 'editor force update',\n    EDITOR_UNFOCUS = 'editor unfocus',\n    EDITOR_PLAY = 'play',\n    EDITOR_PAUSE = 'pause',\n    EDITOR_CLONE = 'clone',\n    EDITOR_DELETE = 'delete',\n    EDITOR_DRAW_NEEDED = 'draw needed',\n    EDITOR_SCENE_MODE_CHANGED = 'scene mode change' // mode just turned on. get state from editorGlobals.recording\n};\n\n// Wrapper that takes only EditorEvents\nclass EditorEventDispatcher {\n    dispatcher: EventDispatcher = new EventDispatcher();\n\n    // priority should be a whole number between -100000 and 100000. a smaller priority number means that it will be executed first.\n    listen(event: EditorEvent | string, callback: ListenerFunction, priority = 0) {\n        return this.dispatcher.listen(event as any as GameEvent, callback, priority);\n    }\n    dispatch(event: EditorEvent | string, a?, b?, c?) {\n        this.dispatcher.dispatch(event as any as GameEvent, a, b, c);\n    }\n    dispatchWithResults(event: EditorEvent | string, a?, b?, c?) {\n        return this.dispatcher.dispatchWithResults(event as any as GameEvent, a, b, c);\n    }\n    getEventPromise(event: EditorEvent | string) {\n\t\treturn new Promise(function(res) {\n\t\t\teditorEventDispacher.listen(event, res);\n\t\t});\n\t}\n}\n\nexport let editorEventDispacher = new EditorEventDispatcher();\neditorEventDispacher.dispatcher['editorEventDispatcher'] = true; // for debugging\n","import Serializable from './serializable';\nimport Entity from './entity';\nimport assert from '../util/assert';\nimport PropertyOwner from './propertyOwner';\nimport Scene, { scene } from './scene';\nimport Game, { game } from './game';\nexport { default as Prop } from './propertyType';\nexport let componentClasses: Map<string, typeof Component> = new Map();\nimport * as performance from '../util/performance';\nimport { PropertyType } from './propertyType';\nimport { GameEvent } from './eventDispatcher';\n\nconst automaticSceneEventListeners = {\n\tonUpdate: 'onUpdate',\n\tonStart: GameEvent.SCENE_START\n};\n\n// Object of a component, see _componentExample.js\nexport class Component extends PropertyOwner {\n\t_componentId: string;\n\tscene: Scene;\n\tgame: Game;\n\t_listenRemoveFunctions: Array<() => void>;\n\tentity: Entity;\n\tcomponentClass: typeof Component;\n\tcomponentName: string;\n\tTransform: Component;\n\t[s: string]: any; // Suppress all errors. Components will have many custom parameters.\n\n\tstatic componentName: string;\n\tstatic category: string;\n\tstatic requirements: Array<string>;\n\tstatic children: Array<any>;\n\tstatic description: string;\n\tstatic allowMultiple: boolean;\n\tstatic icon: string;\n\tstatic color: string;\n\n\tstatic _propertyTypes: Array<PropertyType>;\n\tstatic _propertyTypesByName: { [s: string]: PropertyType };\n\n\tconstructor(predefinedId?: string) {\n\t\tsuper(predefinedId);\n\t\tthis._componentId = null; // Creator will fill this\n\t\tthis.scene = scene;\n\t\tthis.game = game;\n\t\tthis._listenRemoveFunctions = [];\n\t\tthis.entity = null;\n\t}\n\tmakeUpAName() {\n\t\treturn this.componentClass.componentName;\n\t}\n\tclone() {\n\t\tlet component = super.clone() as any as Component;\n\t\tcomponent._componentId = this._componentId;\n\t\treturn component;\n\t}\n\tdelete() {\n\t\t// Component.delete never returns false because entity doesn't have components as children\n\t\tthis._parent = null;\n\t\tthis.entity = null;\n\t\tsuper.delete();\n\t\treturn true;\n\t}\n\t_addEventListener(functionName: string, eventName?: GameEvent) {\n\t\tif (!eventName)\n\t\t\teventName = functionName as GameEvent;\n\n\t\tlet func = this[functionName];\n\t\tlet self = this;\n\t\tlet performanceName = 'Component: ' + this.componentClass.componentName;\n\t\tthis._listenRemoveFunctions.push(this.scene.listen(eventName, function () {\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tperformance.start(performanceName);\n\t\t\t// @endif\n\n\t\t\tfunc.apply(self, arguments);\n\n\t\t\t// @ifndef OPTIMIZE\n\t\t\tperformance.stop(performanceName);\n\t\t\t// @endif\n\t\t}));\n\t}\n\t// In preInit you can init the component with stuff that other components might want to use in init function\n\t// In preInit you can not trust that other components have been inited in any way\n\t_preInit() {\n\t\tthis.componentClass.requirements.forEach(r => {\n\t\t\tthis[r] = this.entity.getComponent(r);\n\t\t\tassert(this[r], this.componentClass.componentName + ` requires component ` + r + ` but it is not found`);\n\t\t});\n\n\t\tthis.forEachChild('com', (c: Component) => c._preInit());\n\n\t\tfor (let key in automaticSceneEventListeners) {\n\t\t\tif (typeof this[key] === 'function') {\n\t\t\t\tthis._addEventListener(key, automaticSceneEventListeners[key]);\n\t\t\t}\n\t\t}\n\t\t/*\n\t\tfor (let i = 0; i < Object.keys(automaticSceneEventListeners).length; ++i) {\n\t\t\tif (typeof this[automaticSceneEventListeners[i]] === 'function') {\n\t\t\t\tthis._addEventListener(automaticSceneEventListeners[i]);\n\t\t\t}\n\t\t}\n\t\t*/\n\n\t\tif (this.componentClass.componentName !== 'Transform' && this.scene)\n\t\t\tthis.scene.addComponent(this);\n\n\t\ttry {\n\t\t\tif (typeof (this as ComponentRegisterPrototype).preInit === 'function')\n\t\t\t\t(this as ComponentRegisterPrototype).preInit();\n\t\t} catch (e) {\n\t\t\tconsole.error(this.entity, this.componentClass.componentName, 'preInit', e);\n\t\t}\n\t}\n\t// In preInit you can access other components and know that their preInit is done.\n\t_init() {\n\t\tthis.forEachChild('com', (c: Component) => c._init());\n\t\ttry {\n\t\t\tif (typeof (this as ComponentRegisterPrototype).init === 'function')\n\t\t\t\t(this as ComponentRegisterPrototype).init();\n\t\t} catch (e) {\n\t\t\tconsole.error(this.entity, this.componentClass.componentName, 'init', e);\n\t\t}\n\t}\n\t_sleep() {\n\t\ttry {\n\t\t\tif (typeof (this as ComponentRegisterPrototype).sleep === 'function')\n\t\t\t\t(this as ComponentRegisterPrototype).sleep();\n\t\t} catch (e) {\n\t\t\tconsole.error(this.entity, this.componentClass.componentName, 'sleep', e);\n\t\t}\n\n\t\tif (this.componentClass.componentName !== 'Transform' && this.scene)\n\t\t\tthis.scene.removeComponent(this);\n\n\t\tthis.forEachChild('com', (c: Component) => c._sleep());\n\n\t\tthis._listenRemoveFunctions.forEach(f => f());\n\t\tthis._listenRemoveFunctions.length = 0;\n\t}\n\tlistenProperty(component: Component, propertyName: string, callback: Function) {\n\t\t// @ifndef OPTIMIZE\n\t\tassert(component, 'listenProperty called without a component');\n\t\t// @endif\n\t\tthis._listenRemoveFunctions.push(component._properties[propertyName].listen(GameEvent.PROPERTY_VALUE_CHANGE, callback));\n\t}\n\tremoveListenerOnSleep(listenerFunction: () => void) {\n\t\tassert(!this.entity.sleeping, 'Cannot call removeListenerOnSleep in sleep mode.');\n\t\tthis._listenRemoveFunctions.push(listenerFunction);\n\t}\n\ttoJSON() {\n\t\treturn Object.assign(super.toJSON(), {\n\t\t\tn: this.componentClass.componentName,\n\t\t\tcid: this._componentId\n\t\t});\n\t}\n\n\tstatic create(name: string, values = {}) {\n\t\tlet componentClass = componentClasses.get(name);\n\t\tassert(componentClass);\n\t\tlet component = new componentClass();\n\t\tcomponent.initWithPropertyValues(values);\n\t\treturn component;\n\t};\n\tstatic createWithInheritedComponentData(inheritedComponentData) {\n\t\tlet component = new inheritedComponentData.componentClass as Component;\n\t\tcomponent._componentId = inheritedComponentData.componentId;\n\t\tlet properties = inheritedComponentData.properties.map(p => p.clone());\n\t\tcomponent.initWithChildren(properties);\n\t\treturn component;\n\t};\n\n\tstatic reservedPropertyNames = new Set(['id', 'constructor', 'delete', 'children', 'entity', 'env', 'init', 'preInit', 'sleep', 'toJSON', 'fromJSON']);\n\tstatic reservedPrototypeMembers = new Set(['id', 'children', 'entity', 'env', '_preInit', '_init', '_sleep', '_forEachChildComponent', '_properties', '_componentData', 'toJSON', 'fromJSON']);\n\tstatic register({\n\t\tname = '', // required\n\t\tdescription = '',\n\t\tcategory = 'Other',\n\t\ticon = 'fa-puzzle-piece', // in editor\n\t\tcolor = '', // in editor\n\t\tproperties = [],\n\t\trequirements = ['Transform'],\n\t\tchildren = [],\n\t\tparentClass = Component,\n\t\tprototype = {},\n\t\tallowMultiple = true,\n\t\trequiresInitWhenEntityIsEdited = false\n\t}: ComponentRegisterOptions = {}) {\n\t\tassert(name, 'Component must have a name.');\n\t\tassert(name[0] >= 'A' && name[0] <= 'Z', 'Component name must start with capital letter.');\n\t\tassert(!componentClasses.has(name), 'Duplicate component class ' + name);\n\t\tObject.keys(prototype).forEach(k => {\n\t\t\tif (Component.reservedPrototypeMembers.has(k))\n\t\t\t\tassert(false, 'Component prototype can not have a reserved member: ' + k);\n\t\t});\n\n\t\tif (requirements.indexOf('Transform') < 0) requirements.push('Transform');\n\t\tlet colorNum = name.split('').reduce((prev, curr) => prev + curr.charCodeAt(0), 0);\n\n\t\tlet constructorFunction = prototype.constructor;\n\t\tlet deleteFunction = prototype.delete;\n\t\tdelete prototype.constructor;\n\t\tdelete prototype.delete;\n\t\tclass Com extends parentClass {\n\t\t\tconstructor(...args) {\n\t\t\t\tsuper(...args);\n\t\t\t\tif (constructorFunction)\n\t\t\t\t\tconstructorFunction.call(this);\n\t\t\t}\n\t\t\tdelete() {\n\t\t\t\tif (!super.delete()) return false;\n\n\t\t\t\tif (deleteFunction)\n\t\t\t\t\tdeleteFunction.call(this);\n\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tstatic componentName = name;\n\t\t\tstatic category = category;\n\t\t\tstatic requirements = requirements;\n\t\t\tstatic children = children;\n\t\t\tstatic description = description;\n\t\t\tstatic allowMultiple = allowMultiple;\n\t\t\tstatic icon = icon;\n\t\t\tstatic color = color || `hsla(${colorNum % 360}, 40%, 60%, 1)`;\n\t\t\tcomponentClass: typeof Component;\n\t\t}\n\t\tproperties.forEach(p => {\n\t\t\tassert(!Component.reservedPropertyNames.has(p.name), 'Can not have property called ' + p.name);\n\t\t});\n\t\tPropertyOwner.defineProperties(Com, properties); // properties means propertyTypes here\n\n\t\tprototype._name = name;\n\t\tCom.prototype.componentClass = Com;\n\t\tObject.assign(Com.prototype, prototype);\n\t\tcomponentClasses.set(Com.componentName, Com);\n\t\treturn Com;\n\t};\n}\n\ninterface ComponentRegisterPrototype {\n\tconstructor?: Function,\n\tdelete?: () => void,\n\t_name?: string,\n\tpreInit?: () => void,\n\tinit?: () => void,\n\tsleep?: () => void,\n\t[others: string]: any\n};\n\ntype ComponentRegisterOptions = {\n\tname?: string,\n\tdescription?: string,\n\tcategory?: string,\n\ticon?: string,\n\tcolor?: string,\n\tproperties?: Array<any>,\n\trequirements?: Array<string>,\n\tchildren?: Array<any>,\n\tparentClass?: typeof Component,\n\tprototype?: ComponentRegisterPrototype,\n\tallowMultiple?: boolean,\n\trequiresInitWhenEntityIsEdited?: boolean\n};\n\nSerializable.registerSerializable(Component, 'com', json => {\n\tlet component = <Component>new (componentClasses.get(json.n))(json.id);\n\tcomponent._componentId = json.cid || null;\n\treturn component;\n});\n","import Serializable, { createStringId } from './serializable';\nimport assert from '../util/assert';\nimport { componentClasses, Component } from './component';\nimport { isClient } from '../util/environment';\nimport Property from './property';\nimport { PropertyOwnerClass } from './propertyOwner';\nimport Prototype from './prototype';\n\nexport default class ComponentData extends Serializable {\n\tname: string;\n\tcomponentClass: typeof Component & PropertyOwnerClass;\n\tcomponentId: string;\n\n\tconstructor(componentClassName, predefinedId?, predefinedComponentId: string = '') {\n\t\tsuper(predefinedId);\n\t\tthis.name = componentClassName;\n\t\tthis.componentClass = componentClasses.get(this.name);\n\t\tassert(this.componentClass, 'Component class not defined: ' + componentClassName);\n\t\tif (!this.componentClass.allowMultiple)\n\t\t\tpredefinedComponentId = '_' + componentClassName;\n\t\tthis.componentId = predefinedComponentId || createStringId('cid', 10); // what will be the id of component created from this componentData\n\t}\n\tmakeUpAName() {\n\t\treturn this.name;\n\t}\n\taddChild(child) {\n\t\tif (child.threeLetterType === 'prp') {\n\t\t\tif (!child.propertyType) {\n\t\t\t\tif (!this.componentClass._propertyTypesByName[child.name]) {\n\t\t\t\t\tif (isClient)\n\t\t\t\t\t\tconsole.log('Property of that name not defined', this.id, child, this);\n\t\t\t\t\telse\n\t\t\t\t\t\tconsole.log('Property of that name not defined', this.id, this.name, child.name);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tchild.setPropertyType(this.componentClass._propertyTypesByName[child.name]);\n\t\t\t}\n\t\t}\n\t\tsuper.addChild(child);\n\t\treturn this as Serializable;\n\t}\n\tclone(options?) {\n\t\tlet newComponentId = (options && options.cloneComponentId) ? this.componentId : '';\n\t\tlet obj = new ComponentData(this.name, false, newComponentId);\n\t\tlet children = [];\n\t\tthis.forEachChild(null, child => {\n\t\t\tchildren.push(child.clone());\n\t\t});\n\t\tobj.initWithChildren(children);\n\t\tthis._state |= Serializable.STATE_CLONE;\n\t\treturn obj as Serializable;\n\t}\n\ttoJSON() {\n\t\treturn Object.assign(super.toJSON(), {\n\t\t\tcid: this.componentId,\n\t\t\tn: this.name\n\t\t});\n\t}\n\t/*\n\tReturns a list of Properties.\n\tThose which don't have an id are temporary properties generated from parents.\n\tDon't set _depth.\n\t */\n\tgetInheritedProperties(_depth = 0) {\n\t\tlet properties = {};\n\n\t\t// properties from parent\n\t\tlet parentComponentData = this.getParentComponentData();\n\t\tif (parentComponentData)\n\t\t\tparentComponentData.getInheritedProperties(_depth + 1).forEach(prop => properties[prop.name] = prop);\n\n\t\t// properties from this. override properties of parents\n\t\tthis.getChildren('prp').forEach((prop: Property) => {\n\t\t\tif (_depth === 0)\n\t\t\t\tproperties[prop.name] = prop;\n\t\t\telse\n\t\t\t\tproperties[prop.name] = prop.clone(true);\n\t\t});\n\n\t\t// fill from propertyType\n\t\tif (_depth === 0) {\n\t\t\treturn this.componentClass._propertyTypes.map(propertyType => {\n\t\t\t\treturn properties[propertyType.name] || propertyType.createProperty({\n\t\t\t\t\tskipSerializableRegistering: true\n\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\treturn Object.keys(properties).map(key => properties[key]);\n\t\t}\n\t}\n\tgetParentComponentData() {\n\t\tif (!this._parent) return null;\n\t\tlet parentPrototype = (this._parent as Prototype).getParentPrototype() as Prototype;\n\t\twhile (parentPrototype) {\n\t\t\tlet parentComponentData = parentPrototype.findChild('cda', (componentData: ComponentData) => componentData.componentId === this.componentId);\n\t\t\tif (parentComponentData)\n\t\t\t\treturn parentComponentData;\n\t\t\telse\n\t\t\t\tparentPrototype = parentPrototype.getParentPrototype() as Prototype;\n\t\t}\n\t\treturn null;\n\t}\n\tgetPropertyOrCreate(name) {\n\t\tlet property = this.findChild('prp', (prp: Property) => prp.name === name);\n\t\tif (!property) {\n\t\t\tproperty = this.componentClass._propertyTypesByName[name].createProperty();\n\t\t\tthis.addChild(property);\n\t\t}\n\t\treturn property;\n\t}\n\tgetProperty(name) {\n\t\treturn this.findChild('prp', prp => (prp as Property).name === name);\n\t}\n\tsetValue(propertyName, value) {\n\t\tthis.getPropertyOrCreate(propertyName).value = value;\n\t\treturn this;\n\t}\n\tgetValue(name) {\n\t\tlet property = this.getProperty(name);\n\t\tif (property)\n\t\t\treturn property.value;\n\t\tlet parent = this.getParentComponentData();\n\n\t\tif (parent)\n\t\t\treturn parent.getValue(name);\n\n\t\treturn this.componentClass._propertyTypesByName[name].initialValue;\n\t}\n\tcreateComponent() {\n\t\tlet properties = this.getInheritedProperties();\n\t\tlet values = {};\n\t\tproperties.forEach(prop => {\n\t\t\tvalues[prop.name] = prop.value;\n\t\t});\n\t\tlet component = Component.create(this.name, values);\n\t\tcomponent._componentId = this.componentId;\n\t\treturn component;\n\t}\n}\nSerializable.registerSerializable(ComponentData, 'cda', json => {\n\treturn new ComponentData(json.n, json.id, json.cid);\n});\n\n\n/*\n\nFrom Component? Is this needed?\n\n\tcreateComponentData() {\n\t\tlet componentName = this.componentClass.componentName;\n\t\tlet propertyTypes = this.class._propertyTypes;\n\t\tlet componentData = new ComponentData(componentName);\n\t\tlet children = [];\n\t\tpropertyTypes.forEach(pt => {\n\t\t\tchildren.push(pt.createProperty({\n\t\t\t\tvalue: this[pt.name]\n\t\t\t}));\n\t\t});\n\t\tcomponentData.initWithChildren(children);\n\t\treturn componentData;\n\t}\n\n*/\n","import Serializable from './serializable';\nimport assert from '../util/assert';\nimport * as performanceTool from '../util/performance';\nimport Prototype, { InheritedComponentData } from './prototype';\nimport { Component } from './component';\nimport { getSerializable } from './serializableManager';\nimport Property from './property';\nimport EntityPrototype from './entityPrototype';\n\nconst ALIVE_ERROR = 'entity is already dead';\n\nexport default class Entity extends Serializable {\n\tcomponents: Map<string, Array<Component>>;\n\tsleeping: boolean;\n\tprototype: EntityPrototype;\n\tlocalMaster: boolean;\n\n\tstatic ENTITY_CREATION_DEBUGGING = false;\n\n\tconstructor(predefinedId?) {\n\t\tsuper(predefinedId);\n\t\tthis.components = new Map(); // name -> array\n\t\tthis.sleeping = false;\n\t\tthis.prototype = null; // should be set immediately after constructor\n\t\tthis.localMaster = true; // set false if entity is controlled over the net\n\n\t\tperformanceTool.eventHappened('Create object');\n\t}\n\n\tmakeUpAName() {\n\t\tif (this.prototype) {\n\t\t\treturn this.prototype.makeUpAName();\n\t\t} else {\n\t\t\treturn 'Entity';\n\t\t}\n\t}\n\n\t// Get the first component of given name\n\tgetComponent(name) {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tlet components = this.components.get(name);\n\t\tif (components !== undefined)\n\t\t\treturn components[0];\n\t\telse\n\t\t\treturn null;\n\t}\n\n\t// Get all components with given name\n\tgetComponents(name) {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\treturn this.components.get(name) || [];\n\t}\n\n\tgetListOfAllComponents() {\n\t\tlet components = [];\n\t\tthis.components.forEach((value, key) => {\n\t\t\tcomponents.push(...value);\n\t\t});\n\t\treturn components;\n\t}\n\n\tclone(parent: Serializable = null) {\n\t\tlet entity = new Entity();\n\t\tentity.prototype = this.prototype.clone() as EntityPrototype;\n\t\tentity.sleeping = this.sleeping;\n\n\t\tlet components = [];\n\t\tthis.components.forEach((value, key) => {\n\t\t\tcomponents.push(...value.map(c => c.clone()));\n\t\t});\n\t\tentity.addComponents(components, { fullInit: false });\n\n\t\tif (parent) {\n\t\t\tparent.addChild(entity);\n\t\t}\n\n\t\tlet children = [];\n\t\tthis.forEachChild('ent', (ent: Entity) => {\n\t\t\tchildren.push(ent.clone(entity));\n\t\t});\n\t\tif (!entity.sleeping) {\n\t\t\tEntity.initComponents(components);\n\t\t}\n\t\treturn entity;\n\t}\n\n\t/*\n\tAdds multiple components as an array to this Entity.\n\tInitializes components after all components are added.\n\t*/\n\taddComponents(components, { fullInit = true } = {}) {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tassert(Array.isArray(components), 'Parameter is not an array.');\n\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('add components for', this.makeUpAName());\n\n\t\tfor (let i = 0; i < components.length; i++) {\n\t\t\tlet component = components[i];\n\t\t\tlet componentList = this.components.get(component._name) || this.components.set(component._name, []).get(component._name);\n\t\t\tcomponentList.push(component);\n\t\t\tcomponent.entity = this;\n\t\t\tcomponent._parent = this;\n\t\t\tcomponent.setRootType(this._rootType);\n\t\t}\n\n\t\tif (!this.sleeping) {\n\t\t\tEntity.preInitComponents(components);\n\t\t\tif (fullInit)\n\t\t\t\tEntity.initComponents(components);\n\t\t}\n\t\treturn this;\n\t}\n\n\tstatic preInitComponents(components) {\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('preInit components for', components[0].entity.makeUpAName());\n\t\tfor (let i = 0; i < components.length; i++) {\n\t\t\tassert(!components[i].entity.sleeping, 'entity can not be sleeping when pre initing components');\n\t\t\tcomponents[i]._preInit();\n\t\t}\n\t}\n\n\tstatic initComponents(components) {\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log(`init ${components.length} components for`, components[0].entity.makeUpAName());\n\t\tfor (let i = 0; i < components.length; i++) {\n\t\t\tassert(!components[i].entity.sleeping, 'entity can not be sleeping when initing components');\n\t\t\tcomponents[i]._init();\n\t\t}\n\t}\n\n\tstatic makeComponentsSleep(components) {\n\t\tfor (let i = 0; i < components.length; i++)\n\t\t\tcomponents[i]._sleep();\n\t}\n\n\tstatic deleteComponents(components) {\n\t\tfor (let i = 0; i < components.length; i++)\n\t\t\tcomponents[i].delete();\n\t}\n\n\tsleep() {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tif (this.sleeping) return false;\n\n\t\tthis.components.forEach((value, key) => Entity.makeComponentsSleep(value));\n\n\t\tthis.forEachChild('ent', (entity: Entity) => entity.sleep());\n\n\t\tthis.sleeping = true;\n\t\treturn true;\n\t}\n\n\twakeUp() {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tif (!this.sleeping) return false;\n\t\tthis.sleeping = false;\n\n\t\tthis.components.forEach((value, key) => Entity.preInitComponents(value));\n\t\tthis.components.forEach((value, key) => Entity.initComponents(value));\n\n\t\tthis.forEachChild('ent', (entity: Entity) => entity.wakeUp());\n\n\t\treturn true;\n\t}\n\n\tresetComponents() {\n\n\t\tlet inheritedComponentDatas = this.prototype.getInheritedComponentDatas();\n\n\t\tinheritedComponentDatas.forEach((icd: InheritedComponentData) => {\n\t\t\tlet component = this.getComponents(icd.componentClass.componentName).find((comp: Component) => comp._componentId === icd.componentId);\n\t\t\ticd.properties.forEach((prop: Property) => {\n\t\t\t\tif (!component._properties[prop.name].valueEquals(prop.value)) {\n\t\t\t\t\tcomponent[prop.name] = prop.value;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\t// debugger; // TODO: do stuff with inheritedComponentDatas\n\n\t\tthis.forEachChild('ent', (ent: Entity) => ent.resetComponents());\n\t}\n\n\tdelete() {\n\t\tassert(this._alive, ALIVE_ERROR);\n\t\tthis.sleep();\n\t\tif (!super.delete()) return false;\n\n\t\tthis.components.forEach((value, key) => Entity.deleteComponents(value));\n\t\tthis.components.clear();\n\n\t\tperformanceTool.eventHappened('Destroy object');\n\n\t\treturn true;\n\t}\n\n\tdeleteComponent(component) {\n\t\tlet array = this.getComponents(component.constructor.componentName);\n\t\tlet idx = array.indexOf(component);\n\t\tassert(idx >= 0);\n\t\tif (!this.sleeping)\n\t\t\tcomponent._sleep();\n\t\tcomponent.delete();\n\t\tarray.splice(idx, 1);\n\t\treturn this;\n\t}\n\n\tsetRootType(rootType) {\n\t\tif (this._rootType === rootType)\n\t\t\treturn;\n\n\t\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('entity added to tree', this.makeUpAName());\n\n\t\tsuper.setRootType(rootType);\n\n\t\tlet i;\n\t\tthis.components.forEach((value, key) => {\n\t\t\tfor (i = 0; i < value.length; ++i) {\n\t\t\t\tvalue[i].setRootType(rootType);\n\t\t\t}\n\t\t});\n\t}\n\n\ttoJSON() {\n\t\tassert(this._alive, ALIVE_ERROR);\n\n\t\tlet components = [];\n\t\tthis.components.forEach(compArray => {\n\t\t\tcompArray.forEach(comp => {\n\t\t\t\tcomponents.push(comp.toJSON());\n\t\t\t});\n\t\t});\n\n\t\treturn Object.assign(super.toJSON(), {\n\t\t\tc: components, // overwrite children. earlier this was named 'comp'\n\t\t\tproto: this.prototype.id\n\t\t});\n\t}\n\tget position() {\n\t\treturn this.getComponent('Transform').position;\n\t}\n\tset position(position) {\n\t\tthis.getComponent('Transform').position = position;\n\t}\n\tget Transform() {\n\t\treturn this.getComponent('Transform');\n\t}\n}\n\nSerializable.registerSerializable(Entity, 'ent', json => {\n\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('creating entity from json', json);\n\tlet entity = new Entity(json.id);\n\tentity.prototype = getSerializable(json.proto);\n\tif (Entity.ENTITY_CREATION_DEBUGGING) console.log('created entity from json', entity);\n\tif (json.comp) {\n\t\tentity.addComponents((json.c || json.comp).map(Serializable.fromJSON));\n\t}\n\treturn entity;\n});\n\n","import Prototype from './prototype';\nimport Property from './property';\nimport Serializable from './serializable';\nimport ComponentData from './componentData';\nimport assert from '../util/assert';\nimport EntityPrototype, { createEntityPrototypeNameProperty, createEntityPrototypeTransform } from \"./entityPrototype\";\n\n// Prefab is an EntityPrototype that has been saved to a prefab.\nexport default class Prefab extends Prototype {\n\tconstructor(predefinedId?: string, siblingId?: string) {\n\t\tsuper(predefinedId, siblingId);\n\t}\n\n\tmakeUpAName() {\n\t\tlet nameProperty = this.findChild('prp', (property: Property) => property.name === 'name');\n\t\treturn nameProperty && nameProperty.value || 'Prefab';\n\t}\n\n\tcreateEntity() {\n\t\treturn this.createEntityPrototype().createEntity();\n\t}\n\n\tgetParentPrototype() {\n\t\treturn null;\n\t}\n\t// Meant for entityPrototypes, but works theoretically for prototypes\n\tstatic createFromPrototype(prototype: Prototype) {\n\t\tlet inheritedComponentDatas = prototype.getInheritedComponentDatas();\n\t\tlet children: Array<Serializable> = inheritedComponentDatas.map(icd => {\n\t\t\tconst cda = new ComponentData(icd.componentClass.componentName, null, icd.componentId)\n\t\t\tcda.initWithChildren(icd.properties.map(prp => prp.clone()))\n\t\t\treturn cda\n\t\t}) as any as Array<Serializable>;\n\n\t\tchildren.push(prototype._properties.name.clone());\n\n\t\tprototype.forEachChild('epr', (childEntityPrototype: EntityPrototype) => {\n\t\t\tlet prefab = Prefab.createFromPrototype(childEntityPrototype);\n\t\t\tchildren.push(prefab);\n\t\t});\n\n\t\tlet prefab = new Prefab(null, prototype.siblingId).initWithChildren(children);\n\n\t\t// Don't just prototype.makeUpAName() because it might give you \"Prototype\" or \"EntityPrototype\". Checking them would be a hack.\n\t\tprefab.name = prototype.name || prototype.prototype && prototype.prototype.makeUpAName() || 'Prefab';\n\n\t\treturn prefab;\n\t}\n\n\tcreateEntityPrototype() {\n\t\tlet entityPrototype = new EntityPrototype(null, this.siblingId);\n\t\tentityPrototype.prototype = this;\n\t\tlet id = entityPrototype.id;\n\n\t\tlet prototypeTransform = this.findChild('cda', (cda: ComponentData) => cda.name === 'Transform');\n\n\t\tif (!prototypeTransform)\n\t\t\tassert(false, 'Prefab (pfa) must have a Transform component');\n\n\t\tlet name = createEntityPrototypeNameProperty(id);\n\t\tlet transform = createEntityPrototypeTransform(id);\n\n\t\ttransform.setValue('position', prototypeTransform.getValue('position'));\n\t\ttransform.setValue('scale', prototypeTransform.getValue('scale'));\n\t\ttransform.setValue('angle', prototypeTransform.getValue('angle'));\n\n\t\tlet children: Serializable[] = [name, transform];\n\n\t\tthis.forEachChild('pfa', (pfa: Prefab) => {\n\t\t\tlet childEntityPrototype = pfa.createEntityPrototype();\n\t\t\tchildren.push(childEntityPrototype);\n\t\t});\n\n\t\tentityPrototype.initWithChildren(children);\n\n\t\t/*\n\t\t\t\tlet inheritedComponentDatas = this.getInheritedComponentDatas();\n\t\t\t\tlet children: Array<Serializable> = inheritedComponentDatas.map(icd => {\n\t\t\t\t\treturn new ComponentData(icd.componentClass.componentName, null, icd.componentId)\n\t\t\t\t\t\t.initWithChildren(icd.properties.map(prp => prp.clone()));\n\t\t\t\t}) as any as Array<Serializable>;\n\t\t\t\tchildren.push(this._properties.name.clone());\n\n\t\t\t\tentityPrototype.initWithChildren(children);\n\t\t\t\t*/\n\n\t\t// @ifndef OPTIMIZE\n\t\tassert(entityPrototype.getTransform(), 'EntityPrototype must have a Transform');\n\t\t// @endif\n\n\t\treturn entityPrototype;\n\t}\n\n\t// Do not use EntityPrototype optimization\n\t// This is only needed if Prefab would extend EntityPrototype instead of Prototype\n\t// toJSON() {\n\t// \treturn Serializable.prototype.toJSON.apply(this, arguments);\n\t// }\n\n\t// This is only needed if Prefab would extend EntityPrototype instead of Prototype\n\t// clone() {\n\t// \treturn Serializable.prototype.clone.apply(this, arguments);\n\t// }\n}\n\n/*\nfilter filters component datas\n\nReturns JSON:\n[\n\t{\n\t\townComponent: false, // component of a parent prototype\n\t\tcomponentClass: [object Object],\n\t\tcomponentId: <componentId>,\n\t\tthreeLetterType: 'icd',\n\t\t generatedForPrototype: <this>,\n\t\tproperties: [\n\t\t\t{ id missing }\n\t\t]\n\t},\n\t{\n\t\t ownComponentData: <ComponentData> || null, // null if this prototype has 0 properties defined\n\t\t componentClass: [object Object],\n\t\t componentId: <componentId>,\n\t\t threeLetterType: 'icd',\n\t\t generatedForPrototype: <this>,\n\t\t properties: [\n\t\t\t { id found if own property } // some properties might be from parent prototypes and thus missing id\n\t\t ]\n\t }\n]\n */\n\nSerializable.registerSerializable(Prefab, 'pfa', json => {\n\treturn new Prefab(json.id, json.si);\n});\n","import Serializable from './serializable';\nimport PropertyOwner, { Prop } from './propertyOwner';\nimport Scene, { scene } from './scene';\n\nlet propertyTypes = [\n\tProp('name', 'No name', Prop.string)\n];\n\nexport default class Level extends PropertyOwner {\n\tname: string;\n\n\tconstructor(predefinedId?) {\n\t\tsuper(predefinedId);\n\t}\n\tcreateScene(predefinedSceneObject: Scene = null) {\n\t\tif (!predefinedSceneObject)\n\t\t\tnew Scene();\n\n\t\tscene.loadLevel(this);\n\n\t\treturn scene;\n\t}\n\tisEmpty() {\n\t\treturn this.getChildren('epr').length === 0;\n\t}\n\n\t/*\n\tOPTIMIZATION DOES NOT WORK, YET\n\ttoJSON() {\n\t\tlet json = super.toJSON();\n\t\tconsole.log('before', json);\n\t\tif (json.c) {\n\t\t\tlet prototypeIds = new Set();\n\t\t\tjson.c.forEach(child => {\n\t\t\t\tconsole.log('child', child);\n\t\t\t\tprototypeIds.add(child.p);\n\t\t\t});\n\n\t\t\tlet prototypeIdToNum = {};\n\t\t\tlet prototypeIdArray = [];\n\t\t\tlet num = 0;\n\t\t\tprototypeIds.forEach(key => {\n\t\t\t\tprototypeIdArray[num] = key;\n\t\t\t\tprototypeIdToNum[key] = num++;\n\t\t\t});\n\n\t\t\tjson.c.forEach(child => {\n\t\t\t\tchild.p = prototypeIdToNum[child.p] || child.p;\n\t\t\t});\n\n\t\t\tjson.p = prototypeIdArray;\n\n\t\t\tconsole.log(json, prototypeIds, prototypeIdToNum, prototypeIdArray);\n\t\t}\n\t\treturn json;\n\t}\n\t*/\n}\nPropertyOwner.defineProperties(Level, propertyTypes);\n\nSerializable.registerSerializable(Level, 'lvl');\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\nimport {default as PIXI} from '../features/graphics';\n\nComponent.register({\n\tname: 'Transform',\n\ticon: 'fa-dot-circle-o',\n\tallowMultiple: false,\n\tproperties: [\n\t\tProp('position', new Vector(0, 0), Prop.vector),\n\t\tProp('scale', new Vector(1, 1), Prop.vector),\n\t\tProp('angle', 0, Prop.float, Prop.float.modulo(0, Math.PI * 2), Prop.flagDegreesInEditor)\n\t],\n\tprototype: {\n\t\tconstructor() {\n\t\t\tthis.layer = this.scene.layers.main;\n\t\t},\n\t\tpreInit() {\n\t\t\tthis.container = new PIXI.Container();\n\t\t\tthis.container._debug = this.entity.makeUpAName() + ' ' + this.name;\n\t\t\tthis.container.position.set(this.position.x, this.position.y);\n\t\t\tthis.container.scale.set(this.scale.x, this.scale.y);\n\t\t\tthis.container.rotation = this.angle;\n\t\t},\n\t\tinit() {\n\n\t\t\t// TODO: move add code to parent? Because container logic is needed in init() of physics component.\n\t\t\tlet parentTransform = this.getParentTransform();\n\t\t\tif (parentTransform) {\n\t\t\t\tparentTransform.container.addChild(this.container);\n\t\t\t\tparentTransform.listen('globalTransformChanged', () => {\n\t\t\t\t\tthis.dispatch('globalTransformChanged', this);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.layer.addChild(this.container);\n\t\t\t}\n\n\t\t\t// Optimize this. Shouldn't be called multiple times per frame.\n\t\t\tlet change = () => {\n\t\t\t\tthis.dispatch('globalTransformChanged', this);\n\t\t\t};\n\n\t\t\tthis.listenProperty(this, 'position', position => {\n\t\t\t\tthis.container.position.set(position.x, position.y);\n\t\t\t\tchange();\n\t\t\t});\n\t\t\tthis.listenProperty(this, 'angle', angle => {\n\t\t\t\tthis.container.rotation = angle;\n\t\t\t\tchange();\n\t\t\t});\n\t\t\tthis.listenProperty(this, 'scale', scale => {\n\t\t\t\tthis.container.scale.set(scale.x, scale.y);\n\t\t\t\tchange();\n\t\t\t});\n\t\t\t// change();\n\t\t},\n\t\tgetParentTransform() {\n\t\t\tif (this.parentTransform !== undefined)\n\t\t\t\treturn this.parentTransform;\n\n\t\t\tlet parentEntity = this.entity.getParent();\n\t\t\tif (parentEntity && parentEntity.threeLetterType === 'ent')\n\t\t\t\tthis.parentTransform = parentEntity.getComponent('Transform');\n\t\t\telse\n\t\t\t\tthis.parentTransform = null;\n\n\t\t\treturn this.parentTransform;\n\t\t},\n\t\tgetGlobalPosition() {\n\t\t\treturn Vector.fromObject(this.layer.toLocal(zeroPoint, this.container, tempPoint));\n\t\t},\n\t\t// given position is altered\n\t\tsetGlobalPosition(position: Vector) {\n\t\t\tthis.position = position.set(this.container.parent.toLocal(position, this.layer, tempPoint));\n\t\t},\n\t\tgetLocalPosition(globalPosition: Vector) {\n\t\t\treturn Vector.fromObject(this.container.parent.toLocal(globalPosition, this.layer, tempPoint));\n\t\t},\n\t\tgetGlobalAngle() {\n\t\t\tlet angle = this.angle;\n\t\t\tlet parent = this.getParentTransform();\n\t\t\twhile (parent) {\n\t\t\t\tangle += parent.angle;\n\t\t\t\tparent = parent.getParentTransform();\n\t\t\t}\n\t\t\treturn angle;\n\t\t},\n\t\tsetGlobalAngle(newGlobalAngle: number) {\n\t\t\tlet globalAngle = this.getGlobalAngle();\n\t\t\tlet change = newGlobalAngle - globalAngle;\n\t\t\tthis.angle = (this.angle + change + Math.PI * 2) % (Math.PI * 2);\n\t\t},\n\t\t// This may give wrong numbers if there are rotations and scale included in object tree.\n\t\tgetGlobalScale() {\n\t\t\tlet scale = this.scale.clone() as Vector;\n\t\t\tlet parentEntity = this.entity.getParent();\n\t\t\twhile (parentEntity && parentEntity.threeLetterType === 'ent') {\n\t\t\t\tscale.multiply(parentEntity.Transform.scale);\n\t\t\t\tparentEntity = parentEntity.getParent();\n\t\t\t}\n\t\t\treturn scale;\n\t\t},\n\t\tsleep() {\n\t\t\tthis.container.destroy();\n\t\t\tthis.container = null;\n\n\t\t\tdelete this.parentTransform;\n\t\t}\n\n\t}\n});\n\nlet zeroPoint = new PIXI.Point();\nlet tempPoint = new PIXI.Point();\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\n\nComponent.register({\n\tname: 'TransformVariance',\n\tcategory: 'Logic',\n\tdescription: `Adds random factor to object's transform/orientation.`,\n\ticon: 'fa-dot-circle-o',\n\tallowMultiple: false,\n\tproperties: [\n\t\tProp('positionVariance', new Vector(0, 0), Prop.vector),\n\t\tProp('scaleVariance', new Vector(0, 0), Prop.vector),\n\t\tProp('angleVariance', 0, Prop.float, Prop.float.range(0, Math.PI), Prop.flagDegreesInEditor)\n\t],\n\tprototype: {\n\t\tonStart() {\n\t\t\tif (!this.positionVariance.isZero())\n\t\t\t\tthis.Transform.position = this.Transform.position.add(this.positionVariance.clone().multiplyScalar(-1 + 2 * Math.random()));\n\n\t\t\tif (!this.scaleVariance.isZero())\n\t\t\t\tthis.Transform.scale = this.Transform.scale.add(this.scaleVariance.clone().multiplyScalar(Math.random()));\n\t\t\t\n\t\t\tif (this.angleVariance)\n\t\t\t\tthis.Transform.angle += this.angleVariance * (-1 + 2 * Math.random());\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\nimport { Color } from '../util/color';\nimport { default as PIXI, generateTextureAndAnchor, getHashedTextureAndAnchor, hitTest } from '../features/graphics';\nimport { GameEvent, globalEventDispatcher } from '../core/eventDispatcher';\n\nComponent.register({\n\tname: 'Shape',\n\tcategory: 'Graphics',\n\ticon: 'fa-stop',\n\tallowMultiple: true,\n\tdescription: 'Draws shape on the screen.',\n\tproperties: [\n\t\tProp('type', 'rectangle', Prop.enum, Prop.enum.values('rectangle', 'circle', 'convex')),\n\t\tProp('radius', 20, Prop.float, Prop.visibleIf('type', ['circle', 'convex'])),\n\t\tProp('size', new Vector(20, 20), Prop.vector, Prop.visibleIf('type', 'rectangle')),\n\t\tProp('points', 3, Prop.int, Prop.int.range(3, 16), Prop.visibleIf('type', 'convex')),\n\t\tProp('topPointDistance', 0.5, Prop.float, Prop.float.range(0.001, 1), Prop.visibleIf('type', 'convex'), 'Only works with at most 8 points'), // Value 0\n\t\tProp('fillColor', new Color(222, 222, 222), Prop.color),\n\t\tProp('borderColor', new Color(255, 255, 255), Prop.color),\n\t\tProp('borderWidth', 1, Prop.float, Prop.float.range(0, 30))\n\t],\n\tprototype: {\n\t\tgraphicsContainPointFunc: null,\n\t\tinit() {\n\t\t\tthis.initSprite();\n\t\t\tthis.Transform.listen('globalTransformChanged', transform => {\n\t\t\t\t/*\n\t\t\t\tthis.sprite.x = transform.globalPosition.x;\n\t\t\t\tthis.sprite.y = transform.globalPosition.y;\n\n\t\t\t\t// rotation setter function has a function call. lets optimize.\n\t\t\t\tif (this.sprite.rotation !== transform.globalAngle)\n\t\t\t\t\tthis.sprite.rotation = transform.globalAngle;\n\n\t\t\t\tthis.sprite.scale.set(transform.globalScale.x, transform.globalScale.y);\n\t\t\t\t*/\n\t\t\t});\n\n\t\t\t/*\n\t\t\tthis.listenProperty(this.Transform, 'position', position => {\n\t\t\t\tthis.sprite.x = position.x;\n\t\t\t\tthis.sprite.y = position.y;\n\t\t\t});\n\n\t\t\tthis.listenProperty(this.Transform, 'angle', angle => {\n\t\t\t\tthis.sprite.rotation = angle;\n\t\t\t});\n\t\t\t*/\n\n\t\t\tlet redrawGraphics = () => {\n\t\t\t\tthis.updateTexture();\n\t\t\t};\n\n\t\t\t// this.listenProperty(this.Transform, 'scale', redrawGraphics);\n\n\t\t\tlet propertiesThatRequireRedraw = [\n\t\t\t\t'type',\n\t\t\t\t'radius',\n\t\t\t\t'size',\n\t\t\t\t'fillColor',\n\t\t\t\t'borderColor',\n\t\t\t\t'borderWidth',\n\t\t\t\t'points',\n\t\t\t\t'topPointDistance'\n\t\t\t];\n\n\t\t\tpropertiesThatRequireRedraw.forEach(propName => {\n\t\t\t\tthis.listenProperty(this, propName, redrawGraphics);\n\t\t\t});\n\t\t},\n\t\tcontainsPoint(vec: Vector) {\n\t\t\tif (this.graphicsContainPointFunc) {\n\t\t\t\treturn this.graphicsContainPointFunc(vec);\n\t\t\t}\n\t\t\treturn false;\n\t\t},\n\t\tinitSprite() {\n\t\t\tlet textureAndAnchor = this.getTextureAndAnchor();\n\t\t\tthis.sprite = new PIXI.Sprite(textureAndAnchor.texture);\n\t\t\tthis.sprite.anchor.set(textureAndAnchor.anchor.x, textureAndAnchor.anchor.y);\n\t\t\tthis.graphicsContainPointFunc = textureAndAnchor.containsPoint;\n\n\t\t\tthis.sprite.selectableEntityOfSprite = this.entity;\n\t\t\tthis.sprite.selectableEntityHitTest = (sprite, pixiCoordinates: Vector, stage) => {\n\t\t\t\tlet localMousePoint = sprite.toLocal(pixiCoordinates, stage);\n\t\t\t\treturn this.containsPoint(localMousePoint);\n\t\t\t}\n\n\t\t\tthis.Transform.container.addChild(this.sprite);\n\t\t},\n\t\tupdateTexture() {\n\t\t\tlet textureAndAnchor = this.getTextureAndAnchor();\n\t\t\tthis.graphicsContainPointFunc = textureAndAnchor.containsPoint;\n\t\t\tthis.sprite.texture = textureAndAnchor.texture;\n\t\t\tthis.sprite.anchor.set(textureAndAnchor.anchor.x, textureAndAnchor.anchor.y);\n\t\t},\n\t\tgetTextureAndAnchor() {\n\t\t\tlet hash = this.createPropertyHash();// + this.Transform.scale;\n\t\t\tlet textureAndAnchor = getHashedTextureAndAnchor(hash);\n\n\t\t\tif (!textureAndAnchor) {\n\t\t\t\tlet graphics = this.createGraphics();\n\t\t\t\ttextureAndAnchor = generateTextureAndAnchor(graphics, hash);\n\t\t\t\t// graphics.destroy();\n\t\t\t}\n\t\t\treturn textureAndAnchor;\n\t\t},\n\t\tcreateGraphics() {\n\t\t\tlet scale = new Vector(1, 1);// this.Transform.scale;\n\t\t\tlet graphics = new PIXI.Graphics();\n\n\t\t\tif (this.type === 'rectangle') {\n\t\t\t\tlet\n\t\t\t\t\tx = -this.size.x / 2 * scale.x,\n\t\t\t\t\ty = -this.size.y / 2 * scale.y,\n\t\t\t\t\tw = this.size.x * scale.x,\n\t\t\t\t\th = this.size.y * scale.y;\n\n\t\t\t\tgraphics.lineStyle(this.borderWidth, this.borderColor.toHexNumber(), 1);\n\t\t\t\tgraphics.beginFill(this.fillColor.toHexNumber());\n\t\t\t\tgraphics.drawRect(x, y, w, h);\n\t\t\t\tgraphics.endFill();\n\t\t\t} else if (this.type === 'circle') {\n\t\t\t\tlet averageScale = (scale.x + scale.y) / 2;\n\n\t\t\t\tgraphics.lineStyle(this.borderWidth, this.borderColor.toHexNumber(), 1);\n\t\t\t\tgraphics.beginFill(this.fillColor.toHexNumber());\n\t\t\t\tgraphics.drawCircle(0, 0, this.radius * averageScale);\n\t\t\t\tgraphics.endFill();\n\t\t\t} else if (this.type === 'convex') {\n\t\t\t\tlet path = this.getConvexPoints(PIXI.Point, false);\n\t\t\t\tpath.push(path[0]); // Close the path\n\n\t\t\t\tgraphics.lineStyle(this.borderWidth, this.borderColor.toHexNumber(), 1);\n\t\t\t\tgraphics.beginFill(this.fillColor.toHexNumber());\n\t\t\t\tgraphics.drawPolygon(path);\n\t\t\t\tgraphics.endFill();\n\t\t\t}\n\n\t\t\treturn graphics;\n\t\t},\n\t\tgetConvexPoints(vectorClass = Vector, takeScaleIntoAccount = true) {\n\t\t\tconst centerAngle = Math.PI * 2 / this.points;\n\t\t\tconst isNotEventPolygon = this.topPointDistance !== 0.5 && this.points <= 8;\n\n\t\t\tlet minDistanceMultiplier;\n\t\t\tlet maxDistanceMultiplier;\n\t\t\tif (isNotEventPolygon) {\n\t\t\t\tconst segmentAngle = Math.PI - centerAngle;\n\t\t\t\tconst unitSegmentLength = 2 * Math.sin(centerAngle / 2);\n\t\t\t\tconst defaultMinDistanceMultiplier = 1 - unitSegmentLength * Math.cos(segmentAngle / 2);\n\n\t\t\t\tif (this.points === 3) {\n\t\t\t\t\tminDistanceMultiplier = 0.2;\n\t\t\t\t\tmaxDistanceMultiplier = 5;\n\t\t\t\t} else if (this.points === 8) {\n\t\t\t\t\tminDistanceMultiplier = defaultMinDistanceMultiplier;\n\t\t\t\t\tmaxDistanceMultiplier = 3;\n\t\t\t\t} else {\n\t\t\t\t\tminDistanceMultiplier = defaultMinDistanceMultiplier;\n\t\t\t\t\tmaxDistanceMultiplier = 5;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet path = [];\n\n\t\t\tlet currentAngle = 0;\n\t\t\tfor (let i = 0; i < this.points; ++i) {\n\t\t\t\tlet x = Math.sin(currentAngle) * this.radius;\n\t\t\t\tlet y = Math.cos(currentAngle) * this.radius;\n\n\t\t\t\tif (isNotEventPolygon && i === 0) {\n\t\t\t\t\tif (this.topPointDistance > 0.5) {\n\t\t\t\t\t\ty *= 1 + (this.topPointDistance - 0.5) * (maxDistanceMultiplier - 1);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ty *= 2 * this.topPointDistance * (1 - minDistanceMultiplier) + minDistanceMultiplier;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tpath.push(new vectorClass(x, -y));\n\t\t\t\tcurrentAngle += centerAngle;\n\t\t\t}\n\t\t\tif (isNotEventPolygon) {\n\t\t\t\t// put weight to center\n\t\t\t\tlet averageY = path.reduce((prev, curr) => prev + curr.y, 0) / this.points;\n\t\t\t\tpath.forEach(p => p.y -= averageY);\n\t\t\t}\n\n\t\t\tif (takeScaleIntoAccount) {\n\t\t\t\tconst scale = this.Transform.getGlobalScale();\n\t\t\t\tif (scale.x !== 1 || scale.y !== 1) {\n\t\t\t\t\tpath.forEach(p => {\n\t\t\t\t\t\tp.x *= scale.x;\n\t\t\t\t\t\tp.y *= scale.y;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn path;\n\t\t},\n\t\tsleep() {\n\t\t\tthis.sprite.destroy();\n\t\t\tthis.sprite = null;\n\t\t\tthis.graphicsContainPointFunc = null;\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\nimport { default as PIXI, generateTextureAndAnchor, getHashedTextureAndAnchor, hitTest } from '../features/graphics';\n\nComponent.register({\n\tname: 'Sprite',\n\tcategory: 'Graphics',\n\ticon: 'fa-stop',\n\tallowMultiple: true,\n\tdescription: 'Draws a sprite on the screen.',\n\tproperties: [\n\t\tProp('resource', 'character.png', Prop.enum, Prop.enum.values('character.png', 'profile.png', 'sprite.png')),\n\t\tProp('anchor', new Vector(0.5, 0.5), Prop.vector)\n\t],\n\tprototype: {\n\t\tinit() {\n\t\t\tthis.initSprite();\n\n\t\t\tthis.listenProperty(this, 'anchor', anchor => {\n\t\t\t\tif (!this.sprite) return;\n\t\t\t\telse this.sprite.anchor.set(this.anchor.x, this.anchor.y);\n\t\t\t});\n\n\t\t\tthis.listenProperty(this, 'resource', resource => {\n\t\t\t\tthis.initSprite();\n\t\t\t});\n\t\t},\n\t\tinitSprite() {\n\t\t\tif (this.sprite) {\n\t\t\t\tthis.sprite.destroy();\n\t\t\t}\n\n\t\t\tthis.sprite = PIXI.Sprite.fromImage('/img/' + this.resource);\n\t\t\tthis.sprite.anchor.set(this.anchor.x, this.anchor.y);\n\t\t\tthis.sprite.selectableEntityOfSprite = this.entity;\n\t\t\tthis.sprite.selectableEntityHitTest = hitTest;\n\n\t\t\tthis.Transform.container.addChild(this.sprite);\n\t\t},\n\t\tsleep() {\n\t\t\tthis.sprite.destroy();\n\t\t\tthis.sprite = null;\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\nimport EntityPrototype from '../core/entityPrototype';\n\nComponent.register({\n\tname: 'Spawner',\n\tcategory: 'Logic',\n\tdescription: 'Spawns types to world.',\n\tproperties: [\n\t\tProp('typeName', '', Prop.string),\n\t\tProp('trigger', 'start', Prop.enum, Prop.enum.values('start', 'interval')),\n\t\tProp('interval', 10, Prop.float, Prop.float.range(0.1, 1000000), Prop.visibleIf('trigger', 'interval'), 'Interval in seconds')\n\t],\n\tprototype: {\n\t\tconstructor() {\n\t\t\tthis.lastSpawn = 0;\n\t\t},\n\t\tinit() {\n\t\t\tthis.lastSpawn = this.scene.time;\n\t\t},\n\t\tonStart() {\n\t\t\tif (this.trigger === 'start')\n\t\t\t\tthis.spawn();\n\t\t},\n\t\tonUpdate() {\n\t\t\tif (this.scene.time > this.lastSpawn + this.interval)\n\t\t\t\tthis.spawn();\n\t\t},\n\t\tonDrawHelper(context) {\n\t\t\tlet size = 30;\n\t\t\tlet\n\t\t\t\tx = this.Transform.position.x - size * this.Transform.scale.x/2,\n\t\t\t\ty = this.Transform.position.y - size * this.Transform.scale.y/2,\n\t\t\t\tw = size * this.Transform.scale.x,\n\t\t\t\th = size * this.Transform.scale.y;\n\t\t\tcontext.save();\n\t\t\tcontext.fillStyle = 'blue';\n\t\t\tcontext.strokeStyle = 'white';\n\t\t\tcontext.lineWidth = 1;\n\t\t\tcontext.font = '40px Font Awesome 5 Free';\n\t\t\tcontext.textAlign = 'center';\n\t\t\tcontext.fillText('\\uF21D', this.Transform.position.x + 2, this.Transform.position.y);\n\t\t\tcontext.strokeText('\\uf21d', this.Transform.position.x + 2, this.Transform.position.y);\n\n\t\t\tcontext.restore();\n\t\t},\n\t\tspawn() {\n\t\t\t// window['testi']++;\n\t\t\tlet prototype = this.game.findChild('prt', prt => prt.name === this.typeName, true);\n\n\t\t\tif (!prototype)\n\t\t\t\treturn;\n\n\t\t\tlet entityPrototype = EntityPrototype.createFromPrototype(prototype);\n\t\t\tentityPrototype.spawnEntityToScene(this.scene, this.Transform.position);\n\t\t\tentityPrototype.delete();\n\t\t\tthis.lastSpawn = this.scene.time;\n\t\t}\n\t},\n\t/* TODO: This kind of thing can improve update performance by 2x or more\n\tsystems: {\n\t\tonUpdate(setOfSpawners, scene) {\n\t\t\tlet sceneTime = scene.time;\n\t\t\tsetOfSpawners.forEach(comp => {\n\t\t\t\tif (sceneTime > comp.lastSpawn + comp.interval)\n\t\t\t\t\tcomp.spawn();\n\t\t\t});\n\t\t}\n\t}\n\t*/\n});\n\n/*\nwindow['testi'] = 0;\nsetInterval(() => {\n\tconsole.log('testi', window['testi']);\n\twindow['testi'] = 0;\n}, 1000);\n*/","import { Component, Prop } from '../core/component';\nimport Vector from '../util/vector';\n\nComponent.register({\n\tname: 'Trigger',\n\tdescription: 'When _ then _.',\n\tcategory: 'Logic',\n\tallowMultiple: true,\n\tproperties: [\n\t\tProp('trigger', 'playerComesNear', Prop.enum, Prop.enum.values('playerComesNear')),\n\t\tProp('radius', 40, Prop.float, Prop.float.range(0, 1000), Prop.visibleIf('trigger', 'playerComesNear')),\n\t\tProp('action', 'win', Prop.enum, Prop.enum.values('win'))\n\t],\n\tprototype: {\n\t\tpreInit() {\n\t\t\tthis.storeProp = `__Trigger_${this._componentId}`;\n\t\t},\n\t\tonUpdate() {\n\t\t\tif (this.trigger === 'playerComesNear') {\n\t\t\t\tlet componentSet = this.scene.getComponents('CharacterController');\n\t\t\t\tlet entities = [];\n\t\t\t\tcomponentSet.forEach(c => entities.push(c.entity));\n\t\t\t\tlet distSq = this.radius * this.radius;\n\t\t\t\tlet pos = this.Transform.getGlobalPosition();\n\t\t\t\tfor (let i = 0; i < entities.length; ++i) {\n\t\t\t\t\tif (entities[i].Transform.getGlobalPosition().distanceSq(pos) < distSq) {\n\t\t\t\t\t\tif (!entities[i][this.storeProp] && this.launchTrigger(entities[i]) !== false)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tentities[i][this.storeProp] = true;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tentities[i][this.storeProp] = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t// Return false if other triggers should not be checked\n\t\t// Note: check this return false logic. Looks weird.\n\t\tlaunchTrigger(entity) {\n\t\t\tif (this.action === 'win') {\n\t\t\t\tthis.scene.win();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\n\n// Export so that other components can have this component as parent\nexport default Component.register({\n\tname: 'Lifetime',\n\tdescription: 'Set the object to be destroyed after a time period.',\n\tcategory: 'Logic', // You can also make up new categories.\n\ticon: 'fa-bars', // Font Awesome id\n\trequirements: ['Transform'], // These shared components are autofilled. Error if component is not found.\n\tproperties: [\n\t\tProp('lifetime', 3, Prop.float, Prop.float.range(0.01, 1000), 'Life time seconds')\n\t],\n\tparentClass: Component,\n\tprototype: {\n\t\tonUpdate() {\n\t\t\tlet lifetime = this.scene.time - this.startTime;\n\t\t\tif (lifetime >= this.lifetime) {\n\t\t\t\tif (this.entity)\n\t\t\t\t\tthis.entity.delete();\n\t\t\t}\n\t\t},\n\t\tinit() {\n\t\t\tthis.startTime = this.scene.time;\n\t\t}\n\t}\n});\n","import { Component, Prop } from '../core/component';\nimport { key, keyPressed, listenKeyDown } from '../util/input';\nimport assert from '../util/assert'\nimport Vector from '../util/vector';\nimport { getWorld, default as p2 } from '../features/physics';\nimport {PHYSICS_SCALE} from './Physics'\nimport { absLimit } from '../util/algorithm';\n\nconst JUMP_SAFE_DELAY = 0.1; // seconds\n\nComponent.register({\n\tname: 'CharacterController',\n\tdescription: 'Lets user control the object.',\n\tcategory: 'Dynamics',\n\tallowMultiple: false,\n\tproperties: [\n\t\tProp('type', 'player', Prop.enum, Prop.enum.values('player', 'AI')),\n\t\tProp('keyboardControls', 'arrows or WASD', Prop.enum, Prop.enum.values('arrows', 'WASD', 'arrows or WASD')),\n\t\tProp('controlType', 'jumper', Prop.enum, Prop.enum.values('jumper', 'top down'/*, 'space ship'*/)),\n\t\tProp('jumpSpeed', 300, Prop.float, Prop.float.range(0, 1000), Prop.visibleIf('controlType', 'jumper')),\n\t\tProp('jumpAddedToVelocity', 0.4, Prop.float, Prop.float.range(0, 1), Prop.visibleIf('controlType', 'jumper'), '1 means that jump speed is added to y velocity when object has y velocity.'),\n\t\tProp('breakInTheAir', true, Prop.bool, Prop.visibleIf('controlType', 'jumper')),\n\t\tProp('speed', 200, Prop.float, Prop.float.range(0, 1000)),\n\t\tProp('acceleration', 2000, Prop.float, Prop.float.range(0, 10000)),\n\t\tProp('breaking', 2000, Prop.float, Prop.float.range(0, 10000))\n\t],\n\tprototype: {\n\t\tinit() {\n\t\t\tthis.Physics = this.entity.getComponent('Physics');\n\n\t\t\tthis.lastJumpTime = 0;\n\n\t\t\tthis.keyListener = listenKeyDown(keyCode => {\n\t\t\t\tif (this.controlType !== 'jumper' || !this.scene.playing)\n\t\t\t\t\treturn;\n\n\t\t\t\tif (this.keyboardControls === 'arrows') {\n\t\t\t\t\tif (keyCode === key.up)\n\t\t\t\t\t\tthis.jump();\n\t\t\t\t} else if (this.keyboardControls === 'WASD') {\n\t\t\t\t\tif (keyCode === key.w)\n\t\t\t\t\t\tthis.jump();\n\t\t\t\t} else if (this.keyboardControls === 'arrows or WASD') {\n\t\t\t\t\tif (keyCode === key.up || keyCode === key.w)\n\t\t\t\t\t\tthis.jump();\n\t\t\t\t} else {\n\t\t\t\t\tassert(false, 'Invalid CharacterController.keyboardControls');\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tsleep() {\n\t\t\tif (this.keyListener) {\n\t\t\t\tthis.keyListener();\n\t\t\t\tthis.keyListener = null;\n\t\t\t}\n\t\t},\n\t\tgetInput() {\n\t\t\tif (this.keyboardControls === 'arrows') {\n\t\t\t\treturn {\n\t\t\t\t\tup: keyPressed(key.up),\n\t\t\t\t\tdown: keyPressed(key.down),\n\t\t\t\t\tleft: keyPressed(key.left),\n\t\t\t\t\tright: keyPressed(key.right)\n\t\t\t\t};\n\t\t\t} else if (this.keyboardControls === 'WASD') {\n\t\t\t\treturn {\n\t\t\t\t\tup: keyPressed(key.w),\n\t\t\t\t\tdown: keyPressed(key.s),\n\t\t\t\t\tleft: keyPressed(key.a),\n\t\t\t\t\tright: keyPressed(key.d)\n\t\t\t\t};\n\t\t\t} else if (this.keyboardControls === 'arrows or WASD') {\n\t\t\t\treturn {\n\t\t\t\t\tup: keyPressed(key.up) || keyPressed(key.w),\n\t\t\t\t\tdown: keyPressed(key.down) || keyPressed(key.s),\n\t\t\t\t\tleft: keyPressed(key.left) || keyPressed(key.a),\n\t\t\t\t\tright: keyPressed(key.right) || keyPressed(key.d)\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tassert(false, 'Invalid CharacterController.keyboardControls');\n\t\t\t}\n\t\t},\n\t\tonUpdate(dt, t) {\n\t\t\tlet { up, down, left, right } = this.getInput();\n\n\t\t\tlet dx = 0,\n\t\t\t\tdy = 0;\n\n\t\t\tif (right) dx++;\n\t\t\tif (left) dx--;\n\t\t\tif (up) dy--;\n\t\t\tif (down) dy++;\n\n\t\t\tif (this.controlType === 'top down') {\n\t\t\t\tthis.moveTopDown(dx, dy, dt);\n\t\t\t} else if (this.controlType === 'jumper') {\n\t\t\t\tthis.moveJumper(dx, dy, dt);\n\t\t\t}\n\t\t},\n\t\t// dx and dy between [-1, 1]\n\t\tmoveTopDown(dx, dy, dt) {\n\t\t\tif (!this.Physics) {\n\t\t\t\tif (dx !== 0 || dy !== 0) {\n\t\t\t\t\tlet Transform = this.Transform;\n\t\t\t\t\tlet p = Transform.position;\n\t\t\t\t\tlet delta = this.speed * dt;\n\t\t\t\t\tTransform.position = new Vector(p.x + dx * delta, p.y + dy * delta);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this.Physics.body)\n\t\t\t\treturn;\n\n\t\t\t// Physics based\n\t\t\t// #############\n\n\t\t\tlet bodyVelocity = this.Physics.body.velocity;\n\n\t\t\tbodyVelocity[0] = absLimit(this.calculateNewVelocity(bodyVelocity[0] / PHYSICS_SCALE, dx, dt), this.speed) * PHYSICS_SCALE;\n\t\t\tbodyVelocity[1] = absLimit(this.calculateNewVelocity(bodyVelocity[1] / PHYSICS_SCALE, dy, dt), this.speed) * PHYSICS_SCALE;\n\t\t},\n\t\tmoveJumper(dx, dy, dt) {\n\t\t\tif (!this.Physics || !this.Physics.body)\n\t\t\t\treturn false;\n\n\t\t\tlet bodyVelocity = this.Physics.body.velocity;\n\n\t\t\tbodyVelocity[0] = this.calculateNewVelocity(bodyVelocity[0] / PHYSICS_SCALE, dx, dt) * PHYSICS_SCALE;\n\t\t},\n\t\tjump() {\n\t\t\tif (this.scene.time > this.lastJumpTime + JUMP_SAFE_DELAY && this.checkIfCanJump()) {\n\t\t\t\tthis.lastJumpTime = this.scene.time;\n\n\t\t\t\tlet bodyVelocity = this.Physics.body.velocity;\n\t\t\t\tif (bodyVelocity[1] > 0) {\n\t\t\t\t\t// going down\n\t\t\t\t\tbodyVelocity[1] = -this.jumpSpeed * PHYSICS_SCALE;\n\t\t\t\t} else {\n\t\t\t\t\t// going up\n\t\t\t\t\tlet velocityVector = Vector.fromArray(bodyVelocity);\n\n\t\t\t\t\tlet contactEquations = getWorld(this.scene).narrowphase.contactEquations;\n\t\t\t\t\tlet body = this.Physics.body;\n\n\t\t\t\t\tfor (let i = contactEquations.length - 1; i >= 0; --i) {\n\t\t\t\t\t\tlet contact = contactEquations[i];\n\t\t\t\t\t\tif (contact.bodyA === body || contact.bodyB === body) {\n\t\t\t\t\t\t\tlet normal = Vector.fromArray(contact.normalA);\n\t\t\t\t\t\t\tif (contact.bodyB === body)\n\t\t\t\t\t\t\t\tnormal.multiplyScalar(-1);\n\t\t\t\t\t\t\tlet dotProduct = velocityVector.dot(normal);\n\t\t\t\t\t\t\tif (dotProduct < 0) {\n\t\t\t\t\t\t\t\t// character is moving away from the contact. could be caused by physics engine.\n\t\t\t\t\t\t\t\tvelocityVector.subtract(normal.multiplyScalar(dotProduct));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tbodyVelocity[1] = velocityVector.y * this.jumpAddedToVelocity - this.jumpSpeed * PHYSICS_SCALE;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tcheckIfCanJump() {\n\t\t\tif (!this.Physics || this.controlType !== 'jumper')\n\t\t\t\treturn false;\n\n\t\t\tlet contactEquations = getWorld(this.scene).narrowphase.contactEquations;\n\t\t\tlet body = this.Physics.body;\n\n\t\t\tif (!body)\n\t\t\t\treturn false;\n\n\t\t\tif (body.sleepState === p2.Body.SLEEPING)\n\t\t\t\treturn true;\n\n\t\t\tfor (let i = contactEquations.length - 1; i >= 0; --i) {\n\t\t\t\tlet contact = contactEquations[i];\n\t\t\t\tif (contact.bodyA === body || contact.bodyB === body) {\n\t\t\t\t\tlet normalY = contact.normalA[1];\n\t\t\t\t\tif (contact.bodyB === body)\n\t\t\t\t\t\tnormalY *= -1;\n\t\t\t\t\tif (normalY > 0.5)\n\t\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tcalculateNewVelocity(velocity, input, dt) {\n\t\t\tif (input !== 0) {\n\t\t\t\tif (velocity >= this.speed && input > 0) {\n\t\t\t\t\t// don't do anything\n\t\t\t\t} else if (velocity <= -this.speed && input < 0) {\n\t\t\t\t\t// don't do anything\n\t\t\t\t} else {\n\t\t\t\t\t// do something\n\t\t\t\t\tvelocity += input * this.acceleration * dt;\n\n\t\t\t\t\tif (input < 0 && velocity < -this.speed)\n\t\t\t\t\t\tvelocity = -this.speed;\n\n\t\t\t\t\tif (input > 0 && velocity > this.speed)\n\t\t\t\t\t\tvelocity = this.speed;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (velocity !== 0 && (this.controlType !== 'jumper' || this.breakInTheAir || this.checkIfCanJump())) {\n\t\t\t\t\tlet absVel = Math.abs(velocity);\n\t\t\t\t\tabsVel -= this.breaking * dt;\n\t\t\t\t\tif (absVel < 0)\n\t\t\t\t\t\tabsVel = 0;\n\n\t\t\t\t\tif (velocity > 0)\n\t\t\t\t\t\tvelocity = absVel;\n\t\t\t\t\telse\n\t\t\t\t\t\tvelocity = -absVel;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn velocity;\n\t\t}\n\t}\n});\n","// Animation clashes with typescript lib \"DOM\" (lib.dom.d.ts). Therefore we have namespace.\nexport namespace animation {\n\n    // Changing this will break games\n    export const DEFAULT_FRAME_COUNT = 24;\n    export const DEFAULT_FRAME_RATE = 24;\n    export const MAX_FRAME_COUNT = 100;\n    export const MAX_FRAME_RATE = 100;\n\n    export type AnimationData = {\n        animations: AnimationDataAnimation[];\n    };\n    export type AnimationDataAnimation = {\n        name: string;\n        tracks: AnimationDataTrack[];\n        frames?: number; // If falsy, use DEFAULT_FRAME_COUNT\n        fps?: number; // If falsy, use DEFAULT_FRAME_RATE\n    };\n    export type AnimationDataTrack = {\n        path: string;\n        cId: string;\n        prpName: string;\n        keyFrames: { [frame: number]: any }\n    };\n\n    // export function parseAnimationData\n\n    /**\n     * @param animationDataString data from Animation component\n     */\n    export function parseAnimationData(animationDataString) {\n        let animationData;\n        try {\n            animationData = JSON.parse(animationDataString);\n        } catch (e) {\n            animationData = {};\n        }\n\n        animationData.animations = animationData.animations || [];\n        return animationData as AnimationData;\n    }\n\n    /**\n     * Helper class for editor. Just JSON.stringify this to get valid animationData animation out.\n     */\n    export class Animation {\n        // If frames is falsy, use DEFAULT_FRAME_COUNT\n        constructor(\n            public name: string,\n            public tracks: Track[] = [],\n            public frames: number = undefined,\n            public fps: number = undefined\n        ) {}\n\n        /**\n         *\n         * @param entityPrototypeId\n         * @param componendId\n         * @param value jsoned property value\n         */\n        saveValue(path: string, componendId: string, propertyName: string, frameNumber: number, value: any) {\n            let track = this.tracks.find(track => track.cId === componendId && track.path === path && track.prpName === propertyName);\n            if (!track) {\n                track = new Track(path, componendId, propertyName);\n                this.tracks.push(track);\n            }\n            track.saveValue(frameNumber, value);\n        }\n\n        getKeyFrames(path: string, componendId: string, propertyName: string) {\n            let track = this.tracks.find(track => track.cId === componendId && track.path === path && track.prpName === propertyName);\n            if (track) {\n                return track.keyFrames;\n            } else {\n                return null;\n            }\n        }\n\n        deleteEmptyTracks() {\n            for (let i = this.tracks.length - 1; i >= 0; i--) {\n                if (Object.keys(this.tracks[i].keyFrames).length === 0) {\n                    this.tracks.splice(i, 1);\n                }\n            }\n        }\n\n        deleteOutOfBoundsKeyFrames() {\n            let frameCount = this.frames || DEFAULT_FRAME_COUNT;\n            for (const track of this.tracks) {\n                let keyFrameKeys = Object.keys(track.keyFrames);\n                for (const keyFrameKey of keyFrameKeys) {\n                    if (+keyFrameKey > frameCount) {\n                        delete track.keyFrames[keyFrameKey];\n                    }\n                }\n            }\n        }\n\n        getHighestKeyFrame() {\n            let highestKeyFrame = 0;\n            for (const track of this.tracks) {\n                let keyFrameKeys = Object.keys(track.keyFrames);\n                for (const keyFrameKey of keyFrameKeys) {\n                    if (+keyFrameKey > highestKeyFrame) {\n                        highestKeyFrame = +keyFrameKey;\n                    }\n                }\n            }\n            return highestKeyFrame;\n        }\n\n        static create(json)  {\n            let tracks = (json.tracks || []).map(Track.create);\n            return new Animation(json.name, tracks, json.frames, json.fps);\n        }\n    }\n\n    export class Track {\n        constructor(public path: string, public cId: string, public prpName: string, public keyFrames: { [frame: number]: any } = {}) {\n        }\n\n        saveValue(frameNumber: number, value) {\n            this.keyFrames[frameNumber] = value;\n        }\n\n        static create(json) {\n            let keyFrames = json.keyFrames || {};\n            return new Track(json.path, json.cId, json.prpName, keyFrames);\n        }\n    }\n}\n","/*\n milliseconds: how often callback can be called\n callbackLimitMode:\n \t- instant: if it has been quiet, call callback() instantly\n \t- soon: if it has been quiet, call callback() instantly after current code loop\n \t- next: if it has been quiet, call callback() after waiting milliseconds.\n\n When calling the callback, limitMode can be overridden: func(callLimitMode);\n */\nexport function limit(milliseconds, callbackLimitMode = 'soon', callback) {\n\tif (!['instant', 'soon', 'next'].includes(callbackLimitMode))\n\t\tthrow new Error('Invalid callbackLimitMode');\n\n\tlet queueTimeout = null; // non-null when call is in queue\n\tlet lastCall = 0; // last time when callback was called\n\n\tfunction callCallback() {\n\t\tlastCall = Date.now();\n\t\tqueueTimeout = null;\n\t\tcallback();\n\t}\n\tfunction callCallbackWithDelay(delayMilliseconds) {\n\t\tqueueTimeout = setTimeout(callCallback, delayMilliseconds);\n\t}\n\n\treturn function(callLimitMode?) {\n\t\tif (queueTimeout)\n\t\t\treturn;\n\n\t\tlet timeToNextPossibleCall = lastCall + milliseconds - Date.now();\n\t\tif (timeToNextPossibleCall > 0) {\n\t\t\tcallCallbackWithDelay(timeToNextPossibleCall);\n\t\t} else {\n\t\t\tlet mode = callLimitMode || callbackLimitMode;\n\t\t\tif (mode === 'instant')\n\t\t\t\tcallCallback();\n\t\t\telse if (mode === 'soon')\n\t\t\t\tcallCallbackWithDelay(0)\n\t\t\telse if (mode === 'next')\n\t\t\t\tcallCallbackWithDelay(milliseconds)\n\t\t}\n\t}\n}\n","import { keyPressed, key, listenKeyDown, simulateKeyEvent } from '../util/input'\nimport Vector from '../util/vector';\nimport debug from './debug'\n\nexport const CONTROL_SIZE = 70; // pixels\n\nexport default class TouchControl {\n\telement: HTMLElement = null; // document not loaded yet.\n\tstate: boolean = false; // is key binding simulated?\n\tvisible: boolean = false;\n\tcontainsFunc: (point: Vector) => boolean = null;\n\n\tconstructor(public elementId: string, public keyBinding: number, public requireTouchStart = false) {\n\t}\n\n\tinitElement() {\n\t\tif (!this.element)\n\t\t\tthis.element = document.getElementById(this.elementId);\n\t}\n\n\tsetPosition(left: number, right: number, bottom: number) {\n\t\tif (left)\n\t\t\tthis.element.style.left = left + 'px';\n\t\telse\n\t\t\tthis.element.style.right = right + 'px';\n\t\tthis.element.style.bottom = bottom + 'px';\n\t}\n\n\tgetPosition() {\n\t\tlet screen = document.getElementById('screen');\n\t\tlet screenWidth = parseInt(screen.style.width);\n\t\tlet screenHeight = parseInt(screen.style.height);\n\n\t\tlet left = parseInt(this.element.style.left);\n\t\tlet right = parseInt(this.element.style.right);\n\t\tlet bottom = parseInt(this.element.style.bottom);\n\n\t\tlet x = !isNaN(left) ? (left + this.element.offsetWidth / 2) : (screenWidth - right - this.element.offsetWidth / 2);\n\t\tlet y = screenHeight - bottom - this.element.offsetHeight / 2;\n\n\t\treturn new Vector(x, y);\n\t}\n\n\tcontains(point: Vector) {\n\t\tif (!this.visible)\n\t\t\treturn false;\n\n\t\tif (this.containsFunc)\n\t\t\treturn this.containsFunc.call(this, point);\n\n\t\tlet position = this.getPosition();\n\t\treturn position.distance(point) <= CONTROL_SIZE / 2;\n\t}\n\t// function(point) {...}\n\tsetContainsFunction(func: (point: Vector) => boolean)  {\n\t\tthis.containsFunc = func;\n\t}\n\n\tsetVisible(visible: boolean) {\n\t\tif (this.visible === visible)\n\t\t\treturn;\n\n\t\tthis.visible = visible;\n\t\tif (visible)\n\t\t\tthis.element.style.display = 'inline-block';\n\t\telse\n\t\t\tthis.element.style.display = 'none';\n\t}\n\n\tsetState(controlContainsATouch: boolean, isTouchStartEvent: boolean) {\n\t\tlet oldState = this.state;\n\n\t\tif (this.requireTouchStart && !this.state && !isTouchStartEvent)\n\t\t\tthis.state = false;\n\t\telse\n\t\t\tthis.state = !!controlContainsATouch;\n\n\t\tif (this.state === oldState)\n\t\t\treturn;\n\n\t\tif (this.state) {\n\t\t\tthis.element.classList.add('pressed');\n\t\t\tsimulateKeyEvent('keydown', this.keyBinding);\n\t\t} else {\n\t\t\tthis.element.classList.remove('pressed');\n\t\t\tsimulateKeyEvent('keyup', this.keyBinding);\n\t\t}\n\t}\n}\n","import '../core/index'\nimport '../components'\nimport { keyPressed, key, listenKeyDown, simulateKeyEvent } from '../util/input'\nimport { scene, forEachScene } from '../core/scene';\nimport { forEachGame } from '../core/game';\nimport { configureNetSync } from '../core/net'\nimport { disableAllChanges, setPropertyChangeSettings } from '../core/property';\n\nimport './canvasResize'\nimport './touchControlManager'\n\nimport * as fullscreen from '../util/fullscreen';\nimport Level from '../core/level';\nimport { GameEvent } from '../core/eventDispatcher';\n\nsetPropertyChangeSettings(false, false);\n\nconfigureNetSync({\n\tserverToClientEnabled: true,\n\tclientToServerEnabled: false,\n\tcontext: 'play'\n});\n\nforEachGame(game => {\n\tlet levelIndex = 0;\n\n\tfunction play() {\n\t\tlet levels = game.getChildren('lvl') as Array<Level>;\n\t\tif (levelIndex >= levels.length)\n\t\t\tlevelIndex = 0;\n\t\tlevels[levelIndex].createScene().play();\n\t}\n\n\tplay();\n\tif (window['introLogo']) {\n\t\twindow['introLogo'].style.display = 'none';\n\t}\n\n\tgame.listen(GameEvent.GAME_LEVEL_COMPLETED, () => {\n\t\tlevelIndex++;\n\t\tplay();\n\t});\n});\n\nlistenKeyDown(keyValue => {\n\tif (keyValue === key.space && scene)\n\t\tscene.win();\n});\n\n\n\n// Fullscreen\n/*\nif (fullscreen.fullscreenSupport()) {\n\twindow.addEventListener('click', () => fullscreen.toggleFullscreen(window.document.body));\n}\nsetTimeout(() => {\n\tdocument.getElementById('fullscreenInfo').classList.add('showSlowly');\n}, 1000);\nsetTimeout(() => {\n\tdocument.getElementById('fullscreenInfo').classList.remove('showSlowly');\n}, 3000);\n*/\n"],"names":["assert","condition","_i","messages","console","warn","changeGetter","get","log","Error","stack","window","join","decideIndexOfListener","array","callback","low","high","length","priority","mid","resetOrigin","origin","getChangeOrigin","setChangeOrigin","_origin","setTimeout","addChange","type","reference","circularEventId","threeLetterType","circularDependencyDetector","enter","id","leave","change","external","externalChange","changeType","setPropertyValue","value","_value","move","parent","_parent","addSerializableToTree","previousOrigin","globalEventDispatcher","dispatch","GameEvent","GLOBAL_CHANGE_OCCURED","executeExternal","executeWithOrigin","task","oldOrigin","createStringId","threeLetterPrefix","characters","i","CHARACTERS","random","CHAR_COUNT","createDataType","_a","_b","name","_c","validators","_d","toJSON","_e","fromJSON","_f","clone","_g","equal","default","createType","Object","keys","forEach","validatorName","createValidator","validatorFunction","validator","args","parameters","validatorArgs","validate","x","apply","hexToRgb","hex","result","exec","r","parseInt","g","b","componentToHex","c","toString","rgbToHex","validateFloat","val","isNaN","Infinity","setXlink","el","obj","key","setAttributeNS","xlinkns","setData","dataset","stickyNonModalErrorPopup","text","document","body","style","filter","popup","position","display","max-width","top","width","padding","font-size","z-index","color","background","text-align","user-select","box-sizing","mount","getRenderer","canvas","renderer","PIXI","autoDetectRenderer","view","autoResize","antialias","sortDisplayObjects","container","children","sort","sortFunc","a","y","getHashedTextureAndAnchor","hash","texturesAndAnchors","generateTextureAndAnchor","graphicsObject","bounds","getLocalBounds","anchor","height","texture","generateTexture","SCALE_MODES","LINEAR","containsPoint","point","graphicsData","data","fill","shape","contains","hitTest","sprite","pixiCoordinates","stage","localBounds","textureSource","baseTexture","source","localMousePoint","toLocal","xPart","yPart","hitTestCanvas","hitTestContext","drawImage","getImageData","createCanvas","createElement","ctx","getContext","gradient","createLinearGradient","RESOLUTION","addColorStop","fillStyle","fillRect","updateSceneBackgroundGradient","scene","createWorld","owner","options","_p2World","p2","World","gravity","sleepMode","BODY_SLEEPING","updateWorld","dt","step","PHYSICS_DT","deleteWorld","clear","_p2Materials","getWorld","addBody","deleteBody","removeBody","createMaterial","materials","assign","defaultMaterialOptions","friction","restitution","stiffness","relaxation","frictionStiffness","frictionRelaxation","surfaceVelocity","material","Material","h","m","o1","o2","contactMaterial","ContactMaterial","Math","min","max","addContactMaterial","keyPressed","listenKeyDown","handler","keyDownListeners","push","splice","indexOf","listenMouseMove","element","domHandler","event","pageX","pageY","offsetLeft","offsetTop","offsetParent","Vector","addEventListener","removeEventListener","listenMouseDown","button","listenMouseUp","simulateKeyEvent","eventName","keyCode","onkeydown","onkeyup","eventHappened","count","includes","currentPerSecondMeters","start","currentPerformanceMeters","performance","now","stop","millis","cumulativePerformance","forEachScene","listener","listen","GLOBAL_SCENE_CREATED","addSerializable","serializable","undefined","serializables","getSerializable","removeSerializable","getDataFromPrototype","prototype","originalPrototype","_depth","parentPrototype","getParentPrototype","componentDatas","getChildren","componentData","componentId","ownComponentData","componentClass","propertyHash","generatedForPrototype","properties","property","j","sortInheritedComponentDatas","componentName","localeCompare","createEntityPrototypeNameProperty","entityPrototypeId","EntityPrototype","_propertyTypesByName","createProperty","predefinedId","createEntityPrototypeTransform","transform","ComponentData","addChild","scale","angle","fromTransformToBodyPosition","Transform","getGlobalPosition","toArray","map","PHYSICS_SCALE","fromBodyPositionToGlobalVector","bodyPosition","fromArray","multiplyScalar","PHYSICS_SCALE_INV","alphaLerp","lerp","scaleLerp","getParticleTexture","size","gradientHardness","rgb","textureCache","context","createRadialGradient","Texture","fromCanvas","absLimit","absMax","getClosestAngle","target","diff","PI","interpolateBezier","fromValue","control1Value","control2Value","targetValue","t","propertyType","typeName","getFlag","Prop","flagDegreesInEditor","t2","interpolateCubic","bezier","calculateControlPointsForScalar","prev","curr","next","control1","control2","isInSceneTree","_rootType","getQueryVariable","variable","query","location","search","substring","vars","split","pair","decodeURIComponent","changeReceivedOverNet","packedChanges","serverToClientEnabled","unpackChange","executeChange","gameReceivedOverNet","gameData","error","Serializable","GLOBAL_GAME_CREATED","game","localStorage","openEditPlayGameId","history","replaceState","e","sendSocketMessage","socket","emit","connect","isServer","v","n","cid","si","p","s","io","on","onevent","packet","param1","listeners","clientToServerEnabled","packChange","packedChange","packed","parentId","keyToShortKey","shortKey","shortKeyToKey","newScene","localMaster","deleteAllChildren","deleteChildren","deleteSerializable","delete","play","resizeCanvas","setSize","force","screen","innerWidth","innerHeight","previousWidth","previousHeight","pixels","quality","MAX_PIXELS","sqrt","screenResolution","gameResolution","scrollTo","getElementById","touchChange","preventDefault","touchCoordinates","getTouchCoordinates","controlArray","control","isPressed","find","coord","setState","touchEvent","targetTouches","touch","clientX","clientY","positionControls","playerFound","jumpSpeedFound","topDownFound","getComponents","characterController","controlType","jumpSpeed","controls","touchUp","setVisible","touchLeft","touchRight","touchDown","touchJump","touchA","touchB","visible","setPosition","setContainsFunction","rel","getRelativePositionToArrowCenter","abs","ARROW_HITBOX_RADIUS","visibleRightHandControls","rightHandControlArray","idx","idxFromRightWall","pos","getPosition","CONTROL_SIZE","getArrowCenter","leftPos","rightPos","add","divideScalar","center","subtract","this","CircularDependencyDetector","chain","currentType","link","_this","part","timeout","reset","pop","eventDispatcherCallbacks","eventDispatchedCallback","globalCircularDependencyDetector","EventDispatcher","listenerCounter","NUMBER_BIGGER_THAN_LISTENER_COUNT","_listeners","hasOwnProperty","index","eventListeners","circularDependencyEvent","Promise","all","results","promises","res","resolve","isClient","module","serializableCallbacks","serializableId","serializableClasses","Map","skipSerializableRegistering","_super","isRoot","tslib_1.__extends","deleteChild","_alive","_state","STATE_DESTROY","_children","child","STATE_INIT","addChildren","_addChild","STATE_ADDCHILD","set","STATE_ADDPARENT","setRootType","filterFunction","deep","foundChild","foundChild_1","findChild","_detachChild","processArray","forEachChild","newParent","_detach","json","arrays_1","Array","from","concat","JSON","stringify","constructor","initWithChildren","STATE_CLONE","rootType","childArray","Boolean","STATE_FROMJSON","Class","defineProperty","info","states","logState","state","stateString","createDebugObject","debug","ref","debugChildren","debugChildArray","gameChangesEnabled","sceneChangesEnabled","sceneChangeFilter","_initialValue","setPropertyType","_initialValueIsJSON","Property","initialValue","otherValue","newValue","oldValue","PROPERTY_VALUE_CHANGE","registerSerializable","description","flags","visibleIf","f","PropertyType","flag","propertyName","defaultValue","optionalParameters","dataType","isFlag","values","isArray","func","vec","scalar","newLength","oldLength","dot","dx","dy","lengthPart","acos","angleTo","setLength","atan2","cos","sin","rotate","verticalAngle","other","Color","round","hexString","FLOAT_JSON_PRECISION_MULTIPLIER","pow","float","parseFloat","range","Number","modulo","int","vector","fromObject","isEqualTo","string","String","longString","bool","enum","newColor","toHexString","_propertyOwnerClass","_propertyTypes","PropertyOwner","propName","propChildren","otherChildren","invalidPropertiesCount","propertyIdToInvalid","prop","nameToProp","_properties","propertyTypes","ClassAsTypeHolder","propertyTypeName","HASH","charCodeAt","DOT","parseQuery","tag","className","mode","offset","char","isHash","isDot","isEnd","ns","createElementNS","setAttribute","doUnmount","childEl","parentEl","hooks","__redom_lifecycle","hooksAreEmpty","__redom_mounted","traverse","trigger","parentHooks","hook","parentNode","hookNames","shadowRootAvailable","before","getEl","__redom_view","wasMounted","oldParent","insertBefore","appendChild","doMount","remount","hooksFound","hookName","triggered","ShadowRoot","setStyle","arg1","arg2","isString","setAttr","isSVG","SVGElement","isFunction","str","createTextNode","parseArguments","arg","isNumber","isNode","nodeType","htmlCache","memoizeHTML","html","len","arguments","cloneNode","Query","Function","bind","extend","sticky","ticker","shared","gradientCanvas","Sprite","layers","static","Game","defineProperties","startsWith","require","left","right","up","down","ctrl","appleLeft","appleRight","alt","shift","space","d","k","l","o","q","u","w","z","0","1","2","3","4","5","6","7","8","9","backspace","esc","plus","minus","questionMark","mouseDown","keyUpListeners","which","activeElement","nodeName","toLowerCase","EditorEvent","EditorEventDispatcher","dispatcher","dispatchWithResults","editorEventDispacher","Date","physicsOptions","enableSleeping","querySelector","mouseListeners","mousePosition","Scene","level","makeUpAName","createLayer","self","layer","Container","cameraPosition","cameraZoom","ui","behind","main","front","components","animationFrameId","playing","time","won","epr","createEntity","pause","destroy","setCameraPositionToPlayer","pivot","timeInMilliseconds","_prevUpdate","performanceTool.start","performanceTool.stop","draw","GAME_LEVEL_COMPLETED","requestAnimFrame","animFrame","requestAnimationFrame","updateCamera","render","SCENE_DRAW","performanceTool.eventHappened","resetting","unloadLevel","loadLevel","SCENE_RESET","cancelAnimationFrame","clearTimeout","SCENE_PAUSE","SCENE_START","SCENE_PLAY","component","Set","pixelDensity","worldPosition","multiply","screenPixels","screenPoint","zoomLevel","SCENE_ZOOM_CHANGED","resize","setScalars","componentClasses","automaticSceneEventListeners","onUpdate","onStart","_componentId","_listenRemoveFunctions","entity","Component","functionName","performanceName","performance.start","performance.stop","requirements","getComponent","_preInit","_addEventListener","addComponent","preInit","_init","init","sleep","removeComponent","_sleep","listenerFunction","sleeping","initWithPropertyValues","inheritedComponentData","category","icon","_h","_j","_k","_l","parentClass","_m","_o","allowMultiple","has","reservedPrototypeMembers","colorNum","reduce","constructorFunction","deleteFunction","call","Com","reservedPropertyNames","_name","componentClassName","predefinedComponentId","newComponentId","cloneComponentId","parentComponentData","getParentComponentData","getInheritedProperties","prp","getPropertyOrCreate","getProperty","getValue","create","ALIVE_ERROR","Entity","addComponents","fullInit","ent","initComponents","ENTITY_CREATION_DEBUGGING","preInitComponents","makeComponentsSleep","wakeUp","getInheritedComponentDatas","icd","comp","valueEquals","resetComponents","deleteComponents","compArray","proto","siblingId","previouslyCreatedEntity","Prototype","createSiblingId","cda","childTarget","path","getParent","siblingIds","siblingIds_1","this_1","prt","hasComponentData","propertyValue","componentDataIsNew","alsoFindFromParents","parent_1","findComponentDataByComponentId","_skipNewEntityEvent","inheritedComponentDatas","createWithInheritedComponentData","findChildren","entityPrototypeCount","levelIds","levels","entityPrototypes","foundInThisLevel","countEntityPrototypes","levelId","levelArray","getEntityPrototypesThatUseThisPrototype","_gameRoot","getRoot","lvl","items","nameProperty","oldScaleProperty","oldAngleProperty","getTransform","childArrays","floatToJSON","handleProperty","entityPrototype","newEntityPrototype","createFromPrototype","thisTransform","setValue","createEntityPrototype","nameId","transformId","positionId","scaleId","angleId","transformData","transformClass","Prefab","childEntityPrototype","prefab","prototypeTransform","pfa","Level","predefinedSceneObject","register","_debug","rotation","parentTransform","getParentTransform","listenProperty","parentEntity","zeroPoint","tempPoint","setGlobalPosition","getLocalPosition","globalPosition","getGlobalAngle","setGlobalAngle","newGlobalAngle","globalAngle","getGlobalScale","Point","positionVariance","isZero","scaleVariance","angleVariance","graphicsContainPointFunc","initSprite","redrawGraphics","updateTexture","textureAndAnchor","getTextureAndAnchor","selectableEntityOfSprite","selectableEntityHitTest","createPropertyHash","createGraphics","graphics","Graphics","lineStyle","borderWidth","borderColor","toHexNumber","beginFill","fillColor","drawRect","endFill","averageScale","drawCircle","radius","getConvexPoints","drawPolygon","vectorClass","takeScaleIntoAccount","minDistanceMultiplier","maxDistanceMultiplier","centerAngle","points","isNotEventPolygon","topPointDistance","segmentAngle","unitSegmentLength","defaultMinDistanceMultiplier","currentAngle","averageY_1","scale_1","resource","fromImage","lastSpawn","spawn","interval","onDrawHelper","save","strokeStyle","lineWidth","font","textAlign","fillText","strokeText","restore","spawnEntityToScene","storeProp","componentSet","entities_1","distSq","distanceSq","launchTrigger","action","win","dynamic","Body","DYNAMIC","kinematic","KINEMATIC","STATIC","SLEEPING","requiresInitWhenEntityIsEdited","inited","update","updatingOthers","Shapes","shapePropertiesThatShouldUpdateShape","updateShape","updateAABB","density","setDensity","updateMaterial","drag","damping","rotationalDrag","angularDamping","fixedRotation","updateMassProperties","bounciness","createBody","velocity","angularVelocity","sleepTimeLimit","sleepSpeedLimit","shapes","stepping","Shape","Box","Circle","Convex","vertices","addShape","updateMass","sleepState","newGlobalPosition","getMass","mass","applyForce","forceVector","setAngularForce","angularForce","startTime","lifetime","blendMode","particles","blendModes","initParticles","updateGlobalCoordinatesProperty","physicsEntity","Physics","positionListener","globalCoordinates","setParent","particleSize","particleHardness","alpha","particleLifetime","particleCount","firstBirth","alive","nextBirth","resetParticle","vx","speed","vy","speedRandom","randomSpeed","randomAngle","spawnType","spawnRadius","spawnRandom","speedToOutside","spawnRect","age","vel","followObject","spritePos","invParticleLifetime","accelerationX","acceleration","accelerationY","startColor","endColor","tint","startMultiplier","BLEND_MODES","ADD","normal","NORMAL","lastJumpTime","keyListener","keyboardControls","jump","getInput","moveTopDown","moveJumper","bodyVelocity","calculateNewVelocity","delta","checkIfCanJump","velocityVector","contactEquations","narrowphase","contact","bodyA","bodyB","normalA","dotProduct","jumpAddedToVelocity","normalY","input","breakInTheAir","absVel","breaking","animation","parseAnimationData","animationDataString","animationData","parse","animations","tracks","frames","fps","Animation","componendId","frameNumber","track","cId","prpName","Track","saveValue","keyFrames","frameCount","DEFAULT_FRAME_COUNT","keyFrameKeys","keyFrameKeys_1","keyFrameKey","highestKeyFrame","keyFrameKeys_2","animator","loadAnimation","Animator","controlPointDistanceFactor","anim","AnimatorAnimation","currentAnimation","animationLength","totalFrames","frame","setFrame","animationJSON","rootEntityPrototype","DEFAULT_FRAME_RATE","trackData","AnimatorTrack","getPrototypeByPath","animatedProperty","keyFrameFrames","keyFrameFrames_1","controlPoints","prevValue","currValue","nextValue","prevToCurr","currToNext","angleFactor","controlPointDistance","prevKeyFrameFrames","currKeyFrameFrames","speedIncreaseSq","prevControlDist","nextControlDist","prevNextDirection","rControl","gControl","bControl","prevFrame","nextFrame","changes","valueChanges","duplicateChange","sendChanges","profile","editAccess","openEditPlayUserId","openEditPlayUserToken","userToken","user","identifyYourself","reload","gameId","userId","errorMessage","message","isFatal","milliseconds","callbackLimitMode","callCallback","lastCall","queueTimeout","callCallbackWithDelay","delayMilliseconds","callLimitMode","timeToNextPossibleCall","elementId","keyBinding","requireTouchStart","TouchControl","bottom","screenWidth","screenHeight","offsetWidth","offsetHeight","containsFunc","distance","controlContainsATouch","isTouchStartEvent","oldState","classList","remove","passive","IS_TOUCH_DEVICE","navigator","maxTouchPoints","standalone","initElement","enableGameChanges","enableSceneChanges","_options","levelIndex","createScene","keyValue"],"mappings":"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"}