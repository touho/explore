!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t,e){if(!t)throw new Error(e)}function e(e){t(void 0===S[e.id],"Serializable id clash"),S[e.id]=e}function n(t){return S[t]||null}function r(t){if(!S[t])throw new Error("Serializable not found!");delete S[t]}function o(){O=null}function i(t){t!==O&&(O=t,w&&t&&t!==P&&(console.log("origin",P),P=t),setTimeout(o))}function a(e,n){if(t(O,"Change without origin!"),n.id){var r={type:e,reference:n,id:n.id,external:b,origin:O};e===E.setPropertyValue?r.value=n._value:e===E.move?r.parent=n._parent:e===E.addSerializableToTree&&(r.parent=n._parent,delete r.id),w&&console.log("change",r),x.forEach(function(t){return t(r)})}}function p(t){return i("external"),b?t():(b=!0,t(),void(b=!1))}function s(e){t("function"==typeof e),x.push(e)}function c(t){t.parent&&(t.parentId=t.parent.id),t.value&&(t.value=t.reference.propertyType.type.toJSON(t.value)),t.type===E.addSerializableToTree&&(t.value=t.reference.toJSON());var e={};return Object.keys(I).forEach(function(n){if(t[n]){if("type"===n&&t[n]===E.setPropertyValue)return;e[I[n]]=t[n]}}),e}function l(t){var e={};if(Object.keys(t).forEach(function(n){var r=N[n];e[r]=t[n]}),e.type||(e.type=E.setPropertyValue),e.reference=n(e.id),e.type===E.addSerializableToTree);else if(!e.reference)return console.error("received a change with unknown id",e),null;return e.parentId&&(e.parent=n(e.parentId)),e}function u(t){var e;p(function(){if(console.log("execute change",t),t.type===E.setPropertyValue)t.reference.value=t.reference.propertyType.type.fromJSON(t.value);else if(t.type===E.addSerializableToTree)if(t.parent){var n=z.fromJSON(t.value);t.parent.addChild(n),"ent"===n.threeLetterType&&(n.localMaster=!1)}else{var r=z.fromJSON(t.value);"sce"===r.threeLetterType&&(e=r)}else t.type===E.deleteAllChildren?t.reference.deleteChildren():t.type===E.deleteSerializable?t.reference.delete():t.type===E.move&&t.reference.move(t.parent)}),e&&e.play()}function h(){return A[Math.random()*D|0]}function d(t,e){void 0===t&&(t="???"),void 0===e&&(e=16);for(var n=t,r=e-1;0!==r;--r)n+=h();return n}function f(e,n,r){for(var o=[],i=arguments.length-3;i-- >0;)o[i]=arguments[i+3];r=r();var a=r.validators.default(),p="",s=[];return o.forEach(function(e){"string"==typeof e?p=e:e&&e.validate?a=e:e&&e.isFlag?s.push(e):t(!1,"invalid parameter "+e)}),new M(e,r,a,n,p,s)}function y(t,e){return void 0===e&&(e={}),e.isFlag=!0,e.type=t,e}function m(e){var n=e.name;void 0===n&&(n="");var r=e.validators;void 0===r&&(r={default:function(t){return t}});var o=e.toJSON;void 0===o&&(o=function(t){return t});var i=e.fromJSON;void 0===i&&(i=function(t){return t});var a=e.clone;void 0===a&&(a=function(t){return t}),t(n,"name missing from property type"),t("function"==typeof r.default,"default validator missing from property type: "+n),t("function"==typeof o,"invalid toJSON for property type: "+n),t("function"==typeof i,"invalid fromJSON for property type: "+n);var p={name:n,validators:r,toJSON:o,fromJSON:i,clone:a},s=function(){return p};return Object.keys(r).forEach(function(t){s[t]=v(t,r[t]),r[t]=s[t]}),s}function v(t,e){var n=function(){for(var n=arguments.length,r=Array(n);n--;)r[n]=arguments[n];var o=[].concat(r);return{validatorName:t,validatorParameters:o,validate:function(t){return e.apply(void 0,[t].concat(o))},parameters:o}};return n.validatorName=t,n.validate=e,n}function _(t){if(isNaN(t)||t===1/0||t===-(1/0))throw new Error("Invalid float: "+t)}function g(t){return Q[t]||!1}function T(t){return"sce"===t.reference.getRoot().threeLetterType}function C(){if(!window.io)return setTimeout(C,10);pt=io();var t=[],e={};s(function(n){if("external"!==n.origin&&st&&!T(n)){if(n.type===E.setPropertyValue){var r=e[n.id];r&&t.splice(t.indexOf(r),1),e[n.id]=n}t.push(n)}}),setInterval(function(){if(0!==t.length){var n=t.map(c);t.length=0,e={},console.log("sending",n),pt.emit("c",n)}},100),pt.on("c",function(t){st&&(console.log("received",t),t.forEach(function(t){t=l(t),t&&u(t)}))})}var S={},w=0,E={addSerializableToTree:"a",setPropertyValue:"s",deleteSerializable:"d",move:"m",deleteAllChildren:"c"},I={id:"i",type:"t",value:"v",parentId:"p"},N={};Object.keys(I).forEach(function(t){N[I[t]]=t});var O,P,b=!1,x=[],A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",D=A.length,J=new Map,z=function n(r){if(void 0===r&&(r=!1),t(this.threeLetterType,"Forgot to Serializable.registerSerializable your class?"),this._children=new Map,this._listeners=[],this._isInTree=this.isRoot,r?(this._state|=n.STATE_PREDEFINEDID,this.id=r):this.id=d(this.threeLetterType),this.id.startsWith("?"))throw new Error("?");e(this),this._state|=n.STATE_CONSTRUCTOR};z.prototype.delete=function(){return this._parent?(this._parent.deleteChild(this),!1):(this.deleteChildren(),this._alive=!1,this._isInTree=!1,this._listeners.length=0,r(this.id),this._state|=z.STATE_DESTROY,!0)},z.prototype.deleteChildren=function(){this._children.size&&(this._children.forEach(function(t){t.forEach(function(t){t._parent=null,t.delete()})}),this._children.clear(),this._parent&&a(E.deleteAllChildren,this))},z.prototype.initWithChildren=function(e){return void 0===e&&(e=[]),t(!(this._state&z.STATE_INIT),"init already done"),this._state|=z.STATE_INIT,e.length>0&&this.addChildren(e),this},z.prototype.addChildren=function(t){for(var e=this,n=0;n<t.length;n++)e.addChild(t[n]);return this},z.prototype.addChild=function(t){return this._addChild(t),this._state|=z.STATE_ADDCHILD,this._isInTree&&a(E.addSerializableToTree,t),this},z.prototype._addChild=function(e){t(null===e._parent);var n=this._children.get(e.threeLetterType);return void 0===n&&(n=[],this._children.set(e.threeLetterType,n)),n.push(e),e._parent=this,e._state|=z.STATE_ADDPARENT,e.setInTreeStatus(this._isInTree),this},z.prototype.findChild=function(t,e){var n=this._children.get(t);return n?e?n.find(e)||null:n[0]:null},z.prototype.findParent=function(t,e){void 0===e&&(e=null);for(var n=this;n;){if(n.threeLetterType===t&&(!e||e(n)))return n;n=n._parent}return null},z.prototype.getRoot=function(){for(var t=this;t._parent;)t=t._parent;return t},z.prototype.deleteChild=function(t,e){return a(E.deleteSerializable,t),this._detachChild(t,e),t.delete(),this},z.prototype._detachChild=function(e,n){void 0===n&&(n=0);var r=this._children.get(e.threeLetterType);return t(r,"child not found"),r[n]!==e&&(n=r.indexOf(e)),t(n>=0,"child not found"),r.splice(n,1),0===r.length&&this._children.delete(e.threeLetterType),e._parent=null,e.setInTreeStatus(!1),this},z.prototype.forEachChild=function(t,e,n){function r(r){r.forEach(function(r){e(r),n&&r.forEachChild(t,e,!0)})}return void 0===t&&(t=null),void 0===n&&(n=!1),t?r(this._children.get(t)||[]):this._children.forEach(r),this},z.prototype.move=function(t){return t._addChild(this._detach()),a(E.move,this),this},z.prototype._detach=function(){return this._parent&&this._parent._detachChild(this),this},z.prototype.getParent=function(){return this._parent||null},z.prototype.getChildren=function(t){return this._children.get(t)||[]},z.prototype.toJSON=function(){var t=this,e={id:this.id};if(this._children.size>0){var n=[];Array.from(this._children.keys()).sort(function(t,e){return"prt"===t?-1:1}).forEach(function(e){return n.push(t._children.get(e))}),e.c=(r=[]).concat.apply(r,n).map(function(t){return t.toJSON()})}return e;var r},z.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},z.prototype.clone=function(){var t=new this.constructor,e=[];return this.forEachChild(null,function(t){e.push(t.clone())}),t.initWithChildren(e),this._state|=z.STATE_CLONE,t},z.prototype.listen=function(t,e){var n=this;return this._listeners.hasOwnProperty(t)||(this._listeners[t]=[]),this._listeners[t].push(e),function(){var r=n._listeners[t].indexOf(e);n._listeners[t].splice(r,1)}},z.prototype.dispatch=function(t){for(var e=this,n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];if(this._listeners.hasOwnProperty(t))for(var o=0;o<this._listeners[t].length;++o)try{e._listeners[t][o].apply(null,n)}catch(n){console.error("Event "+t+" listener crashed.",e._listeners[t][o],n)}},z.prototype.hasDescendant=function(t){var e=this;if(!t)return!1;for(var n=t._parent;n;){if(n===e)return!0;n=n._parent}return!1},z.prototype.setInTreeStatus=function(t){this._isInTree!==t&&(this._isInTree=t,this._children.forEach(function(e){e.forEach(function(e){return e.setInTreeStatus(t)})}))},z.fromJSON=function e(n){t("string"==typeof n.id&&n.id.length>5,"Invalid id.");var e=J.get(n.id.substring(0,3));t(e);var r;try{r=e(n)}catch(t){if(!window.force,!window.force)throw new Error;return null}var o=n.c?n.c.map(function(t){return z.fromJSON(t)}).filter(Boolean):[];return r._state&z.STATE_INIT?r.addChildren(o):r.initWithChildren(o),r._state|=z.STATE_FROMJSON,r},z.registerSerializable=function(e,n,r){void 0===r&&(r=null),e.prototype.threeLetterType=n,t("string"==typeof n&&3===n.length),r||(r=function(t){return new e(t.id)}),J.set(n,r)},z.prototype._parent=null,z.prototype._alive=!0,z.prototype._state=0,z.STATE_CONSTRUCTOR=1,z.STATE_INIT=2,z.STATE_ADDCHILD=4,z.STATE_ADDPARENT=8,z.STATE_CLONE=16,z.STATE_DESTROY=32,z.STATE_FROMJSON=64,z.STATE_PREDEFINEDID=128,z.prototype.isRoot=!1,Object.defineProperty(z.prototype,"debug",{get:function(){var t=this,e=this.threeLetterType;this._children.forEach(function(n,r){e+="|",e+="prp"===r?t.getChildren("prp").map(function(t){return t.name+"="+t._value}).join(", "):r+"("+n.length+")"}),e+="|state: ";var n=[],r=function(e,r){t._state&e&&n.push(r)};return r(z.STATE_CONSTRUCTOR,"constructor"),r(z.STATE_INIT,"init"),r(z.STATE_ADDCHILD,"add child"),r(z.STATE_ADDPARENT,"add parent"),r(z.STATE_CLONE,"clone"),r(z.STATE_DESTROY,"destroy"),r(z.STATE_FROMJSON,"from json"),r(z.STATE_PREDEFINEDID,"predefined id"),e+=n.join(", ")}}),Object.defineProperty(z.prototype,"debugChildren",{get:function(){function t(t){return"gam"===t?new function(){}:"sce"===t?new function(){}:"prt"===t?new function(){}:"prp"===t?new function(){}:"cda"===t?new function(){}:"com"===t?new function(){}:"epr"===t?new function(){}:"ent"===t?new function(){}:("lvl"===t,new function(){})}var e=[];this._children.forEach(function(t,n){e=e.concat(t)});var n=[];return e.forEach(function(e){var r=t(e.threeLetterType);r.debug=e.debug,r.ref=e;var o=e.debugChildArray;o&&o.length>0&&(r.children=o),n.push(r)}),n}});var j=function(e){function n(n){var r=n.value,o=n.predefinedId,i=n.name,a=n.propertyType,p=n.skipSerializableRegistering;void 0===p&&(p=!1),t(i,"Property without a name can not exist"),p||e.call(this,o),this._initialValue=r,a?this.setPropertyType(a):(this.name=i,this._initialValueIsJSON=!0)}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.setPropertyType=function(t){this.propertyType=t;try{void 0!==this._initialValue?this.value=this._initialValueIsJSON?t.type.fromJSON(this._initialValue):this._initialValue:this.value=t.initialValue}catch(e){console.log("Invalid value",e,t,this),this.value=t.initialValue}this.name=t.name},n.prototype.clone=function(t){return void 0===t&&(t=!1),new n({value:this.propertyType.type.clone(this.value),name:this.name,propertyType:this.propertyType,skipSerializableRegistering:t})},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{v:this.type.toJSON(this.value),n:this.propertyType.name})},n}(z);j.prototype.propertyType=null,Object.defineProperty(j.prototype,"type",{get:function(){return this.propertyType.type}}),Object.defineProperty(j.prototype,"value",{set:function(t){this._value=this.propertyType.validator.validate(t),this._isInTree&&a(E.setPropertyValue,this)},get:function(){return this._value}}),z.registerSerializable(j,"prp",function(t){return new j({value:t.v,predefinedId:t.id,name:t.n})}),Object.defineProperty(j.prototype,"debug",{get:function(){return"prp "+this.name+"="+this.value}});var M=function(e,n,r,o,i,a){var p=this;void 0===a&&(a=[]),t("string"==typeof e),t(e[0]>="a"&&e[0]<="z","Name of a property must start with lower case letter."),t(n&&"string"==typeof n.name),t(r&&"function"==typeof r.validate),this.name=e,this.type=n,this.validator=r,this.initialValue=o,this.description=i,this.flags={},a.forEach(function(t){return p.flags[t.type]=t})};M.prototype.getFlag=function(t){return this.flags[t.type]},M.prototype.createProperty=function(t){void 0===t&&(t={});var e=t.value,n=t.predefinedId,r=t.skipSerializableRegistering;return void 0===r&&(r=!1),new j({propertyType:this,value:e,predefinedId:n,name:this.name,skipSerializableRegistering:r})};var R=f;f.flagDegreesInEditor=y("degreesInEditor");var F=function(t,e){this.x=t||0,this.y=e||0};F.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},F.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},F.prototype.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},F.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this},F.prototype.divide=function(t){return this.x/=t.x,this.y/=t.y,this},F.prototype.divideScalar=function(t){return this.x/=t,this.y/=t,this},F.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},F.prototype.lengthSq=function(){return this.x*this.x+this.y*this.y},F.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},F.prototype.distanceSq=function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n},F.prototype.normalize=function(){var t=this.length();return 0===t?(this.x=1,this.y=0):this.divideScalar(t),this},F.prototype.horizontalAngle=function(){return Math.atan2(this.y,this.x)},F.prototype.verticalAngle=function(){return Math.atan2(this.x,this.y)},F.prototype.rotate=function(t){var e=this.x*Math.cos(t)-this.y*Math.sin(t),n=this.x*Math.sin(t)+this.y*Math.cos(t);return this.x=e,this.y=n,this},F.prototype.rotateTo=function(t){return this.rotate(t-this.verticalAngle())},F.prototype.isEqualTo=function(t){return this.x===t.x&&this.y===t.y},F.prototype.clone=function(){return new F(this.x,this.y)},F.prototype.toString=function(){return"["+this.x+", "+this.y+"]"},F.fromObject=function(t){return new F(t.x,t.y)};var L=4,k=Math.pow(10,L),B=1e-7;R.float=m({name:"float",validators:{default:function(t){return t=parseFloat(t),_(t),t},range:function(t,e,n){return t=parseFloat(t),_(t),Math.min(n,Math.max(e,t))},modulo:function(t,e,n){t=parseFloat(t),_(t);var r=n-e;return t<e?t+=(((e-t)/r|0)+1)*r:t>n-B&&(t-=(((t-n)/r|0)+1)*r),t}},toJSON:function(t){return Math.round(t*k)/k},fromJSON:function(t){return t}}),R.int=m({name:"int",validators:{default:function(t){return t=parseInt(t),_(t),t},range:function(t,e,n){return t=parseInt(t),_(t),Math.min(n,Math.max(e,t))}},toJSON:function(t){return t},fromJSON:function(t){return t}}),R.vector=m({name:"vector",validators:{default:function(t){if(!(t instanceof F))throw new Error;return t=t.clone(),t.x=parseFloat(t.x),t.y=parseFloat(t.y),_(t.x),_(t.y),t}},toJSON:function(t){return{x:Math.round(t.x*k)/k,y:Math.round(t.y*k)/k}},fromJSON:function(t){return F.fromObject(t)},clone:function(t){return t.clone()}}),R.string=m({name:"string",validators:{default:function(t){return t?String(t):""}},toJSON:function(t){return t},fromJSON:function(t){return t}}),R.bool=m({name:"bool",validators:{default:function(t){if("boolean"!=typeof t)throw new Error;return t}},toJSON:function(t){return t?1:0},fromJSON:function(t){return!!t}}),R.enum=m({name:"enum",validators:{default:function(){t(!1,"also specify enum values with Prop.enum.values('value1', 'value2', ...)")},values:function t(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];if(!Array.isArray(t))throw new Error;if("string"!=typeof e)throw new Error("val should be string");if(t.indexOf(e)<0)throw new Error("value not in enum");return e}},toJSON:function(t){return t},fromJSON:function(t){return t}});var V=function(e){function n(n){void 0===n&&(n=!1),t(Array.isArray(this.constructor._propertyTypes),"call PropertyOwner.defineProperties after class definition"),e.call(this,n),this._properties={}}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.initWithPropertyValues=function(e){var n=this;void 0===e&&(e={});var r=[];return Object.keys(e).forEach(function(o){var i=n.constructor._propertyTypesByName[o];t(i,"Invalid property "+o),r.push(i.createProperty({value:e[o]}))}),this.initWithChildren(r),this},n.prototype.initWithChildren=function(n){var r=this;void 0===n&&(n=[]),t(!(this._state&e.STATE_INIT),"init already done"),this._state|=e.STATE_INIT;var o=[],i=[];n.forEach(function(t){"prp"===t.threeLetterType?o.push(t):i.push(t)}),e.prototype.addChildren.call(this,i);var a=0;o.filter(function(t){return!t.propertyType}).forEach(function(t){return r.constructor._propertyTypesByName[t.name]?void t.setPropertyType(r.constructor._propertyTypesByName[t.name]):(console.log("Property of that name not defined",r.id,t.name,r),a++,void(t.isInvalid=!0))}),a&&(o=o.filter(function(t){return!t.isInvalid}));var p={};o.forEach(function(t){return p[t.name]=t}),this.constructor._propertyTypes.forEach(function(t){p[t.name]||o.push(t.createProperty())}),e.prototype.addChildren.call(this,o)},n.prototype.addChild=function(n){if(t(this._state&e.STATE_INIT,this.constructor.componentName+" requires that initWithChildren will be called before addChild"),e.prototype.addChild.call(this,n),"prp"===n.threeLetterType){if(!n.propertyType){if(!this.constructor._propertyTypesByName[n.name])return void console.log("Property of that name not defined",this.id,n,this);n.setPropertyType(this.constructor._propertyTypesByName[n.name])}t(void 0===this._properties[n.propertyType.name],"Property already added"),this._properties[n.propertyType.name]=n}},n.prototype.delete=function(){return!!e.prototype.delete.call(this)&&(this._properties={},!0)},n.prototype.deleteChild=function(n,r){t("prp"!==n.threeLetterType,"Can not delete just one Property child."),e.prototype.deleteChild.call(this,n,r)},n}(z);V.defineProperties=function(e,n){e._propertyTypes=n,e._propertyTypesByName={},n.forEach(function(n){t(void 0===e.prototype[n.name],"Property name "+n.name+" clashes"),e._propertyTypesByName[n.name]=n,Object.defineProperty(e.prototype,n.name,{get:function(){return this._properties[n.name].value},set:function(t){this._properties[n.name].value=t}})})};var W="entity is already dead",q=function(e){function n(t){void 0===t&&(t=!1),e.call(this,t),this.components=new Map,this.sleeping=!1,this.prototype=null,this.localMaster=!0}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.getComponent=function(e){t(this._alive,W);var n=this.components.get(e);return void 0!==n?n[0]:null},n.prototype.getComponents=function(e){return t(this._alive,W),this.components.get(e)||[]},n.prototype.getListOfAllComponents=function(){var t=[];return this.components.forEach(function(e,n){t.push.apply(t,e)}),t},n.prototype.clone=function(){var t=new n;t.prototype=this.prototype,t.sleeping=this.sleeping;var e=[];return this.components.forEach(function(t,n){e.push.apply(e,t.map(function(t){return t.clone()}))}),t.addComponents(e),t},n.prototype.addComponents=function(e){var r=this;t(this._alive,W),t(Array.isArray(e),"Parameter is not an array.");for(var o=0;o<e.length;o++){var i=r.components.get(e[o]._name)||r.components.set(e[o]._name,[]).get(e[o]._name);i.push(e[o]),e[o].entity=r,e[o]._parent=r}return this.sleeping||n.initComponents(e),this},n.initComponents=function(t){for(var e=0;e<t.length;e++)t[e]._preInit();for(var n=0;n<t.length;n++)t[n]._init()},n.makeComponentsSleep=function(t){for(var e=0;e<t.length;e++)t[e]._sleep()},n.deleteComponents=function(t){for(var e=0;e<t.length;e++)t[e].delete()},n.prototype.sleep=function(){return t(this._alive,W),!this.sleeping&&(this.components.forEach(function(t,e){return n.makeComponentsSleep(t)}),this.sleeping=!0,!0)},n.prototype.wakeUp=function(){return t(this._alive,W),!!this.sleeping&&(this.components.forEach(function(t,e){return n.initComponents(t)}),this.sleeping=!1,!0)},n.prototype.delete=function(){return t(this._alive,W),this.sleep(),!!e.prototype.delete.call(this)&&(this.components.forEach(function(t,e){return n.deleteComponents(t)}),this.components.clear(),!0)},n.prototype.deleteComponent=function(e){var n=this.getComponents(e.constructor.componentName),r=n.indexOf(e);return t(r>=0),this.sleeping||e._sleep(),e.delete(),n.splice(r,1),this},n.prototype.setInTreeStatus=function(t){this._isInTree!==t&&(this._isInTree=t,this.components.forEach(function(e,n){e.forEach(function(e){return e.setInTreeStatus(t)})}))},n.prototype.toJSON=function(){t(this._alive,W);var n=[];return this.components.forEach(function(t){t.forEach(function(t){n.push(t.toJSON())})}),Object.assign(e.prototype.toJSON.call(this),{comp:n,proto:this.prototype.id})},n}(z);Object.defineProperty(q.prototype,"position",{get:function(){return this.getComponent("Transform").position},set:function(t){this.getComponent("Transform").position=t}}),z.registerSerializable(q,"ent",function(t){console.log("creating entity from json",t);var e=new q(t.id);return e.prototype=getSerializable(t.proto),console.log("created entity from json",e),t.comp&&e.addComponents(t.comp.map(z.fromJSON)),e});var H=null,U=function(t){function e(e){if(void 0===e&&(e=!1),H)try{H.delete()}catch(t){console.warn("Deleting old scene failed",t)}H=this,this.canvas=document.querySelector("canvas.anotherCanvas"),this.context=this.canvas.getContext("2d"),this.level=null,this.animationFrameId=null,this.playing=!1,this.time=0,t.call(this,e),a(E.addSerializableToTree,this),e?console.log("scene import"):console.log("scene created"),this.draw()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.animFrame=function(t){if(this.animationFrameId=null,this._alive&&this.playing){var e=.001*performance.now(),n=e-this._prevUpdate;n>.1&&(n=.1),this._prevUpdate=e,this.time+=n,i(this),this.dispatch("onUpdate",n,this.time),this.draw(),this.requestAnimFrame()}},e.prototype.requestAnimFrame=function(){var t=this;this.animationFrameId=window.requestAnimationFrame(function(){return t.animFrame()})},e.prototype.draw=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.dispatch("onDraw",this.context)},e.prototype.isInInitialState=function(){return!this.playing&&0===this.time},e.prototype.reset=function(){this.pause(),this.deleteChildren(),this.level&&this.level.createScene(this),this.time=0,this.draw()},e.prototype.pause=function(){this.playing&&(this.playing=!1,this.animationFrameId&&window.cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)},e.prototype.play=function(){this.playing||(this._prevUpdate=.001*performance.now(),this.playing=!0,this.requestAnimFrame(),0===this.time&&this.dispatch("onStart"))},e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(H===this&&(H=null),console.log("scene.delete"),!0)},e}(z);U.prototype.isRoot=!0,z.registerSerializable(U,"sce");var Y=function(e){function n(n,r,o){void 0===r&&(r=!1),void 0===o&&(o=!1),this.name=n,this.componentClass=X.get(this.name),t(this.componentClass,"Component class not defined: "+n),e.call(this,r),this.componentClass.allowMultiple||(o="_"+n),this.componentId=o||d("cid",10)}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.addChild=function(t){if("prp"===t.threeLetterType&&!t.propertyType){if(!this.componentClass._propertyTypesByName[t.name])return void console.log("Property of that name not defined",this.id,t,this);t.setPropertyType(this.componentClass._propertyTypesByName[t.name])}return e.prototype.addChild.call(this,t),this},n.prototype.clone=function(){var t=new n(this.name),r=[];return this.forEachChild(null,function(t){r.push(t.clone())}),t.initWithChildren(r),this._state|=e.STATE_CLONE,t},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{cid:this.componentId,n:this.name})},n.prototype.getInheritedProperties=function(t){void 0===t&&(t=0);var e={},n=this.getParentComponentData();return n&&n.getInheritedProperties(t+1).forEach(function(t){return e[t.name]=t}),this.getChildren("prp").forEach(function(n){0===t?e[n.name]=n:e[n.name]=n.clone(!0)}),0===t?this.componentClass._propertyTypes.map(function(t){return e[t.name]||t.createProperty({skipSerializableRegistering:!0})}):Object.keys(e).map(function(t){return e[t]})},n.prototype.getParentComponentData=function(){var t=this;if(!this._parent)return null;for(var e=this._parent.getParentPrototype();e;){var n=e.findChild("cda",function(e){return e.componentId===t.componentId});if(n)return n;e=e.getParentPrototype()}return null},n.prototype.getPropertyOrCreate=function(t){var e=this.findChild("prp",function(e){return e.name===t});return e||(e=this.componentClass._propertyTypesByName[t].createProperty(),this.addChild(e)),e},n.prototype.getProperty=function(t){return this.findChild("prp",function(e){return e.name===t})},n.prototype.setValue=function(t,e){return this.getPropertyOrCreate(t).value=e,this},n.prototype.getValue=function(t){var e=this.getProperty(t);if(e)return e.value;var n=this.getParentComponentData();return n?n.getValue(t):this.componentClass._propertyTypesByName[t].initialValue},n.prototype.createComponent=function(){var t=this.getInheritedProperties(),e={};t.forEach(function(t){e[t.name]=t.value});var n=Z.create(this.name,e);return n._componentId=this.componentId,n},n}(z);z.registerSerializable(Y,"cda",function(t){return new Y(t.n,t.id,t.cid)});var X=new Map,Z=function(e){function n(t){void 0===t&&(t=!1),e.call(this,t),this._componentId=null,this.scene=H,this.game=it,this._listenRemoveFunctions=[],this.entity=null}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.delete=function(){return this._parent=null,this.entity=null,e.prototype.delete.call(this),!0},n.prototype._preInit=function(){var e=this;this.constructor.requirements.forEach(function(n){e[n]=e.entity.getComponent(n),t(e[n],e.constructor.componentName+" requires component "+n+" but it is not found")}),this.forEachChild("com",function(t){return t._preInit()}),["onUpdate","onDraw","onDrawHelper","onStart"].forEach(function(t){"function"==typeof e[t]&&e._listenRemoveFunctions.push(e.scene.listen(t,function(){for(var n=[],r=arguments.length;r--;)n[r]=arguments[r];return(o=e)[t].apply(o,n);var o}))});try{"function"==typeof this.preInit&&this.preInit()}catch(t){console.error(this.entity,this.constructor.componentName,"preInit",t)}},n.prototype._init=function(){this.forEachChild("com",function(t){return t._init()});try{"function"==typeof this.init&&this.init()}catch(t){console.error(this.entity,this.constructor.componentName,"init",t)}},n.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(t){console.error(this.entity,this.constructor.componentName,"sleep",t)}this.forEachChild("com",function(t){return t._sleep()}),this._listenRemoveFunctions.forEach(function(t){return t()}),this._listenRemoveFunctions.length=0},n.prototype.createComponentData=function(){var t=this,e=this.constructor.componentName,n=this.constructor._propertyTypes,r=new Y(e),o=[];return n.forEach(function(e){o.push(e.createProperty({value:t[e.name]}))}),r.initWithChildren(o),r},n.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{n:this.constructor.componentName,cid:this._componentId})},n}(V);Z.create=function(e,n){void 0===n&&(n={});var r=X.get(e);t(r);var o=new r;return o.initWithPropertyValues(n),o},Z.createWithInheritedComponentData=function(t){var e=new t.componentClass;e._componentId=t.componentId;var n=t.properties.map(function(t){return t.clone()});return e.initWithChildren(n),e},Z.reservedPropertyNames=new Set(["id","constructor","delete","children","entity","env","init","preInit","sleep","toJSON","fromJSON"]),Z.reservedPrototypeMembers=new Set(["id","children","entity","env","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentData","toJSON","fromJSON"]),Z.register=function(e){var n=e.name;void 0===n&&(n="");var r=e.description;void 0===r&&(r="");var o=e.category;void 0===o&&(o="Other");var i=e.icon;void 0===i&&(i="fa-puzzle-piece");var a=e.color;void 0===a&&(a="");var p=e.properties;void 0===p&&(p=[]);var s=e.requirements;void 0===s&&(s=["Transform"]);var c=e.children;void 0===c&&(c=[]);var l=e.parentClass;void 0===l&&(l=Z);var u=e.prototype;void 0===u&&(u={});var h=e.allowMultiple;void 0===h&&(h=!0),t(n,"Component must have a name."),t(n[0]>="A"&&n[0]<="Z","Component name must start with capital letter."),t(!X.has(n),"Duplicate component class "+n),Object.keys(u).forEach(function(e){Z.reservedPrototypeMembers.has(e)&&t(!1,"Component prototype can not have a reserved member: "+e)});var d=u.constructor,f=u.delete;delete u.constructor,delete u.delete;var y=function(t){function e(){t.apply(this,arguments),d&&d()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(f&&f(),!0)},e}(l);p.forEach(function(e){t(!Z.reservedPropertyNames.has(e.name),"Can not have property called "+e.name)}),V.defineProperties(y,p),y.componentName=n,y.category=o,s.indexOf("Transform")<0&&s.push("Transform"),y.requirements=s,y.children=c,y.description=r,y.allowMultiple=h,y.icon=i;var m=n.split("").reduce(function(t,e){return t+e.charCodeAt(0)},0);return y.color=a||"hsla("+m%360+", 40%, 60%, 1)",u._name=n,Object.assign(y.prototype,u),X.set(y.componentName,y),y},z.registerSerializable(Z,"com",function(t){var e=new(X.get(t.n))(t.id);return e._componentId=t.cid||null,e}),Z.register({name:"Transform",category:"Core",icon:"fa-dot-circle-o",allowMultiple:!1,properties:[f("position",new F(0,0),f.vector),f("scale",new F(1,1),f.vector),f("rotation",0,f.float,f.float.modulo(0,2*Math.PI),f.flagDegreesInEditor)]});var G=0;Z.register({name:"Test",category:"Core",properties:[f("name","Oh right",f.string),f("enum","yksi",f.enum,f.enum.values("yksi","kaksi","kolme","neljä")),f("topBarHelper",new F(0,1),f.vector),f("test"+ ++G,G,f.int),f("test"+ ++G,!1,f.bool),f("test"+ ++G,!0,f.bool)]});var K={left:37,right:39,up:38,down:40,ctrl:17,appleLeft:91,appleRight:93,alt:18,shift:16,space:32,a:65,z:90,0:48,1:49,9:57,backspace:8,enter:13,esc:27},Q={},$=[],tt=[];"undefined"!=typeof window&&(window.onkeydown=function(t){var e=t.which||t.keyCode;"input"==document.activeElement.nodeName.toLowerCase()&&e!==K.esc||(Q[e]=!0,$.forEach(function(t){return t(e)}))},window.onkeyup=function(t){var e=t.which||t.keyCode;Q[e]=!1,tt.forEach(function(t){return t(e)})}),Z.register({name:"Mover",properties:[f("change",new F(10,10),f.vector),f("userControlled",!1,f.bool),f("speed",1,f.float),f("rotationSpeed",0,f.float,"Degrees per second",f.flagDegreesInEditor)],prototype:{onUpdate:function(t,e){if(this.userControlled){if(!this.entity.localMaster)return;var n=0,r=0;g(K.left)&&(n-=1),g(K.right)&&(n+=1),g(K.up)&&(r-=1),g(K.down)&&(r+=1),n&&this.Transform.position.addScalarX(n*this.speed*t),r&&this.Transform.position.addScalarY(r*this.speed*t),(n||r)&&(this.Transform.position=this.Transform.position),n&&this.rotationSpeed&&(this.Transform.rotation+=t*n*this.rotationSpeed)}else{var o=new F(t,0).rotate(e*this.speed).multiply(this.change);this.Transform.position.copy(this.Transform.position).add(o),this.rotationSpeed&&(this.Transform.rotation+=t*this.rotationSpeed)}}}}),Z.register({name:"Rect",icon:"fa-stop",allowMultiple:!0,properties:[f("size",new F(10,10),f.vector),f("style","red",f.string),f("randomStyle",!1,f.bool)],prototype:{init:function(){this.randomStyle&&(this.style="hsl("+(360*Math.random()|0)+", 100%, 40%)")},onDraw:function(t){var e=this.Transform.position.x-this.size.x/2*this.Transform.scale.x,n=this.Transform.position.y-this.size.y/2*this.Transform.scale.y,r=this.size.x*this.Transform.scale.x,o=this.size.y*this.Transform.scale.y;
t.save(),t.fillStyle=this.style,t.translate(e+r/2,n+o/2),t.rotate(this.Transform.rotation),t.fillRect(-r/2,-o/2,r,o),t.restore()}}});var et=[f("name","No name",f.string)],nt=function(e){function n(){e.apply(this,arguments),this.previouslyCreatedEntity=null}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.addChild=function(n){"cda"!==n.threeLetterType||n.componentClass.allowMultiple||t(null===this.findChild("cda",function(t){return t.componentId===n.componentId}),"Can't have multiple "+n.name+" components. See Component.allowMultiple"),e.prototype.addChild.call(this,n)},n.prototype.getParentPrototype=function(){return this._parent&&"prt"===this._parent.threeLetterType?this._parent:null},n.prototype.getInheritedComponentDatas=function(t){function e(r,o){void 0===o&&(o=0);var i,a=r.getParentPrototype();i=a?e(a,o+1):{};var p=r.getChildren("cda");return p.forEach(function(e){t&&!t(e)||(i[e.componentId]||(i[e.componentId]={ownComponentData:null,componentClass:e.componentClass,componentId:e.componentId,propertyHash:{},threeLetterType:"icd",generatedForPrototype:n}),0===o&&(i[e.componentId].ownComponentData=e),e.getChildren("prp").forEach(function(t){i[e.componentId].propertyHash[t.name]=0===o?t:t.clone(!0)}))}),i}void 0===t&&(t=null);var n=this,r=e(this),o=Object.keys(r).map(function(t){return r[t]});return o.forEach(function(t){t.properties=t.componentClass._propertyTypes.map(function(e){return t.propertyHash[e.name]?t.propertyHash[e.name]:e.createProperty({skipSerializableRegistering:!0})}),delete t.propertyHash}),o.forEach(function(t){t.componentId}),o.sort(function(t,e){return t.componentClass.componentName.localeCompare(e.componentClass.componentName)})},n.prototype.createAndAddPropertyForComponentData=function(e,n,r){var o=e.componentClass._propertyTypesByName[n];t(o,"Invalid propertyName",n,e);var i=this.findChild("cda",function(t){return t.componentId===e.componentId}),a=!1;i||(console.log("no component data. create one",this,e),i=new Y(e.componentClass.componentName,!1,e.componentId),a=!0);var p=i.findChild("prp",function(t){return t.name===n});return p?(p.value=r,p):(p=o.createProperty({value:r}),i.addChild(p),a&&this.addChild(i),p)},n.prototype.findComponentDataByComponentId=function(t,e){void 0===e&&(e=!1);var n=this.findChild("cda",function(e){return e.componentId===t});if(n)return n;if(e){var r=this.getParentPrototype();if(r)return r.findComponentDataByComponentId(t,e)}return null},n.prototype.getOwnComponentDataOrInherit=function(t){var e=this.findComponentDataByComponentId(t,!1);if(!e){var n=this.findComponentDataByComponentId(t,!0);if(!n)return null;e=new Y(n.name,!1,t),this.addChild(e)}return e},n.prototype.findOwnProperty=function(t,e){var n=this.findComponentDataByComponentId(t);return n?n.getProperty(e):null},n.prototype.createEntity=function(){var t=new q,e=this.getInheritedComponentDatas(),n=e.map(Component.createWithInheritedComponentData);return t.addComponents(n),t.prototype=this,this.previouslyCreatedEntity=t,t},n.prototype.getValue=function(t,e){var n=this.findComponentDataByComponentId(t,!0);return n?n.getValue(e):void 0},n.prototype.countEntityPrototypes=function(t){var e=this;if(void 0===t&&(t=!1),"prt"!==this.threeLetterType)return 0;for(var n=0,r=it.getChildren("lvl"),o=r.length-1;o>=0;o--)for(var i=r[o].getChildren("epr"),a=i.length-1;a>=0;a--)i[a].prototype===e&&n++;return t&&this.forEachChild("prt",function(t){return n+=t.countEntityPrototypes(!0)}),n},n.prototype.delete=function(){var t=this;return!!e.prototype.delete.call(this)&&("prt"===this.threeLetterType&&it.forEachChild("lvl",function(e){for(var n=e.getChildren("epr"),r=n.length-1;r>=0;r--)n[r].prototype===t&&e.deleteChild(n[r],r)}),this.previouslyCreatedEntity=null,!0)},n}(V);V.defineProperties(nt,et),nt.create=function(t){return(new nt).initWithPropertyValues({name:t})},z.registerSerializable(nt,"prt");var rt=function(t){function e(e){void 0===e&&(e=!1),t.apply(this,arguments),this.prototype=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getTransform=function(){return this.findChild("cda",function(t){return"Transform"===t.name})},e.prototype.getParentPrototype=function(){return this.prototype},e.prototype.clone=function(){var t=this,n=new e;n.prototype=this.prototype;var r=n.id,o=[];return this.forEachChild(null,function(e){if("prp"===e.threeLetterType&&"name"===e.name){var n=new j({value:e.propertyType.type.clone(e.value),name:e.name,propertyType:t.propertyType,predefinedId:r+"_n"});o.push(n)}else if("cda"===e.threeLetterType&&"Transform"===e.name){var i=new Y("Transform",r+"_t"),a=i.componentClass._propertyTypesByName.position.createProperty({value:e.findChild("prp",function(t){return"position"===t.name}).value,predefinedId:r+"_p"});i.addChild(a);var p=i.componentClass._propertyTypesByName.scale.createProperty({value:e.findChild("prp",function(t){return"scale"===t.name}).value,predefinedId:r+"_s"});i.addChild(p);var s=i.componentClass._propertyTypesByName.rotation.createProperty({value:e.findChild("prp",function(t){return"rotation"===t.name}).value,predefinedId:r+"_r"});i.addChild(s),o.push(i)}else o.push(e.clone())}),n.initWithChildren(o),this._state|=z.STATE_CLONE,n},e.prototype.toJSON=function(){var t=this,e=this.getTransform(),n={id:this.id,p:this.prototype.id},r=[];this._children.forEach(function(t){r.push(t)});var o=(s=[]).concat.apply(s,r).filter(function(n){return n!==e&&n!==t._properties.name});o.length>0&&(n.c=o.map(function(t){return t.toJSON()}));var i=this.prototype,a=f.float().toJSON,p=function(t){"name"===t.name?i&&t.value===i.name||(n.n=t.value):"position"===t.name?(n.x=a(t.value.x),n.y=a(t.value.y)):"scale"===t.name?t.value.isEqualTo(new F(1,1))||(n.w=a(t.value.x),n.h=a(t.value.y)):"rotation"===t.name&&0!==t.value&&(n.a=a(t.value))};return p(this._properties.name),e.getChildren("prp").forEach(p),n;var s},e.prototype.spawnEntityToScene=function(t){if(H){t&&(this.getTransform().getPropertyOrCreate("position").value=t);var e=this.createEntity();H.addChild(e)}},e}(nt);Object.defineProperty(rt.prototype,"position",{get:function(){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value},set:function(t){return this.getTransform().findChild("prp",function(t){return"position"===t.name}).value=t}}),rt.createFromPrototype=function(e,n){void 0===n&&(n=[]);var r=new rt;r.prototype=e;var o=r.id;t(!n.find(function(t){return"Transform"===t.name}),"Prototype (prt) can not have a Transform component");var i=new Y("Transform",o+"_t");n.push(i);var a=i.componentClass._propertyTypesByName.position.createProperty({value:new F(0,0),predefinedId:o+"_p"});i.addChild(a);var p=i.componentClass._propertyTypesByName.scale.createProperty({value:new F(1,1),predefinedId:o+"_s"});i.addChild(p);var s=i.componentClass._propertyTypesByName.rotation.createProperty({value:0,predefinedId:o+"_r"});i.addChild(s);var c=rt._propertyTypesByName.name.createProperty({value:e.name,predefinedId:o+"_n"});return r.initWithChildren([c].concat(n)),r},z.registerSerializable(rt,"epr",function(t){var e=new rt(t.id);e.prototype=n(t.p);var r=t.id+"_n",o=t.id+"_t",i=t.id+"_p",a=t.id+"_s",p=t.id+"_r",s=nt._propertyTypesByName.name.createProperty({value:void 0===t.n?e.prototype.name:t.n,predefinedId:r}),c=new Y("Transform",o),l=X.get("Transform"),u=l._propertyTypesByName.position.createProperty({value:new F(t.x,t.y),predefinedId:i});c.addChild(u,"fromJSON");var h=l._propertyTypesByName.scale.createProperty({value:new F(void 0===t.w?1:t.w,void 0===t.h?1:t.h),predefinedId:a});c.addChild(h,"fromJSON");var d=l._propertyTypesByName.rotation.createProperty({value:t.a||0,predefinedId:p});return c.addChild(d,"fromJSON"),e.initWithChildren([s,c],"fromJSON"),e}),Z.register({name:"Spawner",properties:[f("typeName","",f.string)],prototype:{onStart:function(){this.spawn()},onDrawHelper:function(t){var e=30;this.Transform.position.x-e*this.Transform.scale.x/2,this.Transform.position.y-e*this.Transform.scale.y/2,e*this.Transform.scale.x,e*this.Transform.scale.y;t.save(),t.fillStyle="blue",t.strokeStyle="white",t.lineWidth=1,t.font="40px FontAwesome",t.textAlign="center",t.fillText("",this.Transform.position.x+2,this.Transform.position.y),t.strokeText("",this.Transform.position.x+2,this.Transform.position.y),t.restore()},spawn:function(){var t=this,e=this.game.findChild("prt",function(e){return e.name===t.typeName});e&&rt.createFromPrototype(e).spawnEntityToScene(this.Transform.position)}}});var ot=[f("name","No name",f.string)],it=null,at=function(t){function e(e){if(it)try{it.delete()}catch(t){console.warn("Deleting old game failed",t)}it=this,e?console.log("game import"):console.log("game created"),t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){return!!t.prototype.delete.call(this)&&(it===this&&(it=null),console.log("game.delete"),!0)},e}(V);V.defineProperties(at,ot),at.create=function(t){return(new at).initWithPropertyValues({name:t})},at.prototype.isRoot=!0,z.registerSerializable(at,"gam");var pt,st=!1;"undefined"!=typeof window&&C()});
//# sourceMappingURL=dist/explore.min.js.map