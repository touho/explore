function assert(e,t){if(!e)throw new Error(t)}function addSerializable(e){if(serializables[e.id])throw new Error("Serializable id clash!");serializables[e.id]=e}function getSerializable(e){return serializables[e]||null}function removeSerializable(e){if(!serializables[e])throw new Error("Serializable not found!");delete serializables[e]}function char(){return CHARACTERS[Math.random()*CHAR_COUNT|0]}function createStringId(e,t){void 0===e&&(e="???"),void 0===t&&(t=16);for(var r=e,o=t-1;0!==o;--o)r+=char();return r}function createPropertyType(e,t,r){for(var o=[],n=arguments.length-3;n-- >0;)o[n]=arguments[n+3];r=r();var i=r.validators.default(),a="";return o.forEach(function(e){"string"==typeof e?a=e:e&&e.validate?i=e:assert(!1,"invalid parameter "+e)}),new PropertyType(e,r,i,t)}function addDataType(e){var t=e.name;void 0===t&&(t="");var r=e.validators;void 0===r&&(r={default:function(e){return e}});var o=e.toJSON;void 0===o&&(o=function(e){return e});var n=e.fromJSON;void 0===n&&(n=function(e){return e}),assert(t,"name missing from property type"),assert("function"==typeof r.default,"default validator missing from property type: "+t),assert("function"==typeof o,"invalid toJSON for property type: "+t),assert("function"==typeof n,"invalid fromJSON for property type: "+t);var i={name:t,validators:r,toJSON:o,fromJSON:n},a=function(){return i};Object.keys(r).forEach(function(e){a[e]=createValidator(e,r[e]),r[e]=a[e]}),createPropertyType[t]=a}function createValidator(e,t){var r=function(){for(var r=arguments.length,o=Array(r);r--;)o[r]=arguments[r];var n=[].concat(o);return{validatorName:e,validatorParameters:n,validate:function(e){return t.apply(void 0,[e].concat(n))}}};return r.validatorName=e,r.validate=t,r}function createElement(e,t){for(var r,o,n,i=0,a=0,s=0;s<=e.length;s++){var p=e.charCodeAt(s);if(p===HASH||p===DOT||!p){if(0===i)r=0===s?"div":p?e.substring(a,s):e;else{var l=e.substring(a,s);1===i?o=l:n?n+=" "+l:n=l}a=s+1,i=p===HASH?1:2}}var c=t?document.createElementNS(t,r):document.createElement(r);return o&&(c.id=o),n&&(c.className=n),c}function text(e){return document.createTextNode(e)}function mount(e,t,r){var o=e.el||e,n=t.el||t;n.__redom_list&&(n=n.el),t===n&&n.__redom_view&&(t=n.__redom_view),t!==n&&(n.__redom_view=t),t.isMounted?t.remount&&t.remount():t.mount&&t.mount(),r?o.insertBefore(n,r.el||r):o.appendChild(n),t.isMounted?t.remounted&&t.remounted():(t.isMounted=!0,t.mounted&&t.mounted())}function unmount(e,t){var r=e.el||e,o=t.el||t;t===o&&o.__redom_view&&(t=o.__redom_view),t.unmount&&t.unmount(),r.removeChild(o),t.isMounted=!1,t.unmounted&&t.unmounted()}function el(e){var t,r=arguments;if("string"==typeof e)t=(elcache[e]||(elcache[e]=createElement(e))).cloneNode(!1);else{if(!e||!e.nodeType)throw new Error("At least one argument required");t=e.cloneNode(!1)}for(var o=!0,n=1;n<arguments.length;n++){var i=r[n];if(i)if("function"==typeof i)i(t);else if("string"==typeof i||"number"==typeof i)o?(o=!1,t.textContent=i):t.appendChild(text(i));else if(i.nodeType||i.el&&i.el.nodeType)o=!1,mount(t,i);else if(i.length){o=!1;for(var a=0;a<i.length;a++)mount(t,i[a])}else if("object"==typeof i)for(var s in i){var p=i[s];if("style"===s)if("string"==typeof p)t.setAttribute(s,p);else for(var l in p)t.style[l]=p[l];else s in t||"function"==typeof p?t[s]=p:t.setAttribute(s,p)}}return t}function setChildren(e,t){for(var r=e.el||e,o=r.firstChild,n=0;n<t.length;n++){var i=t[n];if(i){var a=i.el||i;a!==o?mount(e,i,o):o=o.nextSibling}}for(;o;){var s=o.nextSibling;unmount(e,o),o=s}}function list(e,t,r,o){return new List(e,t,r,o)}function List(e,t,r,o){this.__redom_list=!0,this.View=t,this.key=r,this.initData=o,this.views=[],this.el="string"==typeof e?el(e):e,r&&(this.lookup={})}var serializables={},CHARACTERS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",CHAR_COUNT=CHARACTERS.length,serializableClasses=new Map,Serializable=function(e){if(void 0===e&&(e=!1),assert(this._threeLetterType,"Forgot to Serializable.registerSerializable your class?"),this._children=new Map,this.id=e||createStringId(this._threeLetterType),this.id.startsWith("?"))throw new Error("?");addSerializable(this)};Serializable.prototype.delete=function(){return this._parent?void this._parent.deleteChild(this):(this._children.forEach(function(e){e.forEach(function(e){e._parent=null,e.delete()})}),this._children.clear(),void removeSerializable(this.id))},Serializable.prototype.addChildren=function(e){for(var t=this,r=0;r<e.length;r++)t.addChild(e[r]);return this},Serializable.prototype.addChild=function(e){var t=this._children.get(e._threeLetterType);return void 0===t&&(t=[],this._children.set(e._threeLetterType,t)),t.push(e),e._parent=this,this},Serializable.prototype.findChild=function(e,t){var r=this._children.get(e);return r&&r.find(t)||null},Serializable.prototype.getChildrenByType=function(e){return this._children.get(e)||[]},Serializable.prototype.deleteChild=function(e){return this.detachChild(e),e.delete(),this},Serializable.prototype.detachChild=function(e){var t=this._children.get(e._threeLetterType),r=t.indexOf(e);return assert(r>=0,"child not found"),t.splice(r,1),e._parent=null,this},Serializable.prototype.forEachChild=function(e,t,r){function o(o){o.forEach(function(o){t(o),r&&o.forEachChild(e,t,!0)})}void 0===e&&(e=null),void 0===r&&(r=!1),e?o(this._children.get(e)||[]):this._children.forEach(o)},Serializable.prototype.detach=function(){return this._parent&&this._parent.detachChild(this),this},Serializable.prototype.getParent=function(){return this._parent||null},Serializable.prototype.getChildren=function(e){return this._children.get(e)||[]},Serializable.prototype.toJSON=function(){var e={id:this.id};if(this._children.size>0){var t=[];this._children.forEach(function(e){return t.push(e)}),e.c=(r=[]).concat.apply(r,t)}return e;var r},Serializable.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},Serializable.prototype.markDirty=function(){this._dirty=!0,this._parent&&this._parent.markDirty()},Serializable.fromJSON=function e(t){assert("string"==typeof t.id&&t.id.length>3);var e=serializableClasses.get(t.id.substring(0,3));assert(e);var r=e(t);return r.addChildren(t.c?t.c.map(function(e){return Serializable.fromJSON(e)}):[]),r},Serializable.registerSerializable=function(e,t,r){void 0===r&&(r=null),e.prototype._threeLetterType=t,assert("string"==typeof t&&3===t.length),r||(r=function(t){return new e(t.id)}),serializableClasses.set(t,r)},Serializable.prototype._dirty=!0,Serializable.prototype._parent=null;var Property=function(e){function t(t){var r=t.value,o=t.predefinedId,n=t.name,i=t.propertyType;assert(n,"Property without a name can not exist"),e.call(this,o),this._initialValue=r,i?this.setPropertyType(i):this.name=n}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.setPropertyType=function(e){this.propertyType=e,this.value=void 0!==this._initialValue?this._initialValue:e.initialValue,this.name=e.name},t.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{v:this.type.toJSON(this.value),n:this.propertyType.name})},t.prototype.delete=function(){e.prototype.delete.call(this),this.model=null},t}(Serializable);Property.prototype.propertyType=null,Object.defineProperty(Property.prototype,"type",{get:function(){return this.propertyType.type}}),Object.defineProperty(Property.prototype,"value",{set:function(e){this._value=this.propertyType.validator.validate(e),this.markDirty()},get:function(){return this._value}}),Property.fromJSON=function(e){return{value:e.v,predefinedId:e.id}},Serializable.registerSerializable(Property,"prp",function(e){return new Property({value:e.v,predefinedId:e.id,name:e.n})});var PropertyType=function(e,t,r,o){assert("string"==typeof e),assert(t&&"string"==typeof t.name),assert(r&&"function"==typeof r.validate),this.name=e,this.type=t,this.validator=r,this.initialValue=o};PropertyType.prototype.createProperty=function(e){void 0===e&&(e={});var t=e.value,r=e.predefinedId;return new Property({propertyType:this,value:t,predefinedId:r,name:this.name})},addDataType({name:"float",validators:{default:function(e){return e=parseFloat(e),assert(!isNaN(e),"invalid float: "+e),e},range:function(e,t,r){return e=parseFloat(e),assert(!isNaN(e),"invalid float: "+e),Math.min(r,Math.max(t,e))}},toJSON:function(e){return e},fromJSON:function(e){return e}}),addDataType({name:"string",validators:{default:function(e){return e?String(e):""}},toJSON:function(e){return e},fromJSON:function(e){return e}});var PropertyOwner=function(e){function t(t){void 0===t&&(t=!1),assert(Array.isArray(this.constructor._propertyTypes),"call PropertyOwner.defineProperties after class definition"),e.call(this,t),this._properties={}}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.initWithPropertyValues=function(e){var t=this;void 0===e&&(e={});var r=[];return Object.keys(e).forEach(function(o){var n=t.constructor._propertyTypesByName[o];assert(n,"Invalid property "+o),r.push(n.createProperty({value:e[o]}))}),this.addChildren(r),this},t.prototype.addChildren=function(t){var r=this;void 0===t&&(t=[]),this._addChildrenCalled=!0;var o=[],n=[];if(t.forEach(function(e){"prp"===e._threeLetterType?o.push(e):n.push(e)}),e.prototype.addChildren.call(this,n),0!==o.length){var i=0;o.filter(function(e){return!e.propertyType}).forEach(function(e){return r.constructor._propertyTypesByName[e.name]?void e.setPropertyType(r.constructor._propertyTypesByName[e.name]):(console.log("Property of that name not defined",r.id,e.name,r),i++,void(e.isInvalid=!0))}),i&&(o=o.filter(function(e){return!e.isInvalid}));var a={};o.forEach(function(e){return a[e.name]=e}),this.constructor._propertyTypes.forEach(function(e){a[e.name]||o.push(e.createProperty())}),e.prototype.addChildren.call(this,o)}},t.prototype.addChild=function(t){if(assert(this._addChildrenCalled,this.constructor.name+" requires that addChildren will be called before addChild"),e.prototype.addChild.call(this,t),"prp"===t._threeLetterType){if(!t.propertyType){if(!this.constructor._propertyTypesByName[t.name])return void console.log("Property of that name not defined",this.id,t,this);t.setPropertyType(this.constructor._propertyTypesByName[t.name])}assert(void 0===this._properties[t.propertyType.name],"Property already added"),this._properties[t.propertyType.name]=t}},t.prototype.delete=function(){e.prototype.delete.call(this),this._properties={}},t.prototype.deleteChild=function(t){assert("prp"!==t._threeLetterType,"Can not delete just one Property child."),e.prototype.deleteChild.call(this,t)},t}(Serializable);PropertyOwner.defineProperties=function(e,t){e._propertyTypes=t,e._propertyTypesByName={},t.forEach(function(t){assert(void 0===e.prototype[t.name],"Property name "+t.name+" clashes"),e._propertyTypesByName[t.name]=t,Object.defineProperty(e.prototype,t.name,{get:function(){return this._properties[t.name].value},set:function(e){this._properties[t.name].value=e}})})};var componentClasses=new Map,Component=function(e){function t(t,r,o){e.call(this,"com"),this.entity=r,this.env=o,this.children={},this._componentData=t}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.delete=function(){assert(!this.env.entity.alive,"Do not call Component.delete!"),e.prototype.delete.call(this)},t.prototype._preInit=function(){var e=this;this.constructor.requirements.forEach(function(t){e[t]=e.entity.getComponent(t),assert(e[t],"required component not found")}),this._forEachChildComponent(function(e){return e._preInit()});try{"function"==typeof this.preInit&&this.preInit()}catch(e){console.error(this.entity,this.constructor.componentName,"preInit",e)}},t.prototype._init=function(){this._forEachChildComponent(function(e){return e._init()});try{"function"==typeof this.init&&this.init()}catch(e){console.error(this.entity,this.constructor.componentName,"init",e)}},t.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(e){console.error(this.entity,this.constructor.componentName,"sleep",e)}this._forEachChildComponent(function(e){return e._sleep()})},t.prototype._forEachChildComponent=function(e){var t=this;Object.keys(this.children).forEach(function(r){var o=t.children[r];Array.isArray(o)?o.forEach(e):e(o)})},t.prototype.toJSON=function(){return Object.assign(e.prototype.toJSON.call(this),{n:this.constructor.componentName})},t}(PropertyOwner);Component.reservedPropertyNames=new Set(["id","constructor","delete","children","entity","env","init","preInit","sleep","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentData","toJSON","fromJSON"]),Component.reservedPrototypeMembers=new Set(["id","children","entity","env","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentData","toJSON","fromJSON"]),Component.register=function(e){var t=e.name;void 0===t&&(t="");var r=e.description;void 0===r&&(r="");var o=e.category;void 0===o&&(o="Other");var n=e.icon;void 0===n&&(n="fa-bars");var i=e.properties;void 0===i&&(i=[]);var a=e.requirements;void 0===a&&(a=[]);var s=e.children;void 0===s&&(s=[]);var p=e.parentClass;void 0===p&&(p=Component);var l=e.prototype;void 0===l&&(l={}),assert(t,"Component must have a name."),assert(!componentClasses.has(t),"Duplicate component class "+t),Object.keys(l).forEach(function(e){Component.reservedPrototypeMembers.has(e)&&assert(!1,"Component prototype can not have a reserved member: "+e)});var c=l.constructor,u=l.delete;delete l.constructor,delete l.delete;var d=function(e){function t(){e.apply(this,arguments),c&&c()}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.delete=function(){e.prototype.delete.apply(this,arguments),u&&u()},t}(p);return i.forEach(function(e){assert(!Component.reservedPropertyNames.has(e.name),"Can not have property called "+e.name)}),PropertyOwner.defineProperties(d,i),d.componentName=t,d.category=o,d.requirements=a,d.children=s,d.description=r,d.icon=n,Object.assign(d.prototype,l),componentClasses.set(d.componentName,d),d},Component.register({name:"Position",category:"Core",icon:"fa-circle",properties:[createPropertyType("x",.1,createPropertyType.float),createPropertyType("y",.2,createPropertyType.float)]}),Component.register({name:"Test",category:"Core",icon:"fa-circle",properties:[createPropertyType("name","Oh right",createPropertyType.string),createPropertyType("number",666,createPropertyType.float)]});var propertyTypes$1=[createPropertyType("name","No name",createPropertyType.string)],Prototype=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.copy=function(e){throw void 0===e&&(e={}),new Error("broken")},t}(PropertyOwner);PropertyOwner.defineProperties(Prototype,propertyTypes$1),Prototype.create=function(e){return(new Prototype).initWithPropertyValues({name:e})},Serializable.registerSerializable(Prototype,"prt");var propertyTypes=[createPropertyType("name","No name",createPropertyType.string)],Game=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(PropertyOwner);PropertyOwner.defineProperties(Game,propertyTypes),Game.create=function(e){return(new Game).initWithPropertyValues({name:e})},Serializable.registerSerializable(Game,"gam");var ALIVE_ERROR="entity is already dead",Entity=function(e){function t(){e.call(this,"ent"),this.components=new Map,this.alive=!0,this.sleeping=!1,this.prototype=null}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.getComponent=function(e){assert(this.alive,ALIVE_ERROR);var t=this.components.get(e);return void 0!==t?t[0]:null},t.prototype.getComponents=function(e){return assert(this.alive,ALIVE_ERROR),this.components.get(e)||[]},t.prototype.addComponents=function(e){var r=this;assert(this.alive,ALIVE_ERROR),assert(Array.isArray(e),"Parameter is not an array.");for(var o=0;o<e.length;o++){var n=r.components.get(e[o].name)||r.components.set(e[o].name,[]).get(e[o].name);n.push(e[o])}return this.sleeping||t.initComponents(e),this},t.initComponents=function(e){for(var t=0;t<e.length;t++)e[t]._preInit();for(var r=0;r<e.length;r++)e[r]._init()},t.makeComponentsSleep=function(e){for(var t=0;t<e.length;t++)e[t]._sleep()},t.deleteComponents=function(e){for(var t=0;t<e.length;t++)e[t].delete()},t.prototype.sleep=function(){var e=this;if(assert(this.alive,ALIVE_ERROR),this.sleeping)return!1;for(var r=0,o=e.components;r<o.length;r+=1){var n=o[r];t.makeComponentsSleep(n)}return this.sleeping=!0,!0},t.prototype.wakeUp=function(){var e=this;if(assert(this.alive,ALIVE_ERROR),!this.sleeping)return!1;for(var r=0,o=e.components;r<o.length;r+=1){var n=o[r];t.initComponents(n)}return this.sleeping=!1,!0},t.prototype.delete=function(){var r=this;assert(this.alive,ALIVE_ERROR),this.sleep(),e.prototype.delete.call(this),this.alive=!1;for(var o=0,n=r.components;o<n.length;o+=1){var i=n[o];t.deleteComponents(i)}this.components.clear()},t.prototype.toJSON=function(){return assert(this.alive,ALIVE_ERROR),Object.assign(e.prototype.toJSON.call(this),{components:[]})},t}(Serializable);Serializable.registerSerializable(Entity,"ent",function(e){return new Entity(e.id)}),function(){var e=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t}(Serializable);Serializable.registerSerializable(e,"tes",function(t){return new e(t.id)});var t=new e,r=t.id;assert("string"==typeof r&&r.length>10);var o=t.toJSON();assert(o&&"object"==typeof o&&"string"==typeof o.id),t.delete(),t=Serializable.fromJSON(o),assert("string"==typeof t.id&&t.id.length>10&&t.id===r),console.log("Serializable tests OK")}(),function(){var e=new Entity;assert(0===e.components.size),assert(null===e.getComponent("moi")),assert(0===e.getComponents("moi").length),console.log("Entity tests OK")}(),function(){assert(4===createPropertyType.float.default().validate("4")),assert(1===createPropertyType.float.range(0,1).validate(3)),console.log("PropertyType tests OK")}(),Component.register({name:"Example",description:"Description of what this component does",category:"Core",icon:"fa-circle",requirements:["Position"],children:["Image","Image","Sound"],properties:[createPropertyType("variable",.5,createPropertyType.float,createPropertyType.float.range(0,1),"Description of the property"),createPropertyType("otherVar_iaerfperfjoierj","Hello",createPropertyType.string,"Description of the property")],parentClass:Component,prototype:{staticVariable:"Example class info",constructor:function(){this.hiddenVariable=3},preInit:function(){this.data={lotsOfData:123+this.variable+this.hiddenVariable}},init:function(){this.Position.x=this.Position.y+1,this.howToAccessChildren=[this.children.Image[0].property,this.children.Sound.property],this.SomeComponent=this.entity.getComponent("SomeComponent")},sleep:function(){this.data=null,this.SomeComponent=null,this.howToAccessChildren=null},delete:function(){}}});var listeners={},events={listen:function(e,t){return listeners.hasOwnProperty(e)||(listeners[e]=[]),listeners[e].push(t),function(){var r=listeners[e].indexOf(t);listeners[e].splice(r,1)}},dispatch:function(e){for(var t=[],r=arguments.length-1;r-- >0;)t[r]=arguments[r+1];if(listeners.hasOwnProperty(e))for(var o=0;o<listeners[e].length;++o)listeners[e][o].apply(null,t)}},HASH="#".charCodeAt(0),DOT=".".charCodeAt(0),elcache={};el.extend=function(e){var t=elcache[e]||(elcache[e]=createElement(e));return el.bind(this,t)},List.extend=function(e,t,r,o){return List.bind(List,e,t,r,o)},list.extend=List.extend,List.prototype.update=function(e){void 0===e&&(e=[]);for(var t=this.View,r=this.key,o="function"==typeof r,n=this.initData,i=new Array(e.length),a=this.views,s=r&&{},p=r&&this.lookup,l=0;l<e.length;l++){var c=e[l],u=void 0;if(r){var d=o?r(c):c[r];u=i[l]=p[d]||new t(n,c,l,e),s[d]=u,u.__id=d}else u=i[l]=a[l]||new t(n,c,l,e);var h=u.el;h.__redom_list&&(h=h.el),h.__redom_view=u,u.update&&u.update(c,l,e)}setChildren(this,i),r&&(this.lookup=s),this.views=i};var Router=function(e,t){this.el="string"==typeof e?el(e):e,this.Views=t};Router.prototype.update=function(e,t){if(e!==this.route){var r=this.Views,o=r[e];this.view=o&&new o,this.route=e,setChildren(this.el,[this.view])}this.view&&this.view.update&&this.view.update(t)};var ModuleContainer=function(e,t){var r=this;void 0===e&&(e="unknownClass.anotherClass"),void 0===t&&(t="fa-chevron-left"),this.modules=[],this.packButtonEnabled=!!t,this.el=el("div.moduleContainer.packable."+e,this.packButton=t&&el("i.packButton.button.iconButton.fa."+t),this.tabs=list("div.tabs",ModuleTab),this.moduleElements=el("div.moduleElements")),t&&(this.el.onclick=function(){return r.el.classList.contains("packed")&&r.el.classList.remove("packed")},this.packButton.onclick=function(e){r.el.classList.add("packed"),e.stopPropagation()}),events.listen("registerModule_"+e.split(".")[0],function(e,t){var o=new e;o.editor=t,o.state=t.state,o.el.classList.add("module-"+o.id),r.modules.push(o),1!==r.modules.length&&o._hide(),mount(r.moduleElements,o.el),r._updateTabs(),events.listen("activateModule_"+o.id,function(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];void 0===e&&(e=!0),e&&r.el.classList.remove("packed"),r._activateModule(o,t)})}),this._updateTabs()};ModuleContainer.prototype.update=function(){this.modules.forEach(function(e){return e.update()})},ModuleContainer.prototype._updateTabs=function(){this.tabs&&(this.tabs.update(this.modules),!this.packButtonEnabled&&this.modules.length<=1?this.tabs.el.style.display="none":this.tabs.el.style.display="block")},ModuleContainer.prototype._activateModule=function(e,t){this.modules.indexOf(e);this.modules.forEach(function(t){t!==e&&t._hide()}),e.activate.apply(e,t),e._show(),this._updateTabs()};var ModuleTab=function(){var e=this;this.el=el("span.moduleTab.button"),this.module=null,this.el.onclick=function(){events.dispatch("activateModule_"+e.module.id)}};ModuleTab.prototype.update=function(e){this.module=e,this.el.textContent=e.name,this.el.classList.toggle("active",e._visible)};var Layout=function(){var e=this;this.moduleContainers=[];var t=function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];var o=new(Function.prototype.bind.apply(ModuleContainer,[null].concat(t)));return e.moduleContainers.push(o),o};this.el=el("div.editorLayout",el("div.nonRight",t("top",null),el("div.bottomLeft",t("left","fa-chevron-left"),el("div.middle",t("center",null),t("bottom","fa-chevron-down")))),t("right","fa-chevron-right"))};Layout.prototype.update=function(e){this.moduleContainers.forEach(function(t){return t.update(e)})};var Module=function(){for(var e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];this.name=this.name||"Module",this.id=this.id||"module",this.el=el.apply(void 0,["div.module"].concat(t)),this._visible=!0};Module.prototype.activate=function(){},Module.prototype.update=function(){},Module.prototype._show=function(){this.el.classList.remove("hidden"),this._visible=!0},Module.prototype._hide=function(){this.el.classList.add("hidden"),this._visible=!1},Module.activateModule=function(e,t){for(var r=[],o=arguments.length-2;o-- >0;)r[o]=arguments[o+2];void 0===t&&(t=!0),events.dispatch.apply(events,["activateModule_"+e,t].concat(r))},Module.packModuleContainer=function(e){document.querySelectorAll(".moduleContainer."+e)[0].classList.add("packed")},Module.unpackModuleContainer=function(e){document.querySelectorAll(".moduleContainer."+e)[0].classList.remove("packed")},Module.register=function(e,t){registerPromise=registerPromise.then(function(r){return events.dispatch("registerModule_"+t,e,r),r})};var nextTopBarPriorityNumber=1;Module.registerTopButton=function(e,t,r,o){void 0===o&&(o=nextTopBarPriorityNumber++),registerPromise=registerPromise.then(function(n){return events.dispatch("registerTopButton",e,t,r,o),n})};var registerPromise=new Promise(function(e){events.listen("registerModules",function(t){registerPromise.then(function(e){return events.dispatch("modulesRegistered"),e}),e(t)})}),TopBarModule=function(e){function t(){e.call(this,this.logo=el("img.logo.button.iconButton",{src:"../img/logo_reflection_medium.png"}),this.list=list("div.buttonContainer",TopButton)),this.id="topbar",this.name="TopBar"}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.update=function(){this.list.update(this.state.topButtons)},t}(Module);Module.register(TopBarModule,"top"),Module.registerTopButton("Bell Types","fa fa-bell-o",function(){Module.unpackModuleContainer("bottom"),Module.activateModule("types"),Module.activateModule("type")},1),Module.registerTopButton("Cube Instances","fa fa-cubes",function(){Module.activateModule("instances"),Module.activateModule("instance")},2);var TopButton=function(){var e=this;this.el=el("div.button.topIconTextButton",el("div.topIconTextButtonContent",this.icon=el("i.fa"),this.text=el("span"))),this.el.onclick=function(){e.callback&&e.callback()},this.callback=null};TopButton.prototype.update=function(e){this.icon.className=e.icon,this.text.textContent=e.text,this.callback=e.func};var PropertyEditor=function(){this.el=el("div"),this.editor=null};PropertyEditor.prototype.update=function(e){if($(this.el).empty(),"prt"===e.type&&1===e.items.length){var t=new Container;t.update(e.items[0]),mount(this.el,t)}};var Container=function e(){this.el=el("div",this.title=el("div"),this.properties=list("div",Property$2),this.containers=list("div",e),this.controls=el("div"))};Container.prototype.update=function(e){this.properties.update(e.getChildren("prp"));var t=[].concat(e.getChildren("cda"),e.getChildren("com"));this.containers.update(t),this.controls.innerHTML="",mount(this.controls,el("button","Press me"))};var Property$2=function(){var e=this;this.el=el("div",this.name=el("span"),this.input=el("input")),this.input.onchange=function(){e.property.value=e.input.value,events.dispatch("requestUpdate")}};Property$2.prototype.update=function(e){this.property=e,this.name.textContent=e.propertyType.name,this.input.value=e.value};var PropertyModule=function(e){function t(){e.call(this,this.propertyEditor=new PropertyEditor),this.id="type",this.name="Type"}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.update=function(){this.propertyEditor.update(this.state.selection)},t}(Module);Module.register(PropertyModule,"right");var propertyTypeToEditorType$1={float:"number",string:"text"},PropertyModule$1=function(e){function t(){e.call(this,this.propertyEditor=el("div.propertyEditor","hei")),this.id="instance",this.name="Instance"}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.update=function(){this.componentClasses=this.state.componentClasses;var e={editors:[{field:"yks",title:"YKS",type:"text"}]},t={},r=Array.from(this.componentClasses.values());r.forEach(function(r){var o={type:"group",field:r.name,title:r.name,editors:r._propertyTypes.map(function(e){return{field:r.name+"."+e.name,title:e.name.length>30?e.name.substring(0,28)+"..":e.name,type:propertyTypeToEditorType$1[e.type.name]||"text"}})};e.editors.push(o);var n={};r._propertyTypes.forEach(function(e){n[e.name]=e.initialValue}),t[r.name]=n}),new PJS($(this.propertyEditor),e,t)},t}(Module);Module.register(PropertyModule$1,"right");var SceneModule=function(e){function t(){e.call(this,this.content=el("span","moi test")),this.id="scene",this.name="Scene"}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.update=function(){},t}(Module);Module.register(SceneModule,"center");var Types=function(e){function t(){var t=this;e.call(this,this.addButton=el("span.addTypeButton.button.fa.fa-plus"),this.search=el("input"),this.searchIcon=el("i.fa.fa-search.searchIcon"),this.jstree=el("div")),this.id="types",this.name="Types",this.addButton.onclick=function(){t.state.game.addChild(Prototype.create(""+Math.random())),t.editor.update(),t.editor.save()};var r=!1;this.search.addEventListener("keyup",function(){r&&clearTimeout(r),r=setTimeout(function(){$(t.jstree).jstree().search(t.search.value.trim())},200)})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.update=function(){var e=this;if(!this.skipUpdate){var t=[];this.state.game.forEachChild("prt",function(e){var r=e.getParent();t.push({text:e.name,id:e.id,parent:"prt"===r._threeLetterType?r.id:"#"})},!0),this.jstreeInited?($(this.jstree).jstree(!0).settings.core.data=t,$(this.jstree).jstree("refresh")):($(this.jstree).attr("id","types-jstree").on("changed.jstree",function(t,r){e.skipUpdate=!0,e.editor.select(r.selected.map(getSerializable)),e.skipUpdate=!1}).on("loaded.jstree refresh.jstree",function(){$(e.jstree).jstree(!0);"none"===e.state.selection.type,"prt"===e.state.selection.type}).jstree({core:{check_callback:!0,data:t,force_text:!0},plugins:["types","dnd","sort","search","state"],types:{default:{icon:"fa fa-book"}},dnd:{copy:!1},search:{fuzzy:!0,show_only_matches:!0,show_only_matches_children:!0,close_opened_onclear:!1}}),this.jstreeInited=!0),$(this.jstree).data("typesModule",this),"none"===this.state.selection.type}},t}(Module);$(document).on("dnd_stop.vakata",function(e,t){var r=$("#types-jstree").jstree(!0),o=$("#types-jstree").data("typesModule");setTimeout(function(){var e,n=r.get_node(t.data.obj),i=t.data.nodes;e="#"===n.parent?o.state.game:getSerializable(n.parent);var a=i.map(getSerializable);a.forEach(assert),a.forEach(function(t){e.addChild(t.detach())}),o.editor.save()})}),Module.register(Types,"left");var TestModule=function(e){function t(){e.call(this,this.content=el("span","List of instances on the scene")),this.name="Instances",this.id="instances"}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.update=function(){},t}(Module);Module.register(TestModule,"left");var TestModule$1=function(e){function t(){e.call(this,this.content=el("span","This is test 3")),this.id="test",this.name="Test3"}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.update=function(){},t}(Module);Module.register(TestModule$1,"bottom"),window.addEventListener("load",function(){var e;try{e=Serializable.fromJSON(JSON.parse(localStorage.anotherGameJSON))}catch(e){console.warn("game parsing failed",e)}editor=new Editor(e),events.dispatch("registerModules",editor)}),events.listen("modulesRegistered",function(){editor.update(),events.dispatch("loaded")});var editor=null,Editor=function(e){var t=this;void 0===e&&(e=Game.create("My Game")),this.layout=new Layout,this.state={topButtons:[],selection:{type:"none",items:[]},game:e,componentClasses:componentClasses},mount(document.body,this.layout),events.listen("registerTopButton",function(e,r,o,n){for(var i={icon:r,text:e,func:o,priority:n},a=0,s=t.state.topButtons;a<s.length;){var p=s[a];if(p.priority>n){s.splice(a,0,i),a=-1;break}a++}a>=0&&s.push(i)}),events.listen("requestUpdate",function(){console.log("requested"),t.update()})};Editor.prototype.select=function(e){this.state.selection.items=e;var t=Array.from(new Set(e.map(function(e){return e.id.substring(0,3)})));0===t.length?this.state.selection.type="none":1===t.length?this.state.selection.type=t[0]:this.state.selection.type="mixed",this.update()},Editor.prototype.update=function(){this.layout.update(this.state)},Editor.prototype.save=function(){localStorage.anotherGameJSON=JSON.stringify(this.state.game.toJSON()),console.log("saved")},window.Property=Property,window.PropertyModel=createPropertyType,window.Component=Component,window.Serializable=Serializable,window.getSerializable=getSerializable;
//# sourceMappingURL=explore.dev.min.js.map
