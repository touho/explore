function assert(t,e){if(!t)throw new Error(e)}function addSerializable(t){if(serializables.has(t.id))throw new Error("Serializable id clash!");serializables.set(t.id,t)}function removeSerializable(t){if(!serializables.delete(t))throw new Error("Serializable not found!")}function char(){return BASE_64_CHARACTERS[Math.random()*CHAR_COUNT|0]}function createStringId(t,e){void 0===t&&(t="???"),void 0===e&&(e=16);for(var o=t,n=e-1;0!==n;--n)o+=char();return o}function PropertyType(t,e,o){for(var n=[],r=arguments.length-3;r-- >0;)n[r]=arguments[r+3];o=o();var i=o.validators.default(),a="";return n.forEach(function(t){"string"==typeof t?a=t:t&&t.validate?i=t:assert(!1,"invalid parameter "+t)}),new PropertyModel(t,o,i,e)}function addType(t){var e=t.name;void 0===e&&(e="");var o=t.validators;void 0===o&&(o={default:function(t){return t}});var n=t.toJSON;void 0===n&&(n=function(t){return t});var r=t.fromJSON;void 0===r&&(r=function(t){return t}),assert(e,"name missing from property type"),assert("function"==typeof o.default,"default validator missing from property type: "+e),assert("function"==typeof n,"invalid toJSON for property type: "+e),assert("function"==typeof r,"invalid fromJSON for property type: "+e);var i={name:e,validators:o,toJSON:n,fromJSON:r},a=function(){return i};Object.keys(o).forEach(function(t){a[t]=createValidator(t,o[t]),o[t]=a[t]}),PropertyType[e]=a}function createValidator(t,e){var o=function(){for(var o=arguments.length,n=Array(o);o--;)n[o]=arguments[o];var r=[].concat(n);return{validatorName:t,validatorParameters:r,validate:function(t){return e.apply(void 0,[t].concat(r))}}};return o.validatorName=t,o.validate=e,o}function createElement(t,e){for(var o,n,r,i=0,a=0,s=0;s<=t.length;s++){var l=t.charCodeAt(s);if(l===HASH||l===DOT||!l){if(0===i)o=0===s?"div":l?t.substring(a,s):t;else{var p=t.substring(a,s);1===i?n=p:r?r+=" "+p:r=p}a=s+1,i=l===HASH?1:2}}var c=e?document.createElementNS(e,o):document.createElement(o);return n&&(c.id=n),r&&(c.className=r),c}function text(t){return document.createTextNode(t)}function mount(t,e,o){var n=t.el||t,r=e.el||e;r.__redom_list&&(r=r.el),e===r&&r.__redom_view&&(e=r.__redom_view),e!==r&&(r.__redom_view=e),e.isMounted?e.remount&&e.remount():e.mount&&e.mount(),o?n.insertBefore(r,o.el||o):n.appendChild(r),e.isMounted?e.remounted&&e.remounted():(e.isMounted=!0,e.mounted&&e.mounted())}function unmount(t,e){var o=t.el||t,n=e.el||e;e===n&&n.__redom_view&&(e=n.__redom_view),e.unmount&&e.unmount(),o.removeChild(n),e.isMounted=!1,e.unmounted&&e.unmounted()}function el(t){var e,o=arguments;if("string"==typeof t)e=(elcache[t]||(elcache[t]=createElement(t))).cloneNode(!1);else{if(!t||!t.nodeType)throw new Error("At least one argument required");e=t.cloneNode(!1)}for(var n=!0,r=1;r<arguments.length;r++){var i=o[r];if(i)if("function"==typeof i)i(e);else if("string"==typeof i||"number"==typeof i)n?(n=!1,e.textContent=i):e.appendChild(text(i));else if(i.nodeType||i.el&&i.el.nodeType)n=!1,mount(e,i);else if(i.length){n=!1;for(var a=0;a<i.length;a++)mount(e,i[a])}else if("object"==typeof i)for(var s in i){var l=i[s];if("style"===s)if("string"==typeof l)e.setAttribute(s,l);else for(var p in l)e.style[p]=l[p];else s in e||"function"==typeof l?e[s]=l:e.setAttribute(s,l)}}return e}function setChildren(t,e){for(var o=t.el||t,n=o.firstChild,r=0;r<e.length;r++){var i=e[r];if(i){var a=i.el||i;a!==n?mount(t,i,n):n=n.nextSibling}}for(;n;){var s=n.nextSibling;unmount(t,n),n=s}}function list(t,e,o,n){return new List(t,e,o,n)}function List(t,e,o,n){this.__redom_list=!0,this.View=e,this.key=o,this.initData=n,this.views=[],this.el="string"==typeof t?el(t):t,o&&(this.lookup={})}var serializables=new Map,BASE_64_CHARACTERS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",CHAR_COUNT=BASE_64_CHARACTERS.length,Serializable=function(t,e){void 0===e&&(e=!1),e?this.id=e:this.id=createStringId(t),addSerializable(this)};Serializable.prototype.delete=function(){removeSerializable(this.id)},Serializable.prototype.toJSON=function(){return{id:this.id}},Serializable.prototype.toString=function(){return JSON.stringify(this.toJSON(),null,4)},Serializable.fromJSON=function(t){return assert("string"==typeof t.id),new Serializable(null,t.id)};var ALIVE_ERROR="entity is already dead",Entity=function(t){function e(){t.call(this,"ent"),this.components=new Map,this.alive=!0,this.sleeping=!1,this.prototype=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getComponent=function(t){assert(this.alive,ALIVE_ERROR);var e=this.components.get(t);return void 0!==e?e[0]:null},e.prototype.getComponents=function(t){return assert(this.alive,ALIVE_ERROR),this.components.get(t)||[]},e.prototype.addComponents=function(t){var o=this;assert(this.alive,ALIVE_ERROR),assert(Array.isArray(t),"Parameter is not an array.");for(var n=0;n<t.length;n++){var r=o.components.get(t[n].name)||o.components.set(t[n].name,[]).get(t[n].name);r.push(t[n])}return this.sleeping||e.initComponents(t),this},e.initComponents=function(t){for(var e=0;e<t.length;e++)t[e]._preInit();for(var o=0;o<t.length;o++)t[o]._init()},e.makeComponentsSleep=function(t){for(var e=0;e<t.length;e++)t[e]._sleep()},e.deleteComponents=function(t){for(var e=0;e<t.length;e++)t[e].delete()},e.prototype.sleep=function(){var t=this;if(assert(this.alive,ALIVE_ERROR),this.sleeping)return!1;for(var o=0,n=t.components;o<n.length;o+=1){var r=n[o];e.makeComponentsSleep(r)}return this.sleeping=!0,!0},e.prototype.wakeUp=function(){var t=this;if(assert(this.alive,ALIVE_ERROR),!this.sleeping)return!1;for(var o=0,n=t.components;o<n.length;o+=1){var r=n[o];e.initComponents(r)}return this.sleeping=!1,!0},e.prototype.delete=function(){var o=this;assert(this.alive,ALIVE_ERROR),this.sleep(),t.prototype.delete.call(this),this.alive=!1;for(var n=0,r=o.components;n<r.length;n+=1){var i=r[n];e.deleteComponents(i)}this.components.clear()},e.prototype.toJSON=function(){return assert(this.alive,ALIVE_ERROR),Object.assign(t.prototype.toJSON.call(this),{components:[]})},e}(Serializable),PropertyModel=function(t){function e(e,o,n,r){assert("string"==typeof e),assert("string"==typeof o.name),assert("function"==typeof n.validate),t.call(this,"pmo"),this.name=e,this.type=o,this.validator=n,this.initialValue=r}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.toJSON=function(){return Object.assign(t.prototype.toJSON.call(this),{name:this.name,type:this.type.name,validatorName:this.validator.validatorName,validatorParameters:this.validator.validatorParameters,initialValue:this.type.toJSON(this.initialValue)})},e.prototype.delete=function(){t.prototype.delete.call(this),this.type=null,this.validator=null},e}(Serializable);addType({name:"float",validators:{default:function(t){return t=parseFloat(t),assert(!isNaN(t),"invalid float: "+t),t},range:function(t,e,o){return t=parseFloat(t),assert(!isNaN(t),"invalid float: "+t),Math.min(o,Math.max(e,t))}},toJSON:function(t){return t},fromJSON:function(t){return t}}),addType({name:"string",validators:{default:function(t){return String(t)}},toJSON:function(t){return t},fromJSON:function(t){return t}}),function(){var t=new Serializable("tes"),e=t.id;assert("string"==typeof e&&e.length>10);var o=t.toJSON();assert(o&&"object"==typeof o&&"string"==typeof o.id),t.delete(),t=Serializable.fromJSON(o),assert("string"==typeof t.id&&t.id.length>10&&t.id===e),console.log("Serializable tests OK")}(),function(){var t=new Entity;assert(0===t.components.size),assert(null===t.getComponent("moi")),assert(0===t.getComponents("moi").length),console.log("Entity tests OK")}(),function(){assert(4===PropertyType.float.default().validate("4")),assert(1===PropertyType.float.range(0,1).validate(3)),console.log("PropertyType tests OK")}();var Property=function(t){function e(e){t.call(this,"pro"),this.model=e,this.value=e.initialValue}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.toJSON=function(){return Object.assign(t.prototype.toJSON.call(this),{value:this.type.toJSON(this.value),modelId:this.model.id})},e.prototype.delete=function(){t.prototype.delete.call(this),this.model=null},e}(Serializable);Object.defineProperty(Property.prototype,"type",{get:function(){return this.model.type}}),Object.defineProperty(Property.prototype,"value",{set:function(t){this._value=this.model.validator.validate(t)},get:function(){return this._value}}),Object.defineProperty(Property.prototype,"initialValue",{get:function(){return this.model.initialValue}});var componentClasses=new Map,Component=function(t){function e(e,o,n){var r=this;t.call(this,"com"),this.entity=o,this.env=n,this.children={},this._properties={},this._componentModel=e,this.constructor.propertyModels.forEach(function(t){r._properties[t.name]=new Property(t)})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){assert(!this.env.entity.alive,"Do not call Component.delete!"),t.prototype.delete.call(this)},e.prototype._preInit=function(){var t=this;this.constructor.requirements.forEach(function(e){t[e]=t.entity.getComponent(e),assert(t[e],"required component not found")}),this._forEachChildComponent(function(t){return t._preInit()});try{"function"==typeof this.preInit&&this.preInit()}catch(t){console.error(this.entity,this.constructor.name,"preInit",t)}},e.prototype._init=function(){this._forEachChildComponent(function(t){return t._init()});try{"function"==typeof this.init&&this.init()}catch(t){console.error(this.entity,this.constructor.name,"init",t)}},e.prototype._sleep=function(){try{"function"==typeof this.sleep&&this.sleep()}catch(t){console.error(this.entity,this.constructor.name,"sleep",t)}this._forEachChildComponent(function(t){return t._sleep()})},e.prototype._forEachChildComponent=function(t){var e=this;Object.keys(this.children).forEach(function(o){var n=e.children[o];Array.isArray(n)?n.forEach(t):t(n)})},e}(Serializable);Component.reservedPropertyNames=new Set(["id","constructor","delete","children","entity","env","init","preInit","sleep","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentModel"]),Component.reservedPrototypeMembers=new Set(["id","children","entity","env","_preInit","_init","_sleep","_forEachChildComponent","_properties","_componentModel"]),Component.register=function(t){var e=t.name;void 0===e&&(e="");var o=t.description;void 0===o&&(o="");var n=t.category;void 0===n&&(n="Other");var r=t.icon;void 0===r&&(r="fa-bars");var i=t.properties;void 0===i&&(i=[]);var a=t.requirements;void 0===a&&(a=[]);var s=t.children;void 0===s&&(s=[]);var l=t.parentClass;void 0===l&&(l=Component);var p=t.prototype;void 0===p&&(p={}),assert(e,"Component must have a name."),assert(!componentClasses.has(e),"Duplicate component class "+e),Object.keys(p).forEach(function(t){Component.reservedPrototypeMembers.has(t)&&assert(!1,"Component prototype can not have a reserved member: "+t)});var c=p.constructor,u=p.delete;delete p.constructor,delete p.delete;var d=function(t){function e(){t.apply(this,arguments),c&&c()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.delete=function(){t.prototype.delete.apply(this,arguments),u&&u()},e}(l);return Object.defineProperty(d,"name",{get:function(){return e}}),d.propertyModels=i,d.category=n,d.requirements=a,d.children=s,Object.assign(d.prototype,p),d.propertyModels.forEach(function(t){assert(!Component.reservedPropertyNames.has(t.name),"Can not have property called "+t.name),assert(void 0===d.prototype[t.name],"Name "+t.name+" clashes "),Object.defineProperty(d.prototype,t.name,{get:function(){return this._properties[t.name].value},set:function(e){this._properties[t.name].value=e}})}),componentClasses.set(d.name,d),d},Component.register({name:"Example",description:"Description of what this component does",category:"Core",icon:"fa-circle",requirements:["Position"],children:["Image","Image","Sound"],properties:[PropertyType("variable",.5,PropertyType.float,PropertyType.float.range(0,1),"Description of the property"),PropertyType("otherVariaerfperfjoierjfoeifjble","Hello",PropertyType.string,"Description of the property")],parentClass:Component,prototype:{staticVariable:"Example class info",constructor:function(){this.hiddenVariable=3},preInit:function(){this.data={lotsOfData:123+this.variable+this.hiddenVariable}},init:function(){this.Position.x=this.Position.y+1,this.howToAccessChildren=[this.children.Image[0].property,this.children.Sound.property],this.SomeComponent=this.entity.getComponent("SomeComponent")},sleep:function(){this.data=null,this.SomeComponent=null,this.howToAccessChildren=null},delete:function(){}}}),Component.register({name:"Position",category:"Core",icon:"fa-circle",properties:[PropertyType("x",.1,PropertyType.float),PropertyType("y",.2,PropertyType.float)]}),Component.register({name:"Test",category:"Core",icon:"fa-circle",properties:[PropertyType("name","Oh right",PropertyType.string),PropertyType("number",666,PropertyType.float)]});var listeners={},Event={listen:function(t,e){return listeners.hasOwnProperty(t)||(listeners[t]=[]),listeners[t].push(e),function(){var o=listeners[t].indexOf(e);listeners[t].splice(o,1)}},dispatch:function(t,e){if(listeners.hasOwnProperty(t)){Array.isArray(e)||(e=[e]);for(var o=0;o<listeners[t].length;++o)try{listeners[t][o].call(null,e)}catch(t){console&&console.error&&console.error(t)}}}},HASH="#".charCodeAt(0),DOT=".".charCodeAt(0),elcache={};el.extend=function(t){var e=elcache[t]||(elcache[t]=createElement(t));return el.bind(this,e)},List.extend=function(t,e,o,n){return List.bind(List,t,e,o,n)},list.extend=List.extend,List.prototype.update=function(t){void 0===t&&(t=[]);for(var e=this.View,o=this.key,n="function"==typeof o,r=this.initData,i=new Array(t.length),a=this.views,s=o&&{},l=o&&this.lookup,p=0;p<t.length;p++){var c=t[p],u=void 0;if(o){var d=n?o(c):c[o];u=i[p]=l[d]||new e(r,c,p,t),s[d]=u,u.__id=d}else u=i[p]=a[p]||new e(r,c,p,t);var h=u.el;h.__redom_list&&(h=h.el),h.__redom_view=u,u.update&&u.update(c,p,t)}setChildren(this,i),o&&(this.lookup=s),this.views=i};var Router=function(t,e){this.el="string"==typeof t?el(t):t,this.Views=e};Router.prototype.update=function(t,e){if(t!==this.route){var o=this.Views,n=o[t];this.view=n&&new n,this.route=t,setChildren(this.el,[this.view])}this.view&&this.view.update&&this.view.update(e)};var TopButton=function(){this.el=el("div.iconTextButton",this.icon=el("i.fa"),this.text=el("span"))};TopButton.prototype.update=function(t){console.log("Button",t),this.icon.className=t.iconClass,this.text.textContent=t.text};var Top=function(){this.el=el("div.top",this.list=list("div.buttonContainer",TopButton))};Top.prototype.update=function(t){console.log("Top",t),this.list.update(t.buttons)};var PropertyEditor=function(){var t=this;this.el=el("div.propertyEditor.packable",this.editor=el("div.propertyEditor"),this.toggleButton=el("i.togglePacked.iconButton.fa.fa-chevron-right")),this.el.onclick=function(){return t.el.classList.contains("packed")&&t.el.classList.remove("packed")},this.toggleButton.onclick=function(e){t.el.classList.add("packed"),e.stopPropagation()}};PropertyEditor.prototype.update=function(t){new PJS($(this.editor),t.schema,t.data)};var Left=function(){var t=this;this.el=el("div.left.packable",this.toggleButton=el("i.togglePacked.iconButton.fa.fa-chevron-left")),this.el.onclick=function(){return t.el.classList.contains("packed")&&t.el.classList.remove("packed")},this.toggleButton.onclick=function(e){t.el.classList.add("packed"),e.stopPropagation()}};Left.prototype.update=function(t){};var Bottom=function(){var t=this;this.el=el("div.bottom.packable",this.toggleButton=el("i.togglePacked.iconButton.fa.fa-chevron-down")),this.el.onclick=function(){return t.el.classList.contains("packed")&&t.el.classList.remove("packed")},this.toggleButton.onclick=function(e){t.el.classList.add("packed"),e.stopPropagation()}};Bottom.prototype.update=function(t){};var propertyTypeToEditorType={float:"number",string:"text"},Layout=function(){this.el=el("div.editorLayout",el("div.nonRight",this.top=new Top,el("div.middle",this.left=new Left,this.center=new Center),this.bottom=new Bottom),this.propertyEditor=new PropertyEditor)};Layout.prototype.update=function(t){this.top.update(t.top),this.left.update(t.left),this.center.update(t.center),this.propertyEditor.update(t.propertyEditor),this.bottom.update(t.bottom)};var Center=function(){this.el=el("div.center")};Center.prototype.update=function(t){},Event.listen("load",function(){console.log("layout load",componentClasses);var t={editors:[{field:"yks",title:"YKS",type:"text"}]},e={},o=Array.from(componentClasses.values());o.forEach(function(o){var n={type:"group",field:o.name,title:o.name,editors:o.propertyModels.map(function(t){return{field:o.name+"."+t.name,title:t.name.length>30?t.name.substring(0,28)+"..":t.name,type:propertyTypeToEditorType[t.type.name]||"text"}})};t.editors.push(n);var r={};o.propertyModels.forEach(function(t){r[t.name]=t.initialValue}),e[o.name]=r}),console.log("schema",t,e);var n={top:{buttons:[{iconClass:"fa fa-bell-o",text:"Bell"},{iconClass:"fa fa-cubes",text:"Cubes"}]},propertyEditor:{schema:t,data:e}},r=new Layout;r.update(n),mount(document.body,r)}),window.addEventListener("load",function(){console.log("load"),Event.dispatch("load")}),window.Property=Property,window.PropertyModel=PropertyModel,window.PropertyType=PropertyType,window.Component=Component;
//# sourceMappingURL=explore.dev.min.js.map
